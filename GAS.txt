/**
 * 2026 å››åœ‹å·¡ç¦® - é›²ç«¯å¾Œç«¯æ ¸å¿ƒ (Shikoku Trip Backend)
 * æ”¯æ´åŠŸèƒ½ï¼šè¨˜å¸³åŒæ­¥ã€å¾…è¾¦æ¸…å–®åŒæ­¥ã€è¡Œç¨‹é †åºç·¨è¼¯èˆ‡é‡ç½®
 */

// --- å®‰å…¨è¨­å®š ---
// const WEB_APP_TOKEN = "shikoku_2026_secret"; // ğŸ‘ˆ è«‹å‹™å¿…èˆ‡ index.html ä¸­çš„ G_TOKEN ä¸€è‡´
const WEB_APP_TOKEN = PropertiesService.getScriptProperties().getProperty('WEB_APP_TOKEN');

// --- è©¦ç®—è¡¨å…¨åŸŸè®Šæ•¸ ---
const SS = SpreadsheetApp.getActiveSpreadsheet();
const EXP_SHEET = SS.getSheetByName("Expenses");
const CHK_SHEET = SS.getSheetByName("Checklists");
const ITIN_SHEET = SS.getSheetByName("ItineraryEdits");

// æ¬Šé™é©—è­‰ï¼šç¢ºä¿è«‹æ±‚ä¾†è‡ªä½ çš„ç¶²é 
function isAuthorized(token) {
//  return token === WEB_APP_TOKEN;
  return token === WEB_APP_TOKEN;
}

/**
 * è™•ç† GET è«‹æ±‚ï¼šæ‹‰å–æ‰€æœ‰æœ€æ–°é›²ç«¯è³‡æ–™
 */
function doGet(e) {
  if (!isAuthorized(e.parameter.token)) {
    return ContentService.createTextOutput("Unauthorized").setMimeType(ContentService.MimeType.TEXT);
  }

  // 1. è®€å–è¨˜å¸³è³‡æ–™
  const expValues = EXP_SHEET.getDataRange().getValues();
  const expenseList = (expValues.length <= 1) ? [] : expValues.slice(1).map(r => {
    try {
      return { 
        name: r[1], cost: r[2], payer: r[3], type: r[4], ts: r[5], 
        participants: JSON.parse(r[6] || "[]") 
      };
    } catch(err) { return null; }
  }).filter(x => x !== null);

  // 2. è®€å–å‹¾é¸æ¸…å–® (å€‹äºº + å…¨å“¡ GLOBAL)
  const chkValues = CHK_SHEET.getDataRange().getValues();
  const checklistMap = (chkValues.length <= 1) ? [] : chkValues.slice(1).map(r => ({ 
    user: r[0], type: r[1], item: r[2], checked: r[3] === true || r[3] === "TRUE" 
  }));

  // 3. è®€å–è¡Œç¨‹ç·¨è¼¯ç´€éŒ„ (è‡ªå®šç¾©æ’åº)
  const itinValues = ITIN_SHEET.getDataRange().getValues();
  const itineraryEdits = (itinValues.length <= 1) ? {} : itinValues.slice(1).reduce((acc, r) => {
    if (r[0] && r[1]) {
      try { acc[r[0]] = JSON.parse(r[1]); } catch(err) {}
    }
    return acc;
  }, {});

  const result = {
    expenses: expenseList,
    checklists: checklistMap,
    itineraryEdits: itineraryEdits
  };
  
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

/**
 * è™•ç† POST è«‹æ±‚ï¼šå¯«å…¥ã€ä¿®æ”¹æˆ–åˆªé™¤é›²ç«¯è³‡æ–™
 */
function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    if (!isAuthorized(params.token)) {
      return ContentService.createTextOutput("Forbidden").setMimeType(ContentService.MimeType.TEXT);
    }

    const action = params.action;
    const d = params.data;

    // --- [å‹•ä½œ A]ï¼šæ–°å¢è¨˜å¸³ ---
    if (action === "addExpense" && d) {
      EXP_SHEET.appendRow([new Date(), d.name, d.cost, d.payer, d.type, d.ts, JSON.stringify(d.participants || [])]);
    } 
    
    // --- [å‹•ä½œ B]ï¼šåˆªé™¤è¨˜å¸³ ---
    else if (action === "deleteExpense" && d.ts) {
      const data = EXP_SHEET.getDataRange().getValues();
      for (let i = data.length - 1; i >= 1; i--) {
        if (data[i][5] == d.ts) {
          EXP_SHEET.deleteRow(i + 1);
          break; 
        }
      }
    }

    // --- [å‹•ä½œ C]ï¼šæ›´æ–°å‹¾é¸ç‹€æ…‹ (å€‹äººæ¸…å–® & å…¨å“¡å¾…è¾¦) ---
    else if (action === "updateCheck" && d) {
      const dataRows = CHK_SHEET.getDataRange().getValues();
      let found = false;
      for (let i = 1; i < dataRows.length; i++) {
        if (dataRows[i][0] === d.user && dataRows[i][1] === d.type && dataRows[i][2] === d.item) {
          CHK_SHEET.getRange(i + 1, 4).setValue(d.checked);
          found = true; break;
        }
      }
      if (!found) CHK_SHEET.appendRow([d.user, d.type, d.item, d.checked]);
    }

    // --- [å‹•ä½œ D]ï¼šæ›´æ–°è¡Œç¨‹ç·¨è¼¯ (æ’åº/æ™‚é–“ä¿®æ”¹) ---
    else if (action === "updateItinerary" && d.file) {
      const itinRows = ITIN_SHEET.getDataRange().getValues();
      let found = false;
      for (let i = 1; i < itinRows.length; i++) {
        if (itinRows[i][0] === d.file) {
          ITIN_SHEET.getRange(i + 1, 2).setValue(JSON.stringify(d.items));
          found = true; break;
        }
      }
      if (!found) ITIN_SHEET.appendRow([d.file, JSON.stringify(d.items)]);
    }

    // --- [å‹•ä½œ E]ï¼šé‡ç½®è¡Œç¨‹ç‚º Default (åˆªé™¤ç•°å‹•ç´€éŒ„) ---
    else if (action === "resetItinerary" && d.file) {
      const itinRows = ITIN_SHEET.getDataRange().getValues();
      for (let i = itinRows.length - 1; i >= 1; i--) {
        if (itinRows[i][0] === d.file) {
          ITIN_SHEET.deleteRow(i + 1);
        }
      }
    }
    
    return ContentService.createTextOutput("Success").setMimeType(ContentService.MimeType.TEXT);
  } catch (err) {
    return ContentService.createTextOutput("Error: " + err.message).setMimeType(ContentService.MimeType.TEXT);
  }
}