<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>四國慢旅 2026</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* 日式科技風配色 */
            --bg-body: #F5F5F7; /* iOS 淺灰底 */
            --bg-card: #FFFFFF;
            --primary: #2C3E50; /* 深靛藍 (科技感/沈穩) */
            --accent: #007AFF; /* 科技藍 (強調/按鈕) */
            --text-main: #1D1D1F;
            --text-sec: #86868B;
            --divider: #E5E5EA;
            --success: #34C759;
            --radius: 16px;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Roboto', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding-bottom: 100px; /* Nav spacing */
            line-height: 1.5;
        }

        /* --- UI Elements --- */
        
        /* Header */
        .app-header {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .app-header h1 { margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--primary); letter-spacing: 0.5px; }
        .app-header span { font-size: 0.8rem; color: var(--text-sec); font-weight: 500; }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(44, 62, 80, 0.95); /* 深色導航列 */
            backdrop-filter: blur(20px);
            border-radius: 30px;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .nav-item {
            text-align: center;
            color: rgba(255,255,255,0.5);
            font-size: 0.7rem;
            cursor: pointer;
            transition: 0.3s;
            flex: 1;
        }
        .nav-item i { display: block; font-size: 1.3rem; margin-bottom: 4px; }
        .nav-item.active { color: #fff; transform: translateY(-2px); }

        /* Layout */
        .page { display: none; padding: 20px; animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.02);
        }
        .card-title {
            font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; color: var(--primary);
            display: flex; align-items: center; gap: 8px;
        }
        .section-title {
            font-size: 0.9rem; font-weight: 700; color: var(--text-sec);
            margin: 25px 0 10px 5px; text-transform: uppercase; letter-spacing: 1px;
        }

        /* Buttons */
        .btn {
            background: var(--accent); color: white; border: none;
            padding: 12px 20px; border-radius: 12px; font-weight: 600; font-size: 0.95rem;
            cursor: pointer; width: 100%; text-align: center;
            transition: active 0.2s; text-decoration: none; display: inline-block;
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; border-radius: 20px; }
        .btn-map { background: #E9F4FF; color: var(--accent); display: inline-flex; align-items: center; gap: 5px; }

        /* --- PAGE: Pre-trip --- */
        .user-switch {
            background: #EBEBF0; padding: 4px; border-radius: 50px;
            display: flex; gap: 5px; margin-bottom: 20px;
        }
        .user-btn {
            flex: 1; text-align: center; padding: 8px 0; border-radius: 50px;
            font-weight: 600; font-size: 0.9rem; color: var(--text-sec);
            cursor: pointer; transition: 0.3s;
        }
        .user-btn.active { background: #fff; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .checklist-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); /* 3 items per row */
            gap: 10px;
        }
        .check-item {
            background: #F9F9FB; border-radius: 10px; padding: 10px 5px;
            text-align: center; font-size: 0.85rem; color: var(--text-main);
            border: 1px solid transparent; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
        }
        .check-item i { font-size: 1.2rem; color: #C7C7CC; margin-bottom: 5px; }
        .check-item.checked { background: #E8F5E9; border-color: var(--success); color: #2E7D32; }
        .check-item.checked i { color: var(--success); }

        /* --- PAGE: Itinerary --- */
        .day-scroller {
            display: flex; gap: 12px; overflow-x: auto; padding: 0 5px 15px;
            margin: -5px -20px 0; scrollbar-width: none;
            position: sticky; top: 60px; z-index: 90; background: var(--bg-body);
            padding: 15px 20px;
        }
        .day-chip {
            flex: 0 0 auto; background: white; border-radius: 20px;
            padding: 8px 16px; font-size: 0.9rem; font-weight: 600; color: var(--text-sec);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: 0.3s; cursor: pointer;
        }
        .day-chip.active { background: var(--primary); color: white; transform: scale(1.05); box-shadow: 0 4px 12px rgba(44, 62, 80, 0.3); }

        .weather-banner {
            background: linear-gradient(135deg, #6DD5FA 0%, #2980B9 100%);
            border-radius: 20px; padding: 20px; color: white; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 8px 20px rgba(41, 128, 185, 0.3);
        }

        .timeline-card {
            display: flex; gap: 15px; margin-bottom: 20px; position: relative;
        }
        .timeline-left { display: flex; flex-direction: column; align-items: center; min-width: 50px; }
        .time-text { font-weight: 700; color: var(--primary); font-size: 0.95rem; }
        .time-line { width: 2px; background: #E5E5EA; flex: 1; margin-top: 8px; border-radius: 2px; }
        .timeline-content { flex: 1; background: white; border-radius: 16px; padding: 15px; box-shadow: var(--shadow); }
        
        .tag {
            display: inline-block; padding: 4px 8px; border-radius: 6px;
            font-size: 0.75rem; font-weight: 700; margin-bottom: 8px; letter-spacing: 0.5px;
        }
        .tag-food { background: #FFF3E0; color: #F57C00; }
        .tag-sight { background: #E8F5E9; color: #2E7D32; }
        .tag-shop { background: #FFEBEE; color: #D32F2F; }
        .tag-transport { background: #E3F2FD; color: #1976D2; }

        .detail-box {
            background: #F5F5F7; border-radius: 10px; padding: 12px;
            margin-top: 10px; font-size: 0.9rem; display: none;
        }
        .detail-box p { margin: 5px 0; display: flex; gap: 8px; }
        .detail-icon { color: var(--text-sec); width: 20px; }
        
        .mapcode-btn {
            font-family: 'Roboto Mono', monospace; background: #333; color: #fff;
            padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;
            display: inline-flex; align-items: center; gap: 5px; margin-top: 5px;
        }

        /* --- PAGE: Booking --- */
        .flight-ticket {
            background: white; border-radius: 16px; overflow: hidden; margin-bottom: 20px;
            box-shadow: var(--shadow); position: relative;
        }
        .flight-header {
            background: #F5F5F7; padding: 10px 20px; font-size: 0.85rem; font-weight: 600; color: var(--text-sec);
            display: flex; justify-content: space-between;
        }
        .flight-body { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .airport { text-align: center; }
        .code { font-size: 2rem; font-weight: 800; color: var(--primary); display: block; line-height: 1; }
        .city { font-size: 0.85rem; color: var(--text-sec); }
        .flight-icon { color: #E5E5EA; font-size: 1.5rem; transform: rotate(90deg); }
        .flight-footer {
            padding: 15px 20px; border-top: 1px dashed #E5E5EA;
            display: flex; justify-content: space-between; font-size: 0.9rem;
        }

        .hotel-item {
            background: white; border-radius: 16px; overflow: hidden; margin-bottom: 20px; box-shadow: var(--shadow);
        }
        .hotel-img-wrap { height: 160px; position: relative; cursor: pointer; }
        .hotel-img { width: 100%; height: 100%; object-fit: cover; }
        .hotel-overlay {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            padding: 40px 15px 15px; color: white;
        }
        .hotel-info { padding: 15px; }
        .hotel-alert {
            background: #FFF8E1; color: #FBC02D; font-size: 0.85rem; padding: 10px;
            border-radius: 8px; margin-top: 10px; display: flex; gap: 8px; align-items: start;
        }

        /* --- PAGE: Expense --- */
        .expense-input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .expense-input {
            flex: 1; padding: 15px; border: none; background: #F5F5F7;
            border-radius: 12px; font-size: 1rem; outline: none;
        }
        .payer-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
        .payer-chip {
            background: white; border: 1px solid #E5E5EA; border-radius: 50px;
            padding: 10px 0; text-align: center; font-weight: 700; color: var(--text-sec); cursor: pointer;
        }
        .payer-chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .debt-card {
            background: #2C3E50; color: white; border-radius: 16px; padding: 20px; margin-top: 20px;
        }
        .debt-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }

        /* Lightbox */
        .lightbox {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .lightbox.show { display: flex; opacity: 1; }
        .lightbox img { max-width: 100%; max-height: 80vh; }
        .lightbox-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; cursor: pointer; }

    </style>
</head>
<body>

    <header class="app-header">
        <h1>四國慢旅 2026</h1>
        <span>9天8夜</span>
    </header>

    <div id="page-pre" class="page active">
        <div class="card">
            <h2 class="card-title"><i class="fas fa-suitcase-rolling"></i> 行前檢查</h2>
            <div class="user-switch" id="userSwitch">
                </div>
            
            <div class="section-title">旅遊前準備</div>
            <div class="checklist-grid" id="list-before"></div>
            
            <div class="section-title">隨身行李</div>
            <div class="checklist-grid" id="list-carry"></div>

            <div class="section-title">託運行李</div>
            <div class="checklist-grid" id="list-check"></div>
        </div>

        <div class="card">
            <h2 class="card-title"><i class="fas fa-tasks"></i> 全員待辦</h2>
            <ul style="padding-left: 20px; color: var(--text-main); font-size: 0.95rem;">
                <li>租車 ETC + SEP (四國高速吃到飽)</li>
                <li>Visit Japan Web (每人都要填)</li>
                <li>小豆島渡輪預約 (車輛)</li>
                <li>鳴門觀潮船預約</li>
                <li>栗林公園遊船預約</li>
                <li>GoGo 滑索預約</li>
            </ul>
            <a href="https://cheng-ya.deeeep.com.tw/index.php" target="_blank" class="btn">領取香川優惠券</a>
        </div>
    </div>

    <div id="page-itinerary" class="page">
        <div class="day-scroller" id="dayScroller">
            </div>

        <div class="weather-banner" id="weatherBanner">
            <div>
                <h2 style="margin:0; font-size:1.5rem;" id="weatherCity">高松市</h2>
                <div style="font-size:0.9rem; opacity:0.9; margin-top:5px;">
                    <i class="fas fa-temperature-high"></i> <span id="weatherTemp">8°C - 15°C</span>
                    <span style="margin:0 5px;">|</span>
                    <i class="fas fa-cloud-sun"></i> 降雨機率 20%
                </div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:0.75rem; text-transform:uppercase; opacity:0.8;">Stay At</div>
                <div style="font-weight:700; font-size:1rem;" id="stayHotel">Second Home</div>
            </div>
        </div>

        <div id="timelineList">
            </div>
    </div>

    <div id="page-info" class="page">
        <div class="section-title" style="margin-top:0;">Flights</div>
        
        <div class="flight-ticket">
            <div class="flight-header">
                <span><i class="fas fa-plane-departure"></i> 去程 2026/02/27</span>
                <span style="color:var(--accent);">CI 278</span>
            </div>
            <div class="flight-body">
                <div class="airport">
                    <span class="code">TPE</span>
                    <span class="city">台北桃園 T2</span>
                    <span class="time" style="font-weight:700; margin-top:5px; display:block;">07:00</span>
                </div>
                <i class="fas fa-plane flight-icon"></i>
                <div class="airport">
                    <span class="code">TAK</span>
                    <span class="city">高松機場</span>
                    <span class="time" style="font-weight:700; margin-top:5px; display:block;">10:20</span>
                </div>
            </div>
            <div class="flight-footer">
                <span><i class="fas fa-suitcase"></i> 23kg / 1件</span>
                <span>Airbus A321neo</span>
            </div>
        </div>

        <div class="flight-ticket">
            <div class="flight-header">
                <span><i class="fas fa-plane-arrival"></i> 回程 2026/03/07</span>
                <span style="color:var(--accent);">CI 179</span>
            </div>
            <div class="flight-body">
                <div class="airport">
                    <span class="code">TAK</span>
                    <span class="city">高松機場</span>
                    <span class="time" style="font-weight:700; margin-top:5px; display:block;">18:55</span>
                </div>
                <i class="fas fa-plane flight-icon"></i>
                <div class="airport">
                    <span class="code">TPE</span>
                    <span class="city">台北桃園 T2</span>
                    <span class="time" style="font-weight:700; margin-top:5px; display:block;">21:05</span>
                </div>
            </div>
            <div class="flight-footer">
                <span><i class="fas fa-suitcase"></i> 23kg / 1件</span>
                <span>Airbus A321neo</span>
            </div>
        </div>

        <div class="section-title">Hotels</div>
        <div id="hotelList"></div>
    </div>

    <div id="page-money" class="page">
        <div class="card">
            <div class="card-title">新增支出</div>
            <div class="expense-input-row">
                <input type="text" id="exName" class="expense-input" placeholder="項目 (例: 晚餐)">
                <input type="number" id="exCost" class="expense-input" placeholder="金額 (¥)">
            </div>
            <p style="font-size:0.9rem; color:var(--text-sec); margin-bottom:10px;">誰先付款？</p>
            <div class="payer-grid" id="payerGrid">
                <div class="payer-chip" onclick="setPayer('L', this)">L</div>
                <div class="payer-chip" onclick="setPayer('K', this)">K</div>
                <div class="payer-chip" onclick="setPayer('R', this)">R</div>
                <div class="payer-chip" onclick="setPayer('Y', this)">Y</div>
                <div class="payer-chip" onclick="setPayer('J', this)">J</div>
            </div>
            <button class="btn" onclick="addExpense()">加入紀錄</button>
        </div>

        <div class="card">
            <div class="card-title">支出紀錄</div>
            <div id="expenseList" style="max-height: 300px; overflow-y:auto;">
                <p style="text-align:center; color:#ccc; padding:20px;">尚無紀錄</p>
            </div>
        </div>

        <div class="debt-card">
            <h3 style="margin:0 0 15px 0; font-size:1rem;">目前結算 (負數代表欠錢)</h3>
            <div id="debtList"></div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="nav('pre', this)">
            <i class="fas fa-clipboard-check"></i> 行前
        </div>
        <div class="nav-item" onclick="nav('itinerary', this)">
            <i class="fas fa-map-location-dot"></i> 行程
        </div>
        <div class="nav-item" onclick="nav('info', this)">
            <i class="fas fa-ticket"></i> 資訊
        </div>
        <div class="nav-item" onclick="nav('money', this)">
            <i class="fas fa-wallet"></i> 記帳
        </div>
    </nav>

    <div class="lightbox" id="lightbox" onclick="this.classList.remove('show')">
        <div class="lightbox-close">&times;</div>
        <img id="lbImg" src="">
    </div>

<script>
    // --- DATA ---
    const users = ['L', 'K', 'R', 'Y', 'J'];
    let curUser = 'L';
    let curPayer = null;

    const items = {
        before: ['eSIM', '外幣', 'VJW', '保險', '報到'],
        carry: ['護照', '錢包', '手機', '行動電源', '水壺', '防曬', '外套', '耳機', '眼鏡', '筆', '面紙'],
        check: ['衣物', '內衣', '睡衣', '襪子', '備用鞋', '拖鞋', '充電器', '自拍棒', '藥品', '泳衣', '指甲剪', '衣架', '雨具', '延長線', '盥洗', '購物袋', '牙刷', '香氛']
    };

    const hotels = [
        {
            name: "Second Home 瀬戸風月",
            date: "2/27 - 3/2 (3晚)",
            checkin: "16:00", checkout: "11:00",
            note: "附停車位*2，入住時提供密碼。Google 4.9星。",
            mapcode: "77 353 678*81",
            img: "https://images.unsplash.com/photo-1590073844006-33379778ae09?auto=format&fit=crop&q=80&w=600"
        },
        {
            name: "Kowakuen Haruka 古湧園 遙",
            date: "3/2 - 3/3 (1晚)",
            checkin: "15:00", checkout: "11:00",
            note: "含早餐 (+NDT$700)。位於道後溫泉旁。",
            mapcode: "",
            img: "https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?auto=format&fit=crop&q=80&w=600"
        },
        {
            name: "星野集團 OMO7 高知",
            date: "3/3 - 3/6 (3晚)",
            checkin: "15:00", checkout: "11:00",
            note: "含早餐。晚上有夜來祭表演。",
            mapcode: "",
            img: "https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&q=80&w=600"
        },
        {
            name: "御宿 敷島館",
            date: "3/6 - 3/7 (1晚)",
            checkin: "15:00", checkout: "11:00",
            note: "一泊二食！22:00有免費宵夜拉麵。有私人湯屋。",
            mapcode: "",
            img: "https://images.unsplash.com/photo-1611892440504-42a792e24d32?auto=format&fit=crop&q=80&w=600"
        }
    ];

    const timelineData = [
        { date: "2/27", week: "五", area: "高松", hIdx: 0, list: [
            { time: "10:30", title: "抵達高松機場", tag: "transport", desc: "領取華航優惠券、租車櫃台 (ETC+SEP)。", icon: "plane-arrival" },
            { time: "12:30", title: "手打烏龍麵 森家", tag: "food", desc: "必點：炸什錦烏龍麵。 (Kawata週五休改此)", map: "手打うどん もり家" },
            { time: "13:45", title: "呆呆獸公園", tag: "sight", desc: "寶可夢迷必去，有免費停車場。", map: "ひだまり公園 綾川" },
            { time: "14:30", title: "金刀比羅宮", tag: "sight", desc: "御本宮785階。17:00關門。", mapcode: "77 353 678*81", map: "金刀比羅宮" },
            { time: "18:00", title: "永旺夢樂城", tag: "shop", desc: "晚餐、藥妝、Uniqlo採買。", map: "Aeon Mall Takamatsu" }
        ]},
        { date: "2/28", week: "六", area: "小豆島", hIdx: 0, list: [
            { time: "07:20", title: "高松港出發", tag: "transport", desc: "渡輪往土庄港 (約60分)。車輛需預約。", icon: "ship" },
            { time: "09:00", title: "橄欖公園", tag: "sight", desc: "魔女宅急便掃把打卡。", map: "小豆島オリーブ公園" },
            { time: "12:00", title: "HISHIO 拉麵", tag: "food", desc: "天使之路店。必吃醬油拉麵。", map: "小豆島ラーメンHISHIO" },
            { time: "13:45", title: "天使之路", tag: "sight", desc: "⚠️ 退潮時段：13:45~19:45 可通行。", map: "Angel Road" },
            { time: "15:45", title: "返回高松", tag: "transport", desc: "搭乘呆呆獸號渡輪。", icon: "ship" },
            { time: "17:00", title: "高松城 (玉藻公園)", tag: "sight", desc: "三大水城，可餵鯛魚。", map: "玉藻公園" }
        ]},
        { date: "3/01", week: "日", area: "德島", hIdx: 0, list: [
            { time: "09:00", title: "栗林公園", tag: "sight", desc: "已預約遊船。米其林三星庭園。", mapcode: "60 576 348*55", map: "Ritsurin Garden" },
            { time: "11:30", title: "鳴門漩渦", tag: "sight", desc: "⚠️ 最佳大潮時間！請準時。", map: "鳴門渦之道" },
            { time: "12:30", title: "堂の浦 拉麵", tag: "food", desc: "必點：鯛魚鹽味拉麵 + 替飯。", map: "堂の浦 鳴門本店" },
            { time: "15:30", title: "眉山纜車", tag: "sight", desc: "阿波舞會館5樓搭乘。", mapcode: "56 361 036*63", map: "Awa Odori Kaikan" }
        ]},
        { date: "3/02", week: "一", area: "松山", hIdx: 1, list: [
            { time: "08:45", title: "長田 in 香の香", tag: "food", desc: "百名店 NO.2。必點釜揚烏龍麵。", map: "長田 in 香の香" },
            { time: "10:30", title: "丸龜城", tag: "sight", desc: "現存天守，日本第一高石垣。", map: "Marugame Castle" },
            { time: "15:00", title: "松山城", tag: "sight", desc: "搭單人吊椅上山。", map: "Matsuyama Castle" },
            { time: "18:00", title: "道後溫泉街", tag: "sight", desc: "少爺機關鐘、足湯。", map: "Dogo Onsen" }
        ]},
        { date: "3/03", week: "二", area: "高知", hIdx: 2, list: [
            { time: "10:00", title: "下灘車站", tag: "sight", desc: "神隱少女海上鐵道。", map: "Shimonada Station" },
            { time: "13:00", title: "大洲城 & 油屋", tag: "food", desc: "午餐：豚栗飯。", map: "Ozu Castle" },
            { time: "19:00", title: "弘人市場", tag: "food", desc: "必吃：明神丸炙燒鰹魚、安兵衛餃子。", map: "Hirome Market" }
        ]},
        { date: "3/04", week: "三", area: "四萬十", hIdx: 2, list: [
            { time: "10:30", title: "四萬十川", tag: "sight", desc: "佐田沉下橋、騎腳踏車、屋形船。", map: "Sada Chinkabashi" },
            { time: "18:00", title: "俺の串", tag: "food", desc: "日式串燒晚餐。", map: "俺の串" }
        ]},
        { date: "3/05", week: "四", area: "高知市", hIdx: 2, list: [
            { time: "09:00", title: "高知城", tag: "sight", desc: "追手門與天守同框。", map: "Kochi Castle" },
            { time: "11:00", title: "桂濱公園", tag: "sight", desc: "坂本龍馬像、水族館。", map: "Katsurahama" },
            { time: "14:00", title: "牧野植物園", tag: "sight", desc: "日劇《爛漫》場景。", map: "Makino Botanical Garden" },
            { time: "19:00", title: "土佐料理 司", tag: "food", desc: "百年老店，鰹魚半敲燒。", map: "Tsukasa Kochi" }
        ]},
        { date: "3/06", week: "五", area: "祖谷/琴平", hIdx: 3, list: [
            { time: "09:00", title: "大步危遊覽船", tag: "sight", desc: "欣賞峽谷奇岩。", map: "Oboke Gorge" },
            { time: "10:30", title: "GoGo Adventure", tag: "sight", desc: "森林滑索 (需預約)。", map: "Forest Adventure Iya" },
            { time: "13:00", title: "祖谷藤蔓橋", tag: "sight", desc: "三大奇橋，過橋費550円。", map: "Iya Kazurabashi" },
            { time: "16:00", title: "敷島館 Check-in", tag: "hotel", desc: "享受溫泉。", map: "Onyado Shikishima-kan" }
        ]},
        { date: "3/07", week: "六", area: "返台", hIdx: 3, list: [
            { time: "09:00", title: "高松機場", tag: "transport", desc: "還車、免稅店。", map: "Takamatsu Airport" },
            { time: "18:55", title: "CI 179 起飛", tag: "transport", desc: "帶著回憶回家。", icon: "plane-departure" }
        ]}
    ];

    // --- INITIALIZE ---
    document.addEventListener('DOMContentLoaded', () => {
        renderUserSwitch();
        renderChecklists();
        renderTimelineScroller();
        selectDay(0);
        renderHotels();
        loadExpenses();
    });

    // --- NAVIGATION ---
    function nav(page, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + page).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        window.scrollTo(0, 0);
    }

    // --- PRE-TRIP ---
    function renderUserSwitch() {
        const container = document.getElementById('userSwitch');
        container.innerHTML = users.map(u => 
            `<div class="user-btn ${u===curUser?'active':''}" onclick="switchUser('${u}')">${u}</div>`
        ).join('');
    }

    function switchUser(u) {
        curUser = u;
        renderUserSwitch();
        renderChecklists();
    }

    function renderChecklists() {
        // Load data from LocalStorage
        const data = JSON.parse(localStorage.getItem(`check_${curUser}`)) || {};
        
        ['before', 'carry', 'check'].forEach(type => {
            const container = document.getElementById(`list-${type}`);
            container.innerHTML = items[type].map(item => {
                const checked = data[item] ? 'checked' : '';
                // 根據項目選擇 icon
                let icon = 'fa-circle-check';
                if(item.includes('護照')) icon = 'fa-passport';
                if(item.includes('錢包')) icon = 'fa-wallet';
                if(item.includes('手機')) icon = 'fa-mobile-screen';
                
                return `
                <div class="check-item ${checked}" onclick="toggleCheck('${item}', this)">
                    <i class="fa-regular ${checked ? 'fa-circle-check' : 'fa-circle'}"></i>
                    <span>${item}</span>
                </div>`;
            }).join('');
        });
    }

    function toggleCheck(item, el) {
        const data = JSON.parse(localStorage.getItem(`check_${curUser}`)) || {};
        if (data[item]) {
            delete data[item];
            el.classList.remove('checked');
            el.querySelector('i').className = 'fa-regular fa-circle';
        } else {
            data[item] = true;
            el.classList.add('checked');
            el.querySelector('i').className = 'fa-regular fa-circle-check';
        }
        localStorage.setItem(`check_${curUser}`, JSON.stringify(data));
    }

    // --- ITINERARY ---
    function renderTimelineScroller() {
        const container = document.getElementById('dayScroller');
        container.innerHTML = timelineData.map((d, i) => 
            `<div class="day-chip" id="day-chip-${i}" onclick="selectDay(${i})">${d.date}</div>`
        ).join('');
    }

    function selectDay(idx) {
        document.querySelectorAll('.day-chip').forEach(c => c.classList.remove('active'));
        document.getElementById(`day-chip-${idx}`).classList.add('active');
        
        const data = timelineData[idx];
        
        // Update Weather Header
        document.getElementById('weatherCity').innerText = data.area;
        document.getElementById('stayHotel').innerText = hotels[data.hIdx].name;

        // Render List
        const list = document.getElementById('timelineList');
        list.innerHTML = data.list.map(item => {
            let iconHtml = '';
            if (item.tag === 'food') iconHtml = '<i class="fas fa-utensils"></i> ';
            if (item.tag === 'sight') iconHtml = '<i class="fas fa-camera"></i> ';
            if (item.tag === 'transport') iconHtml = '<i class="fas fa-car"></i> ';
            if (item.icon) iconHtml = `<i class="fas fa-${item.icon}"></i> `;

            const mapLink = item.map ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.map)}` : '#';
            const mapcodeBtn = item.mapcode ? 
                `<div class="mapcode-btn" onclick="copy('${item.mapcode}')">Code: ${item.mapcode} <i class="far fa-copy"></i></div>` : '';

            return `
            <div class="timeline-card">
                <div class="timeline-left">
                    <div class="time-text">${item.time}</div>
                    <div class="time-line"></div>
                </div>
                <div class="timeline-content">
                    <div class="tag tag-${item.tag}">${iconHtml}${item.tag.toUpperCase()}</div>
                    <div style="font-weight:700; font-size:1.05rem; margin-bottom:5px; display:flex; justify-content:space-between;">
                        <span>${item.title}</span>
                        ${item.map ? `<a href="${mapLink}" target="_blank" style="color:var(--accent);"><i class="fas fa-location-arrow"></i></a>` : ''}
                    </div>
                    <div style="font-size:0.9rem; color:#666; line-height:1.4;">${item.desc}</div>
                    ${mapcodeBtn}
                    <div class="detail-box">
                        <p><i class="fas fa-clock detail-icon"></i> 營業時間: 09:00 - 17:00</p>
                        <p><i class="fas fa-yen-sign detail-icon"></i> 門票: 500円</p>
                    </div>
                    ${['sight','food'].includes(item.tag) ? 
                        `<div style="text-align:center; margin-top:10px; color:#ccc;" onclick="toggleDetail(this)"><i class="fas fa-chevron-down"></i></div>` : ''}
                </div>
            </div>`;
        }).join('');
    }

    function toggleDetail(el) {
        const box = el.previousElementSibling.previousElementSibling; // mapcode is prev, then text, wait structure changed
        // Simplified: just find .detail-box in parent
        const dBox = el.parentElement.querySelector('.detail-box');
        if(dBox.style.display === 'block') {
            dBox.style.display = 'none';
            el.innerHTML = '<i class="fas fa-chevron-down"></i>';
        } else {
            dBox.style.display = 'block';
            el.innerHTML = '<i class="fas fa-chevron-up"></i>';
        }
    }

    function copy(text) {
        navigator.clipboard.writeText(text);
        alert('已複製 Mapcode: ' + text);
    }

    // --- HOTELS ---
    function renderHotels() {
        const container = document.getElementById('hotelList');
        container.innerHTML = hotels.map(h => `
        <div class="hotel-item">
            <div class="hotel-img-wrap" onclick="showImg('${h.img}')">
                <img src="${h.img}" class="hotel-img">
                <div class="hotel-overlay">
                    <div style="font-weight:700; font-size:1.1rem;">${h.name}</div>
                    <div style="font-size:0.85rem; opacity:0.9;">${h.date}</div>
                </div>
            </div>
            <div class="hotel-info">
                <div style="display:flex; justify-content:space-between; font-size:0.9rem; color:var(--text-sec);">
                    <span><i class="fas fa-sign-in-alt"></i> ${h.checkin}</span>
                    <span><i class="fas fa-sign-out-alt"></i> ${h.checkout}</span>
                </div>
                ${h.mapcode ? `<div class="mapcode-btn" onclick="copy('${h.mapcode}')">Mapcode: ${h.mapcode}</div>` : ''}
                <div class="hotel-alert">
                    <i class="fas fa-info-circle"></i>
                    <div>${h.note}</div>
                </div>
                <div style="margin-top:15px; display:flex; gap:10px;">
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.name)}" target="_blank" class="btn btn-sm">導航</a>
                </div>
            </div>
        </div>`).join('');
    }

    function showImg(src) {
        document.getElementById('lbImg').src = src;
        document.getElementById('lightbox').classList.add('show');
    }

    // --- MONEY ---
    function setPayer(p, el) {
        curPayer = p;
        document.querySelectorAll('.payer-chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    }

    let expenses = [];
    function addExpense() {
        const name = document.getElementById('exName').value;
        const cost = parseInt(document.getElementById('exCost').value);
        if(!name || !cost || !curPayer) return alert('請填寫完整');

        expenses.push({ name, cost, payer: curPayer });
        saveExpenses();
        renderExpenses();
        document.getElementById('exName').value = '';
        document.getElementById('exCost').value = '';
    }

    function renderExpenses() {
        const list = document.getElementById('expenseList');
        const debtDiv = document.getElementById('debtList');
        
        // List
        list.innerHTML = expenses.map((e, i) => `
        <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
            <div>
                <div style="font-weight:600;">${e.name}</div>
                <div style="font-size:0.8rem; color:#888;">${e.payer} 付款</div>
            </div>
            <div style="text-align:right;">
                <div style="font-weight:700; color:var(--primary);">¥${e.cost}</div>
                <div style="font-size:0.8rem; color:red; cursor:pointer;" onclick="delExp(${i})">刪除</div>
            </div>
        </div>`).join('');

        // Calc
        let bal = {L:0, K:0, R:0, Y:0, J:0};
        expenses.forEach(e => {
            const share = e.cost / 5;
            users.forEach(u => {
                if(u === e.payer) bal[u] += (e.cost - share);
                else bal[u] -= share;
            });
        });

        debtDiv.innerHTML = users.map(u => {
            const val = Math.round(bal[u]);
            let color = val >= 0 ? '#4CD964' : '#FF3B30';
            return `
            <div class="debt-row">
                <span>${u}</span>
                <span style="color:${color}; font-weight:700;">${val >= 0 ? '收' : '付'} ¥${Math.abs(val)}</span>
            </div>`;
        }).join('');
    }

    function delExp(i) {
        if(confirm('確定刪除？')) {
            expenses.splice(i, 1);
            saveExpenses();
            renderExpenses();
        }
    }

    function saveExpenses() {
        localStorage.setItem('trip_expenses', JSON.stringify(expenses));
    }

    function loadExpenses() {
        const data = localStorage.getItem('trip_expenses');
        if(data) {
            expenses = JSON.parse(data);
            renderExpenses();
        }
    }

</script>
</body>
</html>