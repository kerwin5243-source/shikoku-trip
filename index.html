<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>2026 四國巡禮</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#F2F2F7" />

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --bg-body:#F2F2F7;
      --bg-card:#FFFFFF;
      --primary:#007AFF;
      --text-main:#1C1C1E;
      --text-sec:#8E8E93;
      --divider:#E5E5EA;
      --radius-L:24px;
      --radius-M:16px;
      --radius-S:12px;
      --shadow:0 8px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      font-family:'Noto Sans TC',sans-serif;
      background:var(--bg-body);
      color:var(--text-main);
      margin:0;
      padding-bottom:110px;
      overscroll-behavior-y:none;
    }
    body.body-no-scroll{ overflow:hidden; }

    .app-header{
      padding:60px 20px 20px;
      background:var(--bg-body);
    }
    .app-header h1{ margin:0; font-size:2rem; font-weight:900; letter-spacing:-.5px; }
    .app-header p{ margin:5px 0 0; font-size:.95rem; color:var(--text-sec); font-weight:500; }

    .page{ display:none; padding:0 20px; animation:fadeIn .3s ease; }
    .page.active{ display:block; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    .card{
      background:var(--bg-card);
      border-radius:var(--radius-L);
      padding:24px;
      margin-bottom:20px;
      box-shadow:var(--shadow);
    }
    .section-title{
      font-size:1.1rem; font-weight:700; margin-bottom:15px;
      display:flex; align-items:center; gap:8px;
    }

    .btn{
      background:var(--text-main); color:#fff; border:none;
      padding:14px; border-radius:var(--radius-S);
      font-weight:600; width:100%; font-size:1rem; cursor:pointer;
      transition:transform .1s;
    }
    .btn:active{ transform:scale(.98); }
    .btn-outline{ background:transparent; border:2px solid var(--text-main); color:var(--text-main); }

    /* tabs */
    .user-tabs{
      display:flex; gap:8px; margin-bottom:20px;
      background:#E5E5EA; padding:4px; border-radius:14px;
    }
    .user-tab{
      flex:1; text-align:center; padding:10px 0; border-radius:10px;
      font-weight:600; font-size:.9rem; color:var(--text-sec);
      cursor:pointer; transition:.2s;
    }
    .user-tab.active{ background:#fff; color:var(--text-main); box-shadow:0 2px 8px rgba(0,0,0,.1); }

    /* checklist grid */
    .checklist-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .check-item{
      background:#F2F2F7; border-radius:var(--radius-S);
      padding:15px 5px; text-align:center; font-size:.85rem; font-weight:500;
      display:flex; flex-direction:column; align-items:center; gap:8px;
      cursor:pointer; border:2px solid transparent; transition:.2s;
    }
    .check-item i{ font-size:1.4rem; color:#C7C7CC; }
    .check-item.checked{ background:#E8F5E9; border-color:#34C759; color:#2E7D32; }
    .check-item.checked i{ color:#34C759; }

    /* 全員待辦（可勾選） */
    .todo-li{
      display:flex; align-items:flex-start; gap:10px;
      padding:10px 0; border-bottom:1px solid #eee;
    }
    .todo-li:last-child{ border-bottom:none; }
    .todo-li input{ width:18px; height:18px; margin-top:2px; accent-color:var(--primary); }
    .todo-title a{ color:inherit; text-decoration:none; font-weight:700; }
    .todo-title span{ font-weight:700; }
    .todo-note{ font-size:.85rem; color:var(--text-sec); margin-top:2px; }

    /* date scroller */
    .date-scroller{
      display:flex; gap:12px; overflow-x:auto; padding:10px 20px 20px;
      margin:0 -20px; scrollbar-width:none;
    }
    .date-chip{
      flex:0 0 auto; background:#fff; border-radius:20px;
      padding:12px 18px; text-align:center; min-width:92px;
      box-shadow:0 4px 10px rgba(0,0,0,.05);
      transition:.2s; cursor:pointer; border:2px solid transparent;
    }
    /* ✅ 日期大、Day小 */
    .date-chip .day{ font-size:1.15rem; font-weight:900; letter-spacing:.3px; }
    .date-chip .date{ font-size:.8rem; font-weight:800; color:var(--text-sec); margin-top:2px; }
    .date-chip.active{ border-color:var(--primary); background:#F0F8FF; }
    .date-chip.active .day{ color:var(--primary); }

    /* weather strip */
    .weather-strip{
      display:flex; gap:20px; overflow-x:auto; padding-bottom:10px; margin-bottom:20px;
      scrollbar-width:none; border-bottom:1px solid var(--divider);
    }
    .weather-hour{ text-align:center; flex:0 0 auto; }
    .w-time{ font-size:.8rem; color:var(--text-sec); margin-bottom:5px; }
    .w-icon{ font-size:1.2rem; margin-bottom:5px; }
    .w-temp{ font-weight:700; font-size:.9rem; }

    /* timeline */
    .timeline-item{ display:flex; gap:16px; margin-bottom:24px; cursor:pointer; }
    .tl-time{
      min-width:52px; font-family:'Roboto Mono', monospace;
      font-weight:600; color:var(--text-sec); text-align:right; padding-top:2px;
    }
    .tl-content{
      flex:1; background:#fff; border-radius:var(--radius-M); padding:16px;
      box-shadow:0 2px 10px rgba(0,0,0,.03);
      border:1px solid rgba(0,0,0,.02);
      transition:transform .1s;
    }
    .tl-content:active{ transform:scale(.98); background:#F9F9F9; }
    .tl-tag{
      display:inline-block; padding:4px 8px; border-radius:6px;
      font-size:.7rem; font-weight:700; margin-bottom:8px; text-transform:uppercase;
    }
    .tag-food{ background:#FFF3E0; color:#FF9500; }
    .tag-sight{ background:#E8F5E9; color:#34C759; }
    .tag-transport{ background:#E5F1FB; color:#007AFF; }
    .tag-hotel{ background:#F3E5F5; color:#9C27B0; }
    .tag-shop{ background:#E3F2FD; color:#1565C0; }

    .tl-title{ font-size:1.1rem; font-weight:700; margin-bottom:4px; }
    .tl-desc{ font-size:.9rem; color:var(--text-sec); line-height:1.4;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }

    /* modal */
    .modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.4); z-index:2000;
      opacity:0; pointer-events:none; transition:opacity .3s;
    }
    .modal-sheet{
      position:fixed; left:0; right:0; bottom:0;
      height:85vh; background:#fff; z-index:2001;
      border-radius:24px 24px 0 0;
      transform:translateY(100%);
      transition:transform .3s cubic-bezier(.16,1,.3,1);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .modal-overlay.active{ opacity:1; pointer-events:auto; }
    .modal-sheet.active{ transform:translateY(0); }

    .modal-drag-handle{
      width:40px; height:5px; background:#E5E5EA; border-radius:10px;
      margin:12px auto; flex-shrink:0;
    }
    .modal-scroll{ flex:1; overflow-y:auto; padding:0 24px 40px; -webkit-overflow-scrolling:touch; }
    .modal-img{
      width:100%; height:200px; object-fit:cover; border-radius:var(--radius-M);
      margin-bottom:20px; background:#eee;
    }
    .modal-title{ font-size:1.8rem; font-weight:900; margin:0 0 6px 0; }
    .modal-subtitle{ color:var(--text-sec); font-size:.9rem; margin-bottom:6px; }

    .pill{
      display:inline-flex; gap:6px; align-items:center;
      padding:6px 10px; border-radius:999px; background:#F2F2F7;
      font-size:.85rem; font-weight:700; color:#444; margin-right:8px; margin-bottom:10px;
    }

    .block{
      background:#F2F2F7; padding:14px; border-radius:var(--radius-M);
      margin:14px 0;
    }
    .block h4{ margin:0 0 10px; font-size:1rem; }
    .bullet{ margin:0; padding-left:18px; line-height:1.7; color:#444; }
    .menu-recommend{
      background:#FFF8E1; border:1px solid #FFECB3;
      padding:15px; border-radius:var(--radius-M); margin:14px 0;
    }
    .menu-item{ display:flex; justify-content:space-between; gap:12px; padding:6px 0; border-bottom:1px dashed #FFE082; }
    .menu-item:last-child{ border-bottom:none; }
    .jp-text{ font-weight:800; color:#5D4037; }

    /* bottom nav */
    .bottom-nav{
      position:fixed; bottom:20px; left:20px; right:20px;
      background:rgba(255,255,255,.9); backdrop-filter:blur(20px);
      border-radius:30px; display:flex; justify-content:space-around;
      padding:14px 0; box-shadow:0 10px 40px rgba(0,0,0,.1);
      z-index:1000; border:1px solid rgba(255,255,255,.5);
    }
    .nav-item{ text-align:center; color:#C7C7CC; font-size:.7rem; cursor:pointer; flex:1; transition:.2s; }
    .nav-item i{ display:block; font-size:1.4rem; margin-bottom:4px; }
    .nav-item.active{ color:var(--text-main); transform:translateY(-2px); }

    /* hotel card */
    .hotel-img-cover{ height:180px; width:100%; object-fit:cover; border-radius:var(--radius-M); margin-bottom:15px; }
    .tag-alert{
      display:inline-block; background:#FFEBEE; color:#D32F2F;
      padding:4px 8px; border-radius:6px; font-size:.8rem; font-weight:700; margin-top:8px;
    }

    /* ✅ 登機證樣式 */
    .boarding{
      background:#fff; border-radius:var(--radius-L);
      box-shadow:var(--shadow); overflow:hidden; margin-bottom:18px;
      border:1px solid rgba(0,0,0,.04);
    }
    .boarding-top{
      padding:18px 18px 14px;
      background:linear-gradient(135deg, rgba(0,122,255,.12), rgba(52,199,89,.10));
    }
    .boarding-top .row{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .boarding-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.7);
      font-weight:800; font-size:.85rem;
    }
    .boarding-mid{
      padding:14px 18px;
      display:flex; justify-content:space-between; align-items:center;
      border-top:1px dashed #E5E5EA;
    }
    .code{ font-size:2.1rem; font-weight:1000; color:var(--primary); letter-spacing:1px; }
    .t{ color:var(--text-sec); font-size:.9rem; margin-top:2px; }
    .boarding-bottom{
      padding:14px 18px;
      border-top:1px solid #F0F0F0;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color:var(--text-sec); font-size:.9rem;
    }
  </style>
</head>

<body>
  <header class="app-header">
    <h1 id="hdrTitle">2026 四國巡禮</h1>
    <p id="hdrSub">9天8夜自駕遊 • L, K, R, Y, J</p>
  </header>

  <!-- 行前 -->
  <div id="page-pre" class="page">
    <!-- ✅ 全員重要待辦（移到上面） -->
    <div class="card">
      <div class="section-title"><i class="fas fa-bullhorn"></i> 全員重要待辦</div>
      <ul id="globalTodoList" style="list-style:none; padding:0; margin:0;"></ul>
    </div>

    <div class="card">
      <div class="section-title"><i class="fas fa-clipboard-user"></i> 個人清單</div>
      <div class="user-tabs" id="userSwitch"></div>

      <h4 style="margin:10px 0 10px; color:var(--text-sec);">旅行前</h4>
      <div class="checklist-grid" id="list-pretrip"></div>

      <h4 style="margin:10px 0 10px; color:var(--text-sec);">隨身行李</h4>
      <div class="checklist-grid" id="list-carry"></div>

      <h4 style="margin:20px 0 10px; color:var(--text-sec);">託運行李</h4>
      <div class="checklist-grid" id="list-check"></div>
    </div>
  </div>

  <!-- 行程 -->
  <div id="page-itinerary" class="page active">
    <div class="date-scroller" id="dayScroller"></div>

    <div class="card" style="margin-top: 20px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div class="section-title" style="margin:0;"><i class="fas fa-cloud-sun"></i> 24H 預報</div>
        <span id="weatherLoc" style="font-size:0.9rem; color:var(--text-sec);"></span>
      </div>
      <div class="weather-strip" id="weatherStrip"></div>
      <div style="text-align:right; font-size:0.8rem; color:var(--text-sec);">
        今晚住宿：<strong id="stayHotelName" style="color:var(--text-main);"></strong>
      </div>
    </div>

    <div id="timelineList" style="padding-bottom: 20px;"></div>
  </div>

  <!-- 資訊 -->
  <div id="page-info" class="page">
    <div class="section-title"><i class="fas fa-plane-departure"></i> 航班資訊</div>
    <div id="flightBoard"></div>

    <div class="section-title" style="margin-top:8px;"><i class="fas fa-hotel"></i> 住宿資訊</div>
    <div id="hotelList"></div>
  </div>

  <!-- 記帳 -->
  <div id="page-money" class="page">
    <div class="card">
      <div class="section-title">新增支出</div>
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <input type="text" id="exName" placeholder="項目 (例: 晚餐)" style="padding:12px; border:1px solid #ddd; border-radius:12px; flex:1;">
        <input type="number" id="exCost" placeholder="金額 (¥)" style="padding:12px; border:1px solid #ddd; border-radius:12px; width:110px;">
      </div>
      <div class="user-tabs" id="payerSwitch" style="background:white; margin-bottom:15px;"></div>
      <button class="btn" onclick="addExpense()">加入紀錄 (平分)</button>
    </div>

    <div class="card">
      <div class="section-title">結算 (負數代表欠款)</div>
      <div id="debtList"></div>
    </div>

    <div class="card">
      <div class="section-title">詳細紀錄</div>
      <div id="expenseList"></div>
    </div>
  </div>

  <!-- modal -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal()"></div>
  <div class="modal-sheet" id="modalSheet">
    <div class="modal-drag-handle"></div>
    <div class="modal-scroll" id="modalContent"></div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item" onclick="nav('itinerary', this)"><i class="fas fa-map-location-dot"></i> 行程</div>
    <div class="nav-item" onclick="nav('info', this)"><i class="fas fa-passport"></i> 資訊</div>
    <div class="nav-item" onclick="nav('money', this)"><i class="fas fa-yen-sign"></i> 記帳</div>
    <div class="nav-item active" onclick="nav('pre', this)"><i class="fas fa-list-check"></i> 行前</div>
  </nav>

<script>
  // ====== Globals (JSON 驅動) ======
  let CONFIG, CHECKLISTS, TODOS, FLIGHTS, HOTELS, ITINERARY;

  let users = [];
  let curUser = 'L';
  let curPayer = 'L';

  let checklistData = { carry: [], check: [] };
  let hotels = [];
  let itinerary = [];

  // ====== Load Data ======
  async function loadAllData(){
    [CONFIG, CHECKLISTS, TODOS, FLIGHTS, HOTELS, ITINERARY] = await Promise.all([
      fetch("./data/config.json").then(r=>r.json()),
      fetch("./data/checklists.json").then(r=>r.json()),
      fetch("./data/todos.json").then(r=>r.json()),
      fetch("./data/flights.json").then(r=>r.json()),
      fetch("./data/hotels.json").then(r=>r.json()),
      fetch("./data/itinerary.json").then(r=>r.json()),
    ]);

    users = CONFIG?.members || ['L','K','R','Y','J'];
    curUser = users[0] || 'L';
    curPayer = users[0] || 'L';

    checklistData = CHECKLISTS || { carry: [], check: [] };
    hotels = HOTELS || [];
    itinerary = ITINERARY || [];

    // header
    document.getElementById('hdrTitle').innerText = CONFIG?.trip_title || '2026 四國巡禮';
    const sub = `${CONFIG?.days || 9}天${CONFIG?.nights || 8}夜${CONFIG?.mode ? CONFIG.mode : ''} • ${users.join(', ')}`;
    document.getElementById('hdrSub').innerText = sub;
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await loadAllData();
    renderGlobalTodos();
    renderUserTabs();
    renderChecklists();
    renderDateScroller();
    selectDay(0);
    renderHotels();
    renderFlights();
    renderExpenseUI();
  });

  function nav(pageId, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-'+pageId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    window.scrollTo(0,0);
  }

  // ====== 全員待辦（JSON + 勾選 + link 無藍線） ======
  function renderGlobalTodos(){
    const el = document.getElementById('globalTodoList');
    if(!el) return;

    const saved = JSON.parse(localStorage.getItem('global_todos')) || {};
    el.innerHTML = (TODOS || []).map((t, idx) => {
      const key = t.title || `todo_${idx}`;
      const checked = saved[key] ? 'checked' : '';

      const titleHTML = t.link
        ? `<div class="todo-title"><a href="${t.link}" target="_blank">${t.title}</a></div>`
        : `<div class="todo-title"><span>${t.title}</span></div>`;

      return `
        <li class="todo-li">
          <input type="checkbox" ${checked} onchange="toggleGlobalTodo('${escapeHtml(key)}')">
          <div>
            ${titleHTML}
            ${t.note ? `<div class="todo-note">${escapeHtml(t.note)}</div>` : ''}
          </div>
        </li>
      `;
    }).join('');
  }

  function toggleGlobalTodo(key){
    // key 可能含特殊字元，用 unescape 處理
    const k = unescapeHtml(key);
    const saved = JSON.parse(localStorage.getItem('global_todos')) || {};
    saved[k] = !saved[k];
    localStorage.setItem('global_todos', JSON.stringify(saved));
  }

  // ====== 個人清單 ======
  function renderUserTabs() {
    document.getElementById('userSwitch').innerHTML = users.map(u =>
      `<div class="user-tab ${u===curUser?'active':''}" onclick="switchUser('${u}')">${u}</div>`
    ).join('');
  }
  function switchUser(u) { curUser = u; renderUserTabs(); renderChecklists(); }

  function iconForItem(item){
    // 你要不同 icon，就在這裡加規則
    if(item.includes('護照')) return 'fa-passport';
    if(item.includes('手機')) return 'fa-mobile-screen';
    if(item.includes('行動電源') || item.includes('充電')) return 'fa-battery-full';
    if(item.includes('藥')) return 'fa-pills';
    if(item.includes('衣') || item.includes('內衣') || item.includes('睡衣')) return 'fa-shirt';
    if(item.includes('雨')) return 'fa-umbrella';
    if(item.includes('牙')) return 'fa-tooth';
    return 'fa-suitcase';
  }

  function renderChecklists() {
    const data = JSON.parse(localStorage.getItem('check_'+curUser)) || {};

    // ✅ 支援新類型 pretrip + 舊類型 carry/check
    ['pretrip','carry','check'].forEach(type => {
        const target = document.getElementById('list-'+type);
        if(!target) return; // 沒有該容器就跳過（保證不會報錯）

        target.innerHTML = (checklistData[type] || []).map(item => {
        const isChecked = data[item] ? 'checked' : '';
        const icon = iconForItem(item);
        return `
            <div class="check-item ${isChecked}" onclick="toggleCheck('${escapeHtml(item)}', this)">
            <i class="fas ${icon}"></i>
            <span>${escapeHtml(item)}</span>
            </div>`;
        }).join('');
    });
    }

  function toggleCheck(itemEscaped, el) {
    const item = unescapeHtml(itemEscaped);
    const data = JSON.parse(localStorage.getItem('check_'+curUser)) || {};
    if(data[item]) { delete data[item]; el.classList.remove('checked'); }
    else { data[item] = true; el.classList.add('checked'); }
    localStorage.setItem('check_'+curUser, JSON.stringify(data));
  }

  // ====== 行程 ======
  function renderDateScroller() {
    document.getElementById('dayScroller').innerHTML = itinerary.map((d, i) => {
      // ✅ 日期固定 02/27 格式（JSON 已是 02/27）
      return `
        <div class="date-chip" id="chip-${i}" onclick="selectDay(${i})">
          <div class="day">${escapeHtml(d.date || '')}</div>
          <div class="date">Day ${i+1} • ${escapeHtml(d.day || '')}</div>
        </div>
      `;
    }).join('');
  }

  function tagClass(tag){
    const t = (tag||'').toLowerCase();
    if(t==='food') return 'tag-food';
    if(t==='sight') return 'tag-sight';
    if(t==='transport') return 'tag-transport';
    if(t==='hotel') return 'tag-hotel';
    if(t==='shop') return 'tag-shop';
    return 'tag-transport';
  }

  function selectDay(idx) {
    document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
    const chip = document.getElementById('chip-'+idx);
    if(chip) chip.classList.add('active');

    const dayData = itinerary[idx];
    document.getElementById('weatherLoc').innerText = dayData?.loc || '';

    const h = hotels.find(x => x.id === dayData?.hotel_id);
    document.getElementById('stayHotelName').innerText = h ? h.name : '';

    // timeline
    document.getElementById('timelineList').innerHTML = (dayData?.items || []).map((item, i) => `
      <div class="timeline-item" onclick='openModal(${idx}, ${i})'>
        <div class="tl-time">${escapeHtml(item.time || '')}</div>
        <div class="tl-content">
          <div class="tl-tag ${tagClass(item.tag)}">${escapeHtml((item.tag||'').toUpperCase())}</div>
          <div class="tl-title">${escapeHtml(item.title || '')}</div>
          <div class="tl-desc">${escapeHtml(item.desc || '')}</div>
        </div>
      </div>
    `).join('');

    // mock weather
    let weatherHTML = '';
    for(let h=9; h<=21; h++) {
      let icon = 'fa-sun';
      if(h > 12 && h < 16) icon = 'fa-cloud-sun';
      if(h > 18) icon = 'fa-moon';
      let temp = 10 + Math.floor(Math.random()*5);
      weatherHTML += `
        <div class="weather-hour">
          <div class="w-time">${h}:00</div>
          <div class="w-icon"><i class="fas ${icon}" style="color:${icon==='fa-sun'?'#FF9500':'#8E8E93'}"></i></div>
          <div class="w-temp">${temp}°</div>
        </div>`;
    }
    document.getElementById('weatherStrip').innerHTML = weatherHTML;
  }

  // ====== Modal（導遊模式 + 防背景滑動） ======
  function openModal(dayIdx, itemIdx) {
    const item = itinerary[dayIdx]?.items?.[itemIdx];
    if(!item) return;

    const content = document.getElementById('modalContent');

    const mapcode = item.mapcode ? `<span class="pill"><i class="fas fa-location-dot"></i> Mapcode：${escapeHtml(item.mapcode)}</span>` : '';
    const hours = item.hours ? `<span class="pill"><i class="fas fa-clock"></i> ${escapeHtml(item.hours)}</span>` : '';
    const price = item.price ? `<span class="pill"><i class="fas fa-ticket"></i> ${escapeHtml(item.price)}</span>` : '';

    const guideList = (item.guide || []).length
      ? `<div class="block"><h4><i class="fas fa-headset"></i> 導遊介紹</h4><ul class="bullet">${item.guide.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul></div>`
      : '';

    const avoidList = (item.avoid || []).length
      ? `<div class="block"><h4><i class="fas fa-triangle-exclamation"></i> 避雷指南</h4><ul class="bullet">${item.avoid.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul></div>`
      : '';

    const menuBlock = (item.menu || []).length
      ? `<div class="menu-recommend">
          <div style="font-weight:800; margin-bottom:10px; color:#F57C00;"><i class="fas fa-thumbs-up"></i> 必吃菜單（中日對照）</div>
          ${(item.menu||[]).map(m=>`
            <div class="menu-item">
              <span class="jp-text">${escapeHtml(m.jp || '')}</span>
              <span style="font-size:.9rem; color:#666;">${escapeHtml(m.zh || '')}</span>
            </div>`).join('')}
        </div>`
      : '';

    const detailText = item.detail || item.desc || '';

    content.innerHTML = `
      ${item.img ? `<img src="${escapeHtml(item.img)}" class="modal-img">` : ''}
      <div class="modal-subtitle">${escapeHtml(item.time || '')} • ${(item.tag||'').toUpperCase()}</div>
      <div class="modal-title">${escapeHtml(item.title || '')}</div>

      <div style="margin:8px 0 6px;">
        ${mapcode}${hours}${price}
      </div>

      <p style="line-height:1.7; color:#444; margin:10px 0 0;">${escapeHtml(detailText)}</p>

      ${menuBlock}
      ${avoidList}
      ${guideList}

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
        <button class="btn btn-outline" onclick="copyText('${escapeHtml(item.title || '')}')">複製名稱</button>
        ${item.mapcode
          ? `<button class="btn" onclick="copyText('${escapeHtml(item.mapcode)}')">複製 Mapcode</button>`
          : `<button class="btn" onclick="openMap('${escapeHtml(item.title || '')}')">Google 導航</button>`}
      </div>
    `;

    // ✅ 防滑動衝突：開 modal 時鎖背景
    document.body.classList.add('body-no-scroll');
    document.getElementById('modalOverlay').classList.add('active');
    document.getElementById('modalSheet').classList.add('active');
  }

  function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
    document.getElementById('modalSheet').classList.remove('active');
    document.body.classList.remove('body-no-scroll');
  }

  function copyText(txt) {
    navigator.clipboard.writeText(txt);
    alert('已複製：' + txt);
  }
  function openMap(q) {
    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`);
  }

  // ====== 住宿 ======
  function renderHotels() {
    document.getElementById('hotelList').innerHTML = hotels.map(h => {
      const dateText = h.stay ? `${h.stay.from} - ${h.stay.to}` : '';
      const img = (h.images && h.images[0]) ? h.images[0]
        : "https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&q=80&w=900";

      return `
        <div class="card" style="padding:0; overflow:hidden;">
          <img src="${escapeHtml(img)}" class="hotel-img-cover">
          <div style="padding:20px;">
            <h3 style="margin:0 0 6px;">${escapeHtml(h.name || '')}</h3>
            <div style="color:var(--text-sec); font-size:0.9rem; margin-bottom:10px;">${escapeHtml(dateText)}</div>
            <div style="font-size:0.9rem; line-height:1.6; color:#444;">
              ${escapeHtml(h.desc || '')}
            </div>
            ${h.mapcode ? `<div class="tag-alert">Mapcode: ${escapeHtml(h.mapcode)}</div>` : ''}
            <button class="btn btn-outline" style="margin-top:15px;" onclick="openMap('${escapeHtml(h.name || '')}')">導航</button>
          </div>
        </div>
      `;
    }).join('');
  }

  // ====== 航班（登機證樣式） ======
  function renderFlights(){
    const el = document.getElementById('flightBoard');
    const out = FLIGHTS?.outbound;
    const inn = FLIGHTS?.inbound;

    el.innerHTML = [out, inn].filter(Boolean).map((f, idx) => {
      const isOut = idx === 0;
      const label = isOut ? `去程 ${mmdd(f.date)} (${weekdayZh(f.date)})` : `回程 ${mmdd(f.date)} (${weekdayZh(f.date)})`;
      const carrier = FLIGHTS?.carrier || '';
      const baggage = f.baggage ? `${f.baggage.checked || ''} / ${f.baggage.pieces || ''}件` : '';
      const terminal = f.from?.terminal ? `• ${f.from.terminal}` : '';

      return `
        <div class="boarding">
          <div class="boarding-top">
            <div class="row">
              <div class="boarding-badge"><i class="fas fa-plane"></i> ${escapeHtml(label)}</div>
              <div style="font-weight:800; color:#333;">${escapeHtml(f.flight_no || '')}</div>
            </div>
            <div style="margin-top:8px; color:var(--text-sec); font-weight:700;">${escapeHtml(carrier)} • ${escapeHtml(f.aircraft || '')}</div>
          </div>

          <div class="boarding-mid">
            <div style="text-align:left;">
              <div class="code">${escapeHtml(f.from?.code || '')}</div>
              <div class="t">${escapeHtml(f.from?.city || '')} • ${escapeHtml(f.depart_time || '')} ${escapeHtml(terminal)}</div>
            </div>
            <i class="fas fa-arrow-right" style="color:#C7C7CC; font-size:1.2rem;"></i>
            <div style="text-align:right;">
              <div class="code">${escapeHtml(f.to?.code || '')}</div>
              <div class="t">${escapeHtml(f.to?.city || '')} • ${escapeHtml(f.arrive_time || '')}</div>
            </div>
          </div>

          <div class="boarding-bottom">
            <div><i class="fas fa-suitcase-rolling"></i> 行李：${escapeHtml(baggage)}</div>
            <div><i class="fas fa-building"></i> 出發：${escapeHtml(f.from?.city || '')} ${escapeHtml(f.from?.terminal || '')}</div>
            <div><i class="fas fa-location-dot"></i> 抵達：${escapeHtml(f.to?.city || '')}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  // ====== 記帳 ======
  let expenses = JSON.parse(localStorage.getItem('expenses')) || [];

  function renderExpenseUI() {
    document.getElementById('payerSwitch').innerHTML = users.map(u =>
      `<div class="user-tab ${u===curPayer?'active':''}" onclick="curPayer='${u}'; renderExpenseUI();">${u}</div>`
    ).join('');

    document.getElementById('expenseList').innerHTML = expenses.map((e,i) => `
      <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #eee;">
        <div>
          <div style="font-weight:600;">${escapeHtml(e.name)}</div>
          <div style="font-size:0.8rem; color:#888;">${escapeHtml(e.payer)} 付款</div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:800;">¥${escapeHtml(String(e.cost))}</div>
          <div style="font-size:0.8rem; color:red; cursor:pointer;" onclick="delExp(${i})">刪除</div>
        </div>
      </div>
    `).join('');

    let bal = {};
    users.forEach(u => bal[u]=0);

    expenses.forEach(e => {
      let share = e.cost / users.length;
      users.forEach(u => {
        if(u===e.payer) bal[u] += (e.cost - share);
        else bal[u] -= share;
      });
    });

    document.getElementById('debtList').innerHTML = users.map(u => {
      let val = Math.round(bal[u]);
      let color = val>=0 ? '#34C759' : '#FF3B30';
      return `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;">
        <span>${escapeHtml(u)}</span>
        <span style="color:${color}; font-weight:900;">${val>=0?'收':'付'} ¥${Math.abs(val)}</span>
      </div>`;
    }).join('');
  }

  function addExpense() {
    const name = document.getElementById('exName').value.trim();
    const cost = parseInt(document.getElementById('exCost').value, 10);
    if(!name || !cost) return alert('請輸入資料');
    expenses.push({name, cost, payer:curPayer});
    localStorage.setItem('expenses', JSON.stringify(expenses));
    document.getElementById('exName').value = '';
    document.getElementById('exCost').value = '';
    renderExpenseUI();
  }

  function delExp(i) {
    if(confirm('刪除?')) {
      expenses.splice(i,1);
      localStorage.setItem('expenses', JSON.stringify(expenses));
      renderExpenseUI();
    }
  }

  // ====== utils ======
  function escapeHtml(str){
    return String(str ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function unescapeHtml(str){
    // 只處理我們 escape 的幾個
    return String(str ?? '')
      .replaceAll('&amp;','&')
      .replaceAll('&lt;','<')
      .replaceAll('&gt;','>')
      .replaceAll('&quot;','"')
      .replaceAll('&#39;',"'");
  }

  function mmdd(iso){
    // "2026-02-27" -> "02/27"
    if(!iso) return '';
    const m = String(iso).slice(5,7);
    const d = String(iso).slice(8,10);
    return `${m}/${d}`;
  }
  function weekdayZh(iso){
    if(!iso) return '';
    const dt = new Date(iso + "T00:00:00");
    const arr = ['日','一','二','三','四','五','六'];
    return arr[dt.getDay()];
  }
</script>
</body>
</html>
