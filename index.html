<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>2026 四國巡禮</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#F6F3EE" />


  <!-- ✅ Serif + Sans（標題日系感） -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Noto+Serif+TC:wght@600;700;900&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --bg-body:#F6F3EE;
      --bg-card:rgba(255,255,255,.72);
      --ink:#1E1E1E;
      --ink2:#6F6A62;
      --divider:#E9E1D6;
      --text-sec: var(--ink2);

      --primary:#2B2723;
      --accent:#B08A5B;

      --radius-L:28px;
      --radius-M:20px;
      --radius-S:14px;

      --shadow-soft:0 10px 26px rgba(0,0,0,.08);
    }
    *, *::before, *::after { box-sizing: border-box; }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      font-family:'Noto Sans TC',sans-serif;
      background:var(--bg-body);
      color:var(--ink);
      margin:0;
      padding-bottom:calc(110px + env(safe-area-inset-bottom));
      overscroll-behavior-y:none;
    }
    body.body-no-scroll{ overflow:hidden; }

    .app-header{
      padding:20px 20px 16px;
      text-align:center;
      background:linear-gradient(to bottom, rgba(246,243,238,1), rgba(246,243,238,.82));
    }

    .app-header h1{
        margin:0;
        font-family:'Noto Serif TC', serif;
        font-size:1.75rem;     /* 原本 2.2rem → 縮小 */
        font-weight:900;
        letter-spacing:.2px;
        display:flex;
        justify-content:center;
        align-items:baseline;
        gap:10px;
    }

    .year-pill{
        font-family:'Noto Sans TC',sans-serif;
        font-size:.78rem;
        font-weight:900;
        padding:4px 10px;
        border-radius:999px;
        border:1px solid rgba(176,138,91,.55);
        background:rgba(255,255,255,.65);
        color:#7D5B34;
    }

    .app-header p{
        margin:8px 0 0;
        font-size:.92rem;
        color:var(--ink2);
        font-weight:700;
        text-align:center;
    }

    .page{ display:none; padding:0 20px; animation:fadeIn .28s ease; }
    .page.active{ display:block; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    .card{
      background:var(--bg-card);
      border:1px solid rgba(233,225,214,.85);
      border-radius:var(--radius-L);
      padding:22px;
      margin-bottom:18px;
      box-shadow:var(--shadow-soft);
      backdrop-filter: blur(10px);
    }
    .section-title{
      font-size:1.05rem; font-weight:900; margin-bottom:14px;
      display:flex; align-items:center; gap:10px;
      font-family:'Noto Serif TC', serif;
    }
    .section-title i{ color:#8B8175; }

    .btn{
      background:var(--primary); color:#fff; border:none;
      padding:14px; border-radius:var(--radius-S);
      font-weight:800; width:100%; font-size:1rem; cursor:pointer;
      transition:transform .1s;
    }
    .btn:active{ transform:scale(.98); }
    .btn-outline{
      background:transparent;
      border:1.5px solid rgba(43,39,35,.35);
      color:var(--primary);
      font-weight:900;
    }

    /* tabs */
    .user-tabs{
      display:flex; gap:8px; margin-bottom:16px;
      background:rgba(233,225,214,.9); padding:4px; border-radius:14px;
    }
    .user-tab{
      flex:1; text-align:center; padding:10px 0; border-radius:10px;
      font-weight:800; font-size:.9rem; color:var(--ink2);
      cursor:pointer; transition:.2s;
    }
    .user-tab.active{
      background:#fff;
      color:var(--primary);
      box-shadow:0 6px 16px rgba(0,0,0,.10);
    }

    /* checklist */
    .checklist-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .check-item{
      background:rgba(255,255,255,.65);
      border:1px solid rgba(233,225,214,.8);
      border-radius:var(--radius-S);
      padding:14px 6px;
      text-align:center;
      font-size:.85rem;
      font-weight:700;
      display:flex; flex-direction:column; align-items:center; gap:8px;
      cursor:pointer;
      transition:.2s;
    }
    .check-item i{ font-size:1.35rem; color:#B9B2AA; }
    .check-item.checked{
      background:rgba(232,245,233,.9);
      border-color:rgba(52,199,89,.65);
      color:#2E7D32;
    }
    .check-item.checked i{ color:#34C759; }

    /* 全員待辦 */
    .todo-li{
      display:flex; align-items:flex-start; gap:10px;
      padding:10px 0; border-bottom:1px solid rgba(233,225,214,.8);
    }
    .todo-li:last-child{ border-bottom:none; }
    .todo-li input{ width:18px; height:18px; margin-top:2px; accent-color:#8C6B43; }
    .todo-title a{ color:inherit; text-decoration:none; font-weight:900; }
    .todo-title span{ font-weight:900; }
    .todo-note{ font-size:.85rem; color:var(--ink2); margin-top:4px; line-height:1.45; }


    .day-hero{
        margin:6px 0 14px;
        border-radius:24px;
        overflow:hidden;
        border:1px solid rgba(233,225,214,.9);
        box-shadow:0 10px 26px rgba(0,0,0,.08);
        background:rgba(255,255,255,.6);
    }

    .hero-track{
        display:flex;
        overflow-x:auto;
        scroll-snap-type:x mandatory;
        scrollbar-width:none;
    }
    .hero-track::-webkit-scrollbar{ display:none; }

    .hero-slide{
        flex:0 0 100%;
        height:170px;
        scroll-snap-align:start;
        position:relative;
    }
    .hero-slide img{
        width:100%;
        height:100%;
        object-fit:cover;
        display:block;
    }

    .hero-dots{
        position:absolute;
        left:0; right:0; bottom:10px;
        display:flex;
        justify-content:center;
        gap:6px;
    }
    .hero-dot{
        width:6px; height:6px;
        border-radius:50%;
        background:rgba(255,255,255,.6);
    }
    .hero-dot.active{ background:rgba(255,255,255,.95); }

    .hero-overlay{
        position:absolute;
        left:12px;
        bottom:14px;
        display:flex;
        flex-direction:column;
        gap:8px;
        max-width:75%;
    }

    .hero-loc{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:8px 10px;
        border-radius:999px;
        background:rgba(0,0,0,.28);
        color:#fff;
        font-weight:900;
        font-size:.85rem;
        backdrop-filter: blur(8px);
    }

    .hero-caption{
        padding:10px 12px;
        border-radius:16px;
        background:rgba(0,0,0,.20);
        color:rgba(255,255,255,.92);
        font-weight:700;
        font-size:.88rem;
        line-height:1.35;
        backdrop-filter: blur(8px);
    }



    /* date chip 是最上面日期 星期 Day */
    .date-chip{
      flex:0 0 auto;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(233,225,214,.9);
      border-radius:16px;
      padding:8px 8px;
      text-align:center;
      min-width:45px;
      box-shadow:0 10px 24px rgba(0,0,0,.08);
      transition:.2s;
      cursor:pointer;
    }
    .date-chip .day{
      font-family:'Roboto Mono', monospace; 
      font-size:.90rem;
      font-weight:900;
      letter-spacing:.02px;
      line-height:1.05;
    }
    .date-chip .date{
      font-size:.60rem;
      font-weight:900;
      color:var(--ink2);
      margin-top:2px;
      line-height:1.05;
    }
    .date-chip .wk{
        margin-top:2px;
        font-family:'Roboto Mono', monospace;
        font-size:.50rem;        /* 星期更小 */
        font-weight:900;
        color:rgba(43,39,35,.45);
        letter-spacing:.14em;
        text-transform:uppercase;
        line-height:1.05;
    }
    .date-chip.active{
      background:#fff;
      border-color:rgba(150, 104, 49, 0.55);
      box-shadow:0 14px 30px rgba(0,0,0,.10);
    }
    .date-chip.active .day{ color:#724b1d; }

        /* date scroller */
    .date-scroller{
      display:flex; gap:8px; overflow-x:auto; padding:4px 16px 8px;
      margin:0 -20px; scrollbar-width:none;
    }
    .date-scroller::-webkit-scrollbar{ display:none; }

    /* weather */
    .weather-strip{
      display:flex; gap:20px; overflow-x:auto;
      padding-bottom:10px; margin-bottom:14px;
      scrollbar-width:none;
      border-bottom:1px solid var(--divider);
    }
    .weather-strip::-webkit-scrollbar{ display:none; }
    .weather-hour{ text-align:center; flex:0 0 auto; }
    .w-time{ font-size:.8rem; color:var(--ink2); margin-bottom:5px; font-weight:800; }
    .w-icon{ font-size:1.15rem; margin-bottom:5px; color:#8B8175; }
    .w-temp{ font-weight:900; font-size:.9rem; color:var(--primary); }



    /* ✅ 讓每一列：左時間、右內容 固定對齊 */
    .timeline-item{
        display:grid;
        grid-template-columns: 64px 1fr;
        column-gap:12px;
        align-items:start;
        margin-bottom:18px; 
        cursor:pointer; 
    }
    .tl-time{
      min-width:56px;
      font-family:'Roboto Mono', monospace;
      font-weight:700;
      color:var(--ink2);
      text-align:right;
      padding-top:6px;
      font-size:1rem;
    }
    


    .tl-content{
      flex:1;
      min-width:0;
      background:rgba(255,255,255,.78);
      border:1px solid rgba(233,225,214,.9);
      border-radius:var(--radius-M);
      padding:12px 16px 14px;
      box-shadow:0 14px 30px rgba(0,0,0,.07);
      transition:transform .12s ease;
    }
    .tl-content:active{ transform:scale(.985); }

    .tl-tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      font-size:.55rem;
      font-weight:900;
      letter-spacing:.12em;
      margin-bottom:6px;
      margin-top:-8px;   /* ✅ 往上貼近卡片上緣 */
      line-height:1;     /* ✅ 讓高度更緊 */
      text-transform:uppercase;
      color:#a5a39f;
    }
    .tl-tag::before{
      content:'';
      width:8px; height:8px;
      border-radius:50%;
      display:inline-block;
      background:#B9B2AA;
    }
    .tag-food::before{ background:#D28A3A; }
    .tag-sight::before{ background:#2F8F5B; }
    .tag-transport::before{ background:#3D6EA9; }
    .tag-hotel::before{ background:#7A4FA8; }
    .tag-shop::before{ background:#e1c820; }

    .tl-title{
      font-family:'Noto Serif TC', serif;
      font-size:1.1rem;
      font-weight:900;
      margin-bottom:6px;
      line-height:1.15;
      letter-spacing:.2px;
    }
    .tl-desc{
      font-size:.92rem;
      color:var(--ink2);
      line-height:1.5;
      display:-webkit-box;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    /* ✅ 小行程：灰底的「預計停留/車程」膠囊 */
    .tl-meta{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }
    .tl-chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:#F2F2F7;
      color:#555;
      font-size:.85rem;
      font-weight:800;
    }
    .tl-chip i{ color:#8E8E93; }


    /* ===== Modal: bottom sheet ===== */
    .modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.38);
      z-index:2000;
      opacity:0; pointer-events:none;
      transition:opacity .2s ease;
    }

    /* 點開小程式懸浮的 */
    .modal-sheet{
      position:fixed;
      left:50%;
      background:#FAF7F2;     /* ✅ 一定要有 */
      box-shadow:0 18px 70px rgba(0,0,0,.22); /* ✅ 讓它像真的浮起來 */
      bottom:max(14px, env(safe-area-inset-bottom));
      transform:translateX(-50%) translateY(120%);
      width:min(760px, calc(100vw - 24px));

      /* ✅ 用 dvh 比 vh 穩（手機網址列縮放不亂跳） */
      max-height:calc(100dvh - 24px - env(safe-area-inset-top));
      background:#FAF7F2;
      z-index:2001;
      border-radius:28px;
      border:1px solid rgba(233,225,214,.95);
      box-shadow:0 22px 60px rgba(0,0,0,.18);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      transition:transform .18s cubic-bezier(.16,1,.3,1);
    }

    .modal-sheet.active{ transform:translateX(-50%) translateY(0); }

    /* ✅ Header 不滾動，永遠在上方 */
    .modal-header{
      position:relative;
      flex:0 0 auto;
      padding:4px 0 2px;
      background:#FAF7F2;
      border-bottom:1px solid rgba(233,225,214,.75);
    }

    /* 拖曳條保持置中 */
    .modal-drag-handle{
      width:44px; height:5px;
      background:#D8CFC4;
      border-radius:99px;
      margin:8px auto 6px;
      flex-shrink:0;
    }

    /* ✅ X 永遠可見（在 header 內） */
    .modal-x{
      position:absolute;
      right:12px;
      top:8px;
      width:36px; height:36px;
      border-radius:50%;
      border:1px solid rgba(233,225,214,.95);
      background:#fff;
      font-size:20px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      z-index:10;
    }

    /* 內容滾動只在這裡發生 */
    .modal-scroll{
      flex:1;
      overflow-y:auto;
      padding:0 18px 16px;
      background:#FAF7F2;           /* ✅ 防止透出看到背後 */
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
    }



    /* sticky 區塊固定在 點開小行程內容滾動區頂端 */
    #modalSticky{
        position: sticky;
        top: 0;
        z-index: 30;
        background:#FAF7F2;
        margin:0 -18px;               /* ✅ 抵消左右 padding，貼齊邊 */
        padding:10px 18px 8px;       /* ✅ 把原本的上方空間放回這裡 */
        border-bottom: 1px solid rgba(233,225,214,.75);
        box-shadow:0 6px 18px rgba(0,0,0,.06); /* 「浮在上面」，可以再加一點淡陰影*/
    }

    /* 左邊彩色直槓（用 tag 類別控制顏色） */
    .modal-sticky-wrap{
        position: relative;
        padding-left: 14px;
    }
    .modal-sticky-wrap::before{
        content:'';
        position:absolute;
        left:-18px;
        top:6px;
        bottom:6px;
        width:4px;
        border-radius:0 999px 999px 0;
        background:#B9B2AA; /* default */
    }
    .modal-sticky-wrap.tag-food::before{ background:#D28A3A; }
    .modal-sticky-wrap.tag-sight::before{ background:#2F8F5B; }
    .modal-sticky-wrap.tag-transport::before{ background:#3D6EA9; }
    .modal-sticky-wrap.tag-hotel::before{ background:#7A4FA8; }
    .modal-sticky-wrap.tag-shop::before{ background:#e1c820; }


    .sheet-head{
      display:flex;
      align-items:center;
      gap:10px; 
      /* padding:6px 2px 10px; */
    }
    /* === Modal tag：水印感（不加框）=== */
    .sheet-tag{
        display:inline-flex;
        align-items:center;
        gap:6px;

        /* 拿掉框框感 */
        padding:0;
        border:none;
        background:transparent;

        font-size:.62rem;
        font-weight:900;
        letter-spacing:.14em;
        text-transform:uppercase;
        color:#A5A39F;
        line-height:1;
    }

    .sheet-tag::before{
        content:"";
        width:8px; height:8px;
        border-radius:50%;
        background:#B9B2AA;
        display:inline-block;
    }

    /* 直接沿用你原本的 tag 顏色點 */
    .sheet-tag.tag-food::before{ background:#D28A3A; }
    .sheet-tag.tag-sight::before{ background:#2F8F5B; }
    .sheet-tag.tag-transport::before{ background:#3D6EA9; }
    .sheet-tag.tag-hotel::before{ background:#7A4FA8; }
    .sheet-tag.tag-shop::before{ background:#2A6FA0; }

    /* ✅ 只縮 modal 內的 tag（不影響外面列表） */
    .sheet-head .tl-tag{
        padding:4px 8px;
        margin:0;                 /* ✅ 取消原本 margin-bottom:10px */
        font-size:.52rem;
        letter-spacing:.10em;
        border-radius:999px;
    }
    .sheet-time{
      font-family:'Noto Serif TC', serif;
      font-size:.86rem;
      font-weight:900;
      color:#2B2723;
    }
    /* FOOD 外框 */
    .tag-chip{
        padding:4px 8px;
        border-radius:999px;
        border:1px solid rgba(233,225,214,.9);
        background:rgba(255,255,255,.55);
    }
.tag-chip.tag-food{ border-color:rgba(210,138,58,.55); }
.tag-chip.tag-sight{ border-color:rgba(47,143,91,.55); }
.tag-chip.tag-transport{ border-color:rgba(61,110,169,.55); }
.tag-chip.tag-hotel{ border-color:rgba(122,79,168,.55); }
.tag-chip.tag-shop{ border-color:rgba(225,200,32,.55); }

    .modal-title{
      font-family:'Noto Serif TC', serif;
      font-size:1.20rem;
      font-weight:900;
      line-height:1.18;
      margin:0 0 10px 0;
      letter-spacing:.2px;
    }

    /* 地址/停車場/Mapcode */
    .meta-box{
      border-top:1px solid var(--divider);
      border-bottom:1px solid var(--divider);
      padding:7px 0;
      margin:8px 0 10px;
      gap:10px;               /* 左右間距縮 */
      color:var(--ink2);
    }
    .meta-row{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:6px 0;
      font-size:.90rem;
      line-height:1.35;
    }
    .meta-ico{ 
        width:auto; 
        text-align:center; 
        flex:0 0 auto; 
        padding-top:0px;
        font-size:1.05rem;      /* icon 稍微小 */
    }
    .meta-val{
        font-size:.92rem;       /* ✅ 字小一點 */
        line-height:1.25;
        color:#6f6a62;
        min-width:0;              /* ✅ 允許正常換行，不把按鈕擠掉 */
        word-break:break-word;
    }

    .mini-btn{
      margin-left:auto;
      align-self:flex-start;  /* ✅ 讓它貼齊第一行 */
      border:1px solid rgba(233,225,214,.95);
      justify-self:end;
      background:#fff;
      border-radius:10px;
      padding:5px 9px;
      font-size:.78rem;         /* ✅ 更小 */
      cursor:pointer;
      font-weight:900;
      color:#5F5A52;
      flex:0 0 auto;
    }


    .detail{
      font-size:1rem;
      color:#3A352E;
      line-height:1.7;
      white-space:pre-wrap;
    }

    .pill-row{ 
        margin:6px 0 2px; 
        display:flex; 
        flex-wrap:wrap; 
        gap:6px; 
    }
    .pill{
      display:inline-flex;
      gap:6px; align-items:center;
      padding:5px 8px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(233,225,214,.95);
      font-size:.78rem;
      font-weight:900;
      color:#5F5A52;
    }
    .pill i{ color:#8B8175; font-size:.85em;}

    .block{
      background:rgba(255,255,255,.72);
      border:1px solid rgba(233,225,214,.85);
      padding:14px;
      border-radius:var(--radius-M);
      margin:12px 0;
    }
    .block h4{
      margin:0 0 10px;
      font-size:1rem;
      font-weight:900;
      color:#2B2723;
      font-family:'Noto Serif TC', serif;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .bullet{ margin:0; padding-left:18px; line-height:1.7; color:#444; }

    .menu-recommend{
      background:#FFF8E1;
      border:1px solid #FFECB3;
      padding:15px;
      border-radius:var(--radius-M);
      margin:12px 0;
    }
    .menu-item{
      display:flex; justify-content:space-between; gap:12px;
      padding:6px 0;
      border-bottom:1px dashed #FFE082;
    }
    .menu-item:last-child{ border-bottom:none; }
    .jp-text{ font-weight:900; color:#5D4037; }

    .sheet-actions{
      position:sticky;
      bottom:0;
      padding:10px 0 2px;
      background:linear-gradient(to top, #FAF7F2 70%, rgba(250,247,242,0));
    }
    .btn-primary{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      width:100%;
      height:50px;
      border-radius:16px;
      border:1px solid rgba(176,138,91,.55);
      background:#fff;
      font-weight:900;
      text-decoration:none;
      color:#2B2723;
    }

    /* bottom nav */
    .bottom-nav{
      position:fixed; 
      bottom: calc(10px + env(safe-area-inset-bottom));
      left:20px; right:20px;
      background:rgba(255,255,255,.72);
      backdrop-filter:blur(20px);
      border-radius:24px;
      display:flex;
      justify-content:space-around;
      padding:10px 0;
      box-shadow:0 16px 50px rgba(0,0,0,.12);
      z-index:1000;
      border:1px solid rgba(233,225,214,.9);
    }
    .nav-item{ text-align:center; color:#B9B2AA; font-size:.66rem; cursor:pointer; flex:1; transition:.2s; }
    .nav-item i{ display:block; font-size:1.18rem; margin-bottom:2px; }
    .nav-item.active{ color:#2B2723; transform:translateY(-1px); }

    /* boarding */
    .boarding{
      background:rgba(255,255,255,.76);
      border-radius:var(--radius-L);
      box-shadow:var(--shadow-soft);
      overflow:hidden; margin-bottom:18px;
      border:1px solid rgba(233,225,214,.9);
      backdrop-filter: blur(10px);
    }
    .boarding-top{
      padding:18px 18px 14px;
      background:linear-gradient(135deg, rgba(176,138,91,.16), rgba(43,39,35,.06));
    }
    .boarding-top .row{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .boarding-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,.75);
      font-weight:900; font-size:.85rem;
      border:1px solid rgba(233,225,214,.9);
    }
    .boarding-mid{
      padding:14px 18px;
      display:flex; justify-content:space-between; align-items:center;
      border-top:1px dashed rgba(233,225,214,.95);
    }
    .code{
      font-family:'Noto Serif TC', serif;
      font-size:2.0rem;
      font-weight:900;
      color:#7D5B34;
      letter-spacing:1px;
    }
    .t{ color:var(--ink2); font-size:.9rem; margin-top:2px; font-weight:800; }
    .boarding-bottom{
      padding:14px 18px;
      border-top:1px solid rgba(233,225,214,.7);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color:var(--ink2); font-size:.9rem;
      font-weight:800;
    }
    .wx-head{
        display:flex;
        justify-content:space-between;
        align-items:baseline;
        margin-bottom:14px;
    }

    .wx-city{
        font-family:'Noto Serif TC', serif;
        font-size:1.25rem;
        font-weight:900;
        color:var(--primary);
    }

    .wx-label{
        font-size:.82rem;
        font-weight:900;
        color:var(--ink2);
        display:flex;
        align-items:center;
        gap:8px;
    }

    .link-grid{
        display:grid;
        grid-template-columns:1fr 1fr;
        gap:10px;
        margin-top:10px;
    }



    /* ===== Route strip (for drive/walk/train/flight/boat) ===== */
    .route-strip{
        display:flex;
        gap:14px;
        align-items:center;
        padding:10px 12px;        /* 更細長 */
        border-radius:16px;
        background:#F2F2F7;
        border:1px solid rgba(0,0,0,.04);
        box-shadow:0 6px 18px rgba(0,0,0,.06);
        width:100%;               /* ✅ 撐滿 */
        margin:0;                 /* ✅ 不要自己縮排 */
    }
    /* 想讓整張更「細長」一點就把 padding 降低 */

    .route-mins{
        flex:0 0 auto;
        font-family:'Roboto Mono', monospace;
        font-size:.65rem;         /* ✅ 縮小 */
        font-weight:900;
        color:#444;
        background:rgba(255,255,255,0.7);
        border-radius:999px;
        padding:5px 8px;
        white-space:nowrap;
    }

    /* 讓 route strip 內容左右分佈更漂亮 */
    .route-main{
        flex: 1;
        min-width: 0;
    }

        /* icon 尺寸（可微調） */
    .route-ico{
        width:38px;
        height:38px;
        border-radius:14px;
        display:flex;
        align-items:center;
        justify-content:center;
        background:rgba(255,255,255,0.55);
        flex:0 0 auto;
    }
    .route-ico i{ font-size:16px; color:var(--primary); }


    .route-title{
      font-weight:900;
      font-size:1.02rem;
      letter-spacing:-.2px;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .route-sub{
      margin-top:4px;
      color:var(--text-sec);
      font-weight:700;
      font-size:.9rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .routeRow{
        display:flex;
        align-items:center;
        gap:12px;
        padding:10px 12px;
        border-radius:14px;
        max-width:100%;
        width:100%;
        overflow:hidden;            /* 防止內部東西撐破 */
    }

    .routeIcon{
        flex:0 0 36px;
        width:36px; height:36px;
        border-radius:12px;
        display:flex; align-items:center; justify-content:center;
    }

    .routeMain{
        flex:1 1 auto;
        min-width:0;                /* ✅ 超重要：允許中間欄位縮 */
    }

    .routeTitle{
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;     /* ✅ 長地名不撐破 */
    }

    .routeDuration{
        flex:0 0 auto;
        margin-left:auto;           /* ✅ 推到最右 */
        white-space:nowrap;
        padding:6px 10px;
        border-radius:999px;
    }



    /* duration / stay pill */
    .stay-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top:12px;
      background:#ECECF0;
      color:#333;
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:.60rem;
    }
    .stay-pill i{ color:#8E8E93; }




    /* 建議加保險：砍掉水平 overflow */
    html, body{ overflow-x:hidden; }
    /* ✅ route 直接吃滿整個容器寬度 */
    .timeline-item.route-item{
        display:block;         /* route 不用兩欄 grid */
        cursor: pointer;
        margin-bottom:18px;
    }

    /* route 卡片本體 */
    .route-item .route-strip{
        width:100%;
        max-width:100%;
        display:flex;
        align-items:center;
        gap:12px;
        padding:12px 16px;
        border-radius:16px;
        background:#EEF2FF;
        overflow:hidden;
    }
    /* 左側：小時間 + icon
    .route-left{
        flex:0 0 auto;
        display:flex;
        flex-direction:column;
        align-items:center;
        gap:6px;
    }

    .route-time-mini{
        font-size:12px;
        font-weight:800;
        color:#6B7280;
        line-height:1;
    } */



    /* 中間標題：可縮 + ... */
    .route-main{ flex:1 1 auto; min-width:0; }
    /* 文字區：上面時間，下面標題 */
    .route-time-top{
        font-size:12px;
        font-weight:800;
        color:#6B7280;
        line-height:1.1;
        margin-bottom:4px;
    }





    /* ===== Mobile layout guard ===== */
    .page, .app-header{
      max-width: 520px;
      margin-left:auto;
      margin-right:auto;
    }

    .bottom-nav{
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
    }

    /* 右側：時間 + 導航按鈕（把 15min 移到這裡） */
    .route-cta{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      justify-content:center;
      gap:10px;
      flex:0 0 auto;
    }

    .route-time{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#ECECF0;
      font-weight:900;
      color:#333;
      white-space:nowrap;
    }

    .route-time i{ color:#8E8E93; }


  </style>
</head>

<body>
  <header class="app-header">
    <h1 id="hdrTitle"></h1>
    <p id="hdrSub"></p>
  </header>

  <!-- 行前 -->
  <div id="page-pre" class="page">
    <div class="card">
      <div class="section-title"><i class="fas fa-bullhorn"></i> 全員重要待辦</div>
      <ul id="globalTodoList" style="list-style:none; padding:0; margin:0;"></ul>
    </div>

    <div class="card">
      <div class="section-title"><i class="fas fa-clipboard-user"></i> 個人清單</div>
      <div class="user-tabs" id="userSwitch"></div>

      <h4 style="margin:10px 0 10px; color:var(--ink2); font-weight:900;">旅行前</h4>
      <div class="checklist-grid" id="list-pretrip"></div>

      <h4 style="margin:10px 0 10px; color:var(--ink2); font-weight:900;">隨身行李</h4>
      <div class="checklist-grid" id="list-carry"></div>

      <h4 style="margin:20px 0 10px; color:var(--ink2); font-weight:900;">託運行李</h4>
      <div class="checklist-grid" id="list-check"></div>
    </div>
  </div>

  <!-- 行程 -->
  <div id="page-itinerary" class="page active">
    <div class="date-scroller" id="dayScroller"></div>
      <!-- ✅ Day photos slideshow（獨立 block，放在天氣預報上方） -->
    <div id="dayHero" class="day-hero"></div>

    <div class="card" style="margin-top: 18px;">
      <div class="wx-head">
        <div id="weatherLoc" class="wx-city"></div>
        <div class="wx-label"><i class="fas fa-cloud-sun"></i> 24H 預報</div>
      </div>
      <div class="weather-strip" id="weatherStrip"></div>
      <div style="text-align:right; font-size:0.86rem; color:var(--ink2); font-weight:800;">
        今晚住宿：<strong id="stayHotelName" style="color:var(--primary);"></strong>
      </div>
    </div>

    <div id="timelineList" style="padding-bottom: 20px;"></div>
  </div>

  <!-- 資訊 -->
  <div id="page-info" class="page">
    <div class="section-title"><i class="fas fa-plane-departure"></i> 航班資訊</div>
    <div id="flightBoard"></div>

    <div class="section-title" style="margin-top:8px;"><i class="fas fa-hotel"></i> 住宿資訊</div>
    <div id="hotelList"></div>
  </div>

  <!-- 記帳 -->
  <div id="page-money" class="page">
    <div class="card">
      <div class="section-title">新增支出</div>
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <input type="text" id="exName" placeholder="項目 (例: 晚餐)" style="padding:12px; border:1px solid rgba(233,225,214,.9); border-radius:14px; flex:1; background:rgba(255,255,255,.8);">
        <input type="number" id="exCost" placeholder="金額 (¥)" style="padding:12px; border:1px solid rgba(233,225,214,.9); border-radius:14px; width:110px; background:rgba(255,255,255,.8);">
      </div>
      <div class="user-tabs" id="payerSwitch" style="background:rgba(233,225,214,.9); margin-bottom:15px;"></div>
      <button class="btn" onclick="addExpense()">加入紀錄 (平分)</button>
    </div>

    <div class="card">
      <div class="section-title">結算 (負數代表欠款)</div>
      <div id="debtList"></div>
    </div>

    <div class="card">
      <div class="section-title">詳細紀錄</div>
      <div id="expenseList"></div>
    </div>
  </div>

  <!-- modal -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal()"></div>
  <div class="modal-sheet" id="modalSheet" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div class="modal-drag-handle"></div>
      <button class="modal-x" onclick="closeModal()" aria-label="close">×</button>
    </div>
    <div class="modal-scroll">
        <div id="modalSticky"></div>
        <div id="modalBody"></div>
    </div>
  </div>


  <nav class="bottom-nav">
    <div class="nav-item active" onclick="nav('itinerary', this)"><i class="fas fa-map-location-dot"></i> 行程</div>
    <div class="nav-item" onclick="nav('info', this)"><i class="fas fa-passport"></i> 資訊</div>
    <div class="nav-item" onclick="nav('money', this)"><i class="fas fa-yen-sign"></i> 記帳</div>
    <div class="nav-item" onclick="nav('pre', this)"><i class="fas fa-list-check"></i> 行前</div>
  </nav>

<script>
  // ====== Globals (JSON 驅動) ======
  let CONFIG, CHECKLISTS, TODOS, FLIGHTS, HOTELS, ITINERARY;

  let users = [];
  let curUser = 'L';
  let curPayer = 'L';

  let checklistData = { carry: [], check: [] };
  let hotels = [];
  let itineraryIndex = [];
  let dayCache = {};
  let currentDayData = null;
  let currentDayIdx = 0;
  let __heroTimer = null;

  // ====== Load Data ======
  async function loadAllData(){ 
    [CONFIG, CHECKLISTS, TODOS, FLIGHTS, HOTELS, ITINERARY] = await Promise.all([
      fetch("./data/config.json").then(r=>r.json()),
      fetch("./data/checklists.json").then(r=>r.json()),
      fetch("./data/todos.json").then(r=>r.json()),
      fetch("./data/flights.json").then(r=>r.json()),
      fetch("./data/hotels.json").then(r=>r.json()),
      fetch("./data/itinerary.index.json").then(r=>r.json()),
    ]);

    users = CONFIG?.members || ['L','K','R','Y','J'];
    curUser = users[0] || 'L';
    curPayer = users[0] || 'L';

    checklistData = CHECKLISTS || { carry: [], check: [] };
    hotels = HOTELS || [];
    itineraryIndex = ITINERARY || [];

    const title = (CONFIG?.trip_title || '四國巡禮').replace(/^2026\s*/,'');
    document.getElementById('hdrTitle').innerHTML = `${escapeHtml(title)}<span class="year-pill">2026</span>`;

    // 2) subtitle 不顯示 L,K,R,Y,J
    const sub = `${CONFIG?.days || 9}天${CONFIG?.nights || 8}夜${CONFIG?.mode ? CONFIG.mode : ''}`;
    document.getElementById('hdrSub').innerText = sub;
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await loadAllData();
    renderGlobalTodos();
    renderUserTabs();
    renderChecklists();
    renderDateScroller();
    await selectDay(0);
    renderHotels();
    renderFlights();
    renderExpenseUI();
  });

  document.getElementById('modalSheet')?.addEventListener(
    'touchmove',
    (e) => e.stopPropagation(),
    { passive: true }
  );


  document.getElementById('modalOverlay')?.addEventListener(
    'touchmove',
    (e) => e.preventDefault(),
    { passive: false }
  );
  document.getElementById('timelineList').addEventListener('click', (e) => {
    const el = e.target.closest('.route-click');
    if(!el) return;

    const from = decodeURIComponent(el.dataset.from || '');
    const to   = decodeURIComponent(el.dataset.to || '');
    const mode = decodeURIComponent(el.dataset.mode || 'drive');

    openDirections(from, to, mode);
   });



  function nav(pageId, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-'+pageId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    window.scrollTo(0,0);
  }

  // ====== 全員待辦 ======
  function renderGlobalTodos(){
    const el = document.getElementById('globalTodoList');
    if(!el) return;

    const saved = JSON.parse(localStorage.getItem('global_todos')) || {};
    el.innerHTML = (TODOS || []).map((t, idx) => {
      const key = t.title || `todo_${idx}`;
      const checked = saved[key] ? 'checked' : '';

      const titleHTML = t.link
        ? `<div class="todo-title"><a href="${t.link}" target="_blank" rel="noopener">${escapeHtml(t.title)}</a></div>`
        : `<div class="todo-title"><span>${escapeHtml(t.title)}</span></div>`;

      return `
        <li class="todo-li">
          <input type="checkbox" ${checked} onchange="toggleGlobalTodo('${escapeHtml(key)}')">
          <div>
            ${titleHTML}
            ${t.note ? `<div class="todo-note">${escapeHtml(t.note)}</div>` : ''}
          </div>
        </li>
      `;
    }).join('');
  }

  function toggleGlobalTodo(key){
    const k = unescapeHtml(key);
    const saved = JSON.parse(localStorage.getItem('global_todos')) || {};
    saved[k] = !saved[k];
    localStorage.setItem('global_todos', JSON.stringify(saved));
  }
  function formatDuration(mins){
    const m = Number(mins);
    if(!Number.isFinite(m) || m <= 0) return '';
    const h = Math.floor(m / 60);
    const r = m % 60;
    if(h <= 0) return `${m} min`;
    if(r === 0) return `${h} hr`;
    return `${h} hr ${r} min`;
  }


  // ====== 個人清單 ======
  function renderUserTabs() {
    document.getElementById('userSwitch').innerHTML = users.map(u =>
      `<div class="user-tab ${u===curUser?'active':''}" onclick="switchUser('${u}')">${u}</div>`
    ).join('');
  }
  function switchUser(u) { curUser = u; renderUserTabs(); renderChecklists(); }

  function iconForItem(item){
    if(item.includes('護照')) return 'fa-passport';
    if(item.includes('手機')) return 'fa-mobile-screen';
    if(item.includes('行動電源') || item.includes('充電')) return 'fa-battery-full';
    if(item.includes('藥')) return 'fa-pills';
    if(item.includes('衣') || item.includes('內衣') || item.includes('睡衣')) return 'fa-shirt';
    if(item.includes('雨')) return 'fa-umbrella';
    if(item.includes('牙')) return 'fa-tooth';
    return 'fa-suitcase';
  }

  function renderChecklists() {
    const data = JSON.parse(localStorage.getItem('check_'+curUser)) || {};

    ['pretrip','carry','check'].forEach(type => {
      const target = document.getElementById('list-'+type);
      if(!target) return;

      target.innerHTML = (checklistData[type] || []).map(item => {
        const isChecked = data[item] ? 'checked' : '';
        const icon = iconForItem(item);
        return `
          <div class="check-item ${isChecked}" onclick="toggleCheck('${escapeHtml(item)}', this)">
            <i class="fas ${icon}"></i>
            <span>${escapeHtml(item)}</span>
          </div>`;
      }).join('');
    });
  }

  function toggleCheck(itemEscaped, el) {
    const item = unescapeHtml(itemEscaped);
    const data = JSON.parse(localStorage.getItem('check_'+curUser)) || {};
    if(data[item]) { delete data[item]; el.classList.remove('checked'); }
    else { data[item] = true; el.classList.add('checked'); }
    localStorage.setItem('check_'+curUser, JSON.stringify(data));
  }

  // ====== 行程 ======
  function renderDateScroller() {
    document.getElementById('dayScroller').innerHTML = itineraryIndex.map((d, i) => `
      <div class="date-chip" id="chip-${i}" onclick="selectDay(${i})">
        <div class="day">${escapeHtml(d.date || '')}</div>
        <div class="wk">${escapeHtml(d.day || '')}</div>
        <div class="date">Day ${i+1}</div>
      </div>
    `).join('');
  }

  function tagClass(tag){
        const t = (tag||'').toLowerCase();
        if(t==='food') return 'tag-food';
        if(t==='sight') return 'tag-sight';
        if(t==='transport') return 'tag-transport';
        if(t==='hotel') return 'tag-hotel';
        if(t==='shop') return 'tag-shop';
        return 'tag-transport';
    }
  function tagIcon(tag){
        const t = (tag||'').toLowerCase();
        if(t==='food') return 'fa-utensils';
        if(t==='sight') return 'fa-torii-gate';
        if(t==='transport') return 'fa-route';
        if(t==='hotel') return 'fa-bed';
        if(t==='shop') return 'fa-bag-shopping';
        return 'fa-circle';
    }

  function durationChip(item){
    // 1) 優先顯示 stay（你 JSON 已經有）
    const stay = (item.stay || '').trim();
    if(stay) return `<span class="tl-chip"><i class="fas fa-hourglass-half"></i> ${escapeHtml(stay)}</span>`;

    // 2) 如果有 route.minutes，顯示車程
    const mins = item?.route?.minutes;
    if(Number.isFinite(mins)) return `<span class="tl-chip"><i class="fas fa-car"></i> ${mins} min</span>`;

    return '';
  }
  function normalizeTime(t){
    // 只取 HH:MM（避免 Before 05:00 / 13:20-13:45 破版）
    const s = String(t ?? '').trim();
    const m = s.match(/(\d{1,2}:\d{2})/);
    if(m) return m[1].padStart(5,'0');
    if(s === '—' || s === '-' || !s) return '—';
    return s; // 真的不是時間就原樣（但建議 json 就別放這種）
  }

  function routeIcon(mode){
    const m = (mode||'').toLowerCase();
    if(m==='drive') return 'fa-car';
    if(m==='walk')  return 'fa-person-walking';
    if(m==='train') return 'fa-train-subway';
    if(m==='ship')  return 'fa-ship';
    if(m==='plane') return 'fa-plane';
    return 'fa-route';
  }

  function renderRouteStrip(item, i){
    const r = item.route || {};
    const mode = (r.mode || 'route').toLowerCase();
    const icon = routeIcon(mode);
    const mins = r.minutes ? `${formatDuration(r.minutes)}` : (item.stay || '');
    const line2 = `${r.from || ''} → ${r.to || ''}`.trim();

    return `
        <div class="timeline-item route-item">
            <div class="tl-time">${escapeHtml(t)}</div>
            <div class="route-spacer"></div>

            <div class="route-strip route-click"
            data-from="${enc(r.from || '')}"
            data-to="${enc(r.to || '')}"
            data-mode="${enc(mode)}">

            <div class="route-ico"><i class="fas ${ico}"></i></div>

            <div class="route-main">
                <div class="route-title">${escapeHtml(title)}</div>
            </div>

            ${dur ? `<div class="route-mins">${escapeHtml(dur)}</div>` : ``}
            </div>
        </div>
    `;
  }

  function renderNormalItem(item, i){
    const stayPill = item.stay ? `<div style="margin-top:10px; display:inline-flex; gap:8px; align-items:center; background:#F2F2F7; padding:6px 10px; border-radius:999px; font-weight:900; color:#4B5563;">
      <i class="fas fa-hourglass-half" style="color:#9CA3AF;"></i>${escapeHtml(item.stay)}
    </div>` : '';

    return `
      <div class="timeline-item" onclick='openModal(${i})'>
        <div class="tl-time">${escapeHtml(item.time || '')}</div>
        <div class="tl-content">
          <div class="tl-tag ${tagClass(item.tag)}">${escapeHtml((item.tag||'').toUpperCase())}</div>
            <i class="fas ${tagIcon(item.tag)} tag-ico"></i>
          <div class="tl-title">${escapeHtml(item.title || '')}</div>
          <div class="tl-desc">${escapeHtml(item.desc || '').replace(/\n/g,'<br>')}</div>
          ${stayPill}
        </div>
      </div>
    `;
  }
  function openDirections(from, to, mode='drive'){
    const tm = travelModeForRoute(mode); // 你下面已經有這個 function
    const url = `https://www.google.com/maps/dir/?api=1`
        + `&origin=${encodeURIComponent(from||'')}`
        + `&destination=${encodeURIComponent(to||'')}`
        + `&travelmode=${encodeURIComponent(tm)}`;
    window.open(url, '_blank', 'noopener');
  }





//   function openDirections(from, to){
//     // Google Maps Directions
//     const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from||'')}&destination=${encodeURIComponent(to||'')}&travelmode=driving`;
//     window.open(url, '_blank');
//   }




  


  async function selectDay(idx) {
    currentDayIdx = idx;

    document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
    const chip = document.getElementById('chip-'+idx);
    if(chip) chip.classList.add('active');

    const meta = itineraryIndex[idx];
    if(!meta) return;

    document.getElementById('weatherLoc').innerText = meta.loc || '';
    const h = hotels.find(x => x.id === meta.hotel_id);
    document.getElementById('stayHotelName').innerText = h ? h.name : '';

    if(!dayCache[idx]) {
      const url = `./${meta.file}?v=1.0.0`;
      const raw = await fetch(url).then(r => r.json());
      dayCache[idx] = Array.isArray(raw) ? raw[0] : raw;
    }
    const dayData = dayCache[idx];
    currentDayData = dayData;
    // ✅ 顯示上方 5 張輪播圖（獨立 block）
    renderDayHero(dayData, meta);



    function renderDayHero(dayData, meta){
        const el = document.getElementById('dayHero');
        if(!el) return;

        // ✅ 來源優先順序：
        // 1) day json: dayData.photos (建議你每一天放 5 張)
        // 2) fallback：用固定的 unsplash 圖（先讓你看到效果）
        const photos = Array.isArray(dayData?.photos) && dayData.photos.length
            ? dayData.photos.slice(0,5)
            : [
                "https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1200&q=80",
                "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80",
                "https://images.unsplash.com/photo-1526481280695-3c687fd5432c?auto=format&fit=crop&w=1200&q=80",
                "https://images.unsplash.com/photo-1528127269322-539801943592?auto=format&fit=crop&w=1200&q=80",
                "https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?auto=format&fit=crop&w=1200&q=80",
            ];

            const locText = dayData?.hero?.loc || meta?.loc || '';
            const caption = dayData?.hero?.caption || '';

            const slides = photos.map((src, idx)=>`
            <div class="hero-slide">
                <img src="${escapeHtml(src)}" alt="day photo ${idx+1}">
                <div class="hero-overlay">
                ${locText ? `<div class="hero-loc"><i class="fas fa-location-dot"></i>${escapeHtml(locText)}</div>` : ``}
                ${caption ? `<div class="hero-caption">${escapeHtml(caption)}</div>` : ``}
                </div>
            <div class="hero-dots">
                ${photos.map((_,d)=>`<span class="hero-dot ${d===0?'active':''}"></span>`).join('')}
            </div>
            </div>
        `).join('');

        el.innerHTML = `<div class="hero-track" id="heroTrack">${slides}</div>`;

        // auto slide
        const track = document.getElementById('heroTrack');
        if(!track) return;

        if(__heroTimer) clearInterval(__heroTimer);

        const dotsAll = Array.from(el.querySelectorAll('.hero-dots'));
        let cur = 0;

        function setDot(i){
            dotsAll.forEach((dotWrap, si)=>{
            const dots = dotWrap.querySelectorAll('.hero-dot');
            dots.forEach(d=>d.classList.remove('active'));
            if(dots[i]) dots[i].classList.add('active');
            });
        }

        __heroTimer = setInterval(()=>{
            cur = (cur + 1) % photos.length;
            track.scrollTo({ left: cur * track.clientWidth, behavior:'smooth' });
            setDot(cur);
        }, 8000);
    }

    
    // timeline
    document.getElementById('timelineList').innerHTML = (dayData?.items || []).map((item, i) => {
      const t = normalizeTime(item.time);
      const stay = item.stay ? `
        <div class="stay-pill"><i class="fas fa-hourglass-half"></i>${escapeHtml(item.stay)}</div>
      ` : '';
    function jsStr(s){ return JSON.stringify(String(s ?? '')); }

    // ✅ route strip：只要有 route 物件就用（不開 modal）
    if(item.route && (item.route.from || item.route.to)){
      const r = item.route;
      const mode = r.mode || 'drive';
      const ico = routeIcon(mode);

      const title = (item.title && item.title.trim())
        ? item.title.trim()
        : `${r.from || ''} → ${r.to || ''}`.trim();

      const dur = (item.stay && String(item.stay).trim())
        ? String(item.stay).trim()
        : (Number.isFinite(r.minutes) ? `${r.minutes} min` : '');

      const enc = (s)=> encodeURIComponent(String(s ?? ''));
      return `
        <div class="timeline-item route-item">
            <div class="route-strip route-click"
            data-from="${enc(r.from || '')}"
            data-to="${enc(r.to || '')}"
            data-mode="${enc(mode)}">
            <div class="route-ico"><i class="fas ${ico}"></i></div>


            <div class="route-main">
                <div class="route-time-top">${escapeHtml(t)}</div>
                <div class="route-title">${escapeHtml(title)}</div>
            </div>

            ${dur ? `<div class="route-mins">${escapeHtml(dur)}</div>` : ``}
            </div>
        </div>
        `;

    }



      // ✅ 一般行程卡（可點開 modal）
      return `
        <div class="timeline-item" onclick='openModal(${i})'>
          <div class="tl-time">${escapeHtml(t)}</div>
          <div class="tl-content">
            <div class="tl-tag ${tagClass(item.tag)}">${escapeHtml((item.tag||'').toUpperCase())}</div>
            <div class="tl-title">${escapeHtml(item.title || '')}</div>
            <div class="tl-desc">${escapeHtml(item.desc || '').replace(/\n/g,'<br>')}</div>
            ${stay}
          </div>
        </div>
      `;
    }).join('');


    await renderWeatherJMA(meta);


  }

  // ====== Google 導航：優先 geo，其次 addr/title ======
  function buildGoogleNavUrl(item){
    const hasGeo = item?.geo?.lat != null && item?.geo?.lng != null;
    if(hasGeo){
      return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(item.geo.lat + ',' + item.geo.lng)}`;
    }
    const q = (item?.addr || item?.title || '').trim();
    if(!q) return 'https://www.google.com/maps';
    return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
  }
  function travelModeForRoute(mode){
    const m = (mode || '').toLowerCase();
    if(m === 'walk')  return 'walking';
    if(m === 'train') return 'transit';
    if(m === 'ship')  return 'transit';
    if(m === 'plane') return 'transit';
    return 'driving';
  }

  function getLatLonForMeta(meta){
    // ✅ 優先：itinerary.index.json 每天直接帶 lat/lon
    if(Number.isFinite(meta?.lat) && Number.isFinite(meta?.lon)){
        return { lat: meta.lat, lon: meta.lon };
    }

    // ✅ 次選：hotels.json 裡的 geo（如果你有存）
    const h = hotels.find(x => x.id === meta.hotel_id);
    const lat = h?.geo?.lat;
    const lon = h?.geo?.lng ?? h?.geo?.lon;
    if(Number.isFinite(lat) && Number.isFinite(lon)){
        return { lat, lon };
    }
    return null;
   }

    function wmoToFa(code, hour){
        // WMO weather_code → FontAwesome
        const night = (hour <= 5 || hour >= 19);
        if(code === 0) return night ? 'fa-moon' : 'fa-sun';
        if(code >= 1 && code <= 3) return night ? 'fa-cloud-moon' : 'fa-cloud-sun';
        if(code === 45 || code === 48) return 'fa-smog';
        if((code >= 51 && code <= 67) || (code >= 80 && code <= 82)) return 'fa-cloud-rain';
        if(code >= 71 && code <= 77) return 'fa-snowflake';
        if(code >= 95 && code <= 99) return 'fa-bolt';
        return night ? 'fa-cloud-moon' : 'fa-cloud-sun';
    }

    function nowInJST(){
        const s = new Intl.DateTimeFormat('sv-SE', {
            timeZone: 'Asia/Tokyo',
            year:'numeric', month:'2-digit', day:'2-digit',
            hour:'2-digit', minute:'2-digit', second:'2-digit',
            hour12:false
        }).format(new Date());
        // sv-SE 會是 "2026-02-27 09:00:00"
        return new Date(s.replace(' ', 'T'));
    }

    function requestGPS(){
        navigator.geolocation.getCurrentPosition(
            (pos)=>{ console.log(pos.coords.latitude, pos.coords.longitude); },
            (err)=>{ console.log(err); },
            { enableHighAccuracy:true, timeout:8000, maximumAge:60000 }
        );
    }
    function openUrl(url){
        if(!url) return;
        window.open(url, '_blank', 'noopener');
    }




    async function renderWeatherJMA(meta){
        const el = document.getElementById('weatherStrip');
        if(!el) return;

        // 你想要 01:00~24:00
        const pad2 = (n)=>String(n).padStart(2,'0');

        // ✅ 16 天限制：如果日期太遠，顯示提示（避免你覺得“不准”）
        // 這裡用「今天」對比 meta.file 裡的 YYYY-MM-DD（如果你不想依賴 file，可改你自己的 date_range）
        const m = String(meta?.file || '').match(/\d{4}-\d{2}-\d{2}/);
        const iso = m ? m[0] : '';
        if(!iso){
            el.innerHTML = `<div style="padding:10px; color:var(--ink2); font-weight:900;">找不到日期（meta.file 需包含 YYYY-MM-DD）</div>`;
            return;
        }

        const today = new Date();
        const target = new Date(iso + 'T00:00:00');
        const diffDays = Math.floor((target - new Date(today.getFullYear(), today.getMonth(), today.getDate())) / 86400000);

        if(diffDays < 0 || diffDays > 16){
            el.innerHTML = `<div style="padding:10px; color:var(--ink2); font-weight:900; line-height:1.5;">
            逐時預報只提供未來 16 天。<br/>
            （目前是 <b>${iso}</b>，接近出發再看會更準）
            </div>`;
            return;
        }

        const ll = getLatLonForMeta(meta);
        if(!ll){
            el.innerHTML = `<div style="padding:10px; color:var(--ink2); font-weight:900; line-height:1.5;">
            尚未設定經緯度：請在 <code>data/itinerary.index.json</code> 這一天加 <code>lat</code> / <code>lon</code>
            </div>`;
            return;
        }

        const url =
            `https://api.open-meteo.com/v1/jma?latitude=${encodeURIComponent(ll.lat)}&longitude=${encodeURIComponent(ll.lon)}`
            + `&hourly=temperature_2m,weather_code`
            + `&forecast_days=16`
            + `&timezone=Asia%2FTokyo`;

        try{
            const data = await fetch(url).then(r=>r.json());
            const times = data?.hourly?.time || [];
            const temps = data?.hourly?.temperature_2m || [];
            const codes = data?.hourly?.weather_code || [];

            const rows = [];
            for(let h=1; h<=24; h++){
            const hh = (h === 24) ? 0 : h;
            const day = (h === 24) ? new Date(target.getTime() + 86400000) : target;
            const y = day.getFullYear();
            const mo = pad2(day.getMonth()+1);
            const d = pad2(day.getDate());
            const tKey = `${y}-${mo}-${d}T${pad2(hh)}:00`;

            const idx = times.indexOf(tKey);
            if(idx === -1){
                rows.push({ time: pad2(h)+':00', icon:'fa-minus', temp:'—' });
                continue;
            }
            const icon = wmoToFa(Number(codes[idx] ?? 0), hh);
            const temp = temps[idx] != null ? Math.round(temps[idx]) + '°' : '—';
            rows.push({ time: pad2(h)+':00', icon, temp });
            }

            el.innerHTML = rows.map(r=>`
            <div class="weather-hour">
                <div class="w-time">${r.time}</div>
                <div class="w-icon"><i class="fas ${r.icon}"></i></div>
                <div class="w-temp">${r.temp}</div>
            </div>
            `).join('');
        }catch(e){
            el.innerHTML = `<div style="padding:10px; color:var(--ink2); font-weight:900;">
            讀取天氣失敗（網路/CORS/服務暫時不可用）
            </div>`;
        }
    }



  function buildGoogleDirUrl(item){
    // route item：用 directions
    const r = item?.route;
    if(r?.from && r?.to){
      const tm = travelModeForRoute(r.mode);
      return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(r.from)}&destination=${encodeURIComponent(r.to)}&travelmode=${tm}`;
    }
    // 一般景點：用 search
    return buildGoogleNavUrl(item);
  }


  // ====== Modal：預計到達/地址/停車/Mapcode/介紹 + Google 導航 ======
  function openModal(itemIdx) {
    const item = currentDayData?.items?.[itemIdx];
    if(!item) return;


    const hours = item.hours ? `<span class="pill"><i class="fas fa-clock"></i> ${escapeHtml(item.hours)}</span>` : '';
    const price = item.price ? `<span class="pill"><i class="fas fa-ticket"></i> ${escapeHtml(item.price)}</span>` : '';
    const stay  = item.stay  ? `<span class="pill"><i class="fas fa-hourglass-half"></i> ${escapeHtml(item.stay)}</span>` : '';

    const guideList = (item.guide || []).length
      ? `<div class="block"><h4><i class="fas fa-headset"></i> 導遊介紹</h4><ul class="bullet">${item.guide.map(x=>`<li>${escapeHtml(x).replace(/\n/g,'<br>').replace(/^\[(.+?)\]：/,'<strong>[$1]：</strong>')}</li>`).join('')}</ul></div>`
      : '';

    const avoidList = (item.avoid || []).length
      ? `<div class="block"><h4><i class="fas fa-triangle-exclamation"></i> 避雷指南</h4><ul class="bullet">${item.avoid.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul></div>`
      : '';

    const menuBlock = (item.menu || []).length
      ? `<div class="menu-recommend">
          <div style="font-weight:900; margin-bottom:10px; color:#8C6B43;"><i class="fas fa-thumbs-up"></i> 必吃菜單（中日對照）</div>
          ${(item.menu||[]).map(m=>`
            <div class="menu-item">
              <span class="jp-text">${escapeHtml(m.jp || '')}</span>
              <span style="font-size:.9rem; color:#666; font-weight:800;">${escapeHtml(m.zh || '')}</span>
            </div>`).join('')}
        </div>`
      : '';

    const detailText = item.detail || item.desc || '';

    // ✅ 你要的欄位（eta/arrive/arrival 皆可）
    const eta = item.eta || item.arrive || item.arrival || '';
    const addr = item.addr || '';
    const parking = item.parking || '';
    const mapcode = item.mapcode || '';

    const navUrl = buildGoogleDirUrl(item);

    const sticky = document.getElementById('modalSticky');
    const body   = document.getElementById('modalBody');

    sticky.innerHTML = `
        <div class="modal-sticky-wrap ${tagClass(item.tag)}">
            <div class="sheet-head">
                <div class="tag-chip ${tagClass(item.tag)}">
                    <div class="sheet-tag ${tagClass(item.tag)}">${escapeHtml((item.tag||'').toUpperCase())}</div>
                </div>
            <div class="sheet-time"><i class="fa-regular fa-clock" style="color:#8B8175; margin-right:6px;"></i>${escapeHtml(item.time || '—')}</div>
            </div>

            <div class="modal-title">${escapeHtml(item.title || '')}</div>

            <div class="pill-row">
            ${hours}${price}${stay}
            </div>
        </div>
    `;

    const links = item.links || {};
    const linkBtns = [
        links.official ? `<button class="btn btn-outline" onclick="openUrl('${enc(links.official)}')">官方網站</button>` : '',
        links.reserve  ? `<button class="btn btn-outline" onclick="openUrl('${enc(links.reserve)}')">訂位 / 購票</button>` : '',
        links.menu     ? `<button class="btn btn-outline" onclick="openUrl('${enc(links.menu)}')">菜單</button>` : '',
    ].filter(Boolean).join('');

    const linkBtnsHtml = linkBtns
        ? `<div class="link-grid">${linkBtns}</div>`
        : '';

    body.innerHTML = `
      <div class="meta-box">
        ${eta ? `
        <div class="meta-row">
          <span class="meta-ico"><i class="fa-regular fa-clock"></i></span>
          <span class="meta-val">預計到達：${escapeHtml(eta)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(eta)}')">複製</button>
        </div>` : ''}

        ${addr ? `
        <div class="meta-row">
          <span class="meta-ico"><i class="fas fa-location-dot"></i></span>
          <span class="meta-val">${escapeHtml(addr)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(addr)}')">複製</button>
        </div>` : ''}

        ${parking ? `
        <div class="meta-row">
          <span class="meta-ico"><i class="fas fa-square-parking"></i></span>
          <span class="meta-val">${escapeHtml(parking)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(parking)}')">複製</button>
        </div>` : ''}

        ${mapcode ? `
        <div class="meta-row">
          <span class="meta-ico">🗾</span>
          <span class="meta-val">Mapcode：${escapeHtml(mapcode)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(mapcode)}')">複製</button>
        </div>` : ''}

        ${(!eta && !addr && !parking && !mapcode) ? `
        <div class="meta-row">
          <span class="meta-ico">ℹ️</span>
          <span class="meta-val">（此行程尚未填：到達/地址/停車/Mapcode）</span>
        </div>` : ''}
      </div>

      <div class="detail">${escapeHtml(detailText)}</div>

      ${menuBlock}
      ${avoidList}
      ${guideList}
      ${linkBtnsHtml}


      


      <div class="sheet-actions">
        <a class="btn-primary" href="${navUrl}" target="_blank" rel="noopener">
          <i class="fas fa-location-arrow"></i> 開啟 Google Maps 導航
        </a>
      </div>`;

    lockBodyScroll();
    document.getElementById('modalOverlay').classList.add('active');
    document.getElementById('modalSheet').classList.add('active');
  }

  // function openRouteMap(ev, idx){
  //   ev?.stopPropagation?.();

  //   const item = currentDayData?.items?.[idx];
  //   if(!item) return;

  //   const r = item.route || {};
  //   const from = r.from || '';
  //   const to   = r.to || '';
  //   if(!to) return;

  //   const mode = (r.mode || 'drive').toLowerCase();
  //   const travelmode =
  //     mode === 'walk'  ? 'walking' :
  //     mode === 'train' ? 'transit' :
  //     mode === 'ship'  ? 'transit' :
  //     mode === 'plane' ? 'transit' :
  //     'driving';

  //   window.open(
  //     `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from)}&destination=${encodeURIComponent(to)}&travelmode=${travelmode}`,
  //     '_blank',
  //     'noopener'
  //   );
  // }
  function openRouteMap(ev, idx){
    ev?.stopPropagation?.();
    const item = currentDayData?.items?.[idx];
    if(!item?.route) return;

    const r = item.route;
    const tm = travelModeForRoute(r.mode);
    window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(r.from||'')}&destination=${encodeURIComponent(r.to||'')}&travelmode=${tm}`, '_blank', 'noopener');
  }


  function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
    document.getElementById('modalSheet').classList.remove('active');

    // 等 sheet 動畫收起（你的 transition 0.3s）
    setTimeout(() => {
      unlockBodyScroll();
    }, 320);
  }


  function openUrl(url){
    window.open(url, '_blank', 'noopener');
  }

  // ====== 住宿/航班/記帳（沿用你原本邏輯） ======
  function renderHotels() {
    document.getElementById('hotelList').innerHTML = (HOTELS || []).map(h => {
      const dateText = h.stay ? `${h.stay.from} - ${h.stay.to}` : '';
      const img = (h.images && h.images[0]) ? h.images[0]
        : "https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&q=80&w=900";

      return `
        <div class="card" style="padding:0; overflow:hidden;">
          <img src="${escapeHtml(img)}" style="height:180px; width:100%; object-fit:cover; border-radius:20px; margin-bottom:0;">
          <div style="padding:20px;">
            <h3 style="margin:0 0 6px; font-family:'Noto Serif TC',serif; font-weight:900;">${escapeHtml(h.name || '')}</h3>
            <div style="color:var(--ink2); font-size:0.9rem; margin-bottom:10px; font-weight:800;">${escapeHtml(dateText)}</div>
            <div style="font-size:0.95rem; line-height:1.6; color:#444; font-weight:700;">
              ${escapeHtml(h.desc || '')}
            </div>
            ${h.mapcode ? `<div style="display:inline-block;background:rgba(255,235,238,.92);color:#B42318;padding:6px 10px;border-radius:999px;font-size:.82rem;font-weight:900;margin-top:10px;border:1px solid rgba(180,35,24,.15);">Mapcode: ${escapeHtml(h.mapcode)}</div>` : ''}
            <button class="btn btn-outline" style="margin-top:15px;" onclick="openUrl('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.name || '')}')">導航</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderFlights(){
    const el = document.getElementById('flightBoard');
    const out = FLIGHTS?.outbound;
    const inn = FLIGHTS?.inbound;

    el.innerHTML = [out, inn].filter(Boolean).map((f, idx) => {
      const isOut = idx === 0;
      const label = isOut ? `去程 ${mmdd(f.date)} (${weekdayZh(f.date)})` : `回程 ${mmdd(f.date)} (${weekdayZh(f.date)})`;
      const carrier = FLIGHTS?.carrier || '';
      const baggage = f.baggage ? `${f.baggage.checked || ''} / ${f.baggage.pieces || ''}件` : '';
      const terminal = f.from?.terminal ? `• ${f.from.terminal}` : '';

      return `
        <div class="boarding">
          <div class="boarding-top">
            <div class="row">
              <div class="boarding-badge"><i class="fas fa-plane"></i> ${escapeHtml(label)}</div>
              <div style="font-weight:900; color:#333;">${escapeHtml(f.flight_no || '')}</div>
            </div>
            <div style="margin-top:8px; color:var(--ink2); font-weight:800;">${escapeHtml(carrier)} • ${escapeHtml(f.aircraft || '')}</div>
          </div>

          <div class="boarding-mid">
            <div style="text-align:left;">
              <div class="code">${escapeHtml(f.from?.code || '')}</div>
              <div class="t">${escapeHtml(f.from?.city || '')} • ${escapeHtml(f.depart_time || '')} ${escapeHtml(terminal)}</div>
            </div>
            <i class="fas fa-arrow-right" style="color:#B9B2AA; font-size:1.1rem;"></i>
            <div style="text-align:right;">
              <div class="code">${escapeHtml(f.to?.code || '')}</div>
              <div class="t">${escapeHtml(f.to?.city || '')} • ${escapeHtml(f.arrive_time || '')}</div>
            </div>
          </div>

          <div class="boarding-bottom">
            <div><i class="fas fa-suitcase-rolling"></i> 行李：${escapeHtml(baggage)}</div>
            <div><i class="fas fa-building"></i> 出發：${escapeHtml(f.from?.city || '')} ${escapeHtml(f.from?.terminal || '')}</div>
            <div><i class="fas fa-location-dot"></i> 抵達：${escapeHtml(f.to?.city || '')}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  // 記帳：沿用你原版（只有視覺已套入上方 CSS）
  let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
  function renderExpenseUI() {
    document.getElementById('payerSwitch').innerHTML = users.map(u =>
      `<div class="user-tab ${u===curPayer?'active':''}" onclick="curPayer='${u}'; renderExpenseUI();">${u}</div>`
    ).join('');

    document.getElementById('expenseList').innerHTML = expenses.map((e,i) => `
      <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(233,225,214,.8);">
        <div>
          <div style="font-weight:900;">${escapeHtml(e.name)}</div>
          <div style="font-size:0.8rem; color:var(--ink2); font-weight:800;">${escapeHtml(e.payer)} 付款</div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:900;">¥${escapeHtml(String(e.cost))}</div>
          <div style="font-size:0.8rem; color:#B42318; cursor:pointer; font-weight:900;" onclick="delExp(${i})">刪除</div>
        </div>
      </div>
    `).join('');

    let bal = {};
    users.forEach(u => bal[u]=0);

    expenses.forEach(e => {
      let share = e.cost / users.length;
      users.forEach(u => {
        if(u===e.payer) bal[u] += (e.cost - share);
        else bal[u] -= share;
      });
    });

    document.getElementById('debtList').innerHTML = users.map(u => {
      let val = Math.round(bal[u]);
      let color = val>=0 ? '#2F8F5B' : '#B42318';
      return `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(233,225,214,.8); font-weight:900;">
        <span>${escapeHtml(u)}</span>
        <span style="color:${color}; font-weight:900;">${val>=0?'收':'付'} ¥${Math.abs(val)}</span>
      </div>`;
    }).join('');
  }

  function addExpense() {
    const name = document.getElementById('exName').value.trim();
    const cost = parseInt(document.getElementById('exCost').value, 10);
    if(!name || !cost) return alert('請輸入資料');
    expenses.push({name, cost, payer:curPayer});
    localStorage.setItem('expenses', JSON.stringify(expenses));
    document.getElementById('exName').value = '';
    document.getElementById('exCost').value = '';
    renderExpenseUI();
  }

  function delExp(i) {
    if(confirm('刪除?')) {
      expenses.splice(i,1);
      localStorage.setItem('expenses', JSON.stringify(expenses));
      renderExpenseUI();
    }
  }

  // utils
  function escapeHtml(str){
    return String(str ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function unescapeHtml(str){
    return String(str ?? '')
      .replaceAll('&amp;','&')
      .replaceAll('&lt;','<')
      .replaceAll('&gt;','>')
      .replaceAll('&quot;','"')
      .replaceAll('&#39;',"'");
  }
  function copyText(txt) {
    navigator.clipboard.writeText(txt);
    alert('已複製：' + txt);
  }

  function mmdd(iso){
    if(!iso) return '';
    const m = String(iso).slice(5,7);
    const d = String(iso).slice(8,10);
    return `${m}/${d}`;
  }
  function weekdayZh(iso){
    if(!iso) return '';
    const dt = new Date(iso + "T00:00:00");
    const arr = ['日','一','二','三','四','五','六'];
    return arr[dt.getDay()];
  }

  let __scrollY = 0;
  function lockBodyScroll(){
    __scrollY = window.scrollY || 0;

    // iOS 最穩：把 body 固定住
    document.body.classList.add('body-no-scroll'); // 你原本那個 class 可以留著
    document.body.style.position = 'fixed';
    document.body.style.top = `-${__scrollY}px`;
    document.body.style.left = '0';
    document.body.style.right = '0';
    document.body.style.width = '100%';
  }

  function unlockBodyScroll(){
    document.body.classList.remove('body-no-scroll');
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.left = '';
    document.body.style.right = '';
    document.body.style.width = '';

    window.scrollTo(0, __scrollY);
  }


</script>
</body>
</html>