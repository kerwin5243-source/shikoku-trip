<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å››åœ‹æ…¢æ—… 2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #556B2F; /* æŠ¹èŒ¶ç¶  */
            --primary-light: #8FBC8F;
            --accent: #D2691E; /* ç„™èŒ¶è‰²/å¼·èª¿è‰² */
            --bg: #FDFCF6; /* ç±³è‰²å’Œç´™æ„Ÿ */
            --card-bg: #FFFFFF;
            --text: #4A4A4A;
            --gray: #F0F0F0;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding-bottom: 90px; /* Bottom Nav space */
        }

        /* --- UI Components --- */
        .header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { margin: 0; font-size: 1.2rem; }

        /* Tabs Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 1000;
        }
        .nav-item {
            text-align: center;
            font-size: 0.75rem;
            color: #999;
            cursor: pointer;
            flex: 1;
        }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item i { display: block; font-size: 1.4rem; margin-bottom: 4px; }

        /* Pages */
        .page { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .card-title { font-weight: bold; font-size: 1.1rem; color: var(--primary); }
        .card-tag { 
            background: var(--gray); color: #666; 
            padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; 
        }

        /* Buttons */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        .btn-block { width: 100%; justify-content: center; }

        /* --- PRE-TRIP Page --- */
        .user-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .user-tab {
            background: #eee; width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; flex-shrink: 0; cursor: pointer;
            border: 2px solid transparent;
        }
        .user-tab.active { border-color: var(--primary); background: white; color: var(--primary); }
        
        .checklist-group h3 { color: var(--accent); border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 20px; }
        .checklist-item {
            display: flex; align-items: center; padding: 10px 0; border-bottom: 1px dashed #eee;
        }
        .checklist-item input { margin-right: 15px; transform: scale(1.3); accent-color: var(--primary); }
        .checklist-item.checked span { text-decoration: line-through; color: #ccc; }

        /* --- ITINERARY Page --- */
        .day-scroller {
            display: flex; overflow-x: auto; gap: 10px; padding: 10px 0;
            position: sticky; top: 60px; background: var(--bg); z-index: 90;
            margin: 0 -15px 15px; padding: 10px 15px;
            scrollbar-width: none; /* Hide scrollbar */
        }
        .day-chip {
            background: white; border: 1px solid #ddd;
            padding: 8px 15px; border-radius: 20px;
            white-space: nowrap; cursor: pointer; font-size: 0.9rem;
        }
        .day-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        .weather-card {
            background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
            color: white; margin-bottom: 20px;
        }
        .daily-summary { font-size: 0.9rem; margin-bottom: 5px; opacity: 0.9; }

        /* Itinerary Item */
        .timeline-item {
            display: flex; gap: 15px; margin-bottom: 20px;
        }
        .time-col { 
            min-width: 50px; font-weight: bold; color: var(--accent); font-size: 0.9rem; 
            display: flex; flex-direction: column; align-items: center;
        }
        .time-line { width: 2px; background: #eee; flex: 1; margin-top: 5px; }
        .event-card { flex: 1; }
        
        .event-img { 
            width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-top: 10px; 
            display: none; /* Hidden by default */
        }
        .event-details {
            display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; font-size: 0.9rem; line-height: 1.6;
        }
        .event-details.show { display: block; }
        .jp-name { color: #888; font-size: 0.8rem; margin-bottom: 5px; display: block; }

        /* --- ACCOMMODATION & FLIGHT Page --- */
        .flight-card {
            background: white; border-left: 5px solid var(--accent);
            padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: var(--shadow);
        }
        .flight-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .airport-code { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .hotel-img-preview { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; cursor: pointer; }
        .hotel-note { background: #fff8e1; color: #8a6d3b; padding: 10px; border-radius: 8px; font-size: 0.85rem; margin-top: 5px; }

        /* --- EXPENSE Page --- */
        .money-input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .money-input { 
            flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; 
        }
        .payer-select {
            display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto;
        }
        .payer-option {
            flex: 1; padding: 10px; text-align: center; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;
        }
        .payer-option.selected { background: var(--primary); color: white; border-color: var(--primary); }
        
        .expense-list { list-style: none; padding: 0; }
        .expense-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 0; border-bottom: 1px solid #eee; 
        }
        .expense-info h4 { margin: 0 0 4px 0; font-size: 1rem; }
        .expense-info span { font-size: 0.8rem; color: #888; }
        .expense-amount { font-weight: bold; color: var(--accent); }
        .btn-delete { color: #ccc; margin-left: 10px; cursor: pointer; }

        /* --- Lightbox --- */
        .lightbox {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .lightbox.active { display: flex; }
        .lightbox img { max-width: 95%; max-height: 80%; border-radius: 8px; }
        .close-lightbox { color: white; font-size: 2rem; margin-bottom: 20px; cursor: pointer; }

        /* Mapcode Button */
        .mapcode-box {
            display: inline-block; background: #eee; padding: 4px 8px; 
            border-radius: 4px; font-family: monospace; font-size: 0.9rem; cursor: pointer;
            margin-top: 5px; border: 1px solid #ccc;
        }
        .mapcode-box:active { background: #ddd; }

    </style>
</head>
<body>

<div class="header">
    <h1><i class="fas fa-torii-gate"></i> å››åœ‹æ…¢æ—… 2026</h1>
    <span style="font-size: 0.8rem;">2/27 - 3/7</span>
</div>

<div id="page-pretrip" class="page active">
    <div class="card">
        <h2 class="card-title"><i class="fas fa-clipboard-check"></i> è¡Œå‰æª¢æŸ¥è¡¨</h2>
        <p style="font-size: 0.8rem; color: #666; margin-bottom: 15px;">é»é¸ä¸‹æ–¹ä»£è™Ÿåˆ‡æ›æ¯å€‹äººçš„æ¸…å–®</p>
        
        <div class="user-tabs" id="userTabs">
            </div>

        <div id="checklistContainer">
            </div>
    </div>

    <div class="card">
        <h2 class="card-title"><i class="fas fa-exclamation-circle"></i> å…¨å“¡å¾…è¾¦äº‹é …</h2>
        <ul style="padding-left: 20px; font-size: 0.9rem; line-height: 1.6;">
            <li>ç§Ÿè»Šé ç´„ (è¨˜å¾—è²· ETC + SEP)</li>
            <li>å¡«å¯« Visit Japan Web</li>
            <li>é ç´„å°è±†å³¶æ¸¡è¼ª (è»Šè¼›)</li>
            <li>é ç´„é³´é–€è§€æ½®èˆ¹</li>
            <li>é ç´„æ —æ—å…¬åœ’éŠèˆ¹</li>
            <li>é ç´„ GoGo æ»‘ç´¢</li>
            <li>é ç´„çƒé¾éºµå­¸æ ¡</li>
        </ul>
        <a href="https://cheng-ya.deeeep.com.tw/index.php" target="_blank" class="btn btn-outline btn-block btn-sm" style="margin-top:10px;">é¦™å·å„ªæƒ ç™»è¨˜</a>
    </div>
</div>

<div id="page-itinerary" class="page">
    <div class="day-scroller" id="dayScroller">
        </div>

    <div class="card weather-card" id="dailyInfoCard">
        <div style="display: flex; justify-content: space-between;">
            <div>
                <h3 style="margin:0;"><i class="fas fa-map-marker-alt"></i> <span id="currentLoc">é«˜æ¾</span></h3>
                <p id="weatherText" style="margin: 5px 0; font-size: 0.9rem;">â˜€ï¸ æ™´æ™‚å¤šé›² 8-15Â°C (é æ¸¬)</p>
            </div>
            <div style="text-align: right;">
                <p style="margin:0; font-size:0.8rem; opacity:0.8;">ä»Šæ™šå…¥ä½</p>
                <strong id="currentHotelName" style="font-size: 1rem;">Second Home</strong>
            </div>
        </div>
        <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" style="color:white; font-size:0.8rem; text-decoration: underline; display: block; margin-top: 10px;">æŸ¥çœ‹æ—¥æœ¬æ°£è±¡å»³è©³æƒ…</a>
    </div>

    <div id="timelineContainer">
        </div>
</div>

<div id="page-booking" class="page">
    <h2 style="color: var(--primary); margin-bottom: 15px;">âœˆï¸ èˆªç­è³‡è¨Š</h2>
    <div class="flight-card">
        <div class="card-tag" style="background: #ffebee; color: #d32f2f; margin-bottom: 10px;">å»ç¨‹ 2026/02/27</div>
        <div class="flight-row">
            <div style="text-align: center;">
                <div class="airport-code">TPE</div>
                <div style="font-size:0.8rem;">å°åŒ—æ¡ƒåœ’ T2</div>
                <div style="font-weight:bold; color:var(--text);">07:00</div>
            </div>
            <div style="flex:1; text-align: center; color:#ccc;">
                <i class="fas fa-plane" style="color:var(--primary);"></i><br>
                ------------
            </div>
            <div style="text-align: center;">
                <div class="airport-code">TAK</div>
                <div style="font-size:0.8rem;">é«˜æ¾æ©Ÿå ´</div>
                <div style="font-weight:bold; color:var(--text);">10:20</div>
            </div>
        </div>
        <div style="display:flex; justify-content: space-between; font-size: 0.9rem; border-top: 1px solid #eee; padding-top: 10px;">
            <span><i class="fas fa-ticket-alt"></i> CI278 (A321 neo)</span>
            <span>è¡Œæ: 23kg / 1 PC</span>
        </div>
    </div>
    <div class="flight-card">
        <div class="card-tag" style="background: #e3f2fd; color: #1976d2; margin-bottom: 10px;">å›ç¨‹ 2026/03/07</div>
        <div class="flight-row">
            <div style="text-align: center;">
                <div class="airport-code">TAK</div>
                <div style="font-size:0.8rem;">é«˜æ¾æ©Ÿå ´</div>
                <div style="font-weight:bold; color:var(--text);">18:55</div>
            </div>
            <div style="flex:1; text-align: center; color:#ccc;">
                <i class="fas fa-plane" style="color:var(--primary);"></i><br>
                ------------
            </div>
            <div style="text-align: center;">
                <div class="airport-code">TPE</div>
                <div style="font-size:0.8rem;">å°åŒ—æ¡ƒåœ’ T2</div>
                <div style="font-weight:bold; color:var(--text);">21:05</div>
            </div>
        </div>
        <div style="display:flex; justify-content: space-between; font-size: 0.9rem; border-top: 1px solid #eee; padding-top: 10px;">
            <span><i class="fas fa-ticket-alt"></i> CI179 (A321 neo)</span>
            <span>è¡Œæ: 23kg / 1 PC</span>
        </div>
    </div>

    <h2 style="color: var(--primary); margin: 25px 0 15px;">ğŸ¨ ä½å®¿è³‡è¨Š</h2>
    <div id="hotelListContainer">
        </div>
</div>

<div id="page-expense" class="page">
    <div class="card">
        <h2 class="card-title">æ–°å¢æ”¯å‡º</h2>
        <div class="money-input-group">
            <input type="text" id="expenseName" class="money-input" placeholder="é …ç›® (ä¾‹: æ™šé¤)">
            <input type="number" id="expenseCost" class="money-input" placeholder="ç¸½é‡‘é¡ (Â¥)">
        </div>
        <p style="font-size:0.9rem; margin-bottom:5px;">èª°å…ˆä»˜æ¬¾ï¼Ÿ</p>
        <div class="payer-select" id="payerSelect">
            <div class="payer-option" onclick="selectPayer('L')">L</div>
            <div class="payer-option" onclick="selectPayer('K')">K</div>
            <div class="payer-option" onclick="selectPayer('R')">R</div>
            <div class="payer-option" onclick="selectPayer('Y')">Y</div>
            <div class="payer-option" onclick="selectPayer('J')">J</div>
        </div>
        <button class="btn btn-block" onclick="addExpense()">â• åŠ å…¥ä¸¦å¹³åˆ†</button>
    </div>

    <div class="card">
        <h2 class="card-title">æ”¯å‡ºç´€éŒ„</h2>
        <ul class="expense-list" id="expenseList">
            </ul>
    </div>

    <div class="card" style="background: #333; color: white;">
        <h2 class="card-title" style="color:white;">çµç®— (æ¯äººæ¬ ä»˜æ¬¾äºº)</h2>
        <div id="debtSummary" style="font-size: 0.9rem; line-height: 1.8;">
            </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchPage('pretrip', this)">
        <i class="fas fa-suitcase"></i> è¡Œå‰
    </div>
    <div class="nav-item" onclick="switchPage('itinerary', this)">
        <i class="fas fa-map-marked-alt"></i> è¡Œç¨‹
    </div>
    <div class="nav-item" onclick="switchPage('booking', this)">
        <i class="fas fa-passport"></i> è³‡è¨Š
    </div>
    <div class="nav-item" onclick="switchPage('expense', this)">
        <i class="fas fa-yen-sign"></i> è¨˜å¸³
    </div>
</div>

<div class="lightbox" id="lightbox">
    <div class="close-lightbox" onclick="closeLightbox()">&times;</div>
    <img id="lightboxImg" src="" alt="Zoomed Image">
</div>

<script>
    // --- DATA: è¡Œå‰æ¸…å–® ---
    const checklistData = {
        before: ["eSIM / æ¼«éŠ", "å¤–å¹£ (æ—¥åœ“)", "Visit Japan Web", "æ—…å¹³éšª", "é å…ˆç·šä¸Šå ±åˆ°"],
        carryOn: ["è­·ç…§", "éŒ¢åŒ… (å¯¦é«”å¡/è¥¿ç“œå¡)", "å¸½å­", "éš±å½¢çœ¼é¡", "åŸå­ç­†", "é¢ç´™", "æ‰‹æ©Ÿ", "æ°´å£º", "é˜²æ›¬ä¹³", "è–„å¤–å¥—", "è€³æ©Ÿ", "ç‰™ç·šæ£’", "è¡Œå‹•é›»æº", "å¤ªé™½çœ¼é¡", "æ—…éŠæ‰‹å†Š", "é‘°åŒ™"],
        checked: ["å¤–å‡ºè¡£ç‰©", "å…§è¡£è¤²", "ç¡è¡£", "è¥ªå­", "å‚™ç”¨é‹", "æ‹–é‹", "æ‰‹æ©Ÿå……é›»å™¨", "è‡ªæ‹æ£’", "å€‹äººè—¥å“", "æ³³è¡£ (L7hotel?)", "æŒ‡ç”²å‰ª", "è¡£æ¶", "é›¨å…·", "å»¶é•·ç·š", "å°å‰ªåˆ€", "ç›¥æ´—ç”¨å“", "è³¼ç‰©è¢‹", "ç‰™åˆ·ç‰™è†", "é¦™æ°›", "å‚™ç”¨çœ¼é¡"]
    };
    const users = ['L', 'K', 'R', 'Y', 'J'];
    let currentUser = 'L';

    // --- DATA: ä½å®¿ ---
    const hotels = [
        {
            name: "Second Home ç€¬æˆ¸é¢¨æœˆ",
            dates: "02/27 - 03/02",
            city: "é«˜æ¾",
            mapcode: "77 353 678*81", // å‡è¨­
            phone: "+81 87-813-7738",
            note: "11é»å‰é€€æˆ¿ã€é™„åœè»Šä½*2ã€å…¥ä½æ™‚æä¾›å¯†ç¢¼ã€‚Google 4.9æ˜Ÿã€‚",
            img: "https://images.unsplash.com/photo-1590073844006-33379778ae09?auto=format&fit=crop&q=80&w=800" // Placeholder
        },
        {
            name: "Kowakuen Haruka å¤æ¹§åœ’ é™",
            dates: "03/02 - 03/03",
            city: "æ¾å±±é“å¾Œ",
            mapcode: "å¾…æŸ¥",
            phone: "+81 89-945-5911",
            note: "15é» Check-in, 11é»é€€æˆ¿ã€‚å«æ—©é¤+NDT$700ã€‚Google 4.4æ˜Ÿã€‚",
            img: "https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?auto=format&fit=crop&q=80&w=800"
        },
        {
            name: "æ˜Ÿé‡é›†åœ˜ OMO7 é«˜çŸ¥",
            dates: "03/03 - 03/06",
            city: "é«˜çŸ¥",
            mapcode: "å¾…æŸ¥",
            phone: "+81 50-3134-8095",
            note: "15é» Check-in, 11é»é€€æˆ¿ã€‚å«æ—©é¤ã€‚",
            img: "https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&q=80&w=800"
        },
        {
            name: "å¾¡å®¿ æ•·å³¶é¤¨",
            dates: "03/06 - 03/07",
            city: "ç´å¹³",
            mapcode: "å¾…æŸ¥",
            phone: "+81 87-758-8005",
            note: "15é» Check-in, 11é»é€€æˆ¿ã€‚ä¸€æ³ŠäºŒé£Ÿï¼",
            img: "https://images.unsplash.com/photo-1611892440504-42a792e24d32?auto=format&fit=crop&q=80&w=800"
        }
    ];

    // --- DATA: è¡Œç¨‹ (éƒ¨åˆ†ç¯„ä¾‹ï¼Œè«‹ä¾éœ€æ±‚è£œå®Œ) ---
    const itinerary = [
        { date: "02/27", day: "äº”", location: "é«˜æ¾", hotelIdx: 0, events: [
            { time: "10:30", title: "æŠµé”é«˜æ¾æ©Ÿå ´", desc: "é ˜å–å„ªæƒ åˆ¸ã€ç§Ÿè»Š (æ©Ÿå ´ç§Ÿè»Šä¸­å¿ƒ)ã€‚", icon: "plane" },
            { time: "12:00", title: "æ‰‹æ‰“çƒé¾éºµ æ£®å®¶", jp: "æ‰‹æ‰“ã†ã©ã‚“ ã‚‚ã‚Šå®¶", desc: "Kawata Udon é€±äº”ä¼‘ï¼Œæ”¹åƒé€™å®¶æ©Ÿå ´é™„è¿‘ååº—ã€‚å¿…é»ï¼šç‚¸ä»€éŒ¦çƒé¾éºµ (Kakiage Udon)ã€‚", type: "food", map: "ã‚‚ã‚Šå®¶", img: "https://images.unsplash.com/photo-1612927601601-6606a9b461e1?auto=format&fit=crop&q=80&w=800" },
            { time: "13:45", title: "å‘†å‘†ç¸å…¬åœ’", desc: "ç´„15åˆ†è»Šç¨‹ã€‚æ—é‚Šæœ‰å…è²»åœè»Šå ´ã€‚", type: "sight", map: "ã²ã ã¾ã‚Šå…¬åœ’ ç¶¾å·" },
            { time: "14:30", title: "é‡‘åˆ€æ¯”ç¾…å®®", desc: "çˆ¬éšæ¢¯ï¼å¾¡æœ¬å®®785éšã€‚å¥§ç¤¾1368éšã€‚17:00é—œé–€ã€‚", mapcode: "77 353 678*81", type: "sight", map: "é‡‘åˆ€æ¯”ç¾…å®®" },
            { time: "18:00", title: "æ°¸æ—ºå¤¢æ¨‚åŸ é«˜æ¾", desc: "æ™šé¤ã€UNIQLOã€è—¥å¦æ¡è²·ã€‚", type: "shop", map: "Aeon Mall Takamatsu" }
        ]},
        { date: "02/28", day: "å…­", location: "å°è±†å³¶", hotelIdx: 0, events: [
            { time: "07:20", title: "é«˜æ¾æ¸¯å‡ºç™¼", desc: "æ­ä¹˜æ¸¡è¼ª (éœ€é ç´„)ã€‚ç´„1å°æ™‚åˆ°åœŸåº„æ¸¯ã€‚", type: "ship" },
            { time: "09:00", title: "å°è±†å³¶ç’°å³¶", desc: "æ©„æ¬–å…¬åœ’ (é­”å¥³å®…æ€¥ä¾¿)ã€é‡å²©ã€‚", type: "sight" },
            { time: "12:00", title: "å°è±†å³¶æ‹‰éºµ HISHIO", desc: "å¤©ä½¿ä¹‹è·¯åº—ã€‚å¿…é»é†¬æ²¹æ‹‰éºµã€‚", type: "food" },
            { time: "13:45", title: "å¤©ä½¿ä¹‹è·¯", desc: "âš ï¸ é…åˆé€€æ½®æ™‚é–“ (13:45~19:45) é€šè¡Œã€‚", type: "sight", map: "Angel Road" },
            { time: "15:45", title: "è¿”å›é«˜æ¾", desc: "æ­ä¹˜å‘†å‘†ç¸è™Ÿã€‚", type: "ship" },
            { time: "17:00", title: "é«˜æ¾åŸ (ç‰è—»å…¬åœ’)", desc: "ä¸‰å¤§æ°´åŸã€‚é¤µé¯›é­šã€‚", type: "sight" }
        ]},
        { date: "03/01", day: "æ—¥", location: "é«˜æ¾/å¾·å³¶", hotelIdx: 0, events: [
            { time: "09:00", title: "æ —æ—å…¬åœ’", desc: "ç±³å…¶æ—ä¸‰æ˜Ÿåº­åœ’ã€‚å·²é ç´„éŠèˆ¹ã€‚", mapcode: "60 576 348*55", type: "sight" },
            { time: "11:30", title: "é³´é–€æ¼©æ¸¦", desc: "âš ï¸ æœ€ä½³å¤§æ½®æ™‚é–“ï¼è«‹å‹™å¿…æº–æ™‚ã€‚", type: "sight", map: "é³´é–€æ¸¦ä¹‹é“" },
            { time: "12:30", title: "å ‚ã®æµ¦ æ‹‰éºµ", desc: "å¿…é»é¯›é­šé¹½å‘³æ‹‰éºµ + æ›¿é£¯(ç‡‰é£¯)ã€‚", type: "food" },
            { time: "15:30", title: "çœ‰å±±çºœè»Š", desc: "é˜¿æ³¢èˆæœƒé¤¨5æ¨“æ­ä¹˜ã€‚çœ‹å¾·å³¶å¸‚æ™¯ã€‚", mapcode: "56 361 036*63", type: "sight" }
        ]},
        { date: "03/02", day: "ä¸€", location: "é«˜æ¾â†’æ¾å±±", hotelIdx: 1, events: [
            { time: "08:45", title: "é•·ç”° in é¦™ã®é¦™", jp: "é•·ç”° in é¦™ã®é¦™", desc: "çƒé¾éºµç™¾ååº—ã€‚å¿…é»é‡œæšçƒé¾éºµ (Kamaage)ã€‚", type: "food", mapcode: "77 132 233*36" },
            { time: "10:30", title: "ä¸¸é¾œåŸ", desc: "ç¾å­˜å¤©å®ˆï¼ŒçŸ³å£æœ€é«˜ã€‚å¡åº¦é™¡ã€‚", type: "sight" },
            { time: "15:00", title: "æ¾å±±åŸ & çºœè»Š", desc: "æ­ä¹˜å–®äººåŠæ¤…ä¸Šå±±ã€‚", type: "sight" },
            { time: "18:00", title: "é“å¾Œæº«æ³‰è¡—", desc: "å°‘çˆºæ©Ÿé—œé˜ã€è¶³æ¹¯ã€ä¼Šç¹”æ¯›å·¾ã€‚", type: "sight" }
        ]},
         { date: "03/03", day: "äºŒ", location: "æ¾å±±â†’é«˜çŸ¥", hotelIdx: 2, events: [
            { time: "10:00", title: "ä¸‹ç˜è»Šç«™", desc: "ç¥éš±å°‘å¥³æµ·ä¸Šéµé“ã€‚ç„¡äººè»Šç«™ã€‚", type: "sight" },
            { time: "13:00", title: "å¤§æ´²åŸ & æ²¹å±‹", desc: "åˆé¤åƒè±šæ —é£¯ã€‚", type: "food" },
            { time: "19:00", title: "å¼˜äººå¸‚å ´", desc: "é«˜çŸ¥äººçš„å»šæˆ¿ï¼å¿…åƒï¼šæ˜ç¥ä¸¸ç‚™ç‡’é°¹é­šã€å®‰å…µè¡›é¤ƒå­ã€‚", type: "food", map: "Hirome Market" }
        ]},
        { date: "03/04", day: "ä¸‰", location: "å››è¬åå·", hotelIdx: 2, events: [
            { time: "10:30", title: "å››è¬åå·", desc: "æ—¥æœ¬æœ€å¾Œçš„æ¸…æµã€‚æ²‰ä¸‹æ©‹ã€å±‹å½¢èˆ¹ã€é¨è…³è¸è»Šã€‚", type: "sight" },
            { time: "18:00", title: "æ™šé¤ï¼šä¿ºã®ä¸²", desc: "æ—¥å¼ä¸²ç‡’ã€‚", type: "food" }
        ]},
        { date: "03/05", day: "å››", location: "é«˜çŸ¥å¸‚å€", hotelIdx: 2, events: [
            { time: "09:00", title: "é«˜çŸ¥åŸ", desc: "è¿½æ‰‹é–€èˆ‡å¤©å®ˆåŒæ¡†ã€‚", type: "sight" },
            { time: "11:00", title: "æ¡‚æ¿±å…¬åœ’", desc: "å‚æœ¬é¾é¦¬åƒã€æ°´æ—é¤¨ (é¤µæµ·ç¸!)ã€‚", type: "sight" },
            { time: "14:00", title: "ç‰§é‡æ¤ç‰©åœ’", desc: "æ—¥åŠ‡ã€Šçˆ›æ¼«ã€‹åŸå‹ã€‚", type: "sight" },
            { time: "17:30", title: "äº”å°å±±å±•æœ›å°", desc: "çœ‹å¤•é™½èˆ‡å¤œæ™¯ã€‚", type: "sight" },
            { time: "19:00", title: "åœŸä½æ–™ç† å¸", desc: "ç™¾å¹´è€åº—ï¼Œé«”é©—æ­£å®—é°¹é­šåŠæ•²ç‡’ã€‚", type: "food" }
        ]},
        { date: "03/06", day: "äº”", location: "ç¥–è°·â†’ç´å¹³", hotelIdx: 3, events: [
            { time: "09:00", title: "å¤§æ­¥å±éŠè¦½èˆ¹", desc: "æ¬£è³å³½è°·å¥‡å²©ã€‚", type: "sight" },
            { time: "10:30", title: "GoGo Adventure", desc: "æ£®æ—æ»‘ç´¢ï¼(éœ€é ç´„)", type: "activity" },
            { time: "13:00", title: "ç¥–è°·è—¤è”“æ©‹", desc: "ä¸‰å¤§å¥‡æ©‹ã€‚éæ©‹è²»550å††ã€‚", type: "sight" },
            { time: "16:00", title: "å…¥ä½ æ•·å³¶é¤¨", desc: "äº«å—æº«æ³‰èˆ‡å…è²»å®µå¤œæ‹‰éºµã€‚", type: "hotel" }
        ]},
        { date: "03/07", day: "å…­", location: "é«˜æ¾â†’è¿”å°", hotelIdx: 3, events: [
            { time: "09:00", title: "å‰å¾€é«˜æ¾æ©Ÿå ´", desc: "é‚„è»Šã€é€›æ©Ÿå ´å…ç¨…åº—ã€‚", type: "transport" },
            { time: "18:55", title: "é£›æ©Ÿèµ·é£› CI179", desc: "å¸¶è‘—æ»¿æ»¿å›æ†¶å›å®¶ï¼", type: "plane" }
        ]}
    ];

    // --- JS Logic ---

    // 1. åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        initPreTrip();
        initItinerary();
        initHotelPage();
        initExpense();
    });

    // 2. å°èˆªåˆ‡æ›
    function switchPage(pageId, navEl) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        navEl.classList.add('active');
        window.scrollTo(0,0);
    }

    // 3. è¡Œå‰æ¸…å–®é‚è¼¯
    function initPreTrip() {
        // ç”Ÿæˆç”¨æˆ¶ Tab
        const tabsContainer = document.getElementById('userTabs');
        users.forEach(u => {
            const btn = document.createElement('div');
            btn.className = `user-tab ${u === currentUser ? 'active' : ''}`;
            btn.innerText = u;
            btn.onclick = () => {
                currentUser = u;
                renderChecklist();
                document.querySelectorAll('.user-tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            };
            tabsContainer.appendChild(btn);
        });
        renderChecklist();
    }

    function renderChecklist() {
        const container = document.getElementById('checklistContainer');
        container.innerHTML = '';
        
        // å–å¾—è©²ç”¨æˆ¶çš„å„²å­˜ç‹€æ…‹
        const savedData = JSON.parse(localStorage.getItem(`checklist_${currentUser}`)) || {};

        const groups = [
            { id: 'before', title: 'æ—…éŠå‰æº–å‚™' },
            { id: 'carryOn', title: 'éš¨èº«è¡Œæ' },
            { id: 'checked', title: 'è¨—é‹è¡Œæ' }
        ];

        groups.forEach(g => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'checklist-group';
            groupDiv.innerHTML = `<h3>${g.title}</h3>`;
            
            checklistData[g.id].forEach(item => {
                const itemDiv = document.createElement('div');
                const isChecked = savedData[item] ? 'checked' : '';
                itemDiv.className = `checklist-item ${isChecked}`;
                itemDiv.innerHTML = `
                    <label style="display:flex; width:100%; align-items:center; cursor:pointer;">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleCheck('${item}', this)">
                        <span>${item}</span>
                    </label>
                `;
                groupDiv.appendChild(itemDiv);
            });
            container.appendChild(groupDiv);
        });
    }

    function toggleCheck(item, checkbox) {
        const savedData = JSON.parse(localStorage.getItem(`checklist_${currentUser}`)) || {};
        if (checkbox.checked) {
            savedData[item] = true;
            checkbox.closest('.checklist-item').classList.add('checked');
        } else {
            delete savedData[item];
            checkbox.closest('.checklist-item').classList.remove('checked');
        }
        localStorage.setItem(`checklist_${currentUser}`, JSON.stringify(savedData));
    }

    // 4. è¡Œç¨‹è¡¨é‚è¼¯
    function initItinerary() {
        const scroller = document.getElementById('dayScroller');
        const timeline = document.getElementById('timelineContainer');
        
        // ç”Ÿæˆæ—¥æœŸ Chips
        itinerary.forEach((day, index) => {
            const chip = document.createElement('div');
            chip.className = `day-chip ${index === 0 ? 'active' : ''}`;
            chip.innerText = `${day.date} (${day.day})`;
            chip.onclick = () => {
                document.querySelectorAll('.day-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                renderTimeline(index);
                chip.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            };
            scroller.appendChild(chip);
        });

        renderTimeline(0); // é è¨­é¡¯ç¤ºç¬¬ä¸€å¤©
    }

    function renderTimeline(dayIndex) {
        const data = itinerary[dayIndex];
        const container = document.getElementById('timelineContainer');
        container.innerHTML = '';

        // æ›´æ–°ç•¶æ—¥è³‡è¨Šå¡
        document.getElementById('currentLoc').innerText = data.location;
        const hotelName = hotels[data.hotelIdx] ? hotels[data.hotelIdx].name : "ç„¡ä½å®¿";
        document.getElementById('currentHotelName').innerText = hotelName;

        // ç”Ÿæˆäº‹ä»¶å¡ç‰‡
        data.events.forEach(event => {
            const el = document.createElement('div');
            el.className = 'card timeline-item';
            
            // Map Link Logic
            let mapBtnHtml = '';
            if (event.mapcode) {
                mapBtnHtml += `<div class="mapcode-box" onclick="copyMapcode('${event.mapcode}')">Mapcode: ${event.mapcode} <i class="far fa-copy"></i></div>`;
            }
            let googleLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.map || event.title)}`;

            // Image HTML (Placeholder logic)
            const imgHtml = event.img ? `<img src="${event.img}" class="event-img" style="display:block;" onclick="openLightbox('${event.img}')">` : '';

            el.innerHTML = `
                <div class="time-col">
                    <div>${event.time}</div>
                    <div class="time-line"></div>
                </div>
                <div class="event-card">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <div class="card-title">${event.title}</div>
                            ${event.jp ? `<span class="jp-name">${event.jp}</span>` : ''}
                        </div>
                        <a href="${googleLink}" target="_blank" class="btn btn-outline btn-sm"><i class="fas fa-location-arrow"></i> å°èˆª</a>
                    </div>
                    <div class="card-tag" style="display:inline-block; margin:5px 0;">${getTypeName(event.type)}</div>
                    <p style="font-size:0.9rem; color:#666; margin:5px 0;">${event.desc}</p>
                    ${mapBtnHtml}
                    ${imgHtml}
                    <div style="text-align:right; margin-top:5px;">
                        <span style="font-size:0.8rem; color:var(--primary); cursor:pointer;" onclick="toggleDetails(this)">å±•é–‹è©³æƒ… <i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="event-details">
                        <p><strong>ç‡Ÿæ¥­æ™‚é–“ï¼š</strong> è«‹ç¢ºèª Google Maps</p>
                        <p><strong>å»ºè­°ï¼š</strong> æˆªåœ–ä¿å­˜è¨‚ä½ä»£è™Ÿã€‚</p>
                        </div>
                </div>
            `;
            container.appendChild(el);
        });
    }

    function getTypeName(type) {
        const map = { food: "ç¾é£Ÿ", sight: "æ™¯é»", shop: "è³¼ç‰©", hotel: "ä½å®¿", transport: "äº¤é€š", activity: "æ´»å‹•" };
        return map[type] || "å…¶ä»–";
    }

    function toggleDetails(btn) {
        const details = btn.parentElement.nextElementSibling;
        if (details.style.display === 'block') {
            details.style.display = 'none';
            btn.innerHTML = 'å±•é–‹è©³æƒ… <i class="fas fa-chevron-down"></i>';
        } else {
            details.style.display = 'block';
            btn.innerHTML = 'æ”¶èµ·è©³æƒ… <i class="fas fa-chevron-up"></i>';
        }
    }

    function copyMapcode(code) {
        navigator.clipboard.writeText(code).then(() => alert('Mapcode å·²è¤‡è£½: ' + code));
    }

    // 5. ä½å®¿é é¢é‚è¼¯
    function initHotelPage() {
        const container = document.getElementById('hotelListContainer');
        hotels.forEach(h => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <img src="${h.img}" class="hotel-img-preview" onclick="openLightbox('${h.img}')">
                <h3 class="card-title">${h.name}</h3>
                <p style="font-size:0.9rem; margin:5px 0;"><i class="far fa-calendar-alt"></i> ${h.dates} | <i class="fas fa-map-marker-alt"></i> ${h.city}</p>
                <div class="hotel-note"><i class="fas fa-info-circle"></i> ${h.note}</div>
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <a href="tel:${h.phone}" class="btn btn-sm btn-outline"><i class="fas fa-phone"></i> é›»è©±</a>
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.name)}" target="_blank" class="btn btn-sm"><i class="fas fa-map"></i> å°èˆª</a>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // 6. è¨˜å¸³é‚è¼¯
    let expenses = JSON.parse(localStorage.getItem('tripExpenses')) || [];
    let payer = null;

    function selectPayer(p) {
        payer = p;
        document.querySelectorAll('.payer-option').forEach(el => el.classList.remove('selected'));
        event.target.classList.add('selected');
    }

    function addExpense() {
        const name = document.getElementById('expenseName').value;
        const cost = parseFloat(document.getElementById('expenseCost').value);
        
        if (!name || !cost || !payer) {
            alert('è«‹å¡«å¯«å®Œæ•´ä¸¦é¸æ“‡ä»˜æ¬¾äºº');
            return;
        }

        const exp = { id: Date.now(), name, cost, payer, date: new Date().toLocaleDateString() };
        expenses.push(exp);
        localStorage.setItem('tripExpenses', JSON.stringify(expenses));
        renderExpenses();
        
        // Reset
        document.getElementById('expenseName').value = '';
        document.getElementById('expenseCost').value = '';
    }

    function initExpense() {
        renderExpenses();
    }

    function renderExpenses() {
        const list = document.getElementById('expenseList');
        list.innerHTML = '';
        const balances = { L:0, K:0, R:0, Y:0, J:0 };

        expenses.forEach(e => {
            // åˆ—è¡¨
            const li = document.createElement('li');
            li.className = 'expense-item';
            li.innerHTML = `
                <div class="expense-info">
                    <h4>${e.name}</h4>
                    <span>${e.payer} ä»˜æ¬¾ (${e.date})</span>
                </div>
                <div>
                    <span class="expense-amount">Â¥${e.cost}</span>
                    <i class="fas fa-trash-alt btn-delete" onclick="deleteExpense(${e.id})"></i>
                </div>
            `;
            list.appendChild(li);

            // è¨ˆç®—çµç®—
            // é‚è¼¯ï¼šç¸½é¡ e.costã€‚ä»˜æ¬¾äºº e.payer å…ˆå‡ºäº† e.costã€‚
            // å¯¦éš›æ¯äººæ‡‰ä»˜ e.cost / 5ã€‚
            // æ‰€ä»¥ä»˜æ¬¾äººã€Œå¤šä»˜äº†ã€ e.cost * (4/5)ã€‚å…¶ä»–äººã€Œæ¬ ã€ e.cost / 5ã€‚
            const perPerson = e.cost / 5;
            users.forEach(u => {
                if (u === e.payer) {
                    balances[u] += (e.cost - perPerson); // ä»–å¤šä»˜çš„ (æ­£å€¼ä»£è¡¨åˆ¥äººæ¬ ä»–)
                } else {
                    balances[u] -= perPerson; // ä»–å°‘ä»˜çš„ (è² å€¼ä»£è¡¨ä»–æ¬ äºº)
                }
            });
        });

        // æ¸²æŸ“çµç®—
        const summaryDiv = document.getElementById('debtSummary');
        let html = '';
        users.forEach(u => {
            const val = balances[u];
            if (val < 0) {
                html += `<div>ğŸ”´ <strong>${u}</strong> éœ€æ‹¿å‡º Â¥${Math.abs(val).toFixed(0)}</div>`;
            } else if (val > 0) {
                html += `<div>ğŸŸ¢ <strong>${u}</strong> æ‡‰æ”¶å› Â¥${val.toFixed(0)}</div>`;
            } else {
                html += `<div>âšª ${u} æ”¶æ”¯å¹³è¡¡</div>`;
            }
        });
        summaryDiv.innerHTML = html || 'å°šç„¡æ”¯å‡º';
    }

    function deleteExpense(id) {
        if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†æ”¯å‡ºï¼Ÿ')) {
            expenses = expenses.filter(e => e.id !== id);
            localStorage.setItem('tripExpenses', JSON.stringify(expenses));
            renderExpenses();
        }
    }

    // 7. Lightbox
    function openLightbox(src) {
        document.getElementById('lightboxImg').src = src;
        document.getElementById('lightbox').classList.add('active');
    }
    function closeLightbox() {
        document.getElementById('lightbox').classList.remove('active');
    }

</script>

</body>
</html>