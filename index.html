<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>2026 四國巡禮</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/icon/apple-touch-icon-180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/icon/apple-touch-icon-167.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-touch-icon-152.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icon/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icon/favicon-16.png">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#F6F3EE" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>	
  <script>
    const TAG_SVGS = {
      takagi: ['./photos/takagi_01_nobg_v2.svg', './photos/takagi_02_nobg_v2.svg']
    };
    function getTagIconHtml(tag, idx){
      const t = (tag||'').toLowerCase();
      if(t==='takagi' && TAG_SVGS.takagi){
        const src = TAG_SVGS.takagi[idx % TAG_SVGS.takagi.length];
        return `<img class="tag-svg" src="${src}" alt="takagi" />`;
      }
      return '';
    }
  </script>				
  <script>
/*      1. 設定你的 GAS API URL */
    const G_API_URL = "https://script.google.com/macros/s/AKfycbz616eqN_z7nL7MvLo6vH98aeOzuD0DxWDquo5LnTnqOPbF8Qqtk1fwbLP-OEdl9pMW/exec"; // 貼上剛才步驟 1 得到的網址
/*     const G_TOKEN = "shikoku_2026_secret"; // 必須與 GAS 內的設定一致 */
/*      2. 改為從 Cookie 讀取 Token */
    let G_TOKEN = getCookie("trip_auth_token") || "";
  
/*      --- Cookie 操作函式 --- */
    function setCookie(name, value, days) {
      let expires = "";
      if (days) {
        let date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Strict";
    }
  
    function getCookie(name) {
      let nameEQ = name + "=";
      let ca = document.cookie.split(';');
      for(let i=0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }
  </script>


  <!-- ✅ Serif + Sans（標題日系感） -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Noto+Serif+TC:wght@600;700;900&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --bg-body:#F6F3EE;
      --bg-card:rgba(255,255,255,.72);
      --ink:#1E1E1E;
      --ink2:#6F6A62;
      --divider:#E9E1D6;
      --text-sec: var(--ink2);

      --primary:#2B2723;
      --accent:#B08A5B;

      --radius-L:28px;
      --radius-M:20px;
      --radius-S:14px;

      --shadow-soft:0 10px 26px rgba(0,0,0,.08);
    }
    *, *::before, *::after { box-sizing: border-box; }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      font-family:'Noto Sans TC',sans-serif;
      background:var(--bg-body);
      color:var(--ink);
      margin:0;
      padding-bottom:calc(90px + env(safe-area-inset-bottom));
      overscroll-behavior-y:none;
    }
    body.body-no-scroll{ overflow:hidden; }

    .app-header{
      padding:calc(20px + env(safe-area-inset-top)) 20px 16px;
      text-align:center;
      background:linear-gradient(to bottom, rgba(246,243,238,1), rgba(246,243,238,.82));
    }

    .app-header h1{
        margin:0;
        font-family:'Noto Sans TC',sans-serif;
        font-size:1.75rem;     /* 原本 2.2rem → 縮小 */
        font-weight:900;
        letter-spacing:.12em;
        display:flex;
        justify-content:center;
        align-items:baseline;
        gap:10px;
    }
    /* subtitle + year 同列：置中、左右排列 */
    .hdr-subrow{
      margin-top:8px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
    }

    #hdrSub{
      margin:0;
      font-size:.92rem;
      color:var(--ink2);
      font-weight:700;
      text-align:center;
    }


    .year-pill{
        font-family:'Noto Sans TC',sans-serif;
        font-size:.70rem;
        font-weight:900;
        padding:3px 8px;
        border-radius:999px;
        border:1px solid rgba(176,138,91,.55);
        background:rgba(255,255,255,.65);
        color:#7D5B34;
    }

    .app-header p{
        margin:8px 0 0;
        font-size:.92rem;
        color:var(--ink2);
        font-weight:700;
        text-align:center;
    }
    /* 假名小一行淡淡置中 */
    .hdr-kana{
      margin-top:6px;
      text-align:center;
      font-size:.72rem;
      letter-spacing:.06em;
      color:rgba(43,39,35,.35);
      font-weight:600;
    }

    .page{ display:none; padding:0 20px; animation:fadeIn .28s ease; }
    .page.active{ display:block; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    .card{
      background:var(--bg-card);
      border:1px solid rgba(233,225,214,.85);
      border-radius:var(--radius-L);
      padding:22px;
      margin-bottom:18px;
      box-shadow:var(--shadow-soft);
      backdrop-filter: blur(10px);
    }
    .section-title{
      font-size:1.05rem; font-weight:900; margin-bottom:14px;
      display:flex; align-items:center; gap:10px;
      font-family:'Noto Serif TC', serif;
    }
    .section-title i{ color:#8B8175; }

    .btn{
      background:var(--primary); color:#fff; border:none;
      padding:14px; border-radius:var(--radius-S);
      font-weight:800; width:100%; font-size:1rem; cursor:pointer;
      transition:transform .1s;
    }
    .btn:active{ transform:scale(.98); }
    .btn-outline{
      background:transparent;
      border:1.5px solid rgba(43,39,35,.35);
      color:var(--primary);
      font-weight:900;
    }

    /* tabs */
    .user-tabs{
      display:flex; gap:8px; margin-bottom:16px;
      background:rgba(233,225,214,.9); padding:4px; border-radius:14px;
    }
    .user-tab{
      flex:1; text-align:center; padding:10px 0; border-radius:10px;
      font-weight:800; font-size:.9rem; color:var(--ink2);
      cursor:pointer; transition:.2s;
    }
    .user-tab.active{
      background:#fff;
      color:var(--primary);
      box-shadow:0 6px 16px rgba(0,0,0,.10);
    }

    /* ===== Money: participant chips + type segmented ===== */
    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:10px 0 12px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(233,225,214,.9);
      background:rgba(255,255,255,.78);
      font-weight:900;
      font-size:.85rem;
      color:var(--primary);
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .chip:active{ transform:scale(.98); }
    .chip.on{
      border-color:rgba(176,138,91,.65);
      box-shadow:0 10px 22px rgba(0,0,0,.08);
    }
    .chip.off{
      opacity:.45;
    }
    .seg{
      display:flex;
      gap:6px;
      background:rgba(233,225,214,.9);
      padding:4px;
      border-radius:14px;
      margin:8px 0 12px;
    }
    .seg-btn{
      flex:1;
      text-align:center;
      padding:10px 0;
      border-radius:10px;
      font-weight:900;
      font-size:.9rem;
      color:var(--ink2);
      cursor:pointer;
      transition:.2s;
      user-select:none;
    }
    .seg-btn.active{
      background:#fff;
      color:var(--primary);
      box-shadow:0 6px 16px rgba(0,0,0,.10);
    }
    .exp-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:.78rem;
      border:1px solid rgba(233,225,214,.9);
      background:rgba(255,255,255,.7);
      color:rgba(43,39,35,.72);
    }
    .exp-badge.prepaid{ border-color:rgba(176,138,91,.35); background:rgba(255,247,229,.9); }
    .exp-badge.trip{ background:rgba(242,242,247,.92); }

    /* checklist */
    .checklist-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .check-item{
      background:rgba(255,255,255,.65);
      border:1px solid rgba(233,225,214,.8);
      border-radius:var(--radius-S);
      padding:14px 6px;
      text-align:center;
      font-size:.85rem;
      font-weight:700;
      display:flex; flex-direction:column; align-items:center; gap:8px;
      cursor:pointer;
      transition:.2s;
    }
    .check-item i{ font-size:1.35rem; color:#B9B2AA; }
    .check-item.checked{
      background:rgba(232,245,233,.9);
      border-color:rgba(52,199,89,.65);
      color:#2E7D32;
    }
    .check-item.checked i{ color:#34C759; }

    /* 全員待辦 */
    .todo-li{
      display:flex; align-items:flex-start; gap:10px;
      padding:10px 0; border-bottom:1px solid rgba(233,225,214,.8);
    }
    .todo-li:last-child{ border-bottom:none; }
    .todo-li input{ width:18px; height:18px; margin-top:2px; accent-color:#8C6B43; }
    .todo-title a{ color:inherit; text-decoration:none; font-weight:900; }
    .todo-title span{ font-weight:900; }
    .todo-note{ font-size:.85rem; color:var(--ink2); margin-top:4px; line-height:1.45; }


    .day-hero{
        margin:6px 0 14px;
        border-radius:24px;
        overflow:hidden;
        border:1px solid rgba(233,225,214,.9);
        box-shadow:0 10px 26px rgba(0,0,0,.08);
        background:rgba(255,255,255,.6);
    }

    .hero-track{
        display:flex;
        overflow-x:auto;
        scroll-snap-type:x mandatory;
        scrollbar-width:none;
    }
    .hero-track::-webkit-scrollbar{ display:none; }

    .hero-slide{
        flex:0 0 100%;
        aspect-ratio: 16 / 9;   /* ✅ 固定 16:9 */
        height:auto;            /* ✅ 不用固定高度 */
        scroll-snap-align:start;
        position:relative;
        overflow:hidden;
    }
    .hero-slide .hero-img{
        width:100%;
        height:100%;
        object-fit:cover;
        display:block;
    }
    /* 背景層：填滿 + 模糊 */
    .hero-slide.hero--blur .hero-bg{
      position:absolute;
      inset:-18px;                 /* 避免 blur 露邊 */
      width:100%;
      height:100%;
      object-fit:cover;
      filter: blur(18px) saturate(1.05) brightness(1.05);
      transform: scale(1.12);
    }

    /* 前景層：完整顯示（不裁切） */
    .hero-slide.hero--blur .hero-img{
      position:relative;
      width:100%;
      height:100%;
      object-fit:cover;          /* ✅ 關鍵 */
      display:block;
    }

    /* 可選：再加一層淡暗幕，讓字更穩 */
    .hero-slide.hero--blur::after{
      content:"";
      position:absolute;
      inset:0;
       background: transparent;
      pointer-events:none;
    }


    .hero-dots{
		  display:none;
		position:absolute;
		  left:0; right:0; bottom:10px;
		  display:flex;
		  justify-content:center;
		  gap:6px;
		  pointer-events:auto;
    }
    .hero-dot{
        width:6px; height:6px;
        border-radius:50%;
        background:transparent;
    }
    .hero-dot.active{ background:rgba(255,255,255,.95); }

    .hero-overlay{
      position:absolute;
      left:12px;                      /* 距左 12 */
      right:12px;                     /* 距右 12（等於容器有左右留白） */
      bottom:2px;                     /* ✅ 貼近圖片底部（想更貼就改 4px 或 0） */
      display:flex;                   /* 讓左右兩塊分開放 */
      justify-content:space-between;  /* 左：hero-loc / 右：hero-caption */
      align-items:flex-end;           /* 兩者都貼齊底部 */

      gap:12px;                       /* 左右之間的安全距離 */
      max-width:none;                 /* ✅ 不要用 75% 限制，不然右邊會被擠 */
      pointer-events:none;            /* 可選：避免遮到滑動/點擊 */
    }

    .hero-loc{
      pointer-events:auto;
      display:inline-flex;
      align-items:center;
      gap:8px;

      /* ✅ 橢圓膠囊底：很淡，但可讀性大幅提升 */
      padding:4px 10px;                 /* 讓膠囊有呼吸空間 */
      border-radius:999px;              /* 橢圓 */
      background: rgba(0,0,0,.18);      /* 很淡的黑底（你可在 .14~.24 間調） */

      /* ✅ 字不要太粗，但要清楚 */
      color: rgba(255,255,255,.95);
      font-size:.90rem;
      font-weight:400;                  /* 700 → 600 更自然 */

      /* ✅ 淡描邊：讓亮背景上也不會消失 */
      border: 1px solid rgba(255,255,255,.18);

      /* ✅ 文字陰影：補強對比 */
      text-shadow: 0 2px 10px rgba(0,0,0,.60);

      /* ✅ 取消毛玻璃（維持你需求） */
      backdrop-filter:none;
      -webkit-backdrop-filter:none;
    }

    .hero-caption{
      pointer-events:auto;            /* 若 caption 需要可點擊 */
      padding:3px 8px;                      /* ✅ 不要底、不要內距，視覺更貼底 */
      background:rgba(0,0,0,.18);         /* ✅ 不要底色 */
      border-radius:0;
      border:1px solid rgba(255,255,255,.18); /* ✅ 淡外框 */

      color:#fff;                     /* ✅ 白色 */
      font-weight:900;
      font-size:1rem;               /* ✅ 字變大（你可改 1rem / 1.05rem） */
      line-height:1.15;               /* ✅ 讓文字更緊湊不會浮起來 */

      text-align:right;               /* ✅ 右下角對齊 */
      text-shadow:0 2px 10px rgba(0,0,0,.65); /* ✅ 保持清楚 */
      transform:translateY(-2px);             /* ✅ 上移 2px */

      margin:0;                       /* ✅ 避免被預設 margin 撐開 */
      -webkit-text-stroke: .4px rgba(0,0,0,.35);
      /* backdrop-filter: blur(6px); */     /* ❌ 取消毛玻璃 */
      /* -webkit-backdrop-filter: blur(6px); */
    }






    /* date chip 是最上面日期 星期 Day */
    .date-chip{
      flex:0 0 auto;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(233,225,214,.9);
      border-radius:16px;
      padding:8px 8px;
      text-align:center;
      min-width:45px;
      box-shadow:0 10px 24px rgba(0,0,0,.08);
      transition:.2s;
      cursor:pointer;
	  position:relative;
    }
    .date-chip .day{
      font-family:'Noto Serif TC', serif;
      font-size:.90rem;
      font-weight:900;
      letter-spacing:.02px;
      line-height:1.05;
    }
    .date-chip .date{
      font-size:.60rem;
      font-weight:900;
      color:var(--ink2);
      margin-top:2px;
      line-height:1.05;
    }
    .date-chip .wk{
        margin-top:2px;
        font-family:'Noto Sans TC', sans-serif;
        font-size:.50rem;        /* 星期更小 */
        font-weight:900;
        color:rgba(43,39,35,.45);
        letter-spacing:.14em;
        text-transform:uppercase;
        line-height:1.05;
    }
    .date-chip.active{
        background:#fff;
        border-color:rgba(176,138,91,.75);
        box-shadow:0 16px 34px rgba(0,0,0,.12);
        transform:translateY(-2px) scale(1.03);
    }
    .date-chip.active .day{ color:#724b1d; }

        /* date scroller */
    .date-scroller{
      display:flex; gap:8px; overflow-x:auto; padding:4px 16px 8px;
      margin:0 -20px; scrollbar-width:none;
    }
    .date-scroller::-webkit-scrollbar{ display:none; }

    /* weather */
    .weather-strip{
      display:flex; gap:20px; overflow-x:auto;
      padding-bottom:10px; margin-bottom:14px;
      scrollbar-width:none;
      border-bottom:1px solid var(--divider);
    }
    .weather-strip::-webkit-scrollbar{ display:none; }
    .weather-hour{ text-align:center; flex:0 0 auto; }
    .w-time{ font-size:.8rem; color:var(--ink2); margin-bottom:5px; font-weight:800; }
    .w-icon{ font-size:1.15rem; margin-bottom:5px; color:#8B8175; }
    .w-temp{ font-weight:900; font-size:.9rem; color:var(--primary); }



    /* ✅ 讓每一列：左時間、右內容 固定對齊 */
    .timeline-item{
        display:grid;
        grid-template-columns: 64px 1fr;
        column-gap:12px;
        align-items:start;
        margin-bottom:18px; 
        cursor:pointer; 

	/* --- 新增：防止系統選單干擾長壓 --- */
        -webkit-touch-callout: none; /* 禁用 iOS 長壓彈出選單 */
        -webkit-user-select: none;   /* 禁止長壓選取文字 */
        user-select: none;           /* 標準屬性 */
        touch-action: pan-y;         /* 允許垂直捲動，但防止其他觸控手勢衝突 */
    }
    .tl-time{
      min-width:56px;
      font-family:'Roboto Mono', monospace;
      font-weight:700;
      color:var(--ink2);
      text-align:right;
      padding-top:6px;
      font-size:1rem;
    }
    


    .tl-content{
      position:relative;
      flex:1;
      min-width:0;
      background:rgba(255,255,255,.78);
      border:1px solid rgba(233,225,214,.9);
      border-radius:var(--radius-M);
      padding:10px 16px 10px;
      box-shadow:0 14px 30px rgba(0,0,0,.07);
      transition:transform .12s ease;
    }
    .tl-content:active{ transform:scale(.985); }

    .tl-content > .reserve-badge{
      position:absolute;
      top:10px;
      right:12px;
      left:auto; 
      display:inline-block;
      font-size:.6rem;
      line-height:1;
      letter-spacing:.08em;
      padding:4px 8px;
      border:1.6px solid rgba(180,35,24,.72);
      color:rgba(180,35,24,.92);
      background:rgba(255,255,255,.86);
      border-radius:8px;
      transform:rotate(-8deg);
      transform-origin:top right;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      z-index:2;                         /* ✅確保不被 tag/標籤蓋住 */
      pointer-events:none;               /* 可選：避免擋點擊 */
      
    }


    .tl-tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      font-size:.55rem;
      font-weight:900;
      letter-spacing:.12em;
      margin:0 0 6px 0;   /* 只留底部一點點距離 */
      line-height:1;     /* ✅ 讓高度更緊 */
      text-transform:uppercase;
      color:#a5a39f;
    }
    .tl-tag::before{
      content:'';
      width:8px; height:8px;
      border-radius:50%;
      display:inline-block;
      background:#B9B2AA;
    }
    .tag-food::before{ background:#D28A3A; }
    .tag-sight::before{ background:#2F8F5B; }
    .tag-transport::before{ background:#3D6EA9; }
    .tag-takagi::before{ background:#f574ef; }
    .tag-hotel::before{ background:#7A4FA8; }
    .tag-shop::before{ background:#e1c820; }

    .tl-title{
      font-family:'Noto Serif TC', serif;
      font-size:1.1rem;
      font-weight:900;
      margin-bottom:6px;
      line-height:1.15;
      letter-spacing:.2px;
    }
    .tl-desc{
      font-size:.92rem;
      color:var(--ink2);
      line-height:1.5;
      display:-webkit-box;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    /* ✅ 小行程：灰底的「預計停留/車程」膠囊 */
    .tl-meta{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }
    .tl-chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:#F2F2F7;
      color:#555;
      font-size:.85rem;
      font-weight:800;
    }
    .tl-chip i{ color:#8E8E93; }
    /* ===== highlight（加厚光暈 + 星星）===== */
    .tl-content.highlight{
      position:relative;
      border-color: rgba(176,138,91,.70);
      /* 保留原本白底 + 加一層淡淡日系金色角落漸層 */
      background:
        linear-gradient(135deg, rgba(176,138,91,.14), rgba(176,138,91,0) 55%),
        rgba(255,255,255,.78);
      box-shadow:
        0 14px 30px rgba(0,0,0,.10),
        0 0 0 1px rgba(176,138,91,.22),
        0 0 28px rgba(176,138,91,.40); /* ✅光暈更厚 */
    }

    /* 外層光暈（你想要更厚就調 blur / opacity / inset） */
    .tl-content.highlight::before{
      content:"";
      position:absolute;
      inset:-12px;                 /* ✅更外擴 */
      border-radius: calc(var(--radius-M) + 14px);
      background:
        radial-gradient(circle at 30% 20%,
          rgba(176,138,91,.45), rgba(176,138,91,0) 60%);
      filter: blur(14px);          /* ✅更厚 */
      opacity: .95;
      z-index:-1;
      pointer-events:none;
    }

    /* 星星 badge（用 ::after 放回來） */
    .tl-content.highlight::after{
      content:"★";
      position:absolute;
      top:10px;
      right:12px;
      width:26px; height:26px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(176,138,91,.95);
      color:#fff;
      font-size:14px;
      box-shadow:0 10px 22px rgba(176,138,91,.45);
    }


    .tl-tag .tag-ico{
        color:#7E7469;
        opacity:.65;
        font-size:.78rem;
        margin-left:2px;
    }
    .day-route-card{
      margin:10px 0 12px;
      background:rgba(255,255,255,.72);
      border:1px solid rgba(233,225,214,.9);
      border-radius:24px;
      padding:14px 16px;
      box-shadow:0 10px 26px rgba(0,0,0,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .day-route-card .txt{
      font-weight:900;
      line-height:1.2;
    }
    .day-route-card .sub{
      margin-top:4px;
      font-size:.86rem;
      color:var(--ink2);
      font-weight:700;
    }




    /* ===== Modal: bottom sheet ===== */
    .modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.38);
      z-index:2000;
      opacity:0; pointer-events:none;
      transition:opacity .12s ease;
    }

    /* 點開小程式懸浮的 */
    .modal-sheet{
      position:fixed;
      left:50%;
      background:#FAF7F2;     /* ✅ 一定要有 */
      box-shadow:0 18px 70px rgba(0,0,0,.22); /* ✅ 讓它像真的浮起來 */
      bottom:max(14px, env(safe-area-inset-bottom));
      transform:translateX(-50%) translateY(120%);
      width:min(760px, calc(100vw - 24px));

      /* ✅ 用 dvh 比 vh 穩（手機網址列縮放不亂跳） */
      max-height:calc(100dvh - 24px - env(safe-area-inset-top));
      background:#FAF7F2;
      z-index:2001;
      border-radius:28px;
      border:1px solid rgba(233,225,214,.95);
      box-shadow:0 22px 60px rgba(0,0,0,.18);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      /* transition:transform .18s cubic-bezier(.16,1,.3,1); */
      transform: translateX(-50%) translateY(calc(100dvh + 60px)); /* ✅ 徹底移出視窗 */
      visibility: hidden;    /* ✅ 連陰影都不會露 */
      pointer-events: none;  /* ✅ 不會吃到點擊 */
      will-change: transform;
    }

    .modal-sheet.active{ 
      transform: translateX(-50%) translateY(0);
      visibility: visible;
      pointer-events: auto;
     }

    /* ✅ Header 不滾動，永遠在上方 */
    .modal-header{
      position:relative;
      flex:0 0 auto;
      padding:4px 0 2px;
      background:#FAF7F2;
      border-bottom:1px solid rgba(233,225,214,.75);
    }

    /* 拖曳條保持置中 */
    .modal-drag-handle{
      width:44px; height:5px;
      background:#D8CFC4;
      border-radius:99px;
      margin:8px auto 6px;
      flex-shrink:0;
    }

    /* ✅ X 永遠可見（在 header 內） */
    .modal-x{
      position:absolute;
      right:12px;
      top:8px;
      width:30px; height:30px;  /* ✅ 圓圈小一點 */
      border-radius:50%;
      display:grid;              /* ✅ 保證置中 */
      border:1px solid rgba(233,225,214,.95);
      background:#fff;
      font-size:20px;
      line-height:1;             /* ✅ 防止 baseline 視覺偏移 */
      cursor:pointer;
      align-items:center; 
      justify-content:center;
      z-index:10;
    }

    /* 內容滾動只在這裡發生 */
    .modal-scroll{
      flex:1;
      overflow-y:auto;
      padding:0 18px 16px;
      background:#FAF7F2;           /* ✅ 防止透出看到背後 */
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
    }



    /* sticky 區塊固定在 點開小行程內容滾動區頂端 */
    #modalSticky{
        position: sticky;
        top: 0;
        z-index: 30;
        background:#FAF7F2;
        margin:0 -18px;               /* ✅ 抵消左右 padding，貼齊邊 */
        padding:10px 18px 8px;       /* ✅ 把原本的上方空間放回這裡 */
        border-bottom: 1px solid rgba(233,225,214,.75);
        box-shadow:0 6px 18px rgba(0,0,0,.06); /* 「浮在上面」，可以再加一點淡陰影*/
    }

    /* 左邊彩色直槓（用 tag 類別控制顏色） */
    .modal-sticky-wrap{
        position: relative;
        padding-left: 14px;
    }
    .modal-overlay.active{
      opacity:1;
      pointer-events:auto;
    }

    .modal-sticky-wrap::before{
        content:'';
        position:absolute;
        left:-18px;
        top:6px;
        bottom:6px;
        width:4px;
        border-radius:0 999px 999px 0;
        background:#B9B2AA; /* default */
    }
    .modal-sticky-wrap.tag-food::before{ background:#D28A3A; }
    .modal-sticky-wrap.tag-sight::before{ background:#2F8F5B; }
    .modal-sticky-wrap.tag-takagi::before{ background:#f574ef; }
    .modal-sticky-wrap.tag-transport::before{ background:#3D6EA9; }
    .modal-sticky-wrap.tag-hotel::before{ background:#7A4FA8; }
    .modal-sticky-wrap.tag-shop::before{ background:#e1c820; }


    .sheet-head{
      display:flex;
      align-items:center;
      gap:10px; 
      /* padding:6px 2px 10px; */
    }
    /* === Modal tag：水印感（不加框）=== */
    .sheet-tag{
        display:inline-flex;
        align-items:center;
        gap:6px;

        /* 拿掉框框感 */
        padding:0;
        border:none;
        background:transparent;

        font-size:.62rem;
        font-weight:900;
        letter-spacing:.14em;
        text-transform:uppercase;
        color:#A5A39F;
        line-height:1;
    }

    .sheet-tag::before{
        content:"";
        width:8px; height:8px;
        border-radius:50%;
        position:relative;
        background:#B9B2AA;
        display:inline-block;
    }

    /* 直接沿用你原本的 tag 顏色點 */
    .sheet-tag.tag-food::before{ background:#D28A3A; }
    .sheet-tag.tag-sight::before{ background:#2F8F5B; }
    .sheet-tag.tag-takagi::before{ background:#f574ef; }
    .sheet-tag.tag-transport::before{ background:#3D6EA9; }
    .sheet-tag.tag-hotel::before{ background:#7A4FA8; }
    .sheet-tag.tag-shop::before{ background:#2A6FA0; }

	/* Takagi SVG icon inside tag */
    .tag-svg{ width:16px; height:16px; display:inline-block; vertical-align:-3px; }
    .sheet-tag.tag-takagi{ color:#f574ef; }

								
    /* /* ✅ 只縮 modal 內的 tag（不影響外面列表）
    .sheet-head .tl-tag{
        padding:4px 8px;
        margin:0;                 /* ✅ 取消原本 margin-bottom:10px */
        /* font-size:.52rem;
        letter-spacing:.10em;
        border-radius:999px;
    } */
    .sheet-time{
      font-family:'Noto Serif TC', serif;
      display:inline-flex;
      align-items:center; 
      font-size:.86rem;
      font-weight:900;
      color:#2B2723;
      line-height:1;
      gap:6px;  
    }
    /* ===== Sheet Splash (open modal show image for ~5s) ===== */
    /* ===== Sheet Splash (camera frame + pop) ===== */
    .sheet-splash{
      position:absolute;
      inset:0;
      z-index:2600;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px;

      /* 不要死灰：改成鏡頭遮光感 */
      background:
        radial-gradient(circle at 50% 40%,
          rgba(0,0,0,.18) 0%,
          rgba(0,0,0,.46) 55%,
          rgba(0,0,0,.62) 100%);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);

      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease;
    }




    .sheet-splash.active{
      opacity:1;
      pointer-events:auto;          /* 出現時吃點擊，避免誤觸內容 */
    }

    .sheet-splash img{
      width:100%;
      max-width:640px;
      max-height:72vh;
      object-fit:cover;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 26px 80px rgba(0,0,0,.38);
    }


    
    /* 取景框本體 */
    .splash-frame{
      width: min(720px, calc(100vw - 16px));
      max-width:660px;
      max-height: 86vh; 
      border-radius:22px;
      position:relative;
      overflow:hidden;

      /* 玻璃卡片感 */
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 28px 90px rgba(0,0,0,.38);

      transform: translateY(18px) scale(.94);
      opacity:0;
      animation: splashPop .34s cubic-bezier(.16,1,.3,1) forwards;
    }

    /* pop 動畫 */
    @keyframes splashPop{
      0%   { transform: translateY(18px) scale(.94); opacity:0; }
      60%  { transform: translateY(-2px) scale(1.01); opacity:1; }
      100% { transform: translateY(0) scale(1); opacity:1; }
    }

    /* 取景框四角（相機框） */
    .splash-frame::before,
    .splash-frame::after{
      content:"";
      position:absolute;
      inset:12px;
      border-radius:16px;
      pointer-events:none;
    }
    .splash-frame::before{
      /* 四角框線：用背景畫四個 L 角 */
      background:
        linear-gradient(#fff,#fff) left top/22px 2px no-repeat,
        linear-gradient(#fff,#fff) left top/2px 22px no-repeat,

        linear-gradient(#fff,#fff) right top/22px 2px no-repeat,
        linear-gradient(#fff,#fff) right top/2px 22px no-repeat,

        linear-gradient(#fff,#fff) left bottom/22px 2px no-repeat,
        linear-gradient(#fff,#fff) left bottom/2px 22px no-repeat,

        linear-gradient(#fff,#fff) right bottom/22px 2px no-repeat,
        linear-gradient(#fff,#fff) right bottom/2px 22px no-repeat;
      opacity:.55;
    }
    .splash-frame::after{
      border:1px solid rgba(255,255,255,.18);
      opacity:.8;
    }

    /* 1 張 / 2 張 */
    .splash-grid{
      display:grid;
      gap:10px;
      padding:10px;
      height: min(82vh, 680px);
    }
    .splash-grid.one{
      grid-template-columns:1fr;
      grid-template-rows: 1fr;
    }
    .splash-grid.two{
      grid-template-columns:1fr;
      grid-template-rows:1fr 1fr;
    }

    /* 圖片本體 */
    .splash-img{
      width:100%;
      height:100%;
      aspect-ratio: 16 / 9;
      object-fit:cover;
      object-position: center;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      box-shadow:0 18px 50px rgba(0,0,0,.25);
      display:none; /* JS 會決定顯示哪張 */
    }

    /* 兩張上下時，讓每張更像拍立得畫面 */
    .splash-grid.two .splash-img{
      aspect-ratio: 16 / 10;
    }

        /* ===== Shutter flash (120ms) ===== */
    .splash-frame{
      position:relative; /* 確保 flash 疊在框上 */
    }

    .splash-frame .shutter-flash{
      position:absolute;
      inset:0;
      border-radius:22px;
      background:rgba(255,255,255,.92);
      opacity:0;
      pointer-events:none;
    }

    .splash-frame.flash .shutter-flash{
      animation: shutterFlash 120ms ease-out 1;
    }

    @keyframes shutterFlash{
      0%   { opacity:0; }
      15%  { opacity:1; }
      100% { opacity:0; }
    }


    /* splash 出現時，禁止底下內容互動（保險） */
    #modalSheet.splash-on #modalScroll{
      pointer-events:none;
    }




    /* FOOD 外框 */
    .tag-chip{
        display:inline-flex;
        align-items:center;
        padding:4px 4px;
        border-radius:999px;
        border:1px solid rgba(233,225,214,.9);
        background:rgba(255,255,255,.55);
    }
.tag-chip.tag-food{ border-color:rgba(210,138,58,.55); }
.tag-chip.tag-sight{ border-color:rgba(47,143,91,.55); }
.tag-chip.tag-transport{ border-color:rgba(61,110,169,.55); }
.tag-chip.tag-hotel{ border-color:rgba(122,79,168,.55); }
.tag-chip.tag-shop{ border-color:rgba(225,200,32,.55); }

    .modal-title{
      font-family:'Noto Serif TC', serif;
      font-size:1.20rem;
      font-weight:900;
      line-height:1.18;
      margin:10px 0 10px 0;
      letter-spacing:.4px;
    }

    /* 地址/停車場/Mapcode */
    .meta-box{
      border-top:1px solid var(--divider);
      border-bottom:1px solid var(--divider);
      padding:7px 0;
      margin:8px 0 8px;
      gap:10px;               /* 左右間距縮 */
      color:var(--ink2);
    }
    .meta-row{
      display:flex;
      align-items:center; 
      gap:10px;
      padding:6px 0;
      font-size:.90rem;
      line-height:1.35;
    }
    .meta-ico{ 
        width:auto; 
        text-align:center; 
        flex:0 0 auto; 
        padding-top:0px;
        font-size:1.05rem;      /* icon 稍微小 */
    }
    .meta-val{
        font-size:.92rem;       /* ✅ 字小一點 */
        line-height:1.25;
        color:#6f6a62;
        min-width:0;              /* ✅ 允許正常換行，不把按鈕擠掉 */
        word-break:break-word;
    }

    .mini-btn{
      margin-left:auto;
      align-self:center;   /* ✅ 讓它貼齊第一行 */
      border:1px solid rgba(233,225,214,.95);
      justify-self:end;
      background:#fff;
      border-radius:10px;
      padding:5px 9px;
      font-size:.78rem;         /* ✅ 更小 */
      cursor:pointer;
      font-weight:900;
      color:#5F5A52;
      flex:0 0 auto;
    }


    .detail{
      font-size:1rem;
      color:#3A352E;
      line-height:1.7;
      white-space:pre-wrap;
      padding-left:1.05em;     /* ✅ 整段往右一點 */
      text-indent:-1.05em;     /* ✅ 第一行往左拉回來，形成「凸排」效果 */
    }

    .pill-row{ 
        margin:6px 0 2px; 
        display:flex; 
        flex-wrap:wrap; 
        gap:6px; 
    }
    .pill{
      display:inline-flex;
      gap:6px; align-items:center;
      padding:5px 8px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(233,225,214,.95);
      font-size:.78rem;
      font-weight:900;
      color:#5F5A52;
    }
    .pill i{ color:#8B8175; font-size:.85em;}

    .block{
      background:rgba(255,255,255,.72);
      border:1px solid rgba(233,225,214,.85);
      padding:14px;
      border-radius:var(--radius-M);
      margin:12px 0;
    }
    .block h4{
      margin:0 0 10px;
      font-size:1rem;
      font-weight:900;
      color:#2B2723;
      font-family:'Noto Serif TC', serif;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .bullet{ margin:0; padding-left:18px; line-height:1.7; color:#444; }

    .menu-recommend{
      background:#FFF8E1;
      border:1px solid #FFECB3;
      padding:15px;
      border-radius:var(--radius-M);
      margin:12px 0;
    }
    .menu-item{
      display:flex; justify-content:space-between; gap:12px;
      padding:6px 0;
      border-bottom:1px dashed #FFE082;
    }
    .menu-item:last-child{ border-bottom:none; }
    .jp-text{ font-weight:900; color:#5D4037; }

    .menuPillRow{ display:flex; flex-direction:column; gap:10px; }

    .menuPill{
      width:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255, 196, 0, .35);
      background:rgba(255,255,255,.75);
      cursor:pointer;
    }

    .menuPill .jp-text{ font-weight:900; color:#5D4037; }
    .menuPill .zh-text{ font-size:.9rem; color:#666; font-weight:800; margin-left:auto; }

    .menuSpeak{
      flex:0 0 auto;
      width:30px; height:30px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(233,225,214,.9);
      background:#fff;
    }

    .menuRecTag{
      flex:0 0 auto;
      font-size:.68rem;
      font-weight:900;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(180,35,24,.10);
      border:1px solid rgba(180,35,24,.25);
      color:rgba(180,35,24,.95);
    }


    .sheet-actions{
      position:sticky;
      bottom:0;
      padding:10px 0 2px;
      background:linear-gradient(to top, #FAF7F2 70%, rgba(250,247,242,0));
    }
    .btn-primary{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      width:100%;
      height:50px;
      border-radius:16px;
      border:1px solid rgba(176,138,91,.55);
      background:#fff;
      font-weight:900;
      text-decoration:none;
      color:#2B2723;
    }

    /* bottom nav */
    .bottom-nav{
      position:fixed; 
      bottom: 0;
      left:50%;
      transform:translateX(-50%);
      width:min(520px, calc(100vw - 40px));

      bottom:max(10px, env(safe-area-inset-bottom));
      padding:10px 0;

      background:rgba(255,255,255,.72);
      backdrop-filter:blur(20px);
      border-radius:24px;
      display:flex;
      justify-content:space-around;
      box-shadow:0 16px 50px rgba(0,0,0,.12);
      z-index:1000;
      border:1px solid rgba(233,225,214,.9); 
      /* background:rgba(255,255,255,.72);
      backdrop-filter:blur(20px);
      border-radius:24px;
      display:flex;
      justify-content:space-around;
      padding:10px 0 calc(10px + env(safe-area-inset-bottom));
      border:1px solid rgba(233,225,214,.9);
      box-shadow:0 16px 50px rgba(0,0,0,.12);
      z-index:1000;
      border:1px solid rgba(233,225,214,.9);
      align-items:flex-end; */
    }
    .nav-item{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;   /* ✅ 內容貼 bar 底 */
      gap:2px;
      font-size:.66rem;
      color:#B9B2AA;
      line-height:1;
    }

    .nav-item i{
      display:block;
      font-size:1.18rem;
      margin-bottom:0;            /* ✅ 不要再把文字往上推 */
    }
    .nav-item.active{ color:#2B2723; transform:translateY(-1px); }

    /* boarding */
    .boarding{
      background:rgba(255,255,255,.76);
      border-radius:var(--radius-L);
      box-shadow:var(--shadow-soft);
      overflow:hidden; margin-bottom:18px;
      border:1px solid rgba(233,225,214,.9);
      backdrop-filter: blur(10px);
    }
    .boarding-top{
      padding:18px 18px 14px;
      background:linear-gradient(135deg, rgba(176,138,91,.16), rgba(43,39,35,.06));
    }
    .boarding-top .row{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .boarding-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,.75);
      font-weight:900; font-size:.85rem;
      border:1px solid rgba(233,225,214,.9);
    }
    .boarding-mid{
      padding:14px 18px;
      display:flex; justify-content:space-between; align-items:center;
      border-top:1px dashed rgba(233,225,214,.95);
    }
    .code{
      font-family:'Noto Serif TC', serif;
      font-size:2.0rem;
      font-weight:900;
      color:#7D5B34;
      letter-spacing:1px;
    }
    .t{ color:var(--ink2); font-size:.9rem; margin-top:2px; font-weight:800; }
    .boarding-bottom{
      padding:14px 18px;
      border-top:1px solid rgba(233,225,214,.7);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color:var(--ink2); font-size:.9rem;
      font-weight:800;
    }
    .wx-head{
        display:flex;
        justify-content:space-between;
        align-items:baseline;
        margin-bottom:14px;
    }

    .wx-city{
        font-family:'Noto Serif TC', serif;
        font-size:1.25rem;
        font-weight:900;
        color:var(--primary);
    }

    .wx-label{
        font-size:.82rem;
        font-weight:900;
        color:var(--ink2);
        display:flex;
        align-items:center;
        gap:8px;
    }

    .link-grid{
        display:grid;
        grid-template-columns:1fr 1fr;
        gap:10px;
        margin-top:10px;
    }



    /* ===== Route strip (for drive/walk/train/flight/boat) ===== */
    .route-strip{
        display:flex;
        gap:14px;
        align-items:center;
        padding:10px 12px;        /* 更細長 */
        border-radius:16px;
        background:#F2F2F7;
        border:1px solid rgba(0,0,0,.04);
        box-shadow:0 6px 18px rgba(0,0,0,.06);
        width:100%;               /* ✅ 撐滿 */
        margin:0;                 /* ✅ 不要自己縮排 */
    }
    /* 想讓整張更「細長」一點就把 padding 降低 */

    .route-mins{
        flex:0 0 auto;
        font-family:'Roboto Mono', monospace;
        font-size:.65rem;         /* ✅ 縮小 */
        font-weight:900;
        color:#444;
        background:rgba(255,255,255,0.7);
        border-radius:999px;
        padding:5px 8px;
        white-space:nowrap;
    }

    /* 讓 route strip 內容左右分佈更漂亮 */
    .route-main{
        flex: 1;
        min-width: 0;
    }

        /* icon 尺寸（可微調） */
    .route-ico{
        width:38px;
        height:38px;
        border-radius:14px;
        display:flex;
        align-items:center;
        justify-content:center;
        background:rgba(255,255,255,0.55);
        flex:0 0 auto;
    }
    .route-ico i{ font-size:16px; color:var(--primary); }


    .route-title{
      font-weight:900;
      font-size:.95rem;
      letter-spacing:-.2px;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .route-sub{
      margin-top:4px;
      color:var(--text-sec);
      font-weight:700;
      font-size:.9rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .routeRow{
        display:flex;
        align-items:center;
        gap:12px;
        padding:10px 12px;
        border-radius:14px;
        max-width:100%;
        width:100%;
        overflow:hidden;            /* 防止內部東西撐破 */
    }

    .routeIcon{
        flex:0 0 36px;
        width:36px; height:36px;
        border-radius:12px;
        display:flex; align-items:center; justify-content:center;
    }

    .routeMain{
        flex:1 1 auto;
        min-width:0;                /* ✅ 超重要：允許中間欄位縮 */
    }

    .routeTitle{
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;     /* ✅ 長地名不撐破 */
    }

    .routeDuration{
        flex:0 0 auto;
        margin-left:auto;           /* ✅ 推到最右 */
        white-space:nowrap;
        padding:6px 10px;
        border-radius:999px;
    }



    /* duration / stay pill */
    .stay-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top:12px;
      background:#ECECF0;
      color:#333;
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:.60rem;
    }
    .stay-pill i{ color:#8E8E93; }




    /* 建議加保險：砍掉水平 overflow */
    html, body{ overflow-x:hidden; }
    /* ✅ route 直接吃滿整個容器寬度 */
    .timeline-item.route-item{
        display:block;         /* route 不用兩欄 grid */
        cursor: pointer;
        margin-bottom:18px;
    }

    /* route 卡片本體 */
    .route-item .route-strip{
        width:100%;
        max-width:100%;
        display:flex;
        align-items:center;
        gap:12px;
        padding:12px 16px;
        border-radius:16px;
        background:#EEF2FF;
        overflow:hidden;
    }
    /* 左側：小時間 + icon
    .route-left{
        flex:0 0 auto;
        display:flex;
        flex-direction:column;
        align-items:center;
        gap:6px;
    }

    .route-time-mini{
        font-size:12px;
        font-weight:800;
        color:#6B7280;
        line-height:1;
    } */



    /* 中間標題：可縮 + ... */
    .route-main{ flex:1 1 auto; min-width:0; }
    /* 文字區：上面時間，下面標題 */
    .route-time-top{
        font-size:12px;
        font-weight:800;
        color:#6B7280;
        line-height:1.1;
        margin-bottom:4px;
    }





    /* ===== Mobile layout guard ===== */
    .page, .app-header{
      max-width: 520px;
      margin-left:auto;
      margin-right:auto;
    }

    /* 右側：時間 + 導航按鈕（把 15min 移到這裡） */
    .route-cta{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      justify-content:center;
      gap:10px;
      flex:0 0 auto;
    }

    .route-time{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#ECECF0;
      font-weight:900;
      color:#333;
      white-space:nowrap;
    }

    .route-time i{ color:#8E8E93; }


    .route-card{
      margin:10px 0 14px;
      background:rgba(255,255,255,.72);
      border:1px solid rgba(233,225,214,.9);
      border-radius:24px;
      box-shadow:0 10px 26px rgba(0,0,0,.08);
      overflow:hidden;
    }

    .route-thumb{
      position:relative;
      aspect-ratio: 16 / 9;
      background:rgba(0,0,0,.06);
    }
    .route-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .route-thumb{
      position:relative;
      aspect-ratio:16/9;
      overflow:hidden;
      border-radius:0; /* 你卡片外層已經 rounded */
    }
    #routeMiniMap{
      width:100%;
      height:100%;
    }
    .route-thumb .leaflet-control-container{ display:none; } /* 隱藏放大縮小按鈕，像縮圖 */


    .route-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px 10px;
      gap:12px;
    }
    .route-title{
      font-weight:900;
      line-height:1.2;
    }
    .route-sub{
      margin-top:4px;
      font-size:.86rem;
      color:var(--ink2);
      font-weight:700;
    }

    .route-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(176,138,91,.35);
      background:rgba(255,255,255,.85);
      font-weight:900;
      color:#6E4B2A;
      white-space:nowrap;
    }
    .route-btn i{
      font-size:14px;
      transform: translateY(-.5px);
    }

    /* mini-map pins */
    .rm-pin{
      border-radius:999px;
      background:rgba(255,255,255,.92);
      border:2px solid rgba(60,110,210,.80);
      box-shadow:0 10px 22px rgba(0,0,0,.16);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .rm-pin span{
      font-family:'Roboto Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-weight:800;
      font-size:.74rem;
      color:rgba(40,70,150,.95);
    }
    .rm-pin.rm-start{
      border-color:rgba(34,139,34,.85);
    }
    .rm-pin.rm-start span{ color:rgba(22,110,22,.95); }
    .rm-pin.rm-end{
      border-color:rgba(180,35,24,.80);
    }
    .rm-pin.rm-end span{ color:rgba(180,35,24,.92); }
    .rm-pin.rm-stop{
      border-color:rgba(60,110,210,.78);
    }

    .menuRow{ display:flex; flex-wrap:wrap; gap:10px; }

    .menuPill{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(233,225,214,.95);
      background:#fff;
      font-weight:800;
      font-size:.9rem;
      cursor:pointer;
    }
    .menuPill.is-rec{
      border-color: rgba(176,138,91,.55);
      box-shadow: 0 10px 20px rgba(0,0,0,.06);
    }
    .menuSpeak{
      display:inline-flex; align-items:center; justify-content:center;
      width:28px; height:28px;
      border-radius:999px;
      border:1px solid rgba(233,225,214,.95);
      background:rgba(255,255,255,.9);
      color:#666;
    }
    .menuSpeak i{ font-size:14px; }

    .menuCardDesc{
      margin-top:10px;
      color:#4B5563;
      font-size:.95rem;
      line-height:1.55;
    }


    /* ===== menu 字卡 ===== */
    .menuCard{
      position:absolute;
      left:12px; right:12px;
      bottom:12px;
      border-radius:18px;
      border:1px solid rgba(233,225,214,.95);
      background:rgba(255,255,255,.96);
      box-shadow:0 18px 40px rgba(0,0,0,.18);
      overflow:hidden;
      z-index:30;
    }
    .menuCardClose{
      position:absolute;
      right:10px; top:8px;
      width:30px; height:30px;
      border-radius:999px;
      border:1px solid rgba(233,225,214,.95);
      background:#fff;
      font-size:18px; font-weight:900; line-height:1;
      display:grid; place-items:center;
    }
    .menuCardImg{
      width:100%;
      height:160px;
      object-fit:cover;
      display:block;
    }
    .menuCardBody{ padding:12px 14px 14px; }
    .menuCardJp{ font-weight:900; margin-bottom:4px; }
    .menuCardZh{ color:#666; font-weight:800; margin-bottom:8px; }
    .menuCardNote{ color:#444; line-height:1.45; }

    /* ✅ 黃色表格外框（回到你第一張那種感覺） */
    .menu-box{
      background: rgba(255, 242, 210, .55);
      border: 1px solid rgba(210, 184, 120, .55);
      border-radius: 16px;
      padding: 14px 14px 10px;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
    }
    .menu-box-head{
      display:flex; align-items:center; gap:8px;
      font-weight: 900;
      color: #5B4A2F;
      margin-bottom: 10px;
    }

    .menu-table{ display:flex; flex-direction:column; gap:0; }

    .menu-row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      padding: 12px 2px;
      background: transparent;;
      border: none;
      border-radius: 0;
      border-bottom:1px solid rgba(0,0,0,.08);
    }

    /* 最後一列不要底線 */
    .menu-row:last-child{
      border-bottom:none;
    }

    .menu-jp{ display:flex; align-items:center; gap:8px; font-size:.9rem; font-weight:900; color:#4B2E2A; }
    .menu-zh{ text-align:right; color:#6B7280; font-size:.9rem; font-weight:800; }

    /* ✅ 小喇叭（放日文前面） */
    .menuSpeak{
      width:28px; height:28px;
      border-radius:999px;
      border:1px solid rgba(210,184,120,.65);
      background:rgba(255,255,255,.75);
      display:inline-flex; align-items:center; justify-content:center;
      color:#6B5B3E;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
    }
    .menuSpeak:active{ transform:scale(.96); }

    /* ✅ 只有推薦的才像「可點」 */
    .menuPill{ cursor:pointer; }
    .menuPill:active{ transform:scale(.985); }






  
/* === PATCH: stronger highlight + reserved badge + route meta === */
.timeline-item.is-highlight .tl-content{ box-shadow:0 18px 40px rgba(0,0,0,.09), 0 0 0 5px rgba(214,158,76,.22) inset; }
.timeline-item.is-highlight:before{ inset:-22px -22px; filter: blur(10px); opacity:.95; }
/* .reserve-badge{ font-size:.62rem; padding:3px 7px; border-radius:7px; border:1.6px solid rgba(219, 64, 56, .9); color:rgb(219,64,56); transform: rotate(-10deg); } */
.route-meta{ margin-top:4px; font-size:.86rem; color:var(--ink2); font-weight:700; }

    /* ===== Timeline edit toolbar ===== */
    .timeline-toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin: 10px 2px 14px;
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.72);
      border:1px solid rgba(233,225,214,.9);
      box-shadow:0 10px 22px rgba(0,0,0,.06);
    }
    .tl-tool-left{ display:flex; gap:6px; align-items:center; }
    .tl-tool-right{ display:flex; gap:6px; align-items:center; }
    .tl-btn{
      appearance:none;
      border:none;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:.9rem;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      color:var(--ink1);
      cursor:pointer;
    }
    .tl-btn.primary{ background: var(--primary); color:#fff; border-color: rgba(0,0,0,.0); }
    .tl-btn.ghost{ background:transparent; }
    .tl-btn:active{ transform: translateY(1px); }
    .tl-edit-hint{ font-size:.85rem; color:var(--ink2); font-weight:800; }
    .edit-badge{
      position:absolute;
      right:10px; top:10px;
      font-size:.8rem;
      font-weight:900;
      color: rgba(60,60,60,.65);
    }
    .edit-row{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:10px;
    }
    .time-input{
      width:110px;
      padding:9px 10px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.9);
      font-weight:900;
      color: var(--ink1);
      font-family:'Roboto Mono', monospace;
    }
    .mini-btn{
      padding:9px 10px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      color: var(--ink1);
      white-space:nowrap;
    }
    .mini-btn.danger{ background: rgba(255,64,64,.10); border-color: rgba(255,64,64,.25); color:#B42318; }
    /* .timeline-item.is-dragging .tl-content{ box-shadow:0 22px 44px rgba(0,0,0,.14); transform: rotate(-.35deg) scale(1.01); } */
    /* ✅ 新增：讓路徑物件在拖曳時也有視覺反饋 */
    .timeline-item.is-dragging .tl-content,
    .timeline-item.is-dragging .route-strip {
      box-shadow: 0 22px 50px rgba(0,0,0,0.22);
      transform: rotate(-0.5deg) scale(1.02);
      z-index: 100;
      opacity: 0.9;
    }
    /* ✅ 新增：控制編輯列的顯示與隱藏，避免 DOM 重構導致位移 */
    .edit-row { 
      display: none; 
    }
    
    /* 當父容器處於編輯模式時才顯示 */
    .edit-mode-active .edit-row { 
      display: flex !important; 
    }
    
    /* 編輯模式時微調間距，確保視覺穩定 */
    .edit-mode-active .tl-content {
      padding-bottom: 14px;
    }
</style>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>

<body>
  <header class="app-header">
    <h1 id="hdrTitle"></h1>
    <div class="hdr-kana" id="hdrKana"></div>
    <div class="hdr-subrow">
      <p id="hdrSub"></p>
      <span class="year-pill" id="hdrYear">2026</span>
    </div>
  </header>

  <!-- 行前 -->
  <div id="page-pre" class="page">
    <div class="card">
      <div class="section-title"><i class="fas fa-bullhorn"></i> 全員重要待辦</div>
      <ul id="globalTodoList" style="list-style:none; padding:0; margin:0;"></ul>
    </div>

    <div class="card">
      <div class="section-title"><i class="fas fa-clipboard-user"></i> 個人清單</div>
      <div class="user-tabs" id="userSwitch"></div>

      <h4 style="margin:10px 0 10px; color:var(--ink2); font-weight:900;">旅行前</h4>
      <div class="checklist-grid" id="list-pretrip"></div>

      <h4 style="margin:10px 0 10px; color:var(--ink2); font-weight:900;">隨身行李</h4>
      <div class="checklist-grid" id="list-carry"></div>

      <h4 style="margin:20px 0 10px; color:var(--ink2); font-weight:900;">託運行李</h4>
      <div class="checklist-grid" id="list-check"></div>
    </div>
  </div>

  <!-- 行程 -->
  <div id="page-itinerary" class="page active">
    <div class="date-scroller" id="dayScroller"></div>
      <!-- ✅ Day photos slideshow（獨立 block，放在天氣預報上方） -->
    <div id="dayHero" class="day-hero"></div>

    <div class="card" style="margin-top: 18px;">
      <div class="wx-head">
        <div id="weatherLoc" class="wx-city"></div>
        <div class="wx-label"><i class="fas fa-cloud-sun"></i> 24H 預報</div>
      </div>
      <div class="weather-strip" id="weatherStrip"></div>
      <div style="text-align:right; font-size:0.86rem; color:var(--ink2); font-weight:800;">
        今晚住宿：<strong id="stayHotelName" style="color:var(--primary);"></strong>
      </div>
    </div>

    <div id="dayRouteCard"></div>

    <div id="timelineToolbar" class="timeline-toolbar"></div>
    <div id="timelineList" style="padding-bottom: 20px;"></div>
  </div>

  <!-- 資訊 -->
  <div id="page-info" class="page">
    <div class="section-title"><i class="fas fa-plane-departure"></i> 航班資訊</div>
    <div id="flightBoard"></div>

    <div class="section-title" style="margin-top:8px;"><i class="fas fa-hotel"></i> 住宿資訊</div>
    <div id="hotelList"></div>
  </div>

  <!-- 記帳 -->
  <div id="page-money" class="page">
    <div class="card">
      <div class="section-title">新增支出</div>
      <div class="seg" id="currencySwitch" style="margin-bottom: 12px;">
        <div class="seg-btn active" data-curr="JPY" onclick="setCurrency('JPY')">日幣 (¥)</div>
        <div class="seg-btn" data-curr="TWD" onclick="setCurrency('TWD')">台幣 ($)</div>
      </div>
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <input type="text" id="exName" placeholder="項目 (例: 晚餐)" style="padding:12px; border:1px solid rgba(233,225,214,.9); border-radius:14px; flex:1; background:rgba(255,255,255,.8);">
        <input type="number" id="exCost" placeholder="金額" style="padding:12px; border:1px solid rgba(233,225,214,.9); border-radius:14px; width:110px; background:rgba(255,255,255,.8);">
      </div>
      <div class="user-tabs" id="payerSwitch" style="background:rgba(233,225,214,.9); margin-bottom:15px;"></div>

      <!-- 類型：行中 / 預付 -->
      <div class="seg" id="expTypeSwitch" aria-label="expense type">
        <div class="seg-btn active" data-type="trip" onclick="setExpenseType('trip')">行中支出</div>
        <div class="seg-btn" data-type="prepaid" onclick="setExpenseType('prepaid')">預付費用</div>
      </div>

      <!-- 參與者：可多選（預設全選） -->
      <div style="font-weight:900; color:var(--ink2); font-size:.9rem; margin-top:2px;">分攤成員</div>
      <div class="chip-row" id="partSwitch"></div>

      <button class="btn" onclick="addExpense()">加入紀錄</button>
    </div>

    <div class="card">
      <div class="section-title">小記</div>
      <div id="expenseSummary"></div>
    </div>

    <div class="card">
      <div class="section-title">結算 (負數代表欠款)</div>
      <div id="debtList"></div>
    </div>

    <div class="card">
      <div class="section-title">詳細紀錄</div>
      <div id="expenseList"></div>
    </div>
  </div>

  <!-- modal -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal()"></div>
  <div class="modal-sheet" id="modalSheet" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div class="modal-drag-handle"></div>
      <button class="modal-x" onclick="closeModal()" aria-label="close">×</button>
    </div>
    <div class="sheet-splash" id="sheetSplash" aria-hidden="true">
      <div class="splash-frame" role="img" aria-label="spotlight">
        <div class="shutter-flash" aria-hidden="true"></div>
        <div class="splash-grid one" id="sheetSplashGrid">
          <img class="splash-img" id="sheetSplashImg1" alt="" />
          <img class="splash-img" id="sheetSplashImg2" alt="" />
        </div>
      </div>
    </div>
    <div class="modal-scroll" id="modalScroll">
        <div id="modalSticky"></div>
        <div id="modalBody"></div>
    </div>
  </div>

  <div id="menuCard" class="menuCard" hidden>
    <button class="menuCardClose" type="button">×</button>
    <img class="menuCardImg" alt="" />
    <div class="menuCardBody">
      <div class="menuCardJp"></div>
      <div class="menuCardZh"></div>
      <div class="menuCardNote"></div>
    </div>
  </div>



  <nav class="bottom-nav">
    <div class="nav-item active" onclick="nav('itinerary', this)"><i class="fas fa-map-location-dot"></i> 行程</div>
    <div class="nav-item" onclick="nav('info', this)"><i class="fas fa-passport"></i> 資訊</div>
    <div class="nav-item" onclick="nav('money', this)"><i class="fas fa-yen-sign"></i> 記帳</div>
    <div class="nav-item" onclick="nav('pre', this)"><i class="fas fa-list-check"></i> 行前</div>
  </nav>

<script>
/*    ====== Globals (JSON 驅動) ====== */
  let CONFIG, CHECKLISTS, TODOS, FLIGHTS, HOTELS, ITINERARY;

  let users = [];
  let curUser = 'L';
  let curPayer = 'L';

/*    timeline (支援本機即時編輯：拖曳排序 / 改時間 / 刪除) */
/*    ✅ 先宣告編輯模式狀態，避免 TDZ 造成行程渲染失敗 */
  let __tlEditMode = false;
  let __tlSortable = null;
  let __editHistory = [];

  let checklistData = { carry: [], check: [] };
  let hotels = [];
  let itineraryIndex = [];
  let dayCache = {};
  let currentDayData = null;
  let currentDayIdx = 0;
  let __heroTimer = null;
  let __sheetSplashTimer = null;

  function pickSheetSplashSrcs(item){
/*
     支援：字串 or 陣列
     可用欄位：splash / splash_img / cover / cover_img / image / img
     也支援第二張：splash2 / splash_img2 / cover2 / image2 / img2
*/
    const main =
      item?.splash || item?.splash_img ||
      item?.cover  || item?.cover_img  ||
      item?.image  || item?.img || '';

    const second =
      item?.splash2 || item?.splash_img2 ||
      item?.cover2  || item?.cover_img2  ||
      item?.image2  || item?.img2 || '';

/*      若 main 本身就是陣列：["a","b"] */
    let list = [];
    if(Array.isArray(main)){
      list = main;
    }else{
      list = [main, second].filter(Boolean);
    }

/*      正規化 & 最多兩張 */
    return list.map(s => normalizeAssetUrl(s)).filter(Boolean).slice(0,2);
  }




  function hideSheetSplash(){
    const ov = document.getElementById('sheetSplash');
    const sheet = document.getElementById('modalSheet');
    if(!ov || !sheet) return;

    ov.classList.remove('active');
    sheet.classList.remove('splash-on');
    const img1 = document.getElementById('sheetSplashImg1');
    const img2 = document.getElementById('sheetSplashImg2');
    if(img1) img1.removeAttribute('src');
    if(img2) img2.removeAttribute('src');

  }

  function showSheetSplash(item){
    const srcs = pickSheetSplashSrcs(item);
    if(!srcs.length) return;

    const ov    = document.getElementById('sheetSplash');
    const sheet = document.getElementById('modalSheet');
    const grid  = document.getElementById('sheetSplashGrid');
    const img1  = document.getElementById('sheetSplashImg1');
    const img2  = document.getElementById('sheetSplashImg2');
    if(!ov || !sheet || !grid || !img1 || !img2) return;

/*      reset timer */
    if(__sheetSplashTimer) clearTimeout(__sheetSplashTimer);

/*      先重置 */
    img1.style.display = 'none';
    img2.style.display = 'none';
    img1.removeAttribute('src');
    img2.removeAttribute('src');

/*      套 1/2 張模式 class */
    grid.classList.remove('one','two');
    grid.classList.add(srcs.length >= 2 ? 'two' : 'one');

/*      塞圖 */
    img1.src = srcs[0];
    img1.style.display = 'block';

    if(srcs[1]){
      img2.src = srcs[1];
      img2.style.display = 'block';
    }

    ov.classList.add('active');
    sheet.classList.add('splash-on');
/*      ✅ shutter flash (120ms) */
    const frame = document.getElementById('sheetSplashFrame');
    if(frame){
      frame.classList.remove('flash');       /* reset */
      requestAnimationFrame(()=> frame.classList.add('flash'));
    }


/*      點一下提前跳過 */
    ov.onclick = () => {
      if(__sheetSplashTimer) clearTimeout(__sheetSplashTimer);
      hideSheetSplash();
    };

    __sheetSplashTimer = setTimeout(()=> hideSheetSplash(), 5000);
  }





/*    ====== Load Data ====== */

/*    Sync data from Google sheet */
  async function syncFromCloud() {
    try {
/*        💡 發送請求，加入 _t 防止瀏覽器快取 */
      const resp = await fetch(`${G_API_URL}?token=${G_TOKEN}&_t=${Date.now()}`);

/*        💡 BIOS Debug: 檢查回應的 URL 是否包含 "ServiceLogin" */
      if (resp.url.includes("ServiceLogin")) {
        console.error("🚨 權限錯誤：GAS 跳轉到了登入頁面。請將 GAS 部署設定為『任何人 (Anyone)』。");
        return;
      }

/*        1. 先讀取為文字 */
      const text = await resp.text();
      console.log("雲端回傳原始字串:", text); /*  檢查這是否為 JSON */

/*        2. 檢查權限 */
      if (text === "Unauthorized") {
        setCookie("trip_auth_token", "", -1);  /* 清除無效的 Cookie */
        alert("訪問暗號錯誤或已過期，請重新輸入。");
        location.reload(); 
        return;
      }
  
/*
       3. 💡 關鍵修復：改用 JSON.parse() 解析已經讀取的 text 字串
       不要再用 await resp.json()
*/
      const cloudData = JSON.parse(text);

/*        4-1. 同步帳本資料 */
      if (cloudData.expenses) {
        expenses = cloudData.expenses; 
        localStorage.setItem('expenses', JSON.stringify(expenses));
        if (typeof renderExpenseUI === 'function') renderExpenseUI(); 
      }
  
/*        4-2. 同步 Checkbox 與 全員待辦 (GLOBAL) */
      if (cloudData.checklists) {
        const userCheckMap = {};
        const globalTodos = {}; 
  
        cloudData.checklists.forEach(item => {
          if (item.user === "GLOBAL") {
            if (item.checked) globalTodos[item.item] = true;
          } else {
            if (!userCheckMap[item.user]) userCheckMap[item.user] = {};
            if (item.checked) userCheckMap[item.user][item.item] = true;
          }
        });
  
        localStorage.setItem('global_todos', JSON.stringify(globalTodos));
        Object.keys(userCheckMap).forEach(user => {
          localStorage.setItem('check_' + user, JSON.stringify(userCheckMap[user]));
        });
        
/*          重新渲染畫面 */
        if (typeof renderGlobalTodos === 'function') renderGlobalTodos();
        if (document.getElementById('page-pre').classList.contains('active')) {
          if (typeof renderChecklists === 'function') renderChecklists();
        }
      }
  
/*
      // 4-3. 💡 新增：同步行程異動 (Itinerary Edits)
       if (cloudData.itineraryEdits) {
         const currentFile = itineraryIndex[currentDayIdx]?.file;
         
         Object.keys(cloudData.itineraryEdits).forEach(file => {
           const key = `day_edits_${file}`;
           const editData = cloudData.itineraryEdits[file];
           
           // 更新 LocalStorage 以供離線使用
           localStorage.setItem(key, JSON.stringify(editData));
           
           // 如果雲端異動的是「目前正在看」的這一天，立即更新快取並重繪
           if (file === currentFile) {
             dayCache[currentDayIdx] = { ...dayCache[currentDayIdx], items: editData.items };
             currentDayData = dayCache[currentDayIdx];
             
             // 確保在行程頁面時才重繪
             if (document.getElementById('page-itinerary').classList.contains('active')) {
               renderTimelineList(currentDayData);
               if (typeof enableTimelineSortable === 'function') enableTimelineSortable();
             }
           }
         });
       }
*/
/*         ✅ 修正行程卡消失後的 syncFromCloud 片段 */
      if (cloudData.itineraryEdits) {
        const currentFile = itineraryIndex[currentDayIdx]?.file;
        
        Object.keys(cloudData.itineraryEdits).forEach(file => {
          const key = `day_edits_${file}`;
          const editData = cloudData.itineraryEdits[file];
          
/*            💡 關鍵修正：判斷 editData 是陣列還是物件 */
          const itemsArray = Array.isArray(editData) ? editData : (editData.items || []);
          
/*            更新 LocalStorage 與 快取 */
          localStorage.setItem(key, JSON.stringify({ items: itemsArray }));
          
/*
          // if (file === currentFile) {
          //   // 確保將快取中的 items 設為正確的陣列
          //   dayCache[currentDayIdx] = { ...dayCache[currentDayIdx], items: itemsArray };
          //   currentDayData = dayCache[currentDayIdx];
            
          //   if (document.getElementById('page-itinerary').classList.contains('active')) {
          //     renderTimelineList(currentDayData);
          //     if (typeof enableTimelineSortable === 'function') enableTimelineSortable();
          //   }
          // }
*/
          if (cloudData.itineraryEdits) {
            Object.keys(cloudData.itineraryEdits).forEach(file => {
              const key = `day_edits_${file}`;
              const editData = cloudData.itineraryEdits[file];
              const itemsArray = Array.isArray(editData) ? editData : (editData.items || []);
              localStorage.setItem(key, JSON.stringify({ items: itemsArray }));
            });

/*              如果目前就在行程頁，重繪當天（用 applyDayEdits 套用最新 localStorage） */
            if (document.getElementById('page-itinerary').classList.contains('active')) {
              const meta = itineraryIndex[currentDayIdx];
              if (dayCache[currentDayIdx]) {
                currentDayData = applyDayEdits(dayCache[currentDayIdx], meta);
                renderTimelineList(currentDayData);
                if (__tlEditMode) enableTimelineSortable();
              }
            }
          }
        });
      }
  
      console.log("雲端資料同步完成");
    } catch (e) {
      console.error("同步失敗:", e);
    }
  }

/*    寫入資料時加入 token 欄位 */
  function cloudPost(action, data) {
    fetch(G_API_URL, {
      method: "POST",
      mode: "no-cors", 
      body: JSON.stringify({
        token: G_TOKEN,  /* 🔑 加入驗證暗號 */
        action: action,
        data: data
      })
    });
  }

  async function loadAllData(){ 
    [CONFIG, CHECKLISTS, TODOS, FLIGHTS, HOTELS, ITINERARY] = await Promise.all([
      fetch("./data/config.json").then(r=>r.json()),
      fetch("./data/checklists.json").then(r=>r.json()),
      fetch("./data/todos.json").then(r=>r.json()),
      fetch("./data/flights.json").then(r=>r.json()),
      fetch("./data/hotels.json").then(r=>r.json()),
      fetch("./data/itinerary.index.json").then(r=>r.json()),
    ]);

    users = CONFIG?.members || ['L','K','R','Y','J'];
    curUser = users[0] || 'L';
    curPayer = users[0] || 'L';

    checklistData = CHECKLISTS || { carry: [], check: [] };
    hotels = HOTELS || [];
    itineraryIndex = ITINERARY || [];

    const title = (CONFIG?.trip_title || '四國巡禮');

/*      2) subtitle 不顯示 L,K,R,Y,J */
    const sub = `${CONFIG?.days || 9}天${CONFIG?.nights || 8}夜${CONFIG?.mode ? CONFIG.mode : ''}`;
    
    document.getElementById('hdrTitle').innerText = title;
    document.getElementById('hdrKana').innerText = 'とくしまけん、かがわけん、えひめけん、こうちけん';
    document.getElementById('hdrSub').innerText = sub;
    document.getElementById('hdrYear').innerText = '2026';
    


    document.getElementById('hdrSub').innerText = sub;
  }

  document.addEventListener('DOMContentLoaded', async () => {
/*       💡 若無 Token 則提示輸入（僅需輸入第一次，後續會存於 Cookie） */
     if (!G_TOKEN) {
       const inputToken = prompt("請輸入訪問暗號 (Token)：");
       if (inputToken) {
         G_TOKEN = inputToken;
         setCookie("trip_auth_token", G_TOKEN, 30);  /* 預設存儲 30 天 */
         location.reload(); 
         return;
       } else {
         alert("未輸入暗號，同步功能將無法正常運作。");
       }
    }
    await loadAllData();
    await syncFromCloud();
/*      --- 新增：手動同步功能 --- */
    const titleEl = document.getElementById('hdrTitle');
    if (titleEl) {
      titleEl.style.cursor = 'pointer';  /* 讓滑鼠移上去顯示手指圖示 */
      titleEl.title = '點擊強制同步雲端資料';/*  增加提示文字 */
      titleEl.onclick = async () => {
        // 增加一點視覺回饋（例如標題變色或震動）
        titleEl.style.opacity = '0.5';
        console.log("手動觸發同步...");
        await syncFromCloud();
        titleEl.style.opacity = '1';
        alert('同步完成！');
      };
    }
/*      ----------------------- */
    renderGlobalTodos();
    renderUserTabs();
    renderChecklists();
    renderDateScroller();
    enableWheelHorizontal(document.getElementById('dayScroller'));
    await selectDay(0);
    renderHotels();
    renderFlights();
    normalizeExpenses();
    renderExpenseUI();
  });

  document.getElementById('modalSheet')?.addEventListener(
    'touchmove',
    (e) => e.stopPropagation(),
    { passive: true }
  );


  document.getElementById('modalOverlay')?.addEventListener(
    'touchmove',
    (e) => e.preventDefault(),
    { passive: false }
  );
  document.getElementById('timelineList').addEventListener('click', (e) => {
    const el = e.target.closest('.route-click');
    if(!el) return;

    const from = decodeURIComponent(el.dataset.from || '');
    const to   = decodeURIComponent(el.dataset.to || '');
    const mode = decodeURIComponent(el.dataset.mode || 'drive');

    openDirections(from, to, mode);
   });



  function nav(pageId, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-'+pageId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    window.scrollTo(0,0);
  }

/*    ====== 全員待辦 ====== */
  function renderGlobalTodos(){
    const el = document.getElementById('globalTodoList');
    if(!el) return;

    const saved = JSON.parse(localStorage.getItem('global_todos')) || {};
    el.innerHTML = (TODOS || []).map((t, idx) => {
      const key = t.title || `todo_${idx}`;
      const checked = saved[key] ? 'checked' : '';

      const titleHTML = t.link
        ? `<div class="todo-title"><a href="${t.link}" target="_blank" rel="noopener">${escapeHtml(t.title)}</a></div>`
        : `<div class="todo-title"><span>${escapeHtml(t.title)}</span></div>`;

      return `
        <li class="todo-li">
          <input type="checkbox" ${checked} onchange="toggleGlobalTodo('${escapeHtml(key)}')">
          <div>
            ${titleHTML}
            ${t.note ? `<div class="todo-note">${escapeHtml(t.note)}</div>` : ''}
          </div>
        </li>
      `;
    }).join('');
  }

  function toggleGlobalTodo(key){
    const k = unescapeHtml(key);
    const saved = JSON.parse(localStorage.getItem('global_todos')) || {};
/*      1. 切換狀態 */
    saved[k] = !saved[k];
    
/*      2. 存入本地 */
    localStorage.setItem('global_todos', JSON.stringify(saved));
  
/*      3. 💡 新增：同步到雲端 (使用 'GLOBAL' 作為用戶名標記) */
    cloudPost("updateCheck", { 
      user: "GLOBAL", 
      type: "todo", 
      item: k, 
      checked: saved[k] 
    });
  }
  function formatDuration(mins){
    const m = Number(mins);
    if(!Number.isFinite(m) || m <= 0) return '';
    const h = Math.floor(m / 60);
    const r = m % 60;
    if(h <= 0) return `${m} min`;
    if(r === 0) return `${h} hr`;
    return `${h} hr ${r} min`;
  }


/*    ====== 個人清單 ====== */
  function renderUserTabs() {
    document.getElementById('userSwitch').innerHTML = users.map(u =>
      `<div class="user-tab ${u===curUser?'active':''}" onclick="switchUser('${u}')">${u}</div>`
    ).join('');
  }
  function switchUser(u) { curUser = u; renderUserTabs(); renderChecklists(); }

  function iconForItem(item){
    if(item.includes('護照')) return 'fa-passport';
    if(item.includes('手機')) return 'fa-mobile-screen';
    if(item.includes('行動電源') || item.includes('充電')) return 'fa-battery-full';
    if(item.includes('藥')) return 'fa-pills';
    if(item.includes('衣') || item.includes('內衣') || item.includes('睡衣')) return 'fa-shirt';
    if(item.includes('雨')) return 'fa-umbrella';
    if(item.includes('牙')) return 'fa-tooth';
    return 'fa-suitcase';
  }

  function renderChecklists() {
    const data = JSON.parse(localStorage.getItem('check_'+curUser)) || {};

    ['pretrip','carry','check'].forEach(type => {
      const target = document.getElementById('list-'+type);
      if(!target) return;

      target.innerHTML = (checklistData[type] || []).map(item => {
        const isChecked = data[item] ? 'checked' : '';
        const icon = iconForItem(item);
        return `
          <div class="check-item ${isChecked}" onclick="toggleCheck('${escapeHtml(item)}', this)">
            <i class="fas ${icon}"></i>
            <span>${escapeHtml(item)}</span>
          </div>`;
      }).join('');
    });
  }

  function toggleCheck(itemEscaped, el) {
    const item = unescapeHtml(itemEscaped);
    const data = JSON.parse(localStorage.getItem('check_'+curUser)) || {};
    if(data[item]) { delete data[item]; el.classList.remove('checked'); }
    else { data[item] = true; el.classList.add('checked'); }
    localStorage.setItem('check_'+curUser, JSON.stringify(data));

/*      Add data to Google sheet */
    const isChecked = el.classList.contains('checked'); /*  判斷現在是勾選還是消 */

/*        傳送到雲端 */
      cloudPost("updateCheck", { user: curUser, type: "carry", item: item, checked: isChecked });
  }

/*    ====== 行程 ====== */
  function renderDateScroller() {
    document.getElementById('dayScroller').innerHTML = itineraryIndex.map((d, i) => `
      <div class="date-chip" id="chip-${i}" onclick="selectDay(${i})">
        <div class="day">${escapeHtml(d.date || '')}</div>
        <div class="wk">${escapeHtml(d.day || '')}</div>
        <div class="date">Day ${i+1}</div>
      </div>
    `).join('');
  }

  function tagClass(tag){
        const t = (tag||'').toLowerCase();
        if(t==='food') return 'tag-food';
        if(t==='sight') return 'tag-sight';
        if(t==='sight') return 'tag-sight';
        if(t==='takagi') return 'tag-takagi';
        if(t==='hotel') return 'tag-hotel';
        if(t==='shop') return 'tag-shop';
        return 'tag-transport';
    }

/*
 回傳對應 Font Awesome icon class（不含 "fa-solid" 那種前綴）
 規則：先看 subtag（子分類）→ 沒命中再看 tag（大分類）→ 都沒有就用預設圓點
*/
  function tagIcon(tag, subtag){

/*      t = 大分類（food / sight / transport / hotel / shop） */
    const t  = (tag || '').toLowerCase().trim();


/*      st = 子分類（ramen / sushi / train / onsen ...） */
    const ALIAS = {
      '汽車':'car','飛機':'plane','火車':'train','巴士':'bus','纜車':'cablecar','輪船':'ferry','起飛':'departure','抵達':'arrived',
      '生魚片':'sashimi','壽司':'sushi','咖哩飯':'curry','牛排':'steak','buffet':'buffet','拉麵':'ramen','串燒':'yakitori','居酒屋':'izakaya','咖啡廳':'cafe',
      '海水浴場':'beach','貓咪':'cat','城池':'castle','溫泉':'onsen','車站':'station',
      '河川':'river','植物園':'botanic','動物園':'zoo','公園':'park','鳥居':'torii','博物館':'museum',
    };

    const st = (ALIAS[subtag] || subtag || '').toLowerCase().trim();
    const TAG_SVGS = {
      takagi: ['./photos/takagi_01_nobg_v2.svg', './photos/takagi_02_nobg_v2.svg']
    };


/*
     -----------------------------
     ✅ 子分類 icon（優先）
     你在資料中寫 subtag，就會優先用這裡的 icon
     例如：tag=food, subtag=ramen → fa-bowl-food
     -----------------------------
*/
    const SUB = {

/*        ===== transport 交通子分類 ===== */
      car:      'fa-car',             /* 汽車 */
      plane:    'fa-plane',           /* 飛機 */
      train:    'fa-train',           /* 火車 */
      bus:      'fa-bus',             /* 巴士 */
      cablecar: 'fa-cable-car',       /* 纜車（FA 版本若沒有，改成 fa-mountain/ fa-train 都行） */
      ferry:    'fa-ship',            /* 輪船/渡輪 */
      departure:'fas fa-plane-departure',  /* 起飛 */
      arrived:  'fas fa-plane-arrival',  /* 抵達 */

/*        ===== food 餐飲子分類 ===== */
      sashimi:  'fa-fish',            /* 生魚片（保守 icon，通常版本都會有） */
      sushi:    'fa-fish-fins',       /* 壽司（若你版本沒有 → 換 fa-fish） */
      curry:    'fa-pepper-hot',      /* 咖哩飯（若覺得不貼 → 換 fa-utensils） */
      steak:    'fa-drumstick-bite',  /* 牛排（若版本沒有 → 換 fa-utensils） */
      buffet:   'fa-plate-wheat',     /* buffet（若版本沒有 → 換 fa-utensils） */
      ramen:    'fa-bowl-food',       /* 拉麵（FA6 才比較穩） */
      yakitori: 'fa-fire-flame-curved',  /* 串燒/炭火（FA6 才比較穩；保守可換 fa-fire） */
      izakaya:  'fa-beer-mug-empty',  /* 居酒屋（FA6 才比較穩；保守可換 fa-mug-hot） */
      cafe:     'fa-mug-hot',         /* 咖啡廳 */

/*        ===== sight 景點子分類 ===== */
      beach:    'fa-umbrella-beach',  /* 海水浴場 */
      cat:      'fa-cat',             /* 貓咪 */
      castle:   'fa-chess-rook',      /* 城池 */
      onsen:    'fa-hot-tub-person',  /* 溫泉（FA6 才比較穩；保守可換 fa-water） */
      station:  'fa-train-subway',    /* 車站（若版本沒有 → 換 fa-train） */
      river:    'fa-water',           /* 河川 */
      botanic:  'fa-seedling',        /* 植物園 */
      zoo:      'fa-paw',             /* 動物園 */
      park:     'fa-tree',            /* 公園 */
      torii:    'fa-torii-gate',      /* 鳥居 */
      shrine:   'fa-torii-gate',      /* 神社（同鳥居） */
      museum:   'fa-landmark',        /* 博物館 */
      takagi:   ''
    };

/*
     -----------------------------
     ✅ 大分類 icon（fallback）
     當 subtag 沒寫或沒命中時，退回看 tag
     例如：tag=food, subtag="" → fa-utensils
     -----------------------------
*/
    const TAG = {
      food:      'fa-utensils',       /* 餐飲 */
      sight:     'fa-torii-gate',     /* 景點（預設用鳥居） */
      transport: 'fa-route',          /* 交通 */
      hotel:     'fa-bed',            /* 住宿 */
      shop:      'fa-bag-shopping'    /* 購物 */
    };

/*      ✅ 回傳順序：子分類 → 大分類 → 預設 */
    return SUB[st] || TAG[t] || 'fa-circle';   /* fa-circle = 沒分類時用圓點 */
  }


  function durationChip(item){
/*      1) 優先顯示 stay（你 JSON 已經有） */
    const stay = (item.stay || '').trim();
    if(stay) return `<span class="tl-chip"><i class="fas fa-hourglass-half"></i> ${escapeHtml(stay)}</span>`;

/*      2) 如果有 route.minutes，顯示車程 */
    const mins = item?.route?.minutes;
    if(Number.isFinite(mins)) return `<span class="tl-chip"><i class="fas fa-car"></i> ${mins} min</span>`;

    return '';
  }
  function normalizeTime(t){
/*      只取 HH:MM（避免 Before 05:00 / 13:20-13:45 破版） */
    const s = String(t ?? '').trim();
    const m = s.match(/(\d{1,2}:\d{2})/);
    if(m) return m[1].padStart(5,'0');
    if(s === '—' || s === '-' || !s) return '—';
    return s;  /* 真的不是時間就原樣（但建議 json 就別放這種） */
  }

  function routeIcon(mode){
    const m = (mode||'').toLowerCase();
    if(m==='drive') return 'fa-car';
    if(m==='walk')  return 'fa-person-walking';
    if(m==='train') return 'fa-train-subway';
    if(m==='ship')  return 'fa-ship';
    if(m==='plane') return 'fa-plane';
    return 'fa-route';
  }

  function renderRouteStrip(item, i){
    const r = item.route || {};
    const mode = (r.mode || 'route').toLowerCase();
    const icon = routeIcon(mode);
    const mins = r.minutes ? `${formatDuration(r.minutes)}` : (item.stay || '');
    const line2 = `${r.from || ''} → ${r.to || ''}`.trim();

    return `
        <div class="timeline-item route-item">
            <div class="tl-time">${escapeHtml(t)}</div>
            <div class="route-spacer"></div>

            <div class="route-strip route-click"
            data-from="${enc(r.from || '')}"
            data-to="${enc(r.to || '')}"
            data-mode="${enc(mode)}">

            <div class="route-ico"><i class="fas ${ico}"></i></div>

            <div class="route-main">
                <div class="route-title">${escapeHtml(title)}</div>
            </div>

            ${dur ? `<div class="route-mins">${escapeHtml(dur)}</div>` : ``}
            </div>
        </div>
    `;
  }

  function renderNormalItem(item, i){
    const stayPill = item.stay ? `<div style="margin-top:6px; display:inline-flex; gap:8px; align-items:center; background:#F2F2F7; padding:4px 10px; border-radius:999px; font-weight:900; font-size:.82rem; line-height:1.1; color:#4B5563;">
      <i class="fas fa-hourglass-half" style="color:#9CA3AF;"></i>${escapeHtml(item.stay)}
    </div>` : '';

/*      ✅ 關鍵：移除 onclick，改用 data-idx 供 JS 識別 */
    return `
      <div class="timeline-item" data-idx="${i}" id="exp-item-${i}">
        <div class="tl-time">${escapeHtml(t)}</div>
        <div class="tl-content ${item.highlight ? 'highlight' : ''}" style="position:relative;">
          ${item.reserved ? `<div class="reserve-badge">予約済</div>` : ``}
          <div class="tl-tag ${tagClass(item.tag)}">
              ${escapeHtml((item.tag || '').toUpperCase())}
              <i class="fas ${tagIcon(item.tag, item.subtag)} tag-ico"></i>
          </div>	  
          <div class="tl-title">${escapeHtml(item.title || '').replace(/\n/g, '<br>')}</div>
          <div class="tl-desc">${escapeHtml(item.desc || '').replace(/\n/g, '<br>')}</div>
          ${stay}
          ${renderEditRow(i, item)}
        </div>
      </div>
    `;
/*
//     return `
//       <div class="timeline-item" onclick='openModal(${i})'>
//         <div class="tl-time">${escapeHtml(item.time || '')}</div>
//         <div class="tl-content ${item.highlight ? 'highlight' : ''}">
//           <div class="tl-tag ${tagClass(item.tag)}">
//             ${escapeHtml((item.tag||'').toUpperCase())}
//             ${((item.tag||'').toLowerCase()==='takagi')
//               ? getTagIconHtml('takagi', i)
//               : `<i class="fas ${tagIcon(item.tag, item.subtag)} tag-ico"
//                   style="opacity:.35; font-size:.72rem; margin-left:2px;"></i>`
//             }
//           </div>
//           <div class="tl-title">${escapeHtml(item.title || '').replace(/\n/g,'<br>')}</div>
//           <div class="tl-desc">${escapeHtml(item.desc || '').replace(/\n/g,'<br>')}</div>
//           ${stayPill}
//         </div>
//       </div>
//     `;
*/
  }
  function openDirections(from, to, mode='drive'){
    const tm = travelModeForRoute(mode);  /* 你下面已經有這個 function */
    const url = `https://www.google.com/maps/dir/?api=1`
        + `&origin=${encodeURIComponent(from||'')}`
        + `&destination=${encodeURIComponent(to||'')}`
        + `&travelmode=${encodeURIComponent(tm)}`;
    window.open(url, '_blank', 'noopener');
  }





/*
//   function openDirections(from, to){
//     // Google Maps Directions
//     const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from||'')}&destination=${encodeURIComponent(to||'')}&travelmode=driving`;
//     window.open(url, '_blank');
//   }
*/


    /* --- ✅ 修正：將以下函式移至全域位置（selectDay 的外部） --- */
    
    function renderTimelineList(dayData) {
      const listEl = document.getElementById('timelineList');
      if (!listEl) return;
    
/*        ✅ 根據狀態切換 CSS 類別 */
      if (__tlEditMode) listEl.classList.add('edit-mode-active');
      else listEl.classList.remove('edit-mode-active');

      listEl.innerHTML = (dayData?.items || []).map((item, i) => {
        const t = normalizeTime(item.time);
        const stay = item.stay ? `
          <div class="stay-pill"><i class="fas fa-hourglass-half"></i>${escapeHtml(item.stay)}</div>
        ` : '';
    
/*          ✅ Route 渲染邏輯 */
        if (item.route && (item.route.from || item.route.to)) {
          const r = item.route;
          const mode = r.mode || 'drive';
          const ico = routeIcon(mode);
          const title = (item.title && item.title.trim()) ? item.title.trim() : `${r.from || ''} → ${r.to || ''}`.trim();
          const dur = (item.stay && String(item.stay).trim()) ? String(item.stay).trim() : (Number.isFinite(r.minutes) ? `${r.minutes} min` : '');
          const enc = (s) => encodeURIComponent(String(s ?? ''));
    
          return `
            <div class="timeline-item route-item">
                <div class="route-strip route-click" data-from="${enc(r.from || '')}" data-to="${enc(r.to || '')}" data-mode="${enc(mode)}">
                  <div class="route-ico"><i class="fas ${ico}"></i></div>
                  <div class="route-main">
                      <div class="route-time-top">${escapeHtml(t)}</div>
                      <div class="route-title">${escapeHtml(title)}</div>
                  </div>
                  ${dur ? `<div class="route-mins">${escapeHtml(dur)}</div>` : ``}
                </div>
                  <div style="margin-left:76px; margin-top:-10px;" onclick="event.stopPropagation()">
                    ${renderEditRow(i, item)}
                  </div>
            </div>`;
        }
    
/*          ✅ 一般行程渲染邏輯 */
        return `
          <div class="timeline-item" data-idx="${i}" id="exp-item-${i}">
            <div class="tl-time">${escapeHtml(t)}</div>
            <div class="tl-content ${item.highlight ? 'highlight' : ''}" style="position:relative;">
              ${item.reserved ? `<div class="reserve-badge">予約済</div>` : ``}
              <div class="tl-tag ${tagClass(item.tag)}">
                  ${escapeHtml((item.tag || '').toUpperCase())}
                  <i class="fas ${tagIcon(item.tag, item.subtag)} tag-ico"></i>
              </div>	  
              <div class="tl-title">${escapeHtml(item.title || '').replace(/\n/g, '<br>')}</div>
              <div class="tl-desc">${escapeHtml(item.desc || '').replace(/\n/g, '<br>')}</div>
              ${stay}
              ${renderEditRow(i, item)}
            </div>
          </div>`;
      }).join('');
    
      bindLongPressSelection();  /* 渲染完重新綁定 */
    }
    
/*      渲染編輯列 */
    function renderEditRow(i, item) {
/*       if (!__tlEditMode) return ''; */
/*        ✅ 移除判斷式，讓編輯列永遠生成，改由 CSS 的 .edit-row { display: none; } 控制 */
      const t = normalizeTime(item.time);
      return `
        <div class="edit-row" onclick="event.stopPropagation()">
          <input class="time-input" type="time" value="${escapeHtml(t)}" data-edit-time="1" data-idx="${i}" />
          <button class="mini-btn danger" data-delete-idx="${i}"><i class="fas fa-trash"></i> 刪除</button>
        </div>`;
    }
    
/*
    // 儲存異動
//     function saveDayEdits() {
//       const meta = itineraryIndex[currentDayIdx];
//       const file = meta?.file;
//       if (!file) return;
//       const dataToSave = { items: (currentDayData?.items || []) };
//       localStorage.setItem(`day_edits_${file}`, JSON.stringify(dataToSave));
//       cloudPost("updateItinerary", { file: file, items: dataToSave });
//     }
*/

    function renderDayHero(dayData, meta){
        const el = document.getElementById('dayHero');
        if(!el) return;

/*
         ✅ 支援兩種格式：
         1) 新格式：[{src,loc,caption}]
         2) 舊格式：[ "url1", "url2" ]
*/
        let photosRaw = Array.isArray(dayData?.photos) ? dayData.photos.slice(0,5) : [];
        if(!photosRaw.length){
            photosRaw = [
            "https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1200&q=80",
            "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80",
            "https://images.unsplash.com/photo-1526481280695-3c687fd5432c?auto=format&fit=crop&w=1200&q=80",
            "https://images.unsplash.com/photo-1528127269322-539801943592?auto=format&fit=crop&w=1200&q=80",
            "https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?auto=format&fit=crop&w=1200&q=80",
            ];
        }

        const photos = photosRaw.map(p=>{
            if(typeof p === 'string'){
                return { src:p, loc: (meta?.loc||''), caption:'' };
            }
            return {
                src: p.src || p.url || '',
                loc: (p.loc !== undefined) ? (p.loc ?? '') : (meta?.loc || ''),
                caption: p.caption || ''
            };
        }).filter(x=>x.src);

        const slides = photos.map((p, idx)=>`
          <div class="hero-slide hero--blur">
            <img
                src="${escapeHtml(p.src)}"
                alt="day photo ${idx+1}"
                loading="lazy"
                decoding="async"
                referrerpolicy="no-referrer"
                onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80';"
                class="hero-bg" alt="" aria-hidden="true"
            >
            <img
                src="${escapeHtml(p.src)}"
                alt="day photo ${idx+1}"
                loading="lazy"
                decoding="async"
                referrerpolicy="no-referrer"
                onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80';"
                class="hero-img" alt="day photo ...">
            >
            <div class="hero-overlay">
                ${p.loc ? `<div class="hero-loc"><i class="fas fa-location-dot"></i>${escapeHtml(p.loc)}</div>` : ``}
                ${p.caption ? `<div class="hero-caption">${escapeHtml(p.caption)}</div>` : ``}
					  
								   
																									
            </div>
           </div>
        `).join('');

        
/*          ❌ dots（小白點）已移除：不顯示也不需要同步 */
        el.innerHTML = `<div class="hero-track" id="heroTrack">${slides}</div>`;

        const track = document.getElementById('heroTrack');
        if(!track) return;

/*          ✅ 桌機滾輪也能左右滑 */
        enableWheelHorizontal(track);

        if(__heroTimer) clearInterval(__heroTimer);

/*          auto slide */

        let cur = 0;
        __heroTimer = setInterval(()=>{
            cur = (cur + 1) % photos.length;
            track.scrollTo({ left: cur * track.clientWidth, behavior:'smooth' });
        }, 12000);
    }

    async function selectDay(idx) {
        currentDayIdx = idx;
        __editHistory = []; 
        __tlEditMode = false;
    
/*          UI 更新 (Active Date Chip) */
        document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
        const chip = document.getElementById('chip-' + idx);
/*         if (chip) chip.classList.add('active'); */
        if (chip) {
            chip.classList.add('active');

            /* ✅ 新增：將所選日期置中捲動的邏輯 */
            const scroller = document.getElementById('dayScroller');
            if (scroller) {
                const scrollPos = chip.offsetLeft - (scroller.clientWidth / 2) + (chip.clientWidth / 2);
                scroller.scrollTo({ left: scrollPos, behavior: 'smooth' });
            }
        } 

        const meta = itineraryIndex[idx];
        if (!meta) return;
    
/*
        // 載入資料
        // if (!dayCache[idx]) {
        //   const url = `./${meta.file}?v=${Date.now()}`;
        //   const raw = await fetch(url).then(r => r.json());
        //   dayCache[idx] = Array.isArray(raw) ? raw[0] : raw;
        // }
*/

        const needFetch =
          !dayCache[idx] ||
          (!Array.isArray(dayCache[idx]?.photos) || dayCache[idx].photos.length === 0) ||
          (dayCache[idx]?.items && !dayCache[idx]?.route && !dayCache[idx]?.loc); // 依你資料型態自行微調

        if (needFetch) {
          const url = `./${meta.file}?v=${Date.now()}`;
          const raw = await fetch(url).then(r => r.json());
          dayCache[idx] = Array.isArray(raw) ? raw[0] : raw;
        }

    
/*          應用編輯 (本地與雲端緩存) */
        currentDayData = applyDayEdits(dayCache[idx], meta);
    
/*          ✅ 呼叫現在已變成全域的渲染函式 */
        renderDayHero(currentDayData, meta);
        await renderDayRouteCard(currentDayData);
        renderTimelineToolbar(meta);
        renderTimelineList(currentDayData);
        enableTimelineSortable();
        await renderWeatherJMA(meta);
    }


/*      ===== timeline edit helpers ===== */
/*      (__tlEditMode / __tlSortable 已在上方宣告) */

/*     function dayEditKey(){ return `day_edits_${meta?.file || ''}`; } */
/*       ✅ 修正後的 dayEditKey：從全域索引中取得 meta */
     function dayEditKey() {
       const meta = itineraryIndex[currentDayIdx];  /* 從全域變數抓取目前的 meta */
       return `day_edits_${meta?.file || ''}`;
     }

/*      ✅ 修正後的 applyDayEdits (確保它也是獨立的) */
    function applyDayEdits(dayData, meta) {
      try {
        const key = `day_edits_${meta?.file || ''}`;
        const saved = JSON.parse(localStorage.getItem(key) || 'null');
        if (saved && Array.isArray(saved.items)) {
          return { ...dayData, items: saved.items };
        }
      } catch (e) {}
      return dayData;
    }

/*
//     function applyDayEdits(dayData, meta){
//       try{
//         const key = `day_edits_${meta?.file || ''}`;
//         const saved = JSON.parse(localStorage.getItem(key) || 'null');
//         if(saved && Array.isArray(saved.items)){
//           return { ...dayData, items: saved.items };
//         }
//       }catch(e){}
//       return dayData;
//     }

//     function saveDayEdits() {
//       try {
//         const file = itineraryIndex[currentDayIdx]?.file;
//         if (!file) return;
//     
//         const key = dayEditKey();
//         const dataToSave = { items: (currentDayData?.items || []) };
//         
//         // 1. 本地備份
//         localStorage.setItem(key, JSON.stringify(dataToSave));
//     
//         // 2. 雲端同步
//         cloudPost("updateItinerary", {
//           file: file,
//           items: dataToSave // 包含完整的項目順序與時間
//         });
//         console.log(`Day ${currentDayIdx + 1} 行程異動已同步雲端`);
//       } catch (e) {
//         console.error("儲存失敗", e);
//       }
//     }
*/
/*       ✅ 修正後的 saveDayEdits */
     function saveDayEdits() {
       try {
         const file = itineraryIndex[currentDayIdx]?.file;
         if (!file) return;
     
         const key = dayEditKey();  /* 現在這裡不會再報錯了 */
         const dataToSave = { items: (currentDayData?.items || []) };
         
/*           1. 本地備份 */
         localStorage.setItem(key, JSON.stringify(dataToSave));
     
/*           2. 雲端同步 */
         cloudPost("updateItinerary", {
           file: file,
           items: dataToSave.items  /* 確保傳送的是陣列 */
         });
         console.log(`Day ${currentDayIdx + 1} 行程異動已同步雲端`);
       } catch (e) {
         console.error("儲存失敗", e);
       }
     }

    function resetDayEdits(){
      try{ localStorage.removeItem(dayEditKey()); }catch(e){}
    }

/*      let __editHistory = []; // 用於存放上一步的狀態 */
    
    function renderTimelineToolbar(meta) {
      const el = document.getElementById('timelineToolbar');
      if (!el) return;
    
      el.innerHTML = `
        <div class="tl-tool-left">
          <button class="tl-btn ${__tlEditMode ? 'primary' : ''}" id="tlEditToggle">
            <i class="fas ${__tlEditMode ? 'fa-check' : 'fa-pen'}"></i>
            ${__tlEditMode ? '完成' : '編輯'}
          </button>
        </div>
        <div class="tl-tool-right">
          <button class="tl-btn ghost" id="tlUndoEdit"><i class="fas fa-undo"></i> 回復上一步</button>
          <button class="tl-btn ghost" id="tlResetDay"><i class="fas fa-rotate-left"></i> 重置default</button>
        </div>
      `;
    
/*        --- 重置功能 --- */
      el.querySelector('#tlResetDay')?.addEventListener('click', async () => {
        const file = itineraryIndex[currentDayIdx]?.file;
        if (!file || !confirm('確定要將此日行程「重置default」嗎？')) return;
        cloudPost("resetItinerary", { file: file });
        localStorage.removeItem(`day_edits_${file}`);
        delete dayCache[currentDayIdx];
        await selectDay(currentDayIdx);
      });
    
/*        --- 回復上一步 (Undo) --- */
      el.querySelector('#tlUndoEdit')?.addEventListener('click', () => {
        if (__editHistory.length > 0) {
          const prevState = __editHistory.pop();
          currentDayData.items = prevState; 
          
          saveDayEdits();
          renderTimelineList(currentDayData);
          enableTimelineSortable();  /* ✅ 關鍵：回復後必須重新啟用排序監聽 */
          
          console.log("已回復上一步，剩餘步數:", __editHistory.length);
        } else {
          alert('沒有更多步驟可以回復');
        }
      });
    
/*
//       el.querySelector('#tlEditToggle')?.addEventListener('click', () => {
//         __tlEditMode = !__tlEditMode;
//         renderTimelineToolbar(meta);
// //         renderTimelineList(currentDayData);
//         // ✅ 修正：只有在「關閉」編輯模式時，為了清理可能的狀態才重新渲染
//         if (!__tlEditMode) {
//             renderTimelineList(currentDayData);
//         }
//         enableTimelineSortable();
//       });
*/
      el.querySelector('#tlEditToggle')?.addEventListener('click', () => {
/*          ✅ 如果是開啟編輯模式，紀錄捲動位置 */
        const scrollY = window.scrollY;
        
        __tlEditMode = !__tlEditMode;
      
/*          切換 Class */
        const listEl = document.getElementById('timelineList');
        if (listEl) {
/*
           if (__tlEditMode) listEl.classList.add('edit-mode-active');
           else listEl.classList.remove('edit-mode-active');
*/
            if (__tlEditMode) {
              listEl.classList.add('edit-mode-active');
/*                listEl.style.touchAction = 'none'; // 編輯中禁用系統捲動 */
            } else {
              listEl.classList.remove('edit-mode-active');
/*                listEl.style.touchAction = 'pan-y'; // 完成後恢復 y 軸捲動 */
            }
        }
      
        renderTimelineToolbar(meta);
      
/*         ✅ 不論是進入還是離開，都呼叫一次來確保 Sortable 狀態同步 */
       enableTimelineSortable(); 
       
       if (!__tlEditMode) renderTimelineList(currentDayData); 
      });
    }

    function enableTimelineSortable(){
      const list = document.getElementById('timelineList');
      if(!list) return;
      if(__tlSortable){ __tlSortable.destroy(); __tlSortable = null; }
      if(!__tlEditMode) return;
      if(typeof Sortable === 'undefined') return;
    
      __tlSortable = new Sortable(list, {
        animation: 180,
        handle: '.tl-content, .route-strip, .tl-time, .route-time-top',
        ghostClass: 'is-dragging',
/*
         delay: 400,
         delayOnTouchOnly: true,
*/
	delay: 200,
        touchStartThreshold: 5,
    
        onStart: (evt)=>{ 
          if (navigator.vibrate) navigator.vibrate(40);
          evt.item.classList.add('is-dragging'); 
        },
        onEnd: (evt)=>{
/*            ✅ 新增：恢復觸控動作 */
          evt.item.style.touchAction = '';

          evt.item.classList.remove('is-dragging');
          const oldIndex = evt.oldIndex;
          const newIndex = evt.newIndex;
          
/*            ✅ 檢查：如果位置沒有變動，就不需要紀錄歷史與重新渲染 */
          if(oldIndex === newIndex || oldIndex == null || newIndex == null) return;
    
/*            ✅ 關鍵：在修改陣列順序之前，先存入目前的狀態到「上一步」 */
          pushHistory();
    
          const arr = (currentDayData?.items || []).slice();
          const [moved] = arr.splice(oldIndex, 1);
          arr.splice(newIndex, 0, moved);
          currentDayData = { ...currentDayData, items: arr };
          
          saveDayEdits();
          renderTimelineList(currentDayData);
          enableTimelineSortable();
        }
      });
    }

/*      事件委派：改時間 / 刪除 */
    document.getElementById('timelineList').addEventListener('input', (e)=>{
      if(!__tlEditMode) return;
      const inp = e.target.closest('input[data-edit-time]');
      if(!inp) return;

      pushHistory();  /* 💡 新增：修改前紀錄狀態 */

      const idx = Number(inp.dataset.idx);
      if(!Number.isFinite(idx)) return;
      const arr = (currentDayData?.items || []).slice();
      if(!arr[idx]) return;
      arr[idx] = { ...arr[idx], time: inp.value };
      currentDayData = { ...currentDayData, items: arr };
      saveDayEdits();
      renderTimelineList(currentDayData);
    });

    document.getElementById('timelineList').addEventListener('click', (e)=>{
      if(!__tlEditMode) return;
      const btn = e.target.closest('[data-delete-idx]');
      if(!btn) return;

      pushHistory();  /* 💡 新增：修改前紀錄狀態 */

      const idx = Number(btn.dataset.deleteIdx);
      if(!Number.isFinite(idx)) return;
      const arr = (currentDayData?.items || []).slice();
      arr.splice(idx, 1);
      currentDayData = { ...currentDayData, items: arr };
      saveDayEdits();
      renderTimelineList(currentDayData);
      enableTimelineSortable();
    }, true);


/*    ====== Google 導航：優先 geo，其次 addr/title ====== */
  function buildGoogleNavUrl(item){
    const hasGeo = item?.geo?.lat != null && item?.geo?.lng != null;
    if(hasGeo){
/*      return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(item.geo.lat + ',' +
	     item.geo.lng)}`; */
      return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.geo.lat + ',' + item.geo.lng)}`;
    }
    const q = (item?.addr || item?.title || '').trim();
    if(!q) return 'https://www.google.com/maps';
/*     return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`; */
    return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
  }
  function travelModeForRoute(mode){
    const m = (mode || '').toLowerCase();
    if(m === 'walk')  return 'walking';
    if(m === 'train') return 'transit';
    if(m === 'ship')  return 'transit';
    if(m === 'plane') return 'transit';
    return 'driving';
  }

  function getLatLonForMeta(meta){
/*      ✅ 優先：itinerary.index.json 每天直接帶 lat/lon */
    if(Number.isFinite(meta?.lat) && Number.isFinite(meta?.lon)){
        return { lat: meta.lat, lon: meta.lon };
    }

/*      ✅ 次選：hotels.json 裡的 geo（如果你有存） */
    const h = hotels.find(x => x.id === meta.hotel_id);
    const lat = h?.geo?.lat;
    const lon = h?.geo?.lng ?? h?.geo?.lon;
    if(Number.isFinite(lat) && Number.isFinite(lon)){
        return { lat, lon };
    }
    return null;
   }
  async function renderDayRouteCard(dayData){
    const el = document.getElementById('dayRouteCard');
    if(!el) return;

    const route = dayData?.route;
    const rawPts = route?.points || [];
    const mode = route?.mode || 'drive';

/*
     ✅ 支援三種格式：
     1) "lat,lng"  (字串)
     2) "地點名稱" (字串：只用於 Google，縮圖不畫點)
     3) { q:"地點名稱", lat:34.12, lng:134.56 } (物件：Google + 縮圖都能用)
*/
    const pts = rawPts.map(p=>{
      if(p == null) return null;

      if(typeof p === 'string'){
        const s = p.trim();
        if(!s) return null;
        const ll = parseLatLng(s);
        if(ll) return { q: `${ll.lat},${ll.lng}`, lat: ll.lat, lng: ll.lng };
        return { q: s };
      }

      if(typeof p === 'object'){
        const q = (p.q || p.name || p.title || '').toString().trim();
        const lat = (p.lat != null) ? Number(p.lat) : null;
        const lng = (p.lng != null) ? Number(p.lng) : null;
        const hasLL = Number.isFinite(lat) && Number.isFinite(lng);
        return { q: q || (hasLL ? `${lat},${lng}` : ''), lat: hasLL ? lat : null, lng: hasLL ? lng : null };
      }

      return null;
    }).filter(Boolean);

    if(!route || pts.length < 2){
      el.innerHTML = '';
      return;
    }

    const gUrl = buildGoogleDirUrlFromPoints(pts, mode);

/*      --- Stops (中間的停靠點數量) --- */
    const stopCount = Math.max(0, pts.length - 2);

/*      --- 先準備座標點（只有有 lat/lng 的才拿來畫縮圖 + OSRM）--- */
    const stopLatLngs = pts.filter(p=>Number.isFinite(p.lat) && Number.isFinite(p.lng)).map(p=>({lat:p.lat, lng:p.lng}));

/*      --- center / zoom --- */
    const centerObj = parseLatLng(route?.preview?.center || '') || (stopLatLngs[0] || null);
    const centerStr = centerObj ? `${centerObj.lat},${centerObj.lng}` : '';
    const zoom = route?.preview?.zoom || 11;

/*      --- Road distance (優先：route.distance_km > OSRM > (不顯示/直線估算)) --- */
    let roadKm = (route?.distance_km != null) ? Number(route.distance_km) : null;
    if(!Number.isFinite(roadKm)) roadKm = null;

/*      OSRM 取得道路路徑 + 距離（不需要 API Key；但可能因網路/CORS 失敗） */
    let pathLatLngs = null;
    if(roadKm == null && stopLatLngs.length >= 2){
      try{
        const osrm = await fetchOsrmRoute(stopLatLngs, mode);
        if(osrm?.distanceKm != null) roadKm = osrm.distanceKm.toFixed(1);
        if(osrm?.pathLatLngs?.length) pathLatLngs = osrm.pathLatLngs;
      }catch(e){
/*          失敗就不顯示 km（避免再回到直線 65km 那種誤差） */
        console.warn('OSRM route failed:', e);
      }
    }

/*      沒有 OSRM 路徑就用停靠點直線（至少能畫出大概） */
    if(!pathLatLngs) pathLatLngs = stopLatLngs;

    const meta = `${stopCount} 個停留點` + (roadKm != null ? ` · 預計行駛 ${roadKm} km` : '');

/*      --- UI：維持你第 3 張那個卡片排版 --- */
    el.innerHTML = `
      <div class="route-card">
        <div class="route-thumb" id="routeMiniMap"></div>
        <div class="route-head">
          <div>
            <div class="route-title">Google Map 導航</div>
            <div class="route-meta">${meta}</div>
          </div>
          <a class="route-btn" href="${gUrl}" target="_blank" rel="noopener">
            <i class="fas fa-location-arrow" aria-hidden="true"></i>
            <span>開啟</span>
          </a>
        </div>
      </div>
    `;

/*      --- 縮圖地圖（用 OSRM 的道路路徑畫出「像第4張」的走法）--- */
    if(stopLatLngs.length){
      renderRouteMiniMap(pathLatLngs, stopLatLngs, centerStr, zoom);
    }
  }


  function buildGoogleDirUrlFromPoints(points, mode='drive'){
/*      points: [{q,lat,lng}, ...] */
    const list = points.map(p => (p?.q || (p?.lat!=null && p?.lng!=null ? `${p.lat},${p.lng}` : '')).trim()).filter(Boolean);
    if(list.length < 2) return 'https://www.google.com/maps';

    const origin = list[0];
    const dest   = list[list.length - 1];
    const wps    = list.slice(1, -1).join('|');   /* pipe-separated */

    const tm = travelModeForRoute(mode);
    return `https://www.google.com/maps/dir/?api=1`
      + `&origin=${encodeURIComponent(origin)}`
      + `&destination=${encodeURIComponent(dest)}`
      + (wps ? `&waypoints=${encodeURIComponent(wps)}` : '')
      + `&travelmode=${tm}`;
  }
  function buildGoogleDirPathUrl(points){
/*      https://www.google.com/maps/dir/點1/點2/點3/點4 */
    const path = points.map(p => encodeURIComponent(p)).join('/');
    return `https://www.google.com/maps/dir/${path}`;
  }
  function parseLatLng(s){
/*      支援 "lat,lng" 字串 */
    if(!s) return null;
    const m = String(s).trim().match(/^(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)$/);
    if(!m) return null;
    const lat = parseFloat(m[1]);
    const lng = parseFloat(m[3]);
    if(Number.isNaN(lat) || Number.isNaN(lng)) return null;
    return {lat, lng};
  }
  function normalizeLatLng(p){
    if(!p) return null;
    if(typeof p === 'string') return parseLatLng(p);
    if(Array.isArray(p) && p.length>=2){
      const lat = Number(p[0]), lng = Number(p[1]);
      if(Number.isFinite(lat) && Number.isFinite(lng)) return {lat,lng};
      return null;
    }
    if(typeof p === 'object' && Number.isFinite(p.lat) && Number.isFinite(p.lng)){
      return {lat:Number(p.lat), lng:Number(p.lng)};
    }
    return null;
  }


  function haversineKm(a, b){
    const R = 6371; /* Earth radius km */
    const toRad = (d)=> d*Math.PI/180;
    const dLat = toRad(b.lat - a.lat);
    const dLng = toRad(b.lng - a.lng);
    const lat1 = toRad(a.lat);
    const lat2 = toRad(b.lat);

    const x = Math.sin(dLat/2)**2 +
              Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
    return R * c;
  }

  
function estimateRouteKm(points){
/*    Fallback: straight-line (haversine) distance in km (UNDER-estimates driving distance). */
  const coords = (points||[]).map(parseLatLng).filter(Boolean);
  if(coords.length < 2) return null;
  let sum = 0;
  for(let i=0;i<coords.length-1;i++){
    sum += haversineKm(coords[i], coords[i+1]);
  }
  return sum;
}

/*  ✅ Preferred: get road route from OSRM and return { distanceKm, pathLatLngs } */
async function fetchOsrmRoute(latlngPoints, mode){
  try{
/*      latlngPoints 目前在 renderDayRouteCard 給的是 [{lat,lng}, ...] */
    const pts = (latlngPoints || [])
      .map(normalizeLatLng)     /*  -> {lat,lng} */
      .filter(Boolean);

    if(pts.length < 2) return null;

/*      OSRM 需要 lon,lat */
    const coords = pts.map(p => `${p.lng},${p.lat}`).join(';');

/*      OSRM demo server profiles: driving / walking / cycling */
    const m = (mode || 'drive').toLowerCase();
    const profile = (m === 'walk') ? 'walking' : 'driving';

    const url = `https://router.project-osrm.org/route/v1/${profile}/${coords}?overview=full&geometries=geojson`;

    const r = await fetch(url);
    const j = await r.json();

    if(!j || j.code !== 'Ok' || !j.routes || !j.routes[0]) return null;

    const distKm = (j.routes[0].distance || 0) / 1000;

/*      轉成 [{lat,lng}, ...]（跟你其他地方一致，renderRouteMiniMap 才能畫「道路曲線」） */
    const line = j.routes[0]?.geometry?.coordinates || [];
    const pathLatLngs = line.map(([lon, lat]) => ({ lat, lng: lon }));

    return { distanceKm: distKm, pathLatLngs };
  }catch(e){
    console.warn('OSRM route failed', e);
    return null;
  }
}


function buildOsmStaticThumb(center, zoom, points){
/*
     OSM 靜態地圖服務（免 key）
     需要 center，否則就用第一個點（若是座標可用）或 fallback 一張 placeholder
*/
    const base = 'https://staticmap.openstreetmap.fr/staticmap.php';

    const c = (center && center.includes(',')) ? center : null;

/*      markers：最多建議放 5 個，不然 URL 太長（你要更多點就只放起訖） */
    const mk = [];
    const pick = points.length <= 5 ? points : [points[0], points[points.length-1]];

/*      若 pick 是 "lat,lng" 才能當 marker；若是文字地址 OSM 靜態圖沒辦法地理編碼 */
    pick.forEach(p=>{
      if(/^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/.test(p)){
        mk.push(`&markers=${encodeURIComponent(p)},lightblue1`);
      }
    });

/*      沒 center 又沒有座標 marker → 給一張淡底圖（避免 broken image） */
    if(!c && mk.length === 0){
      return 'data:image/svg+xml,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="800" height="450">
          <rect width="100%" height="100%" fill="#f3f1ee"/>
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
            fill="#9a938a" font-size="24" font-family="system-ui, -apple-system">
            請在 route.preview.center 設定座標
          </text>
        </svg>`
      );
    }

    const centerParam = c ? `center=${encodeURIComponent(c)}&zoom=${encodeURIComponent(zoom)}` : '';
    return `${base}?${centerParam}&size=800x450&maptype=mapnik${mk.join('')}`;
  }

  let __routeMap = null;

  
function renderRouteMiniMap(pathLatLngs, stopLatLngs, fallbackCenterStr, zoom){
  if(!window.L) return;

  const container = document.getElementById('routeMiniMap');
  if(!container) return;

/*    reset old map instance */
  if(window.__routeMap){
    try{ window.__routeMap.remove(); }catch(e){}
    window.__routeMap = null;
  }

  const centerObj = parseLatLng(fallbackCenterStr) || stopLatLngs?.[0] || pathLatLngs?.[0] || {lat:34.25, lng:134.105};
  const map = L.map(container, {
    zoomControl:false,
    attributionControl:false,
    dragging:false,
    scrollWheelZoom:false,
    doubleClickZoom:false,
    boxZoom:false,
    keyboard:false,
    tap:false
  }).setView([centerObj.lat, centerObj.lng], zoom || 11);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

/*    --- route line (用 OSRM 的道路 polyline 會更像 Google 那種走法) --- */
  if(Array.isArray(pathLatLngs) && pathLatLngs.length >= 2){
    const line = L.polyline(pathLatLngs.map(p=>[p.lat,p.lng]), {
      weight: 5,
      opacity: .95,
      lineCap: 'round',
      lineJoin: 'round'
    }).addTo(map);

/*      subtle outline */
    L.polyline(pathLatLngs.map(p=>[p.lat,p.lng]), {
      weight: 10,
      opacity: .18,
      lineCap: 'round',
      lineJoin: 'round'
    }).addTo(map);

    try{ map.fitBounds(line.getBounds(), {padding:[14,14]}); }catch(e){}
  }else if(Array.isArray(stopLatLngs) && stopLatLngs.length >= 2){
    const line = L.polyline(stopLatLngs.map(p=>[p.lat,p.lng]), { weight: 4, opacity: .75 }).addTo(map);
    try{ map.fitBounds(line.getBounds(), {padding:[14,14]}); }catch(e){}
  }

/*    --- stop markers (只放停靠點，不要把整條 polyline 每點都變 marker) --- */
  (stopLatLngs || []).forEach((p, i)=>{
    const isStart = (i === 0);
    const isEnd   = (i === (stopLatLngs.length - 1));
    const cls = isStart ? 'rm-start' : (isEnd ? 'rm-end' : 'rm-stop');

    const icon = L.divIcon({
      className: `rm-pin ${cls}`,
      html: `<span>${isStart ? 'S' : (isEnd ? 'G' : (i))}</span>`,
      iconSize: [24,24],
      iconAnchor: [12,12]
    });
    L.marker([p.lat, p.lng], { icon }).addTo(map);
  });

  window.__routeMap = map;
}


async function renderWeatherJMA(meta){
        const el = document.getElementById('weatherStrip');
        if(!el) return;

/*          你想要 01:00~24:00 */
        const pad2 = (n)=>String(n).padStart(2,'0');

/*
         ✅ 16 天限制：如果日期太遠，顯示提示（避免你覺得“不准”）
         這裡用「今天」對比 meta.file 裡的 YYYY-MM-DD（如果你不想依賴 file，可改你自己的 date_range）
*/
        const m = String(meta?.file || '').match(/\d{4}-\d{2}-\d{2}/);
        const iso = m ? m[0] : '';
        if(!iso){
            el.innerHTML = `<div style="padding:10px; color:var(--ink2); font-weight:900;">找不到日期（meta.file 需包含 YYYY-MM-DD）</div>`;
            return;
        }

        const today = new Date();
        const target = new Date(iso + 'T00:00:00');
        const diffDays = Math.floor((target - new Date(today.getFullYear(), today.getMonth(), today.getDate())) / 86400000);

        if(diffDays < 0 || diffDays > 16){
            el.innerHTML = `<div style="padding:10px; color:var(--ink2); font-weight:900; line-height:1.5;">
            逐時預報只提供未來 16 天。<br/>
            （目前點選是 <b>${iso}</b>）
            </div>`;
            return;
        }

        const ll = getLatLonForMeta(meta);
        if(!ll){
            el.innerHTML = `<div style="padding:10px; color:var(--ink2); font-weight:900; line-height:1.5;">
            尚未設定經緯度：請在 <code>data/itinerary.index.json</code> 這一天加 <code>lat</code> / <code>lon</code>
            </div>`;
            return;
        }

        const url =
            `https://api.open-meteo.com/v1/jma?latitude=${encodeURIComponent(ll.lat)}&longitude=${encodeURIComponent(ll.lon)}`
            + `&hourly=temperature_2m,weather_code`
            + `&forecast_days=16`
            + `&timezone=Asia%2FTokyo`;

        try{
            const data = await fetch(url).then(r=>r.json());
            const times = data?.hourly?.time || [];
            const temps = data?.hourly?.temperature_2m || [];
            const codes = data?.hourly?.weather_code || [];

            const rows = [];
            for(let h=1; h<=24; h++){
            const hh = (h === 24) ? 0 : h;
            const day = (h === 24) ? new Date(target.getTime() + 86400000) : target;
            const y = day.getFullYear();
            const mo = pad2(day.getMonth()+1);
            const d = pad2(day.getDate());
            const tKey = `${y}-${mo}-${d}T${pad2(hh)}:00`;

            const idx = times.indexOf(tKey);
            if(idx === -1){
                rows.push({ time: pad2(h)+':00', icon:'fa-minus', temp:'—' });
                continue;
            }
            const icon = wmoToFa(Number(codes[idx] ?? 0), hh);
            const temp = temps[idx] != null ? Math.round(temps[idx]) + '°' : '—';
            rows.push({ time: pad2(h)+':00', icon, temp });
            }

            el.innerHTML = rows.map(r=>`
            <div class="weather-hour">
                <div class="w-time">${r.time}</div>
                <div class="w-icon"><i class="fas ${r.icon}"></i></div>
                <div class="w-temp">${r.temp}</div>
            </div>
            `).join('');
        }catch(e){
            el.innerHTML = `<div style="padding:10px; color:var(--ink2); font-weight:900;">
            讀取天氣失敗（網路/CORS/服務暫時不可用）
            </div>`;
        }
    }



  function buildGoogleDirUrlForItem(item){
/*      route item：用 directions */
    const r = item?.route;
    if(r?.from && r?.to){
      const tm = travelModeForRoute(r.mode);
      return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(r.from)}&destination=${encodeURIComponent(r.to)}&travelmode=${tm}`;
    }
/*      一般景點：用 search */
    return buildGoogleNavUrl(item);
  }

  function normalizeAssetUrl(src){
    const s = String(src || '').trim();
    if(!s) return '';
/*      外部連結 / base64 不動 */
    if(/^https?:\/\//i.test(s) || s.startsWith('data:')) return s;
/*      以 / 開頭：改成相對路徑，讓它跟 index.html 同層開始找 */
    return s.startsWith('/') ? ('.' + s) : s;
  }

  if(!window.__modalBound){
    window.__modalBound = true;
    document.getElementById('modalSheet')?.addEventListener('click', (e) => {
      const speakBtn = e.target.closest?.('.menuSpeak');
      if(speakBtn){
        e.stopPropagation();
        const text = speakBtn.getAttribute('data-speak') || '';
        speakJapanese(text);
        return;
      }
      const pill = e.target.closest?.('.menuPill');
      if(!pill) return;
      const isRec = pill.getAttribute('data-rec') === '1';
      if(!isRec) return;
      const idx = Number(pill.getAttribute('data-menu-idx'));
      const m = window.__activeModalItem?.menu?.[idx];
      if(m) openMenuCard(m);
    });
  }




/*    ====== Modal：預計到達/地址/停車/Mapcode/介紹 + Google 導航 ====== */
  function openModal(itemIdx) {
    const item = currentDayData?.items?.[itemIdx];
    if(!item) return;
    window.__activeModalItem = item;


    const hours = item.hours ? `<span class="pill"><i class="fas fa-clock"></i> ${escapeHtml(item.hours)}</span>` : '';
    const price = item.price ? `<span class="pill"><i class="fas fa-ticket"></i> ${escapeHtml(item.price)}</span>` : '';
    const stay  = item.stay  ? `<span class="pill"><i class="fas fa-hourglass-half"></i> ${escapeHtml(item.stay)}</span>` : '';

    const guideList = (item.guide || []).length
      ? `<div class="block"><h4><i class="fas fa-headset"></i> 特色介紹</h4><ul class="bullet">${item.guide.map(x=>`<li>${escapeHtml(x).replace(/\n/g,'<br>').replace(/^\[(.+?)\]：/,'<strong>[$1]：</strong>')}</li>`).join('')}</ul></div>`
      : '';

    const avoidList = (item.avoid || []).length
      ? `<div class="block"><h4><i class="fas fa-triangle-exclamation"></i> 注意事項</h4><ul class="bullet">${item.avoid.map(x=>`<li>${escapeHtml(x).replace(/\n/g,'<br>').replace(/^\[(.+?)\]：/,'<strong>[$1]：</strong>')}</li>`).join('')}</ul></div>`
      : '';

    const menuBlock = (item.menu || []).length ? `
      <div class="menu-box">
        <div class="menu-box-head">
          <i class="fas fa-thumbs-up"></i> 必吃美食
        </div>
        <div class="menu-table">
          ${(item.menu || []).map((m, idx) => {
            const jpRaw = (m.jp || '');
            const jp = escapeHtml(jpRaw);
            const zh = escapeHtml(m.zh || '');
            const isRec = m.rec === true || m.recommend === true;

/*              ✅ 只讓推薦的項目可以點開（維持你原本邏輯） */
            const pillCls = `menu-row ${isRec ? 'menuPill' : ''}`;

            return `
              <div class="${pillCls}" data-menu-idx="${idx}" data-rec="${isRec ? '1':'0'}">
                <div class="menu-jp">
                  <button class="menuSpeak" type="button" data-speak="${escapeHtml(m.speak || jpRaw)}" aria-label="speak">
                    <i class="fas fa-volume-up"></i>
                  </button>
                  <span>${jp}</span>
                </div>
                <div class="menu-zh">${zh}</div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    ` : '';


    const reserveBlock = (item.reservations || []).length
      ? `<div class="block">
            <h4><i class="fas fa-receipt"></i> 預約資訊</h4>
            ${(item.reservations||[]).map(r=>`
                <div class="meta-row" style="padding:6px 0; border-bottom:1px dashed rgba(233,225,214,.85);">
                <span class="meta-ico"><i class="fas fa-hashtag"></i></span>
                <span class="meta-val"><b>${escapeHtml(r.label||'')}</b>：${escapeHtml(r.value||'')}</span>
                <button class="mini-btn" onclick="copyText('${escapeHtml(r.value||'')}')">複製</button>
                </div>
            `).join('')}
        </div>`
    : '';							

    const detailText = item.detail || item.desc || '';

/*      ✅ 支援 links 是「物件」或「陣列包一個物件」 */
    const links = Array.isArray(item.links) ? (item.links[0] || {}) : (item.links || {});

/*      ✅ 用 JSON.stringify 避免引號/特殊字元把 onclick 撐爆 */
    const linkBtns = [
        links.official ? `<button class="btn btn-outline" onclick='openUrl(${JSON.stringify(String(links.official))})'>官網</button>` : '',
        links.reserve  ? `<button class="btn btn-outline" onclick='openUrl(${JSON.stringify(String(links.reserve))})'>reserveseat</button>` : '',
        links.menu     ? `<button class="btn btn-outline" onclick='openUrl(${JSON.stringify(String(links.menu))})'>meun</button>` : '',
        links.cupon    ? `<button class="btn btn-outline" onclick='openUrl(${JSON.stringify(String(links.cupon))})'>cupon</button>` : '',
        links.floormap      ? `<button class="btn btn-outline" onclick='openUrl(${JSON.stringify(String(links.floormap))})'>樓層地圖</button>` : '',
    ].filter(Boolean).join('');

    const linkBtnsHtml = linkBtns ? `<div class="link-grid">${linkBtns}</div>` : '';

/*      ✅ 你要的欄位（eta/arrive/arrival 皆可） */
    const eta = item.eta || item.arrive || item.arrival || '';
    const addr = item.addr || '';
    const parking = item.parking || '';
    const mapcode = item.mapcode || '';

    const navUrl = buildGoogleDirUrlForItem(item);

    const sticky = document.getElementById('modalSticky');
    const body   = document.getElementById('modalBody');

    sticky.innerHTML = `
        <div class="modal-sticky-wrap ${tagClass(item.tag)}">
            <div class="sheet-head">
                <div class="tag-chip ${tagClass(item.tag)}">
                    <div class="sheet-tag ${tagClass(item.tag)}">
                      ${escapeHtml((item.tag||'').toUpperCase())}
                      ${((item.tag||'').toLowerCase()==='takagi') ? getTagIconHtml('takagi', itemIdx) : ''}
                    </div>
                </div>
            <div class="sheet-time"><i class="fa-regular fa-clock" style="color:#8B8175;"></i>${escapeHtml(item.time || '—')}</div>
            </div>

            <div class="modal-title">${escapeHtml(item.title || '')}</div>

            <div class="pill-row">
            ${hours}${price}${stay}
            </div>
        </div>
    `;



    body.innerHTML = `
      <div class="meta-box">
        ${eta ? `
        <div class="meta-row">
          <span class="meta-ico"><i class="fa-regular fa-clock"></i></span>
          <span class="meta-val">預計到達：${escapeHtml(eta)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(eta)}')">複製</button>
        </div>` : ''}

        ${addr ? `
        <div class="meta-row">
          <span class="meta-ico"><i class="fas fa-location-dot"></i></span>
          <span class="meta-val">${escapeHtml(addr)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(addr)}')">複製</button>
        </div>` : ''}

        ${parking ? `
        <div class="meta-row">
          <span class="meta-ico"><i class="fas fa-square-parking"></i></span>
          <span class="meta-val">${escapeHtml(parking)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(parking)}')">複製</button>
        </div>` : ''}

        ${mapcode ? `
        <div class="meta-row">
          <span class="meta-ico">🗾</span>
          <span class="meta-val">Mapcode：${escapeHtml(mapcode)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(mapcode)}')">複製</button>
        </div>` : ''}

        ${(!eta && !addr && !parking && !mapcode) ? `
        <div class="meta-row">
          <span class="meta-ico">ℹ️</span>
          <span class="meta-val">（此行程尚未填：到達/地址/停車/Mapcode）</span>
        </div>` : ''}
      </div>
      ${reserveBlock}	 
      ${menuBlock}
      <div class="detail">${escapeHtml(detailText)}</div>

      ${avoidList}
      ${guideList}
      ${linkBtnsHtml}


      


      <div class="sheet-actions">
        <a class="btn-primary" href="${navUrl}" target="_blank" rel="noopener">
          <i class="fas fa-location-arrow"></i> 開啟 Google Maps 導航
        </a>
      </div>`;

    lockBodyScroll();
    document.getElementById('modalOverlay').classList.add('active');
    document.getElementById('modalSheet').classList.add('active');
    showSheetSplash(item);

/*
    // === menu pill click + 喇叭 click：事件委派（只綁一次）===
    // document.getElementById('modalSheet')?.addEventListener('click', (e) => {
    //   const speakBtn = e.target.closest?.('.menuSpeak');
    //   if(speakBtn){
    //     e.stopPropagation();
    //     const text = speakBtn.getAttribute('data-speak') || '';
    //     speakJapanese(text);
    //     return;
    //   }

    //   const pill = e.target.closest?.('.menuPill');
    //   if(!pill) return;

    //   const isRec = pill.getAttribute('data-rec') === '1';
    //   if(!isRec) return; // 不是推薦就不開卡

    //   const idx = Number(pill.getAttribute('data-menu-idx'));
    //   const m = window.__activeModalItem?.menu?.[idx];
    //   if(m) openMenuCard(m);
    // });
*/

  }

/*
  // function openRouteMap(ev, idx){
  //   ev?.stopPropagation?.();

  //   const item = currentDayData?.items?.[idx];
  //   if(!item) return;

  //   const r = item.route || {};
  //   const from = r.from || '';
  //   const to   = r.to || '';
  //   if(!to) return;

  //   const mode = (r.mode || 'drive').toLowerCase();
  //   const travelmode =
  //     mode === 'walk'  ? 'walking' :
  //     mode === 'train' ? 'transit' :
  //     mode === 'ship'  ? 'transit' :
  //     mode === 'plane' ? 'transit' :
  //     'driving';

  //   window.open(
  //     `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from)}&destination=${encodeURIComponent(to)}&travelmode=${travelmode}`,
  //     '_blank',
  //     'noopener'
  //   );
  // }
*/
  function openRouteMap(ev, idx){
    ev?.stopPropagation?.();
    const item = currentDayData?.items?.[idx];
    if(!item?.route) return;

    const r = item.route;
    const tm = travelModeForRoute(r.mode);
/*     window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(r.from||'')}&destination=${encodeURIComponent(r.to||'')}&travelmode=${tm}`,
	    '_blank', 'noopener'); */
    window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(r.from||'')}&destination=${encodeURIComponent(r.to||'')}&travelmode=${tm}`, '_blank', 'noopener');
  }

  let __closingModal = false;

  function closeModal(){
    if(__closingModal) return;
    __closingModal = true;

    const overlay = document.getElementById('modalOverlay');
    const sheet   = document.getElementById('modalSheet');

    /*      ✅ 避免拖曳關閉時殘留 inline style 造成 transitionend 怪怪的 */
    overlay.style.opacity = '';
    sheet.style.transition = '';
    sheet.style.transform  = '';
    hideSheetSplash();
    

    /*      先讓 sheet 開始下滑 */
    sheet.classList.remove('active');
    closeMenuCard();

    /*      ✅ overlay 先淡出/先不擋視覺（你就不會覺得「多蓋一層灰」） */
    overlay.classList.remove('active');

    const done = ()=>{
      unlockBodyScroll();
      __closingModal = false;
    };

    /*      ✅ 保險：transitionend 有時候會不觸發（或被重排打斷） */
    const onEnd = (e)=>{
      if(e.target !== sheet) return;
      sheet.removeEventListener('transitionend', onEnd);
      done();
    };

    sheet.addEventListener('transitionend', onEnd);

    /*      fallback（比你的 .18s 稍長一點就好） */
    setTimeout(()=>{
      sheet.removeEventListener('transitionend', onEnd);
      done();
    }, 260);
  }


  function showUserDetail(userName) {
    const userExpenses = expenses.filter(e => e.payer === userName || e.participants.includes(userName));
    let html = `<div style="padding:10px;">`;
    userExpenses.forEach(e => {
      const isPayer = e.payer === userName;
      const symbol = e.currency === 'TWD' ? '$' : '¥';
      html += `<div style="margin-bottom:10px; border-bottom:1px dashed #DDD; padding-bottom:5px;">
        <div style="font-weight:800;">${e.name} (${e.currency})</div>
        <div style="font-size:0.85rem; color:#666;">${isPayer ? '你付了' : '你分攤'} ${symbol}${e.cost}</div>
      </div>`;
    });
    html += `</div>`;

    // 填入您現有的 Modal
    document.getElementById('modalSticky').innerHTML = `<div class="modal-title">${userName} 的個人明細</div>`;
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalOverlay').classList.add('active');
    document.getElementById('modalSheet').classList.add('active');
  }


  function openMenuCard(m){
    const card = document.getElementById('menuCard');
    if(!card) return;

    card.hidden = false;
    card.querySelector('.menuCardJp').textContent = m.jp || '';
    card.querySelector('.menuCardZh').textContent = m.zh || '';
    card.querySelector('.menuCardNote').textContent = m.note || '';

    const img = card.querySelector('.menuCardImg');
    if(m.img){
      img.src = m.img;
      img.style.display = 'block';
    }else{
      img.removeAttribute('src');
      img.style.display = 'none';
    }
    const desc = m.desc || m.note || m.detail || m.intro || '';
    


    const closeBtn = card.querySelector('.menuCardClose');
    closeBtn.onclick = closeMenuCard;
  }

  function closeMenuCard(){
    const card = document.getElementById('menuCard');
    if(card) card.hidden = true;
  }

  function speakJapanese(text){
    if(!text) return;
    if(!('speechSynthesis' in window)) return;

    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'ja-JP';

/*      嘗試挑 ja-JP voice（有的瀏覽器要 voiceschanged 後才拿得到） */
    const pickVoice = () => {
      const vs = window.speechSynthesis.getVoices?.() || [];
      const v = vs.find(v => (v.lang||'').toLowerCase().startsWith('ja'));
      if(v) u.voice = v;
      window.speechSynthesis.speak(u);
    };

    const voices = window.speechSynthesis.getVoices?.() || [];
    if(voices.length) pickVoice();
    else window.speechSynthesis.onvoiceschanged = pickVoice;
  }



/*    ===== Modal drag to close ===== */
  (function initModalDrag(){
    const sheet   = document.getElementById('modalSheet');
    const overlay = document.getElementById('modalOverlay');
    const handle  = document.querySelector('.modal-header');  /* 或改成 .modal-drag-handle */

    if(!sheet || !overlay || !handle) return;

    let startY = 0;
    let dy = 0;
    let dragging = false;

    function setTranslate(y){
      sheet.style.transform = `translateX(-50%) translateY(${y}px)`;
      sheet.style.transition = 'none';
/*        讓遮罩跟著變淡（可選） */
      const k = Math.max(0, 1 - y / 280);
      overlay.style.opacity = (0.38 * k).toFixed(3);
    }

    function reset(){
      sheet.style.transition = '';
      sheet.style.transform = '';        /* 交回給 .active 的 transform */
      overlay.style.opacity = '';        /* 交回給 CSS */
    }

    

    handle.addEventListener('pointerdown', (e)=>{
      if(!sheet.classList.contains('active')) return;
      dragging = true;
      startY = e.clientY;
      dy = 0;
      sheet.setPointerCapture?.(e.pointerId);
    });

    handle.addEventListener('pointermove', (e)=>{
      if(!dragging) return;
      dy = Math.max(0, e.clientY - startY);  /* 只允許往下拖 */
      setTranslate(dy);
    });

    handle.addEventListener('pointerup', (e)=>{
      if(!dragging) return;
      dragging = false;
      sheet.releasePointerCapture?.(e.pointerId);

/*        拖超過門檻就關掉，否則彈回 */
      if(dy > 120){
        reset();
        closeModal();
      }else{
/*          彈回原位 */
        sheet.style.transition = 'transform .18s cubic-bezier(.16,1,.3,1)';
        sheet.style.transform  = 'translateX(-50%) translateY(0)';
        overlay.style.opacity  = '0.38';
        setTimeout(reset, 200);
      }
    });

    handle.addEventListener('pointercancel', ()=>{
      if(!dragging) return;
      dragging = false;
      reset();
    });
  })();



  function openUrl(url){
    window.open(url, '_blank', 'noopener');
  }

/*    ====== 住宿/航班/記帳（沿用你原本邏輯） ====== */
  function renderHotels() {
    document.getElementById('hotelList').innerHTML = (HOTELS || []).map(h => {
      const dateText = h.stay ? `${h.stay.from} - ${h.stay.to}` : '';
      const img = (h.images && h.images[0]) ? h.images[0]
        : "https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&q=80&w=900";

      return `
        <div class="card" style="padding:0; overflow:hidden;">
          <img src="${escapeHtml(img)}" style="height:180px; width:100%; object-fit:cover; border-radius:20px; margin-bottom:0;">
          <div style="padding:20px;">
            <h3 style="margin:0 0 6px; font-family:'Noto Serif TC',serif; font-weight:900;">${escapeHtml(h.name || '')}</h3>
            <div style="color:var(--ink2); font-size:0.9rem; margin-bottom:10px; font-weight:800;">${escapeHtml(dateText)}</div>
            <div style="font-size:0.95rem; line-height:1.6; color:#444; font-weight:700;">
              ${escapeHtml(h.desc || '')}
            </div>
            ${h.mapcode ? `<div style="display:inline-block;background:rgba(255,235,238,.92);color:#B42318;padding:6px 10px;border-radius:999px;font-size:.82rem;font-weight:900;margin-top:10px;border:1px solid rgba(180,35,24,.15);">Mapcode: ${escapeHtml(h.mapcode)}</div>` : ''}
            <button class="btn btn-outline" style="margin-top:15px;" onclick="openUrl('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.name || '')}')">導航</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderFlights(){
    const el = document.getElementById('flightBoard');
    const out = FLIGHTS?.outbound;
    const inn = FLIGHTS?.inbound;

    el.innerHTML = [out, inn].filter(Boolean).map((f, idx) => {
      const isOut = idx === 0;
      const label = isOut ? `去程 ${mmdd(f.date)} (${weekdayZh(f.date)})` : `回程 ${mmdd(f.date)} (${weekdayZh(f.date)})`;
      const carrier = FLIGHTS?.carrier || '';
      const baggage = f.baggage ? `${f.baggage.checked || ''} / ${f.baggage.pieces || ''}件` : '';
      const terminal = f.from?.terminal ? `• ${f.from.terminal}` : '';

      return `
        <div class="boarding">
          <div class="boarding-top">
            <div class="row">
              <div class="boarding-badge"><i class="fas fa-plane"></i> ${escapeHtml(label)}</div>
              <div style="font-weight:900; color:#333;">${escapeHtml(f.flight_no || '')}</div>
            </div>
            <div style="margin-top:8px; color:var(--ink2); font-weight:800;">${escapeHtml(carrier)} • ${escapeHtml(f.aircraft || '')}</div>
          </div>

          <div class="boarding-mid">
            <div style="text-align:left;">
              <div class="code">${escapeHtml(f.from?.code || '')}</div>
              <div class="t">${escapeHtml(f.from?.city || '')} • ${escapeHtml(f.depart_time || '')} ${escapeHtml(terminal)}</div>
            </div>
            <i class="fas fa-arrow-right" style="color:#B9B2AA; font-size:1.1rem;"></i>
            <div style="text-align:right;">
              <div class="code">${escapeHtml(f.to?.code || '')}</div>
              <div class="t">${escapeHtml(f.to?.city || '')} • ${escapeHtml(f.arrive_time || '')}</div>
            </div>
          </div>

          <div class="boarding-bottom">
            <div><i class="fas fa-suitcase-rolling"></i> 行李：${escapeHtml(baggage)}</div>
            <div><i class="fas fa-plane-departure"></i> 出發：${escapeHtml(f.from?.city || '')} ${escapeHtml(f.from?.terminal || '')}</div>
            <div><i class="fas fa-plane-arrival"></i> 抵達：${escapeHtml(f.to?.city || '')}</div>
          </div>
        </div>
      `;
    }).join('');
  }

/*    ====== 記帳（支援：參與者多選 / 行中 vs 預付） ====== */
  let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
  let curCurrency = 'JPY';  // 預設日幣
  const JPY_TWD_RATE = 0.21; // 您可以根據需求修改匯率
  let editingTs = null;      // 追蹤是否正在編輯
  let curParticipants = new Set();
  let curExpenseType = 'trip';  /* 'trip' | 'prepaid' */
  /* 💡 在 curCurrency = 'JPY' 附近添加 */
  function setCurrency(curr) {
      curCurrency = curr;
      // 更新按鈕 UI 高亮狀態
      document.querySelectorAll('#currencySwitch .seg-btn').forEach(btn => {
          btn.classList.toggle('active', btn.getAttribute('data-curr') === curr);
      });
      // 重新渲染，這會讓輸入框或列表即時反應
      renderExpenseUI(); 
  }
    

/*    兼容舊資料（沒有 participants/type 時補上） */
  function normalizeExpenses(){
    expenses = (Array.isArray(expenses) ? expenses : []).map(e => {
      const payer = (e?.payer || users[0] || 'L');
      const cost = Number(e?.cost);
      const name = String(e?.name || '').trim();
      const participants = Array.isArray(e?.participants) && e.participants.length
        ? e.participants.filter(x => users.includes(x))
        : users.slice();
      const type = (e?.type === 'prepaid') ? 'prepaid' : 'trip';
      return {
        name,
        cost: Number.isFinite(cost) ? cost : 0,
        payer,
        participants,
        type,
        ts: e?.ts || Date.now()
      };
    }).filter(e => e.name && e.cost > 0);
    localStorage.setItem('expenses', JSON.stringify(expenses));
  }

  function setExpenseType(type){
    curExpenseType = (type === 'prepaid') ? 'prepaid' : 'trip';
    renderExpenseUI();
  }

  function toggleParticipant(u){
    if(curParticipants.has(u)){
/*        至少留 1 個 */
      if(curParticipants.size <= 1) return;
      curParticipants.delete(u);
    }else{
      curParticipants.add(u);
    }
    renderExpenseUI();
  }

  function renderExpenseUI() {
    /*      初始化 participants：預設全選 */
    if(curParticipants.size === 0){
      users.forEach(u => curParticipants.add(u));
    }

    /*      payer tabs */
    document.getElementById('payerSwitch').innerHTML = users.map(u =>
      `<div class="user-tab ${u===curPayer?'active':''}" onclick="curPayer='${u}'; renderExpenseUI();">${escapeHtml(u)}</div>`
    ).join('');

    /*      type segmented */
    const typeEl = document.getElementById('expTypeSwitch');
    if(typeEl){
      typeEl.querySelectorAll('.seg-btn').forEach(btn => {
        const t = btn.getAttribute('data-type');
        btn.classList.toggle('active', t === curExpenseType);
      });
    }

    /*      participants chips */
    const partEl = document.getElementById('partSwitch');
    if(partEl){
      partEl.innerHTML = users.map(u => {
        const on = curParticipants.has(u);
        return `<span class="chip ${on?'on':'off'}" onclick="toggleParticipant('${escapeHtml(u)}')">
          <i class="fas ${on?'fa-user-check':'fa-user'}" style="opacity:${on?0.55:0.35};"></i>${escapeHtml(u)}
        </span>`;
      }).join('');
    }

    /*      list */
    const listEl = document.getElementById('expenseList');
    if(listEl){
      listEl.innerHTML = expenses
        .slice()
        .sort((a,b)=> (b.ts||0) - (a.ts||0))
        .map((e,i) => {
          const parts = Array.isArray(e.participants) && e.participants.length ? e.participants : users;
          const typeLabel = e.type === 'prepaid' ? '預付' : '行中';
          const typeCls = e.type === 'prepaid' ? 'prepaid' : 'trip';
          const symbol = e.currency === 'TWD' ? '$' : '¥';
          const altSymbol = e.currency === 'TWD' ? '¥' : '$';
          // 簡單換算邏輯
          const altCost = e.currency === 'TWD' ? Math.round(e.cost / JPY_TWD_RATE) : Math.round(e.cost * JPY_TWD_RATE);
          return `
            <div style="display:flex; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px solid rgba(233,225,214,.8);">
              <div style="min-width:0;">
                <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                  <div style="font-weight:900;">${escapeHtml(e.name)}</div>
                  <span class="exp-badge ${typeCls}"><i class="fas ${e.type==='prepaid'?'fa-receipt':'fa-bag-shopping'}" style="opacity:.55;"></i>${typeLabel}</span>
                </div>
                <div style="font-size:0.8rem; color:var(--ink2); font-weight:800; margin-top:4px;">
                  ${escapeHtml(e.payer)} 付款 · 分攤：${escapeHtml(parts.join('、'))}
                </div>
              </div>
              <div style="text-align:right; flex:0 0 auto;">
                <div style="font-weight:900;">${symbol}${e.cost}</div>
                <div style="font-size:0.75rem; color:#999; font-weight:700;">(${altSymbol}${altCost})</div>
                <div style="font-size:0.8rem; margin-top:4px;">
                  <span style="color:var(--accent); cursor:pointer; font-weight:900; margin-right:8px;" onclick="startEdit(${e.ts})">編輯</span>
                  <span style="color:#B42318; cursor:pointer; font-weight:900;" onclick="delExpByTs(${e.ts})">刪除</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
    }

    // 修改計算 bal 的邏輯，拆成兩組
    let balJPY = {}, balTWD = {};
    users.forEach(u => { balJPY[u]=0; balTWD[u]=0; });

    expenses.forEach(e => {
      const parts = e.participants || users;
      const share = e.cost / parts.length;
      const targetBal = (e.currency === 'TWD') ? balTWD : balJPY; // 💡 判斷要加到哪組

      if(users.includes(e.payer)) targetBal[e.payer] += e.cost;
      parts.forEach(u => { if(users.includes(u)) targetBal[u] -= share; });
    });

    // 渲染時顯示兩行
    debtEl.innerHTML = users.map(u => {
      return `
        <div style="padding:10px 0; border-bottom:1px solid #EEE;" onclick="showUserDetail('${u}')">
          <div style="font-weight:900; color:var(--primary); cursor:pointer;">👤 ${u} (點擊明細)</div>
          <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
            <span style="color:${balJPY[u]>=0?'#2F8F5B':'#B42318'}">日幣：${balJPY[u]>=0?'收':'付'} ¥${Math.abs(Math.round(balJPY[u]))}</span>
            <span style="color:${balTWD[u]>=0?'#2F8F5B':'#B42318'}">台幣：${balTWD[u]>=0?'收':'付'} $${Math.abs(Math.round(balTWD[u]))}</span>
          </div>
        </div>`;
    }).join('');
    

    /*      summary */
    const sumEl = document.getElementById('expenseSummary');
    if(sumEl){
      const totalAll = expenses.reduce((a,e)=>a+Number(e.cost||0),0);
      const totalTrip = expenses.filter(e=>e.type!=='prepaid').reduce((a,e)=>a+Number(e.cost||0),0);
      const totalPre = expenses.filter(e=>e.type==='prepaid').reduce((a,e)=>a+Number(e.cost||0),0);

      sumEl.innerHTML = `
        <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(233,225,214,.8); font-weight:900;">
          <span>行中支出</span><span>¥${Math.round(totalTrip)}</span>
        </div>
        <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(233,225,214,.8); font-weight:900;">
          <span>預付費用</span><span>¥${Math.round(totalPre)}</span>
        </div>
        <div style="display:flex; justify-content:space-between; padding:10px 0; font-weight:900;">
          <span>目前總花費</span><span>¥${Math.round(totalAll)}</span>
        </div>
        <div style="margin-top:10px; color:var(--ink2); font-size:.86rem; font-weight:800; line-height:1.45;">
          ✅ 分攤規則：只對「分攤成員」平均分攤（可 1 人、2–3 人…）。<br>
          ✅ 預付費用：可先記機票 / 飯店 / 預約票券，方便掌握總額。
        </div>
      `;
    }
  }

  function addExpense() {
    const name = document.getElementById('exName').value.trim();
    const cost = Number(document.getElementById('exCost').value);
    const participants = Array.from(curParticipants);
    
    if(!name || !Number.isFinite(cost) || cost<=0) return alert('請輸入正確項目與金額');
    if(participants.length<=0) return alert('請至少選一位分攤成員');
  
/*      建立資料物件 */
    const expData = {
      name,
      cost: Math.round(cost),
      payer: curPayer,
      participants,
      type: curExpenseType,
      currency: curCurrency, // 💡 紀錄這筆錢是日幣還是台幣
      ts: editingTs || Date.now() // 💡 如果是編輯，延用舊的時間戳記
    };
    if (editingTs) {
      // 編輯模式：取代舊資料
      const idx = expenses.findIndex(e => e.ts === editingTs);
      if(idx !== -1) expenses[idx] = expData;
      editingTs = null; // 重置
      const btn = document.querySelector('#page-money .btn');
      if(btn) btn.innerText = "加入紀錄";
    } 
    else {
      // 新增模式
      expenses.push(expData);
    }
  
    /*      1. 先更新本地 UI (讓使用者感覺反應很快) */
    localStorage.setItem('expenses', JSON.stringify(expenses));
    document.getElementById('exName').value = '';
    document.getElementById('exCost').value = '';
    renderExpenseUI();
  
    /*      2. 傳送到雲端 */
    cloudPost("addExpense", expData);
    // 清空輸入框
    document.getElementById('exName').value = '';
    document.getElementById('exCost').value = '';

  }

  /* 💡 新增：啟動編輯模式的 Function */
  function startEdit(ts) {
    const e = expenses.find(exp => exp.ts === ts);
    if(!e) return;
    
    editingTs = ts;
    document.getElementById('exName').value = e.name;
    document.getElementById('exCost').value = e.cost;
    curPayer = e.payer;
    curCurrency = e.currency || 'JPY';
    curExpenseType = e.type || 'trip';
    curParticipants = new Set(e.participants);
    
    // 💡 修正 1：變更按鈕文字以提供回饋
    const btn = document.querySelector('#page-money .btn');
    if(btn) btn.innerText = "更新紀錄 (取消請重整)";
    
    // 💡 修正 2：確保頁面捲回「新增支出」的區塊
    // 如果你有使用 header 或 padding，捲動到 0 或是該 Card 的位置
    window.scrollTo({ top: 0, behavior: 'smooth' });
    renderExpenseUI();
  }

  function delExpByTs(ts) {
    const t = Number(ts);
    if (!Number.isFinite(t)) return;
  
/*      1. 使用確認對話框 (優化語氣) */
    if (!confirm('確定要永久刪除這筆紀錄嗎？此動作將同步移除雲端資料。')) return;
  
/*      2. 本地資料過濾 */
    const index = expenses.findIndex(e => Number(e.ts) === t);
    if (index === -1) return;
  
/*      備份一份資料，萬一失敗可以回滾 (BIOS 工程師習慣的備援機制) */
    const deletedItem = expenses[index];
    
/*      先從本地陣列移除 */
    expenses.splice(index, 1);
    localStorage.setItem('expenses', JSON.stringify(expenses));
    
/*      3. 立即刷新 UI (Optimistic UI 更新，讓使用者感覺很快) */
    renderExpenseUI();
  
/*      4. 同步至雲端 */
    fetch(G_API_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify({
        token: G_TOKEN,
        action: "deleteExpense",
        data: { ts: t }
      })
    }).then(() => {
      console.log(`雲端刪除成功: ${t}`);
    }).catch(err => {
      console.error("雲端刪除失敗，資料可能在下次重新整理時恢復", err);
      alert("網路連線不穩，雲端同步失敗。");
    });
  }

  
/*    ====== Desktop: wheel -> horizontal scroll for horizontal strips ====== */
  function enableWheelHorizontal(el){
    if(!el) return;
    el.addEventListener('wheel', (e)=>{
/*        只在滑鼠停在可水平滾動區塊時，把滾輪轉成水平移動 */
      if(Math.abs(e.deltaY) > Math.abs(e.deltaX)){
        e.preventDefault();
        el.scrollLeft += e.deltaY;
      }
    }, { passive:false });
  }

/*  utils */
  function escapeHtml(str){
    return String(str ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function unescapeHtml(str){
    return String(str ?? '')
      .replaceAll('&amp;','&')
      .replaceAll('&lt;','<')
      .replaceAll('&gt;','>')
      .replaceAll('&quot;','"')
      .replaceAll('&#39;',"'");
  }
  function copyText(txt) {
    navigator.clipboard.writeText(txt);
    alert('已複製：' + txt);
  }
  function speakJapanese(text){
    const t = String(text||'').trim();
    if(!t) return;

    if(!('speechSynthesis' in window)) return;

    const u = new SpeechSynthesisUtterance(t);
    u.lang = 'ja-JP';
    u.rate = 0.95;
    u.pitch = 1.0;

/*      嘗試挑 ja-JP voice */
    const voices = speechSynthesis.getVoices?.() || [];
    const ja = voices.find(v => (v.lang||'').toLowerCase().startsWith('ja'));
    if(ja) u.voice = ja;

    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

/*    確保 menu card 的 DOM 存在 */
  function ensureMenuCardUI(){
    if(document.getElementById('menuCardOverlay')) return;

    const overlay = document.createElement('div');
    overlay.id = 'menuCardOverlay';
    overlay.style.cssText = `
      position:fixed; inset:0;
      background:rgba(0,0,0,.38);
      z-index:3000;
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:0 12px calc(14px + env(safe-area-inset-bottom));
    `;

    overlay.innerHTML = `
      <div id="menuCardSheet" style="
        width:min(560px, 100%);
        background:#FAF7F2;
        border-radius:22px;
        border:1px solid rgba(233,225,214,.95);
        box-shadow:0 22px 60px rgba(0,0,0,.22);
        overflow:hidden;
      ">
        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(233,225,214,.8);">
          <div style="font-weight:900;">品項介紹</div>
          <button onclick="closeMenuCard()" style="
            width:34px;height:34px;border-radius:999px;
            border:1px solid rgba(233,225,214,.95);
            background:#fff;font-size:18px;display:flex;align-items:center;justify-content:center;
          ">×</button>
        </div>
        <div id="menuCardBody" style="padding:14px;"></div>
      </div>
    `;

    overlay.addEventListener('click', (e)=>{
      if(e.target === overlay) closeMenuCard();
    });

    document.body.appendChild(overlay);
  }

  function openMenuCard(m){
    ensureMenuCardUI();
    const ov = document.getElementById('menuCardOverlay');
    const body = document.getElementById('menuCardBody');
    if(!ov || !body) return;

    const img = (m.img || '').trim();
    const desc = (m.desc || '').trim();

    body.innerHTML = `
      ${img ? `<img src="${escapeHtml(img)}" alt="" style="width:100%; aspect-ratio:16/9; object-fit:cover; border-radius:14px; border:1px solid rgba(233,225,214,.9);">` : ``}
      <div style="margin-top:10px; font-weight:900; font-size:1.05rem;">${escapeHtml(m.jp || '')}</div>
      <div style="margin-top:4px; color:var(--ink2); font-weight:800;">${escapeHtml(m.zh || '')}</div>
      ${desc ? `<div style="margin-top:10px; line-height:1.65; color:#3A352E; font-weight:700;">${escapeHtml(desc).replace(/\n/g,'<br>')}</div>` : ``}
      ${desc ? `<div class="menuCardDesc">${escapeHtml(desc).replace(/\n/g,'<br>')}</div>` : ``}
    `;

    ov.style.display = 'flex';
  }

  function closeMenuCard(){
    const ov = document.getElementById('menuCardOverlay');
    if(ov) ov.style.display = 'none';
  }


  function mmdd(iso){
    if(!iso) return '';
    const m = String(iso).slice(5,7);
    const d = String(iso).slice(8,10);
    return `${m}/${d}`;
  }
  function weekdayZh(iso){
    if(!iso) return '';
    const dt = new Date(iso + "T00:00:00");
    const arr = ['日','一','二','三','四','五','六'];
    return arr[dt.getDay()];
  }

  let __scrollY = 0;
  function lockBodyScroll(){
    __scrollY = window.scrollY || 0;

/*      iOS 最穩：把 body 固定住 */
    document.body.classList.add('body-no-scroll'); /*  你原本那個 class 可以留著 */
    document.body.style.position = 'fixed';
    document.body.style.top = `-${__scrollY}px`;
    document.body.style.left = '0';
    document.body.style.right = '0';
    document.body.style.width = '100%';
  }

  function unlockBodyScroll(){
    document.body.classList.remove('body-no-scroll');
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.left = '';
    document.body.style.right = '';
    document.body.style.width = '';

    window.scrollTo(0, __scrollY);
  }

  function bindLongPressSelection() {
/*      選取所有非路徑的行程項目 */
/*      const items = document.querySelectorAll('.timeline-item:not(.route-item)'); */
/*      ✅ 修正 1：移除 :not(.route-item)，讓路徑卡片也能長壓進入編輯模式 */
    const items = document.querySelectorAll('.timeline-item');
    
    items.forEach(el => {
      let pressTimer;
      let isLongPress = false;
      let startPos = { x: 0, y: 0 };
  
/*        攔截系統選單中斷 */
      el.oncontextmenu = (e) => {
        if (!__tlEditMode) e.preventDefault(); 
      };
  
/*
//       const start = (e) => {
//         if (__tlEditMode) return; 
//         
//         isLongPress = false;
//         startPos = { x: e.clientX, y: e.clientY };
//         
//         // 啟動 700ms 定時器
//         pressTimer = setTimeout(() => {
//           isLongPress = true;
//           triggerEditMode(el);
//         }, 700); 
//       };
*/
/*      ✅ 修改：將原始事件 e 傳入 triggerEditMode */
    const start = (e) => {
      if (__tlEditMode) return; 
      
      isLongPress = false;
      startPos = { x: e.clientX, y: e.clientY };
      
/*        啟動 700ms 定時器 */
      pressTimer = setTimeout(() => {
        isLongPress = true;
        triggerEditMode(el, e);  /* 👈 這裡多傳入 e */
      }, 700); 
    };
  
      const cancel = (e) => {
        clearTimeout(pressTimer);
        
/*          如果不是長壓，且是正常放開指針，則視為「點擊」打開 Modal */
        if (!isLongPress && e.type === 'pointerup') {
/*            檢查位移，避免滑動時意外開啟 Modal */
          const dist = Math.hypot(e.clientX - startPos.x, e.clientY - startPos.y);
          if (dist < 10) {
            const idx = el.dataset.idx;
/*              openModal(idx); */
            if (idx !== undefined) openModal(idx);
          }
        }
      };
  
/*        如果移動距離過大（在滑動網頁），則取消長壓偵測 */
      const move = (e) => {
        const dist = Math.hypot(e.clientX - startPos.x, e.clientY - startPos.y);
/*          if (dist > 10) clearTimeout(pressTimer); */
/*
         ✅ 關鍵：提高「取消長壓」的門檻到 30px
         只要手指移動超過 30 像素，就判定使用者是在「滑動網頁」，立刻殺掉定時器
*/
        if (dist > 20) {
          clearTimeout(pressTimer);
        }
      };
  
/*        綁定所有指針事件 */
      el.addEventListener('pointerdown', start);
      el.addEventListener('pointerup', cancel);
      el.addEventListener('pointermove', move);
      el.addEventListener('pointercancel', () => clearTimeout(pressTimer));
    });
  }

/*    ✅ 新增：統一的歷史紀錄推送函式 */
  function pushHistory() {
    if (currentDayData && currentDayData.items) {
      __editHistory.push(JSON.parse(JSON.stringify(currentDayData.items)));
/*        限制 Stack 大小為 10 步 */
      if (__editHistory.length > 10) __editHistory.shift();
      console.log("已紀錄歷史狀態，當前步數:", __editHistory.length);
    }
  }

/*
//   function triggerEditMode(targetEl) {
//     if (navigator.vibrate) navigator.vibrate(50); // 觸覺回饋
//     
//     // 紀錄目前狀態到歷史紀錄，支援「回復上一步」
// //     if (currentDayData) {
// //       __editHistory.push(JSON.parse(JSON.stringify(currentDayData.items)));
// //       if (__editHistory.length > 10) __editHistory.shift();
// //     }
// 
//     // ✅ 修改：呼叫統一的歷史紀錄函式，紀錄「進入編輯前」的原始狀態
//     pushHistory();
//   
//     __tlEditMode = true;
//     
//     // 重新渲染 UI 以顯示拖曳手柄與工具列
//     // ✅ 修正：直接操作 CSS Class，不要重新渲染整個列表
//     const listEl = document.getElementById('timelineList');
//     if (listEl) {
//       listEl.classList.add('edit-mode-active');
//     }
//     renderTimelineToolbar(itineraryIndex[currentDayIdx]);
// //     renderTimelineList(currentDayData);
//     enableTimelineSortable();
//     
//     // 給選中的項目一個視覺提示
//     const content = targetEl.querySelector('.tl-content');
//     if (content) {
//       content.style.transition = "transform 0.2s";
//       content.style.transform = "scale(1.05)";
//       setTimeout(() => content.style.transform = "", 200);
//     }
//   }
//     function triggerEditMode(targetEl) {
//       if (navigator.vibrate) navigator.vibrate(50); // 觸覺回饋
//       
//       // ✅ 1. 紀錄切換前的 Viewport 座標 (頂端距離)
//       const oldTop = targetEl.getBoundingClientRect().top;
//       
//       pushHistory();
//       __tlEditMode = true;
//     
//       // ✅ 2. 切換 Class 顯示編輯列
//       const listEl = document.getElementById('timelineList');
//       if (listEl) {
//         listEl.classList.add('edit-mode-active');
//       }
//     
//       // ✅ 3. 立即計算位移並補償捲動 (核心修正)
//       const newTop = targetEl.getBoundingClientRect().top;
//       window.scrollBy(0, newTop - oldTop);
//     
//       renderTimelineToolbar(itineraryIndex[currentDayIdx]);
//       enableTimelineSortable();
//       
//       // 視覺提示
//       const content = targetEl.querySelector('.tl-content');
//       if (content) {
//         content.style.transition = "transform 0.2s";
//         content.style.transform = "scale(1.05)";
//         setTimeout(() => content.style.transform = "", 200);
//       }
//     }
//     // ✅ 修改：接收第二個參數 originalEvent
//     function triggerEditMode(targetEl, originalEvent) {
//       if (navigator.vibrate) navigator.vibrate(50); 
//       
//       const oldTop = targetEl.getBoundingClientRect().top;
//       
//       pushHistory();
//       __tlEditMode = true;
//     
//       const listEl = document.getElementById('timelineList');
//       if (listEl) {
//         listEl.classList.add('edit-mode-active');
// 	// ✅ 防止在拖曳過程中頁面發生意外的滾動行為
// //         listEl.style.touchAction = 'none';
//       }
//     
//       const newTop = targetEl.getBoundingClientRect().top;
//       window.scrollBy(0, newTop - oldTop);
//     
//       // ✅ 使用 requestAnimationFrame 確保位移補償生效後再移交事件
//       requestAnimationFrame(() => {
//           if (__tlSortable && originalEvent) {
//               __tlSortable._onTapStart(originalEvent);
//           }
//       });
// 
//       renderTimelineToolbar(itineraryIndex[currentDayIdx]);
//       
//       // 1. 先初始化 Sortable
//       enableTimelineSortable();
//       
//       // 2. 💡 關鍵：手動將原始 pointerdown 事件「餵」給 Sortable 實體
//       // 這會讓 Sortable 覺得使用者「剛剛才按下去」，並立即進入拖曳狀態
//       if (__tlSortable && originalEvent) {
//         __tlSortable._onTapStart(originalEvent);
//       }
//     
//       const content = targetEl.querySelector('.tl-content');
//       if (content) {
//         content.style.transition = "transform 0.2s";
//         content.style.transform = "scale(1.05)";
//         setTimeout(() => content.style.transform = "", 200);
//       }
//     }
*/
    function triggerEditMode(targetEl, originalEvent) {
      if (navigator.vibrate) navigator.vibrate(50); 
      
/*        ✅ 新增：立即鎖定觸控行為，防止瀏覽器在移交事件時跳回捲動模式 */
      targetEl.style.touchAction = 'none';

      const oldTop = targetEl.getBoundingClientRect().top;
      pushHistory();
      __tlEditMode = true;
    
      const listEl = document.getElementById('timelineList');
      if (listEl) {
        listEl.classList.add('edit-mode-active');
      }
    
      const newTop = targetEl.getBoundingClientRect().top;
      window.scrollBy(0, newTop - oldTop);

      renderTimelineToolbar(itineraryIndex[currentDayIdx]);
      
/*        ✅ 修正 3：先初始化 SortableJS */
      enableTimelineSortable();
      
/*
       ✅ 修正 4：使用 requestAnimationFrame 確保位移補償生效後再移交事件
       並移除原本重複的 _onTapStart 呼叫
*/
/*       requestAnimationFrame(() => { */
          if (__tlSortable && originalEvent) {
              try {
                  __tlSortable._onTapStart(originalEvent);
              } catch (e) {
                  console.warn("事件移交失敗");
              }
          }
/*       }); */
    
/*        視覺提示：同時相容一般卡片與路徑卡片 */
      const visualTarget = targetEl.querySelector('.tl-content, .route-strip');
      if (visualTarget) {
        visualTarget.style.transition = "transform 0.2s";
        visualTarget.style.transform = "scale(1.05)";
        setTimeout(() => visualTarget.style.transform = "", 200);
      }
    }

/*    在你的 script 結尾加入 */
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      console.log("偵測到回到網頁，啟動同步...");
      syncFromCloud();
    }
  });

</script>
</body>
</html>
