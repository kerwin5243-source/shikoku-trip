<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>2026 å››åœ‹å·¡ç¦®</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#F6F3EE" />


  <!-- âœ… Serif + Sansï¼ˆæ¨™é¡Œæ—¥ç³»æ„Ÿï¼‰ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Noto+Serif+TC:wght@600;700;900&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --bg-body:#F6F3EE;
      --bg-card:rgba(255,255,255,.72);
      --ink:#1E1E1E;
      --ink2:#6F6A62;
      --divider:#E9E1D6;
      --text-sec: var(--ink2);

      --primary:#2B2723;
      --accent:#B08A5B;

      --radius-L:28px;
      --radius-M:20px;
      --radius-S:14px;

      --shadow-soft:0 10px 26px rgba(0,0,0,.08);
    }
    *, *::before, *::after { box-sizing: border-box; }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      font-family:'Noto Sans TC',sans-serif;
      background:var(--bg-body);
      color:var(--ink);
      margin:0;
      padding-bottom:110px;
      overscroll-behavior-y:none;
    }
    body.body-no-scroll{ overflow:hidden; }

    .app-header{
      padding:56px 20px 16px;
      background:linear-gradient(to bottom, rgba(246,243,238,1), rgba(246,243,238,.82));
    }
    .app-header h1{
      margin:0;
      font-family:'Noto Serif TC', serif;
      font-size:2.2rem;
      font-weight:900;
      letter-spacing:.2px;
    }
    .app-header p{
      margin:8px 0 0;
      font-size:.95rem;
      color:var(--ink2);
      font-weight:600;
    }

    .page{ display:none; padding:0 20px; animation:fadeIn .28s ease; }
    .page.active{ display:block; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    .card{
      background:var(--bg-card);
      border:1px solid rgba(233,225,214,.85);
      border-radius:var(--radius-L);
      padding:22px;
      margin-bottom:18px;
      box-shadow:var(--shadow-soft);
      backdrop-filter: blur(10px);
    }
    .section-title{
      font-size:1.05rem; font-weight:900; margin-bottom:14px;
      display:flex; align-items:center; gap:10px;
      font-family:'Noto Serif TC', serif;
    }
    .section-title i{ color:#8B8175; }

    .btn{
      background:var(--primary); color:#fff; border:none;
      padding:14px; border-radius:var(--radius-S);
      font-weight:800; width:100%; font-size:1rem; cursor:pointer;
      transition:transform .1s;
    }
    .btn:active{ transform:scale(.98); }
    .btn-outline{
      background:transparent;
      border:1.5px solid rgba(43,39,35,.35);
      color:var(--primary);
      font-weight:900;
    }

    /* tabs */
    .user-tabs{
      display:flex; gap:8px; margin-bottom:16px;
      background:rgba(233,225,214,.9); padding:4px; border-radius:14px;
    }
    .user-tab{
      flex:1; text-align:center; padding:10px 0; border-radius:10px;
      font-weight:800; font-size:.9rem; color:var(--ink2);
      cursor:pointer; transition:.2s;
    }
    .user-tab.active{
      background:#fff;
      color:var(--primary);
      box-shadow:0 6px 16px rgba(0,0,0,.10);
    }

    /* checklist */
    .checklist-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .check-item{
      background:rgba(255,255,255,.65);
      border:1px solid rgba(233,225,214,.8);
      border-radius:var(--radius-S);
      padding:14px 6px;
      text-align:center;
      font-size:.85rem;
      font-weight:700;
      display:flex; flex-direction:column; align-items:center; gap:8px;
      cursor:pointer;
      transition:.2s;
    }
    .check-item i{ font-size:1.35rem; color:#B9B2AA; }
    .check-item.checked{
      background:rgba(232,245,233,.9);
      border-color:rgba(52,199,89,.65);
      color:#2E7D32;
    }
    .check-item.checked i{ color:#34C759; }

    /* å…¨å“¡å¾…è¾¦ */
    .todo-li{
      display:flex; align-items:flex-start; gap:10px;
      padding:10px 0; border-bottom:1px solid rgba(233,225,214,.8);
    }
    .todo-li:last-child{ border-bottom:none; }
    .todo-li input{ width:18px; height:18px; margin-top:2px; accent-color:#8C6B43; }
    .todo-title a{ color:inherit; text-decoration:none; font-weight:900; }
    .todo-title span{ font-weight:900; }
    .todo-note{ font-size:.85rem; color:var(--ink2); margin-top:4px; line-height:1.45; }

    /* date scroller */
    .date-scroller{
      display:flex; gap:12px; overflow-x:auto; padding:10px 20px 18px;
      margin:0 -20px; scrollbar-width:none;
    }
    .date-scroller::-webkit-scrollbar{ display:none; }
    .date-chip{
      flex:0 0 auto;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(233,225,214,.9);
      border-radius:22px;
      padding:12px 18px;
      text-align:center;
      min-width:96px;
      box-shadow:0 10px 24px rgba(0,0,0,.08);
      transition:.2s;
      cursor:pointer;
    }
    .date-chip .day{
      font-family:'Noto Serif TC', serif;
      font-size:1.2rem; font-weight:900; letter-spacing:.3px;
    }
    .date-chip .date{
      font-size:.78rem;
      font-weight:900;
      color:var(--ink2);
      margin-top:2px;
    }
    .date-chip.active{
      background:#fff;
      border-color:rgba(176,138,91,.55);
      box-shadow:0 14px 30px rgba(0,0,0,.10);
    }
    .date-chip.active .day{ color:#7D5B34; }

    /* weather */
    .weather-strip{
      display:flex; gap:20px; overflow-x:auto;
      padding-bottom:10px; margin-bottom:14px;
      scrollbar-width:none;
      border-bottom:1px solid var(--divider);
    }
    .weather-strip::-webkit-scrollbar{ display:none; }
    .weather-hour{ text-align:center; flex:0 0 auto; }
    .w-time{ font-size:.8rem; color:var(--ink2); margin-bottom:5px; font-weight:800; }
    .w-icon{ font-size:1.15rem; margin-bottom:5px; color:#8B8175; }
    .w-temp{ font-weight:900; font-size:.9rem; color:var(--primary); }

    /* timeline */
    .timeline-item{ display:flex; gap:16px; margin-bottom:18px; cursor:pointer; }
    .tl-time{
      min-width:56px;
      font-family:'Roboto Mono', monospace;
      font-weight:700;
      color:var(--ink2);
      text-align:right;
      padding-top:6px;
    }
    .tl-content{
      flex:1;
      background:rgba(255,255,255,.78);
      border:1px solid rgba(233,225,214,.9);
      border-radius:var(--radius-M);
      padding:16px 16px 14px;
      box-shadow:0 14px 30px rgba(0,0,0,.07);
      transition:transform .12s ease;
    }
    .tl-content:active{ transform:scale(.985); }

    .tl-tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-size:.72rem;
      font-weight:900;
      letter-spacing:.12em;
      margin-bottom:10px;
      text-transform:uppercase;
      background:#fff;
      border:1px solid rgba(233,225,214,.95);
      color:#6F6A62;
    }
    .tl-tag::before{
      content:'';
      width:8px; height:8px;
      border-radius:50%;
      display:inline-block;
      background:#B9B2AA;
    }
    .tag-food::before{ background:#D28A3A; }
    .tag-sight::before{ background:#2F8F5B; }
    .tag-transport::before{ background:#3D6EA9; }
    .tag-hotel::before{ background:#7A4FA8; }
    .tag-shop::before{ background:#2A6FA0; }

    .tl-title{
      font-family:'Noto Serif TC', serif;
      font-size:1.15rem;
      font-weight:900;
      margin-bottom:6px;
      letter-spacing:.2px;
    }
    .tl-desc{
      font-size:.92rem;
      color:var(--ink2);
      line-height:1.5;
      display:-webkit-box;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    /* âœ… å°è¡Œç¨‹ï¼šç°åº•çš„ã€Œé è¨ˆåœç•™/è»Šç¨‹ã€è† å›Š */
    .tl-meta{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }
    .tl-chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:#F2F2F7;
      color:#555;
      font-size:.85rem;
      font-weight:800;
    }
    .tl-chip i{ color:#8E8E93; }


    /* ===== Modal: bottom sheet ===== */
    .modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.38);
      z-index:2000;
      opacity:0; pointer-events:none;
      transition:opacity .2s ease;
    }
    .modal-sheet{
      position:fixed;
      left:50%;
      bottom:max(14px, env(safe-area-inset-bottom));
      transform:translateX(-50%) translateY(120%);
      width:min(760px, calc(100vw - 24px));

      /* âœ… ç”¨ dvh æ¯” vh ç©©ï¼ˆæ‰‹æ©Ÿç¶²å€åˆ—ç¸®æ”¾ä¸äº‚è·³ï¼‰ */
      max-height:calc(100dvh - 24px - env(safe-area-inset-top));
      background:#FAF7F2;
      z-index:2001;
      border-radius:28px;
      border:1px solid rgba(233,225,214,.95);
      box-shadow:0 22px 60px rgba(0,0,0,.18);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      transition:transform .18s cubic-bezier(.16,1,.3,1);
    }

    .modal-sheet.active{ transform:translateX(-50%) translateY(0); }

    /* âœ… Header ä¸æ»¾å‹•ï¼Œæ°¸é åœ¨ä¸Šæ–¹ */
    .modal-header{
      position:relative;
      flex:0 0 auto;
      padding:6px 0 4px;
      background:#FAF7F2;
      border-bottom:1px solid rgba(233,225,214,.75);
    }

    /* æ‹–æ›³æ¢ä¿æŒç½®ä¸­ */
    .modal-drag-handle{
      width:44px; height:5px;
      background:#D8CFC4;
      border-radius:99px;
      margin:8px auto 6px;
    }

    /* âœ… X æ°¸é å¯è¦‹ï¼ˆåœ¨ header å…§ï¼‰ */
    .modal-x{
      position:absolute;
      right:12px;
      top:8px;
      width:36px; height:36px;
      border-radius:50%;
      border:1px solid rgba(233,225,214,.95);
      background:#fff;
      font-size:20px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      z-index:10;
    }

    /* å…§å®¹æ»¾å‹•åªåœ¨é€™è£¡ç™¼ç”Ÿ */
    .modal-scroll{
      flex:1;
      overflow-y:auto;
      padding:12px 18px 16px;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
    }


    .modal-drag-handle{
      width:44px; height:5px;
      background:#D8CFC4;
      border-radius:99px;
      margin:10px auto 6px;
      flex-shrink:0;
    }

    .sheet-head{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 2px 10px;
    }
    .sheet-time{
      font-family:'Noto Serif TC', serif;
      font-size:1.12rem;
      font-weight:900;
      color:#2B2723;
    }

    .modal-title{
      font-family:'Noto Serif TC', serif;
      font-size:1.55rem;
      font-weight:900;
      line-height:1.18;
      margin:0 0 10px 0;
      letter-spacing:.2px;
    }

    .meta-box{
      border-top:1px solid var(--divider);
      border-bottom:1px solid var(--divider);
      padding:10px 0;
      margin:10px 0 12px;
      color:var(--ink2);
    }
    .meta-row{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:7px 0;
      font-size:.95rem;
      line-height:1.35;
    }
    .meta-ico{ width:22px; text-align:center; flex:0 0 auto; padding-top:1px; }
    .meta-val{ flex:1; }

    .mini-btn{
      margin-left:auto;
      border:1px solid rgba(233,225,214,.95);
      background:#fff;
      border-radius:10px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:900;
      color:#5F5A52;
      flex:0 0 auto;
    }

    .detail{
      font-size:1rem;
      color:#3A352E;
      line-height:1.7;
      white-space:pre-wrap;
    }

    .pill-row{ margin:8px 0 4px; display:flex; flex-wrap:wrap; gap:8px; }
    .pill{
      display:inline-flex;
      gap:6px; align-items:center;
      padding:7px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(233,225,214,.95);
      font-size:.86rem;
      font-weight:900;
      color:#5F5A52;
    }
    .pill i{ color:#8B8175; }

    .block{
      background:rgba(255,255,255,.72);
      border:1px solid rgba(233,225,214,.85);
      padding:14px;
      border-radius:var(--radius-M);
      margin:12px 0;
    }
    .block h4{
      margin:0 0 10px;
      font-size:1rem;
      font-weight:900;
      color:#2B2723;
      font-family:'Noto Serif TC', serif;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .bullet{ margin:0; padding-left:18px; line-height:1.7; color:#444; }

    .menu-recommend{
      background:#FFF8E1;
      border:1px solid #FFECB3;
      padding:15px;
      border-radius:var(--radius-M);
      margin:12px 0;
    }
    .menu-item{
      display:flex; justify-content:space-between; gap:12px;
      padding:6px 0;
      border-bottom:1px dashed #FFE082;
    }
    .menu-item:last-child{ border-bottom:none; }
    .jp-text{ font-weight:900; color:#5D4037; }

    .sheet-actions{
      position:sticky;
      bottom:0;
      padding:10px 0 2px;
      background:linear-gradient(to top, #FAF7F2 70%, rgba(250,247,242,0));
    }
    .btn-primary{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      width:100%;
      height:50px;
      border-radius:16px;
      border:1px solid rgba(176,138,91,.55);
      background:#fff;
      font-weight:900;
      text-decoration:none;
      color:#2B2723;
    }

    /* bottom nav */
    .bottom-nav{
      position:fixed; bottom:20px; left:20px; right:20px;
      background:rgba(255,255,255,.72);
      backdrop-filter:blur(20px);
      border-radius:30px;
      display:flex;
      justify-content:space-around;
      padding:14px 0;
      box-shadow:0 16px 50px rgba(0,0,0,.13);
      z-index:1000;
      border:1px solid rgba(233,225,214,.9);
    }
    .nav-item{ text-align:center; color:#B9B2AA; font-size:.7rem; cursor:pointer; flex:1; transition:.2s; }
    .nav-item i{ display:block; font-size:1.35rem; margin-bottom:4px; }
    .nav-item.active{ color:#2B2723; transform:translateY(-2px); }

    /* boarding */
    .boarding{
      background:rgba(255,255,255,.76);
      border-radius:var(--radius-L);
      box-shadow:var(--shadow-soft);
      overflow:hidden; margin-bottom:18px;
      border:1px solid rgba(233,225,214,.9);
      backdrop-filter: blur(10px);
    }
    .boarding-top{
      padding:18px 18px 14px;
      background:linear-gradient(135deg, rgba(176,138,91,.16), rgba(43,39,35,.06));
    }
    .boarding-top .row{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .boarding-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,.75);
      font-weight:900; font-size:.85rem;
      border:1px solid rgba(233,225,214,.9);
    }
    .boarding-mid{
      padding:14px 18px;
      display:flex; justify-content:space-between; align-items:center;
      border-top:1px dashed rgba(233,225,214,.95);
    }
    .code{
      font-family:'Noto Serif TC', serif;
      font-size:2.0rem;
      font-weight:900;
      color:#7D5B34;
      letter-spacing:1px;
    }
    .t{ color:var(--ink2); font-size:.9rem; margin-top:2px; font-weight:800; }
    .boarding-bottom{
      padding:14px 18px;
      border-top:1px solid rgba(233,225,214,.7);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color:var(--ink2); font-size:.9rem;
      font-weight:800;
    }
    /* ===== Route strip (for drive/walk/train/flight/boat) ===== */
    .route-strip{
        display:flex;
        gap:14px;
        align-items:center;
        padding:12px 14px;        /* æ›´ç´°é•· */
        border-radius:18px;
        background:#F2F2F7;
        border:1px solid rgba(0,0,0,.04);
        box-shadow:0 6px 18px rgba(0,0,0,.06);
        width:100%;               /* âœ… æ’æ»¿ */
        margin:0;                 /* âœ… ä¸è¦è‡ªå·±ç¸®æ’ */
    }

    .route-mins{
        flex:0 0 auto;
        font-family:'Roboto Mono', monospace;
        font-size:.62rem;         /* âœ… ç¸®å° */
        font-weight:900;
        color:#444;
        background:#ECECF0;
        border-radius:999px;
        padding:6px 10px;
        white-space:nowrap;
    }

    .route-ico{
        width:44px; height:44px;
        border-radius:16px;
        display:flex; align-items:center; justify-content:center;
        background:#EAF2FF;
        flex:0 0 auto;
    }
    .route-ico i{ font-size:18px; color:var(--primary); }

    /* è®“ route strip å…§å®¹å·¦å³åˆ†ä½ˆæ›´æ¼‚äº® */
    .route-main{
        flex: 1;
        min-width: 0;
    }

    /* æƒ³è®“æ•´å¼µæ›´ã€Œç´°é•·ã€ä¸€é»å°±æŠŠ padding é™ä½ */
    .route-strip{
        padding: 12px 14px;     /* âœ… æ¯”åŸæœ¬ 16 18 æ›´ç´°é•· */
        border-radius: 18px;
    }
    .route-title{
      font-weight:900;
      font-size:1.02rem;
      letter-spacing:-.2px;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .route-sub{
      margin-top:4px;
      color:var(--text-sec);
      font-weight:700;
      font-size:.9rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .routeRow{
        display:flex;
        align-items:center;
        gap:12px;
        padding:10px 12px;
        border-radius:14px;
        max-width:100%;
        width:100%;
        overflow:hidden;            /* é˜²æ­¢å…§éƒ¨æ±è¥¿æ’ç ´ */
    }

    .routeIcon{
        flex:0 0 36px;
        width:36px; height:36px;
        border-radius:12px;
        display:flex; align-items:center; justify-content:center;
    }

    .routeMain{
        flex:1 1 auto;
        min-width:0;                /* âœ… è¶…é‡è¦ï¼šå…è¨±ä¸­é–“æ¬„ä½ç¸® */
    }

    .routeTitle{
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;     /* âœ… é•·åœ°åä¸æ’ç ´ */
    }

    .routeDuration{
        flex:0 0 auto;
        margin-left:auto;           /* âœ… æ¨åˆ°æœ€å³ */
        white-space:nowrap;
        padding:6px 10px;
        border-radius:999px;
    }



    /* duration / stay pill */
    .stay-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top:12px;
      background:#ECECF0;
      color:#333;
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:.95rem;
    }
    .stay-pill i{ color:#8E8E93; }

    /* time column better for mobile */
    .tl-time{
      min-width:56px;
      font-size:1rem;
    }

    /* âœ… è®“æ¯ä¸€åˆ—ï¼šå·¦æ™‚é–“ã€å³å…§å®¹ å›ºå®šå°é½Š */
    .timeline-item{
        display:grid;
        grid-template-columns: 64px 1fr;
        column-gap:12px;
        align-items:start;
    }

    /* âœ… å³æ¬„ä¸€å®šè¦èƒ½ç¸®ï¼Œæ‰ä¸æœƒæŠŠæ•´é æ’å¯¬é€ æˆå¯å·¦å³æ»‘/å¯ç¸®å° */
    .tl-content{
        min-width:0;
    }

    /* å»ºè­°åŠ ä¿éšªï¼šç æ‰æ°´å¹³ overflow */
    html, body{ overflow-x:hidden; }

    /* âœ… Route itemï¼šæ™‚é–“ä¸€è¡Œ + è·¯ç·šå¡ä¸€è¡Œï¼ˆå¡ç‰‡åœ¨ time ä¸‹æ–¹ï¼Œä¸”èˆ‡å…¶ä»–å¡ç‰‡å°é½Šï¼‰ */
    .timeline-item.route-item{
        grid-template-rows: auto auto;   /* å…©è¡Œ */
    }

    /* ç¬¬ 1 è¡Œï¼šæ™‚é–“åœ¨å·¦æ¬„ */
    .timeline-item.route-item .tl-time{
        grid-column: 1;
        grid-row: 1;
    }

    /* ç¬¬ 1 è¡Œï¼šå³æ¬„ç•™ç©º */
    .timeline-item.route-item .route-spacer{
        grid-column: 2;
        grid-row: 1;
    }

    /* ç¬¬ 2 è¡Œï¼šroute å¡ç‰‡æ”¾å³æ¬„ï¼ˆå°é½Šå…¶ä»–å¡ç‰‡èµ·é»ï¼‰ */
    .timeline-item.route-item .route-strip{
        grid-column: 2;
        grid-row: 2;
        width: 100%;
        max-width: 100%;
    }

    /* âœ… å°ä¿éšªï¼šroute-strip å…§éƒ¨ä¸è¦æŠŠè‡ªå·±æ’çˆ† */
    .route-strip{
        min-width: 0;
    }

    /* âœ… è®“ä¸­é–“æ¨™é¡Œæ¬„ä½å¯è¢«å£“ç¸®ï¼Œç¢ºä¿å³é‚Š minutes ä¸æœƒè¢«æ“ æ‰ */
    .route-main{
        min-width: 0;
    }




    /* ===== Mobile layout guard ===== */
    .page, .app-header{
      max-width: 520px;
      margin-left:auto;
      margin-right:auto;
    }

    .bottom-nav{
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
    }

    body{
      padding-bottom: calc(110px + env(safe-area-inset-bottom));
    }
    /* å³å´ï¼šæ™‚é–“ + å°èˆªæŒ‰éˆ•ï¼ˆæŠŠ 15min ç§»åˆ°é€™è£¡ï¼‰ */
    .route-cta{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      justify-content:center;
      gap:10px;
      flex:0 0 auto;
    }

    .route-time{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#ECECF0;
      font-weight:900;
      color:#333;
      white-space:nowrap;
    }

    .route-time i{ color:#8E8E93; }


  </style>
</head>

<body>
  <header class="app-header">
    <h1 id="hdrTitle">2026 å››åœ‹å·¡ç¦®</h1>
    <p id="hdrSub">9å¤©8å¤œè‡ªé§•éŠ</p>
  </header>

  <!-- è¡Œå‰ -->
  <div id="page-pre" class="page">
    <div class="card">
      <div class="section-title"><i class="fas fa-bullhorn"></i> å…¨å“¡é‡è¦å¾…è¾¦</div>
      <ul id="globalTodoList" style="list-style:none; padding:0; margin:0;"></ul>
    </div>

    <div class="card">
      <div class="section-title"><i class="fas fa-clipboard-user"></i> å€‹äººæ¸…å–®</div>
      <div class="user-tabs" id="userSwitch"></div>

      <h4 style="margin:10px 0 10px; color:var(--ink2); font-weight:900;">æ—…è¡Œå‰</h4>
      <div class="checklist-grid" id="list-pretrip"></div>

      <h4 style="margin:10px 0 10px; color:var(--ink2); font-weight:900;">éš¨èº«è¡Œæ</h4>
      <div class="checklist-grid" id="list-carry"></div>

      <h4 style="margin:20px 0 10px; color:var(--ink2); font-weight:900;">è¨—é‹è¡Œæ</h4>
      <div class="checklist-grid" id="list-check"></div>
    </div>
  </div>

  <!-- è¡Œç¨‹ -->
  <div id="page-itinerary" class="page active">
    <div class="date-scroller" id="dayScroller"></div>

    <div class="card" style="margin-top: 18px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
        <div class="section-title" style="margin:0;"><i class="fas fa-cloud-sun"></i> 24H é å ±</div>
        <span id="weatherLoc" style="font-size:0.9rem; color:var(--ink2); font-weight:900;"></span>
      </div>
      <div class="weather-strip" id="weatherStrip"></div>
      <div style="text-align:right; font-size:0.86rem; color:var(--ink2); font-weight:800;">
        ä»Šæ™šä½å®¿ï¼š<strong id="stayHotelName" style="color:var(--primary);"></strong>
      </div>
    </div>

    <div id="timelineList" style="padding-bottom: 20px;"></div>
  </div>

  <!-- è³‡è¨Š -->
  <div id="page-info" class="page">
    <div class="section-title"><i class="fas fa-plane-departure"></i> èˆªç­è³‡è¨Š</div>
    <div id="flightBoard"></div>

    <div class="section-title" style="margin-top:8px;"><i class="fas fa-hotel"></i> ä½å®¿è³‡è¨Š</div>
    <div id="hotelList"></div>
  </div>

  <!-- è¨˜å¸³ -->
  <div id="page-money" class="page">
    <div class="card">
      <div class="section-title">æ–°å¢æ”¯å‡º</div>
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <input type="text" id="exName" placeholder="é …ç›® (ä¾‹: æ™šé¤)" style="padding:12px; border:1px solid rgba(233,225,214,.9); border-radius:14px; flex:1; background:rgba(255,255,255,.8);">
        <input type="number" id="exCost" placeholder="é‡‘é¡ (Â¥)" style="padding:12px; border:1px solid rgba(233,225,214,.9); border-radius:14px; width:110px; background:rgba(255,255,255,.8);">
      </div>
      <div class="user-tabs" id="payerSwitch" style="background:rgba(233,225,214,.9); margin-bottom:15px;"></div>
      <button class="btn" onclick="addExpense()">åŠ å…¥ç´€éŒ„ (å¹³åˆ†)</button>
    </div>

    <div class="card">
      <div class="section-title">çµç®— (è² æ•¸ä»£è¡¨æ¬ æ¬¾)</div>
      <div id="debtList"></div>
    </div>

    <div class="card">
      <div class="section-title">è©³ç´°ç´€éŒ„</div>
      <div id="expenseList"></div>
    </div>
  </div>

  <!-- modal -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal()"></div>
  <div class="modal-sheet" id="modalSheet" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div class="modal-drag-handle"></div>
      <button class="modal-x" onclick="closeModal()" aria-label="close">Ã—</button>
    </div>
    <div class="modal-scroll" id="modalContent"></div>
  </div>


  <nav class="bottom-nav">
    <div class="nav-item" onclick="nav('itinerary', this)"><i class="fas fa-map-location-dot"></i> è¡Œç¨‹</div>
    <div class="nav-item" onclick="nav('info', this)"><i class="fas fa-passport"></i> è³‡è¨Š</div>
    <div class="nav-item" onclick="nav('money', this)"><i class="fas fa-yen-sign"></i> è¨˜å¸³</div>
    <div class="nav-item active" onclick="nav('pre', this)"><i class="fas fa-list-check"></i> è¡Œå‰</div>
  </nav>

<script>
  // ====== Globals (JSON é©…å‹•) ======
  let CONFIG, CHECKLISTS, TODOS, FLIGHTS, HOTELS, ITINERARY;

  let users = [];
  let curUser = 'L';
  let curPayer = 'L';

  let checklistData = { carry: [], check: [] };
  let hotels = [];
  let itineraryIndex = [];
  let dayCache = {};
  let currentDayData = null;
  let currentDayIdx = 0;

  // ====== Load Data ======
  async function loadAllData(){ 
    [CONFIG, CHECKLISTS, TODOS, FLIGHTS, HOTELS, ITINERARY] = await Promise.all([
      fetch("./data/config.json").then(r=>r.json()),
      fetch("./data/checklists.json").then(r=>r.json()),
      fetch("./data/todos.json").then(r=>r.json()),
      fetch("./data/flights.json").then(r=>r.json()),
      fetch("./data/hotels.json").then(r=>r.json()),
      fetch("./data/itinerary.index.json").then(r=>r.json()),
    ]);

    users = CONFIG?.members || ['L','K','R','Y','J'];
    curUser = users[0] || 'L';
    curPayer = users[0] || 'L';

    checklistData = CHECKLISTS || { carry: [], check: [] };
    hotels = HOTELS || [];
    itineraryIndex = ITINERARY || [];

    document.getElementById('hdrTitle').innerText = CONFIG?.trip_title || '2026 å››åœ‹å·¡ç¦®';
    const sub = `${CONFIG?.days || 9}å¤©${CONFIG?.nights || 8}å¤œ${CONFIG?.mode ? CONFIG.mode : ''} â€¢ ${users.join(', ')}`;
    document.getElementById('hdrSub').innerText = sub;
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await loadAllData();
    renderGlobalTodos();
    renderUserTabs();
    renderChecklists();
    renderDateScroller();
    await selectDay(0);
    renderHotels();
    renderFlights();
    renderExpenseUI();
  });

  document.getElementById('modalSheet')?.addEventListener(
    'touchmove',
    (e) => e.stopPropagation(),
    { passive: true }
  );


  document.getElementById('modalOverlay')?.addEventListener(
    'touchmove',
    (e) => e.preventDefault(),
    { passive: false }
  );
  document.getElementById('timelineList').addEventListener('click', (e) => {
    const el = e.target.closest('.route-click');
    if(!el) return;

    const from = decodeURIComponent(el.dataset.from || '');
    const to   = decodeURIComponent(el.dataset.to || '');
    const mode = decodeURIComponent(el.dataset.mode || 'drive');

    openDirections(from, to, mode);
   });



  function nav(pageId, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-'+pageId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    window.scrollTo(0,0);
  }

  // ====== å…¨å“¡å¾…è¾¦ ======
  function renderGlobalTodos(){
    const el = document.getElementById('globalTodoList');
    if(!el) return;

    const saved = JSON.parse(localStorage.getItem('global_todos')) || {};
    el.innerHTML = (TODOS || []).map((t, idx) => {
      const key = t.title || `todo_${idx}`;
      const checked = saved[key] ? 'checked' : '';

      const titleHTML = t.link
        ? `<div class="todo-title"><a href="${t.link}" target="_blank" rel="noopener">${escapeHtml(t.title)}</a></div>`
        : `<div class="todo-title"><span>${escapeHtml(t.title)}</span></div>`;

      return `
        <li class="todo-li">
          <input type="checkbox" ${checked} onchange="toggleGlobalTodo('${escapeHtml(key)}')">
          <div>
            ${titleHTML}
            ${t.note ? `<div class="todo-note">${escapeHtml(t.note)}</div>` : ''}
          </div>
        </li>
      `;
    }).join('');
  }

  function toggleGlobalTodo(key){
    const k = unescapeHtml(key);
    const saved = JSON.parse(localStorage.getItem('global_todos')) || {};
    saved[k] = !saved[k];
    localStorage.setItem('global_todos', JSON.stringify(saved));
  }

  // ====== å€‹äººæ¸…å–® ======
  function renderUserTabs() {
    document.getElementById('userSwitch').innerHTML = users.map(u =>
      `<div class="user-tab ${u===curUser?'active':''}" onclick="switchUser('${u}')">${u}</div>`
    ).join('');
  }
  function switchUser(u) { curUser = u; renderUserTabs(); renderChecklists(); }

  function iconForItem(item){
    if(item.includes('è­·ç…§')) return 'fa-passport';
    if(item.includes('æ‰‹æ©Ÿ')) return 'fa-mobile-screen';
    if(item.includes('è¡Œå‹•é›»æº') || item.includes('å……é›»')) return 'fa-battery-full';
    if(item.includes('è—¥')) return 'fa-pills';
    if(item.includes('è¡£') || item.includes('å…§è¡£') || item.includes('ç¡è¡£')) return 'fa-shirt';
    if(item.includes('é›¨')) return 'fa-umbrella';
    if(item.includes('ç‰™')) return 'fa-tooth';
    return 'fa-suitcase';
  }

  function renderChecklists() {
    const data = JSON.parse(localStorage.getItem('check_'+curUser)) || {};

    ['pretrip','carry','check'].forEach(type => {
      const target = document.getElementById('list-'+type);
      if(!target) return;

      target.innerHTML = (checklistData[type] || []).map(item => {
        const isChecked = data[item] ? 'checked' : '';
        const icon = iconForItem(item);
        return `
          <div class="check-item ${isChecked}" onclick="toggleCheck('${escapeHtml(item)}', this)">
            <i class="fas ${icon}"></i>
            <span>${escapeHtml(item)}</span>
          </div>`;
      }).join('');
    });
  }

  function toggleCheck(itemEscaped, el) {
    const item = unescapeHtml(itemEscaped);
    const data = JSON.parse(localStorage.getItem('check_'+curUser)) || {};
    if(data[item]) { delete data[item]; el.classList.remove('checked'); }
    else { data[item] = true; el.classList.add('checked'); }
    localStorage.setItem('check_'+curUser, JSON.stringify(data));
  }

  // ====== è¡Œç¨‹ ======
  function renderDateScroller() {
    document.getElementById('dayScroller').innerHTML = itineraryIndex.map((d, i) => `
      <div class="date-chip" id="chip-${i}" onclick="selectDay(${i})">
        <div class="day">${escapeHtml(d.date || '')}</div>
        <div class="date">Day ${i+1} â€¢ ${escapeHtml(d.day || '')}</div>
      </div>
    `).join('');
  }

  function tagClass(tag){
    const t = (tag||'').toLowerCase();
    if(t==='food') return 'tag-food';
    if(t==='sight') return 'tag-sight';
    if(t==='transport') return 'tag-transport';
    if(t==='hotel') return 'tag-hotel';
    if(t==='shop') return 'tag-shop';
    return 'tag-transport';
  }
  function durationChip(item){
    // 1) å„ªå…ˆé¡¯ç¤º stayï¼ˆä½  JSON å·²ç¶“æœ‰ï¼‰
    const stay = (item.stay || '').trim();
    if(stay) return `<span class="tl-chip"><i class="fas fa-hourglass-half"></i> ${escapeHtml(stay)}</span>`;

    // 2) å¦‚æœæœ‰ route.minutesï¼Œé¡¯ç¤ºè»Šç¨‹
    const mins = item?.route?.minutes;
    if(Number.isFinite(mins)) return `<span class="tl-chip"><i class="fas fa-car"></i> ${mins} min</span>`;

    return '';
  }
  function normalizeTime(t){
    // åªå– HH:MMï¼ˆé¿å… Before 05:00 / 13:20-13:45 ç ´ç‰ˆï¼‰
    const s = String(t ?? '').trim();
    const m = s.match(/(\d{1,2}:\d{2})/);
    if(m) return m[1].padStart(5,'0');
    if(s === 'â€”' || s === '-' || !s) return 'â€”';
    return s; // çœŸçš„ä¸æ˜¯æ™‚é–“å°±åŸæ¨£ï¼ˆä½†å»ºè­° json å°±åˆ¥æ”¾é€™ç¨®ï¼‰
  }

  function routeIcon(mode){
    const m = (mode||'').toLowerCase();
    if(m==='drive') return 'fa-car';
    if(m==='walk')  return 'fa-person-walking';
    if(m==='train') return 'fa-train-subway';
    if(m==='ship')  return 'fa-ship';
    if(m==='plane') return 'fa-plane';
    return 'fa-route';
  }

  function renderRouteStrip(item, i){
    const r = item.route || {};
    const mode = (r.mode || 'route').toLowerCase();
    const icon = routeIcon(mode);
    const mins = r.minutes ? `${r.minutes} min` : (item.stay || '');
    const line2 = `${r.from || ''} â†’ ${r.to || ''}`.trim();

    return `
    <div class="timeline-item route-item">
        <div class="tl-time">${escapeHtml(t)}</div>
        <div class="route-spacer"></div>

        <div class="route-strip route-click"
        data-from="${enc(r.from || '')}"
        data-to="${enc(r.to || '')}"
        data-mode="${enc(mode)}">

        <div class="route-ico"><i class="fas ${ico}"></i></div>

        <div class="route-main">
            <div class="route-title">${escapeHtml(title)}</div>
        </div>

        ${dur ? `<div class="route-mins">${escapeHtml(dur)}</div>` : ``}
        </div>
    </div>
    `;
  }

  function renderNormalItem(item, i){
    const stayPill = item.stay ? `<div style="margin-top:10px; display:inline-flex; gap:8px; align-items:center; background:#F2F2F7; padding:6px 10px; border-radius:999px; font-weight:900; color:#4B5563;">
      <i class="fas fa-hourglass-half" style="color:#9CA3AF;"></i>${escapeHtml(item.stay)}
    </div>` : '';

    return `
      <div class="timeline-item" onclick='openModal(${i})'>
        <div class="tl-time">${escapeHtml(item.time || '')}</div>
        <div class="tl-content">
          <div class="tl-tag ${tagClass(item.tag)}">${escapeHtml((item.tag||'').toUpperCase())}</div>
          <div class="tl-title">${escapeHtml(item.title || '')}</div>
          <div class="tl-desc">${escapeHtml(item.desc || '')}</div>
          ${stayPill}
        </div>
      </div>
    `;
  }
  function openDirections(from, to, mode='drive'){
    const tm = travelModeForRoute(mode); // ä½ ä¸‹é¢å·²ç¶“æœ‰é€™å€‹ function
    const url = `https://www.google.com/maps/dir/?api=1`
        + `&origin=${encodeURIComponent(from||'')}`
        + `&destination=${encodeURIComponent(to||'')}`
        + `&travelmode=${encodeURIComponent(tm)}`;
    window.open(url, '_blank', 'noopener');
  }





//   function openDirections(from, to){
//     // Google Maps Directions
//     const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from||'')}&destination=${encodeURIComponent(to||'')}&travelmode=driving`;
//     window.open(url, '_blank');
//   }




  


  async function selectDay(idx) {
    currentDayIdx = idx;

    document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
    const chip = document.getElementById('chip-'+idx);
    if(chip) chip.classList.add('active');

    const meta = itineraryIndex[idx];
    if(!meta) return;

    document.getElementById('weatherLoc').innerText = meta.loc || '';
    const h = hotels.find(x => x.id === meta.hotel_id);
    document.getElementById('stayHotelName').innerText = h ? h.name : '';

    if(!dayCache[idx]) {
      const url = `./${meta.file}?v=${Date.now()}`;
      const raw = await fetch(url).then(r => r.json());
      dayCache[idx] = Array.isArray(raw) ? raw[0] : raw;
    }
    const dayData = dayCache[idx];
    currentDayData = dayData;
    
    // timeline
    document.getElementById('timelineList').innerHTML = (dayData?.items || []).map((item, i) => {
      const t = normalizeTime(item.time);
      const stay = item.stay ? `
        <div class="stay-pill"><i class="fas fa-hourglass-half"></i>${escapeHtml(item.stay)}</div>
      ` : '';
    function jsStr(s){ return JSON.stringify(String(s ?? '')); }

    // âœ… route stripï¼šåªè¦æœ‰ route ç‰©ä»¶å°±ç”¨ï¼ˆä¸é–‹ modalï¼‰
    if(item.route && (item.route.from || item.route.to)){
      const r = item.route;
      const mode = r.mode || 'drive';
      const ico = routeIcon(mode);

      const title = (item.title && item.title.trim())
        ? item.title.trim()
        : `${r.from || ''} â†’ ${r.to || ''}`.trim();

      const dur = (item.stay && String(item.stay).trim())
        ? String(item.stay).trim()
        : (Number.isFinite(r.minutes) ? `${r.minutes} min` : '');

      const enc = (s)=> encodeURIComponent(String(s ?? ''));
      return `
      <div class="timeline-item">
            <div class="tl-time">${escapeHtml(t)}</div>

            <div class="route-strip route-click"
            data-from="${enc(r.from || '')}"
            data-to="${enc(r.to || '')}"
            data-mode="${enc(mode)}">

            <div class="route-ico"><i class="fas ${ico}"></i></div>

            <div class="route-main">
                <div class="route-title">${escapeHtml(title)}</div>
            </div>

            ${dur ? `<div class="route-mins">${escapeHtml(dur)}</div>` : ``}
            </div>
      </div>
      `;
    }



      // âœ… ä¸€èˆ¬è¡Œç¨‹å¡ï¼ˆå¯é»é–‹ modalï¼‰
      return `
        <div class="timeline-item" onclick='openModal(${i})'>
          <div class="tl-time">${escapeHtml(t)}</div>
          <div class="tl-content">
            <div class="tl-tag ${tagClass(item.tag)}">${escapeHtml((item.tag||'').toUpperCase())}</div>
            <div class="tl-title">${escapeHtml(item.title || '')}</div>
            <div class="tl-desc">${escapeHtml(item.desc || '')}</div>
            ${stay}
          </div>
        </div>
      `;
    }).join('');



    // mock weather
    let weatherHTML = '';
    for(let h=9; h<=21; h++) {
      let icon = 'fa-sun';
      if(h > 12 && h < 16) icon = 'fa-cloud-sun';
      if(h > 18) icon = 'fa-moon';
      let temp = 10 + Math.floor(Math.random()*5);
      weatherHTML += `
        <div class="weather-hour">
          <div class="w-time">${h}:00</div>
          <div class="w-icon"><i class="fas ${icon}"></i></div>
          <div class="w-temp">${temp}Â°</div>
        </div>`;
    }
    document.getElementById('weatherStrip').innerHTML = weatherHTML;
  }

  // ====== Google å°èˆªï¼šå„ªå…ˆ geoï¼Œå…¶æ¬¡ addr/title ======
  function buildGoogleNavUrl(item){
    const hasGeo = item?.geo?.lat != null && item?.geo?.lng != null;
    if(hasGeo){
      return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(item.geo.lat + ',' + item.geo.lng)}`;
    }
    const q = (item?.addr || item?.title || '').trim();
    if(!q) return 'https://www.google.com/maps';
    return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
  }
  function travelModeForRoute(mode){
    const m = (mode || '').toLowerCase();
    if(m === 'walk')  return 'walking';
    if(m === 'train') return 'transit';
    if(m === 'ship')  return 'transit';
    if(m === 'plane') return 'transit';
    return 'driving';
  }

  function buildGoogleDirUrl(item){
    // route itemï¼šç”¨ directions
    const r = item?.route;
    if(r?.from && r?.to){
      const tm = travelModeForRoute(r.mode);
      return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(r.from)}&destination=${encodeURIComponent(r.to)}&travelmode=${tm}`;
    }
    // ä¸€èˆ¬æ™¯é»ï¼šç”¨ search
    return buildGoogleNavUrl(item);
  }


  // ====== Modalï¼šé è¨ˆåˆ°é”/åœ°å€/åœè»Š/Mapcode/ä»‹ç´¹ + Google å°èˆª ======
  function openModal(itemIdx) {
    const item = currentDayData?.items?.[itemIdx];
    if(!item) return;

    const content = document.getElementById('modalContent');

    const hours = item.hours ? `<span class="pill"><i class="fas fa-clock"></i> ${escapeHtml(item.hours)}</span>` : '';
    const price = item.price ? `<span class="pill"><i class="fas fa-ticket"></i> ${escapeHtml(item.price)}</span>` : '';
    const stay  = item.stay  ? `<span class="pill"><i class="fas fa-hourglass-half"></i> ${escapeHtml(item.stay)}</span>` : '';

    const guideList = (item.guide || []).length
      ? `<div class="block"><h4><i class="fas fa-headset"></i> å°éŠä»‹ç´¹</h4><ul class="bullet">${item.guide.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul></div>`
      : '';

    const avoidList = (item.avoid || []).length
      ? `<div class="block"><h4><i class="fas fa-triangle-exclamation"></i> é¿é›·æŒ‡å—</h4><ul class="bullet">${item.avoid.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul></div>`
      : '';

    const menuBlock = (item.menu || []).length
      ? `<div class="menu-recommend">
          <div style="font-weight:900; margin-bottom:10px; color:#8C6B43;"><i class="fas fa-thumbs-up"></i> å¿…åƒèœå–®ï¼ˆä¸­æ—¥å°ç…§ï¼‰</div>
          ${(item.menu||[]).map(m=>`
            <div class="menu-item">
              <span class="jp-text">${escapeHtml(m.jp || '')}</span>
              <span style="font-size:.9rem; color:#666; font-weight:800;">${escapeHtml(m.zh || '')}</span>
            </div>`).join('')}
        </div>`
      : '';

    const detailText = item.detail || item.desc || '';

    // âœ… ä½ è¦çš„æ¬„ä½ï¼ˆeta/arrive/arrival çš†å¯ï¼‰
    const eta = item.eta || item.arrive || item.arrival || '';
    const addr = item.addr || '';
    const parking = item.parking || '';
    const mapcode = item.mapcode || '';

    const navUrl = buildGoogleDirUrl(item);

    content.innerHTML = `
      <div class="sheet-head">
        <div class="tl-tag ${tagClass(item.tag)}">${escapeHtml((item.tag||'').toUpperCase())}</div>
        <div class="sheet-time"><i class="fa-regular fa-clock" style="color:#8B8175; margin-right:6px;"></i>${escapeHtml(item.time || 'â€”')}</div>
      </div>

      <div class="modal-title">${escapeHtml(item.title || '')}</div>

      <div class="pill-row">
        ${hours}${price}${stay}
      </div>

      <div class="meta-box">
        ${eta ? `
        <div class="meta-row">
          <span class="meta-ico">â±ï¸</span>
          <span class="meta-val">é è¨ˆåˆ°é”ï¼š${escapeHtml(eta)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(eta)}')">è¤‡è£½</button>
        </div>` : ''}

        ${addr ? `
        <div class="meta-row">
          <span class="meta-ico">ğŸ“</span>
          <span class="meta-val">${escapeHtml(addr)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(addr)}')">è¤‡è£½</button>
        </div>` : ''}

        ${parking ? `
        <div class="meta-row">
          <span class="meta-ico">ğŸ…¿ï¸</span>
          <span class="meta-val">${escapeHtml(parking)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(parking)}')">è¤‡è£½</button>
        </div>` : ''}

        ${mapcode ? `
        <div class="meta-row">
          <span class="meta-ico">ğŸ§­</span>
          <span class="meta-val">Mapcodeï¼š${escapeHtml(mapcode)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(mapcode)}')">è¤‡è£½</button>
        </div>` : ''}

        ${(!eta && !addr && !parking && !mapcode) ? `
        <div class="meta-row">
          <span class="meta-ico">â„¹ï¸</span>
          <span class="meta-val">ï¼ˆæ­¤è¡Œç¨‹å°šæœªå¡«ï¼šåˆ°é”/åœ°å€/åœè»Š/Mapcodeï¼‰</span>
        </div>` : ''}
      </div>

      <div class="detail">${escapeHtml(detailText)}</div>

      ${menuBlock}
      ${avoidList}
      ${guideList}

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
        <button class="btn btn-outline" onclick="copyText('${escapeHtml(item.title || '')}')">è¤‡è£½åç¨±</button>

        ${item.mapcode
          ? `<button class="btn btn-outline" onclick="copyText('${escapeHtml(item.mapcode)}')">è¤‡è£½ Mapcode</button>`
          : `<button class="btn btn-outline" onclick="copyText('${escapeHtml(item.addr || item.title || '')}')">è¤‡è£½åœ°å€</button>`}
      </div>


      <div class="sheet-actions">
        <a class="btn-primary" href="${navUrl}" target="_blank" rel="noopener">
          <i class="fas fa-location-arrow"></i> é–‹å•Ÿ Google Maps å°èˆª
        </a>
      </div>`;

    lockBodyScroll();
    document.getElementById('modalOverlay').classList.add('active');
    document.getElementById('modalSheet').classList.add('active');
  }

  // function openRouteMap(ev, idx){
  //   ev?.stopPropagation?.();

  //   const item = currentDayData?.items?.[idx];
  //   if(!item) return;

  //   const r = item.route || {};
  //   const from = r.from || '';
  //   const to   = r.to || '';
  //   if(!to) return;

  //   const mode = (r.mode || 'drive').toLowerCase();
  //   const travelmode =
  //     mode === 'walk'  ? 'walking' :
  //     mode === 'train' ? 'transit' :
  //     mode === 'ship'  ? 'transit' :
  //     mode === 'plane' ? 'transit' :
  //     'driving';

  //   window.open(
  //     `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from)}&destination=${encodeURIComponent(to)}&travelmode=${travelmode}`,
  //     '_blank',
  //     'noopener'
  //   );
  // }
  function openRouteMap(ev, idx){
    ev?.stopPropagation?.();
    const item = currentDayData?.items?.[idx];
    if(!item?.route) return;

    const r = item.route;
    const tm = travelModeForRoute(r.mode);
    window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(r.from||'')}&destination=${encodeURIComponent(r.to||'')}&travelmode=${tm}`, '_blank', 'noopener');
  }


  function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
    document.getElementById('modalSheet').classList.remove('active');

    // ç­‰ sheet å‹•ç•«æ”¶èµ·ï¼ˆä½ çš„ transition 0.3sï¼‰
    setTimeout(() => {
      unlockBodyScroll();
    }, 320);
  }


  function openUrl(url){
    window.open(url, '_blank', 'noopener');
  }

  // ====== ä½å®¿/èˆªç­/è¨˜å¸³ï¼ˆæ²¿ç”¨ä½ åŸæœ¬é‚è¼¯ï¼‰ ======
  function renderHotels() {
    document.getElementById('hotelList').innerHTML = (HOTELS || []).map(h => {
      const dateText = h.stay ? `${h.stay.from} - ${h.stay.to}` : '';
      const img = (h.images && h.images[0]) ? h.images[0]
        : "https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&q=80&w=900";

      return `
        <div class="card" style="padding:0; overflow:hidden;">
          <img src="${escapeHtml(img)}" style="height:180px; width:100%; object-fit:cover; border-radius:20px; margin-bottom:0;">
          <div style="padding:20px;">
            <h3 style="margin:0 0 6px; font-family:'Noto Serif TC',serif; font-weight:900;">${escapeHtml(h.name || '')}</h3>
            <div style="color:var(--ink2); font-size:0.9rem; margin-bottom:10px; font-weight:800;">${escapeHtml(dateText)}</div>
            <div style="font-size:0.95rem; line-height:1.6; color:#444; font-weight:700;">
              ${escapeHtml(h.desc || '')}
            </div>
            ${h.mapcode ? `<div style="display:inline-block;background:rgba(255,235,238,.92);color:#B42318;padding:6px 10px;border-radius:999px;font-size:.82rem;font-weight:900;margin-top:10px;border:1px solid rgba(180,35,24,.15);">Mapcode: ${escapeHtml(h.mapcode)}</div>` : ''}
            <button class="btn btn-outline" style="margin-top:15px;" onclick="openUrl('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.name || '')}')">å°èˆª</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderFlights(){
    const el = document.getElementById('flightBoard');
    const out = FLIGHTS?.outbound;
    const inn = FLIGHTS?.inbound;

    el.innerHTML = [out, inn].filter(Boolean).map((f, idx) => {
      const isOut = idx === 0;
      const label = isOut ? `å»ç¨‹ ${mmdd(f.date)} (${weekdayZh(f.date)})` : `å›ç¨‹ ${mmdd(f.date)} (${weekdayZh(f.date)})`;
      const carrier = FLIGHTS?.carrier || '';
      const baggage = f.baggage ? `${f.baggage.checked || ''} / ${f.baggage.pieces || ''}ä»¶` : '';
      const terminal = f.from?.terminal ? `â€¢ ${f.from.terminal}` : '';

      return `
        <div class="boarding">
          <div class="boarding-top">
            <div class="row">
              <div class="boarding-badge"><i class="fas fa-plane"></i> ${escapeHtml(label)}</div>
              <div style="font-weight:900; color:#333;">${escapeHtml(f.flight_no || '')}</div>
            </div>
            <div style="margin-top:8px; color:var(--ink2); font-weight:800;">${escapeHtml(carrier)} â€¢ ${escapeHtml(f.aircraft || '')}</div>
          </div>

          <div class="boarding-mid">
            <div style="text-align:left;">
              <div class="code">${escapeHtml(f.from?.code || '')}</div>
              <div class="t">${escapeHtml(f.from?.city || '')} â€¢ ${escapeHtml(f.depart_time || '')} ${escapeHtml(terminal)}</div>
            </div>
            <i class="fas fa-arrow-right" style="color:#B9B2AA; font-size:1.1rem;"></i>
            <div style="text-align:right;">
              <div class="code">${escapeHtml(f.to?.code || '')}</div>
              <div class="t">${escapeHtml(f.to?.city || '')} â€¢ ${escapeHtml(f.arrive_time || '')}</div>
            </div>
          </div>

          <div class="boarding-bottom">
            <div><i class="fas fa-suitcase-rolling"></i> è¡Œæï¼š${escapeHtml(baggage)}</div>
            <div><i class="fas fa-building"></i> å‡ºç™¼ï¼š${escapeHtml(f.from?.city || '')} ${escapeHtml(f.from?.terminal || '')}</div>
            <div><i class="fas fa-location-dot"></i> æŠµé”ï¼š${escapeHtml(f.to?.city || '')}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  // è¨˜å¸³ï¼šæ²¿ç”¨ä½ åŸç‰ˆï¼ˆåªæœ‰è¦–è¦ºå·²å¥—å…¥ä¸Šæ–¹ CSSï¼‰
  let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
  function renderExpenseUI() {
    document.getElementById('payerSwitch').innerHTML = users.map(u =>
      `<div class="user-tab ${u===curPayer?'active':''}" onclick="curPayer='${u}'; renderExpenseUI();">${u}</div>`
    ).join('');

    document.getElementById('expenseList').innerHTML = expenses.map((e,i) => `
      <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(233,225,214,.8);">
        <div>
          <div style="font-weight:900;">${escapeHtml(e.name)}</div>
          <div style="font-size:0.8rem; color:var(--ink2); font-weight:800;">${escapeHtml(e.payer)} ä»˜æ¬¾</div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:900;">Â¥${escapeHtml(String(e.cost))}</div>
          <div style="font-size:0.8rem; color:#B42318; cursor:pointer; font-weight:900;" onclick="delExp(${i})">åˆªé™¤</div>
        </div>
      </div>
    `).join('');

    let bal = {};
    users.forEach(u => bal[u]=0);

    expenses.forEach(e => {
      let share = e.cost / users.length;
      users.forEach(u => {
        if(u===e.payer) bal[u] += (e.cost - share);
        else bal[u] -= share;
      });
    });

    document.getElementById('debtList').innerHTML = users.map(u => {
      let val = Math.round(bal[u]);
      let color = val>=0 ? '#2F8F5B' : '#B42318';
      return `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(233,225,214,.8); font-weight:900;">
        <span>${escapeHtml(u)}</span>
        <span style="color:${color}; font-weight:900;">${val>=0?'æ”¶':'ä»˜'} Â¥${Math.abs(val)}</span>
      </div>`;
    }).join('');
  }

  function addExpense() {
    const name = document.getElementById('exName').value.trim();
    const cost = parseInt(document.getElementById('exCost').value, 10);
    if(!name || !cost) return alert('è«‹è¼¸å…¥è³‡æ–™');
    expenses.push({name, cost, payer:curPayer});
    localStorage.setItem('expenses', JSON.stringify(expenses));
    document.getElementById('exName').value = '';
    document.getElementById('exCost').value = '';
    renderExpenseUI();
  }

  function delExp(i) {
    if(confirm('åˆªé™¤?')) {
      expenses.splice(i,1);
      localStorage.setItem('expenses', JSON.stringify(expenses));
      renderExpenseUI();
    }
  }

  // utils
  function escapeHtml(str){
    return String(str ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function unescapeHtml(str){
    return String(str ?? '')
      .replaceAll('&amp;','&')
      .replaceAll('&lt;','<')
      .replaceAll('&gt;','>')
      .replaceAll('&quot;','"')
      .replaceAll('&#39;',"'");
  }
  function copyText(txt) {
    navigator.clipboard.writeText(txt);
    alert('å·²è¤‡è£½ï¼š' + txt);
  }

  function mmdd(iso){
    if(!iso) return '';
    const m = String(iso).slice(5,7);
    const d = String(iso).slice(8,10);
    return `${m}/${d}`;
  }
  function weekdayZh(iso){
    if(!iso) return '';
    const dt = new Date(iso + "T00:00:00");
    const arr = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
    return arr[dt.getDay()];
  }

  let __scrollY = 0;
  function lockBodyScroll(){
    __scrollY = window.scrollY || 0;

    // iOS æœ€ç©©ï¼šæŠŠ body å›ºå®šä½
    document.body.classList.add('body-no-scroll'); // ä½ åŸæœ¬é‚£å€‹ class å¯ä»¥ç•™è‘—
    document.body.style.position = 'fixed';
    document.body.style.top = `-${__scrollY}px`;
    document.body.style.left = '0';
    document.body.style.right = '0';
    document.body.style.width = '100%';
  }

  function unlockBodyScroll(){
    document.body.classList.remove('body-no-scroll');
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.left = '';
    document.body.style.right = '';
    document.body.style.width = '';

    window.scrollTo(0, __scrollY);
  }


</script>
</body>

</html>
