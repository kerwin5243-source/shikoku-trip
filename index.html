<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>2026 å››åœ‹å·¡ç¦®</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/icon/apple-touch-icon-180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/icon/apple-touch-icon-167.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-touch-icon-152.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icon/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icon/favicon-16.png">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#F6F3EE" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>	
  <script>
    const TAG_SVGS = {
      takagi: ['./photos/takagi_01_nobg_v2.svg', './photos/takagi_02_nobg_v2.svg']
    };
    function getTagIconHtml(tag, idx){
      const t = (tag||'').toLowerCase();
      if(t==='takagi' && TAG_SVGS.takagi){
        const src = TAG_SVGS.takagi[idx % TAG_SVGS.takagi.length];
        return `<img class="tag-svg" src="${src}" alt="takagi" />`;
      }
      return '';
    }
  </script>				
  <script>
/*      1. è¨­å®šä½ çš„ GAS API URL */
    const G_API_URL = "https://script.google.com/macros/s/AKfycbzv1elsDGSjeo2biqiiTaBVo1UvnxhJUSlHTotd8uffDfFbjbsl9jZs2wvIPdS554Yr/exec"; // è²¼ä¸Šå‰›æ‰æ­¥é©Ÿ 1 å¾—åˆ°çš„ç¶²å€
/*     const G_TOKEN = "shikoku_2026_secret"; // å¿…é ˆèˆ‡ GAS å…§çš„è¨­å®šä¸€è‡´ */
/*      2. æ”¹ç‚ºå¾ Cookie è®€å– Token */
    let G_TOKEN = getCookie("trip_auth_token") || "";
  
/*      --- Cookie æ“ä½œå‡½å¼ --- */
    function setCookie(name, value, days) {
      let expires = "";
      if (days) {
        let date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Strict";
    }
  
    function getCookie(name) {
      let nameEQ = name + "=";
      let ca = document.cookie.split(';');
      for(let i=0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }
  </script>


  <!-- âœ… Serif + Sansï¼ˆæ¨™é¡Œæ—¥ç³»æ„Ÿï¼‰ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Noto+Serif+TC:wght@600;700;900&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --bg-body:#F6F3EE;
      --bg-card:rgba(255,255,255,.72);
      --ink:#1E1E1E;
      --ink2:#6F6A62;
      --divider:#E9E1D6;
      --text-sec: var(--ink2);

      --primary:#2B2723;
      --accent:#B08A5B;

      --radius-L:28px;
      --radius-M:20px;
      --radius-S:14px;

      --shadow-soft:0 10px 26px rgba(0,0,0,.08);
    }
    *, *::before, *::after { box-sizing: border-box; }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      font-family:'Noto Sans TC',sans-serif;
      background:var(--bg-body);
      color:var(--ink);
      margin:0;
      padding-bottom:calc(90px + env(safe-area-inset-bottom));
      /* âœ… ä¿®æ­£ï¼šæ”¹ç‚º auto æˆ–åƒ…åœ¨è¡Œå‹•ç«¯å•Ÿå‹•ï¼Œé¿å…æ¡Œæ©Ÿæ²å‹•è¡çª */
      overscroll-behavior-y: auto;
    }
    body.body-no-scroll{ overflow:hidden; }

    .app-header{
      padding:calc(20px + env(safe-area-inset-top)) 20px 16px;
      text-align:center;
      background:linear-gradient(to bottom, rgba(246,243,238,1), rgba(246,243,238,.82));
    }

    .app-header h1{
        margin:0;
        font-family:'Noto Sans TC',sans-serif;
        font-size:1.75rem;     /* åŸæœ¬ 2.2rem â†’ ç¸®å° */
        font-weight:900;
        letter-spacing:.12em;
        display:flex;
        justify-content:center;
        align-items:baseline;
        gap:10px;
    }
    /* subtitle + year åŒåˆ—ï¼šç½®ä¸­ã€å·¦å³æ’åˆ— */
    .hdr-subrow{
      margin-top:8px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
    }

    #hdrSub{
      margin:0;
      font-size:.92rem;
      color:var(--ink2);
      font-weight:700;
      text-align:center;
    }


    .year-pill{
        font-family:'Noto Sans TC',sans-serif;
        font-size:.70rem;
        font-weight:900;
        padding:3px 8px;
        border-radius:999px;
        border:1px solid rgba(176,138,91,.55);
        background:rgba(255,255,255,.65);
        color:#7D5B34;
    }

    .app-header p{
        margin:8px 0 0;
        font-size:.92rem;
        color:var(--ink2);
        font-weight:700;
        text-align:center;
    }
    /* å‡åå°ä¸€è¡Œæ·¡æ·¡ç½®ä¸­ */
    .hdr-kana{
      margin-top:6px;
      text-align:center;
      font-size:.72rem;
      letter-spacing:.06em;
      color:rgba(43,39,35,.35);
      font-weight:600;
    }

    .page{ display:none; padding:0 20px; animation:fadeIn .28s ease; }
    .page.active{ display:block; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    .card{
      background:var(--bg-card);
      border:1px solid rgba(233,225,214,.85);
      border-radius:var(--radius-L);
      padding:22px;
      margin-bottom:18px;
      box-shadow:var(--shadow-soft);
      backdrop-filter: blur(10px);
    }
    .section-title{
      font-size:1.05rem; font-weight:900; margin-bottom:14px;
      display:flex; align-items:center; gap:10px;
      font-family:'Noto Serif TC', serif;
    }
    .section-title i{ color:#8B8175; }

    .btn{
      background:var(--primary); color:#fff; border:none;
      padding:14px; border-radius:var(--radius-S);
      font-weight:800; width:100%; font-size:1rem; cursor:pointer;
      transition:transform .1s;
    }
    .btn:active{ transform:scale(.98); }
    .btn-outline{
      background:transparent;
      border:1.5px solid rgba(43,39,35,.35);
      color:var(--primary);
      font-weight:900;
    }

    /* tabs */
    .user-tabs{
      display:flex; gap:8px; margin-bottom:16px;
      background:rgba(233,225,214,.9); padding:4px; border-radius:14px;
    }
    .user-tab{
      flex:1; text-align:center; padding:10px 0; border-radius:10px;
      font-weight:800; font-size:.9rem; color:var(--ink2);
      cursor:pointer; transition:.2s;
    }
    .user-tab.active{
      background:#fff;
      color:var(--primary);
      box-shadow:0 6px 16px rgba(0,0,0,.10);
    }

    /* ===== Money: participant chips + type segmented ===== */
    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:10px 0 12px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(233,225,214,.9);
      background:rgba(255,255,255,.78);
      font-weight:900;
      font-size:.85rem;
      color:var(--primary);
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .chip:active{ transform:scale(.98); }
    .chip.on{
      border-color:rgba(176,138,91,.65);
      box-shadow:0 10px 22px rgba(0,0,0,.08);
    }
    .chip.off{
      opacity:.45;
    }
    .seg{
      display:flex;
      gap:6px;
      background:rgba(233,225,214,.9);
      padding:4px;
      border-radius:14px;
      margin:8px 0 12px;
    }
    .seg-btn{
      flex:1;
      text-align:center;
      padding:10px 0;
      border-radius:10px;
      font-weight:900;
      font-size:.9rem;
      color:var(--ink2);
      cursor:pointer;
      transition:.2s;
      user-select:none;
    }
    .seg-btn.active{
      background:#fff;
      color:var(--primary);
      box-shadow:0 6px 16px rgba(0,0,0,.10);
    }
    .exp-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:.78rem;
      border:1px solid rgba(233,225,214,.9);
      background:rgba(255,255,255,.7);
      color:rgba(43,39,35,.72);
    }
    .exp-badge.prepaid{ border-color:rgba(176,138,91,.35); background:rgba(255,247,229,.9); }
    .exp-badge.trip{ background:rgba(242,242,247,.92); }

    /* checklist */
    .checklist-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .check-item{
      background:rgba(255,255,255,.65);
      border:1px solid rgba(233,225,214,.8);
      border-radius:var(--radius-S);
      padding:14px 6px;
      text-align:center;
      font-size:.85rem;
      font-weight:700;
      display:flex; flex-direction:column; align-items:center; gap:8px;
      cursor:pointer;
      transition:.2s;
    }
    .check-item i{ font-size:1.35rem; color:#B9B2AA; }
    .check-item.checked{
      background:rgba(232,245,233,.9);
      border-color:rgba(52,199,89,.65);
      color:#2E7D32;
    }
    .check-item.checked i{ color:#34C759; }

    /* å…¨å“¡å¾…è¾¦ */
    .todo-li{
      display:flex; align-items:flex-start; gap:10px;
      padding:10px 0; border-bottom:1px solid rgba(233,225,214,.8);
    }
    .todo-li:last-child{ border-bottom:none; }
    .todo-li input{ width:18px; height:18px; margin-top:2px; accent-color:#8C6B43; }
    .todo-title a{ color:inherit; text-decoration:none; font-weight:900; }
    .todo-title span{ font-weight:900; }
    .todo-note{ font-size:.85rem; color:var(--ink2); margin-top:4px; line-height:1.45; }


    .day-hero{
        margin:6px 0 14px;
        border-radius:24px;
        overflow:hidden;
        border:1px solid rgba(233,225,214,.9);
        box-shadow:0 10px 26px rgba(0,0,0,.08);
        background:rgba(255,255,255,.6);
    }

    .hero-track{
        display:flex;
        overflow-x:auto;
        scroll-snap-type:x mandatory;
        scrollbar-width:none;
    }
    .hero-track::-webkit-scrollbar{ display:none; }

    .hero-slide{
        flex:0 0 100%;
        aspect-ratio: 16 / 9;   /* âœ… å›ºå®š 16:9 */
        height:auto;            /* âœ… ä¸ç”¨å›ºå®šé«˜åº¦ */
        scroll-snap-align:start;
        position:relative;
        overflow:hidden;
    }
    .hero-slide .hero-img{
        width:100%;
        height:100%;
        object-fit:cover;
        display:block;
    }
    /* èƒŒæ™¯å±¤ï¼šå¡«æ»¿ + æ¨¡ç³Š */
    .hero-slide.hero--blur .hero-bg{
      position:absolute;
      inset:-18px;                 /* é¿å… blur éœ²é‚Š */
      width:100%;
      height:100%;
      object-fit:cover;
      filter: blur(18px) saturate(1.05) brightness(1.05);
      transform: scale(1.12);
    }

    /* å‰æ™¯å±¤ï¼šå®Œæ•´é¡¯ç¤ºï¼ˆä¸è£åˆ‡ï¼‰ */
    .hero-slide.hero--blur .hero-img{
      position:relative;
      width:100%;
      height:100%;
      object-fit:cover;          /* âœ… é—œéµ */
      display:block;
    }

    /* å¯é¸ï¼šå†åŠ ä¸€å±¤æ·¡æš—å¹•ï¼Œè®“å­—æ›´ç©© */
    .hero-slide.hero--blur::after{
      content:"";
      position:absolute;
      inset:0;
       background: transparent;
      pointer-events:none;
    }


    .hero-dots{
		  display:none;
		position:absolute;
		  left:0; right:0; bottom:10px;
		  display:flex;
		  justify-content:center;
		  gap:6px;
		  pointer-events:auto;
    }
    .hero-dot{
        width:6px; height:6px;
        border-radius:50%;
        background:transparent;
    }
    .hero-dot.active{ background:rgba(255,255,255,.95); }

    .hero-overlay{
      position:absolute;
      left:12px;                      /* è·å·¦ 12 */
      right:12px;                     /* è·å³ 12ï¼ˆç­‰æ–¼å®¹å™¨æœ‰å·¦å³ç•™ç™½ï¼‰ */
      bottom:2px;                     /* âœ… è²¼è¿‘åœ–ç‰‡åº•éƒ¨ï¼ˆæƒ³æ›´è²¼å°±æ”¹ 4px æˆ– 0ï¼‰ */
      display:flex;                   /* è®“å·¦å³å…©å¡Šåˆ†é–‹æ”¾ */
      justify-content:space-between;  /* å·¦ï¼šhero-loc / å³ï¼šhero-caption */
      align-items:flex-end;           /* å…©è€…éƒ½è²¼é½Šåº•éƒ¨ */

      gap:12px;                       /* å·¦å³ä¹‹é–“çš„å®‰å…¨è·é›¢ */
      max-width:none;                 /* âœ… ä¸è¦ç”¨ 75% é™åˆ¶ï¼Œä¸ç„¶å³é‚Šæœƒè¢«æ“  */
      pointer-events:none;            /* å¯é¸ï¼šé¿å…é®åˆ°æ»‘å‹•/é»æ“Š */
    }

    .hero-loc{
      pointer-events:auto;
      display:inline-flex;
      align-items:center;
      gap:8px;

      /* âœ… æ©¢åœ“è† å›Šåº•ï¼šå¾ˆæ·¡ï¼Œä½†å¯è®€æ€§å¤§å¹…æå‡ */
      padding:4px 10px;                 /* è®“è† å›Šæœ‰å‘¼å¸ç©ºé–“ */
      border-radius:999px;              /* æ©¢åœ“ */
      background: rgba(0,0,0,.18);      /* å¾ˆæ·¡çš„é»‘åº•ï¼ˆä½ å¯åœ¨ .14~.24 é–“èª¿ï¼‰ */

      /* âœ… å­—ä¸è¦å¤ªç²—ï¼Œä½†è¦æ¸…æ¥š */
      color: rgba(255,255,255,.95);
      font-size:.90rem;
      font-weight:400;                  /* 700 â†’ 600 æ›´è‡ªç„¶ */

      /* âœ… æ·¡æé‚Šï¼šè®“äº®èƒŒæ™¯ä¸Šä¹Ÿä¸æœƒæ¶ˆå¤± */
      border: 1px solid rgba(255,255,255,.18);

      /* âœ… æ–‡å­—é™°å½±ï¼šè£œå¼·å°æ¯” */
      text-shadow: 0 2px 10px rgba(0,0,0,.60);

      /* âœ… å–æ¶ˆæ¯›ç»ç’ƒï¼ˆç¶­æŒä½ éœ€æ±‚ï¼‰ */
      backdrop-filter:none;
      -webkit-backdrop-filter:none;
    }

    .hero-caption{
      pointer-events:auto;            /* è‹¥ caption éœ€è¦å¯é»æ“Š */
      padding:3px 8px;                      /* âœ… ä¸è¦åº•ã€ä¸è¦å…§è·ï¼Œè¦–è¦ºæ›´è²¼åº• */
      background:rgba(0,0,0,.18);         /* âœ… ä¸è¦åº•è‰² */
      border-radius:0;
      border:1px solid rgba(255,255,255,.18); /* âœ… æ·¡å¤–æ¡† */

      color:#fff;                     /* âœ… ç™½è‰² */
      font-weight:900;
      font-size:1rem;               /* âœ… å­—è®Šå¤§ï¼ˆä½ å¯æ”¹ 1rem / 1.05remï¼‰ */
      line-height:1.15;               /* âœ… è®“æ–‡å­—æ›´ç·Šæ¹Šä¸æœƒæµ®èµ·ä¾† */

      text-align:right;               /* âœ… å³ä¸‹è§’å°é½Š */
      text-shadow:0 2px 10px rgba(0,0,0,.65); /* âœ… ä¿æŒæ¸…æ¥š */
      transform:translateY(-2px);             /* âœ… ä¸Šç§» 2px */

      margin:0;                       /* âœ… é¿å…è¢«é è¨­ margin æ’é–‹ */
      -webkit-text-stroke: .4px rgba(0,0,0,.35);
      /* backdrop-filter: blur(6px); */     /* âŒ å–æ¶ˆæ¯›ç»ç’ƒ */
      /* -webkit-backdrop-filter: blur(6px); */
    }






    /* date chip æ˜¯æœ€ä¸Šé¢æ—¥æœŸ æ˜ŸæœŸ Day */
    .date-chip{
      flex:0 0 auto;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(233,225,214,.9);
      border-radius:16px;
      padding:8px 8px;
      text-align:center;
      min-width:45px;
      box-shadow:0 10px 24px rgba(0,0,0,.08);
      transition:.2s;
      cursor:pointer;
	  position:relative;
    }
    .date-chip .day{
      font-family:'Noto Serif TC', serif;
      font-size:.90rem;
      font-weight:900;
      letter-spacing:.02px;
      line-height:1.05;
    }
    .date-chip .date{
      font-size:.60rem;
      font-weight:900;
      color:var(--ink2);
      margin-top:2px;
      line-height:1.05;
    }
    .date-chip .wk{
        margin-top:2px;
        font-family:'Noto Sans TC', sans-serif;
        font-size:.50rem;        /* æ˜ŸæœŸæ›´å° */
        font-weight:900;
        color:rgba(43,39,35,.45);
        letter-spacing:.14em;
        text-transform:uppercase;
        line-height:1.05;
    }
    .date-chip.active{
        background:#fff;
        border-color:rgba(176,138,91,.75);
        box-shadow:0 16px 34px rgba(0,0,0,.12);
        transform:translateY(-2px) scale(1.03);
    }
    .date-chip.active .day{ color:#724b1d; }

        /* date scroller */
    .date-scroller{
      display:flex; gap:8px; overflow-x:auto; padding:4px 16px 8px;
      margin:0 -20px; scrollbar-width:none;
    }
    .date-scroller::-webkit-scrollbar{ display:none; }

    /* weather */
    .weather-strip{
      display:flex; gap:20px; overflow-x:auto;
      padding-bottom:10px; margin-bottom:14px;
      scrollbar-width:none;
      border-bottom:1px solid var(--divider);
    }
    .weather-strip::-webkit-scrollbar{ display:none; }
    .weather-hour{ text-align:center; flex:0 0 auto; }
    .w-time{ font-size:.8rem; color:var(--ink2); margin-bottom:5px; font-weight:800; }
    .w-icon{ font-size:1.15rem; margin-bottom:5px; color:#8B8175; }
    .w-temp{ font-weight:900; font-size:.9rem; color:var(--primary); }



    /* âœ… è®“æ¯ä¸€åˆ—ï¼šå·¦æ™‚é–“ã€å³å…§å®¹ å›ºå®šå°é½Š */
    .timeline-item{
        display:grid;
        grid-template-columns: 64px 1fr;
        column-gap:12px;
        align-items:start;
        margin-bottom:18px; 
        cursor:pointer; 

	/* --- æ–°å¢ï¼šé˜²æ­¢ç³»çµ±é¸å–®å¹²æ“¾é•·å£“ --- */
        -webkit-touch-callout: none; /* ç¦ç”¨ iOS é•·å£“å½ˆå‡ºé¸å–® */
        -webkit-user-select: none;   /* ç¦æ­¢é•·å£“é¸å–æ–‡å­— */
        user-select: none;           /* æ¨™æº–å±¬æ€§ */
        touch-action: pan-y;         /* å…è¨±å‚ç›´æ²å‹•ï¼Œä½†é˜²æ­¢å…¶ä»–è§¸æ§æ‰‹å‹¢è¡çª */
    }
    .tl-time{
      min-width:56px;
      font-family:'Roboto Mono', monospace;
      font-weight:700;
      color:var(--ink2);
      text-align:right;
      padding-top:6px;
      font-size:1rem;
    }
    


    .tl-content{
      position:relative;
      flex:1;
      min-width:0;
      background:rgba(255,255,255,.78);
      border:1px solid rgba(233,225,214,.9);
      border-radius:var(--radius-M);
      padding:10px 16px 10px;
      box-shadow:0 14px 30px rgba(0,0,0,.07);
      transition:transform .12s ease;
    }
    .tl-content:active{ transform:scale(.985); }

    .tl-content > .reserve-badge{
      position:absolute;
      top:10px;
      right:12px;
      left:auto; 
      display:inline-block;
      font-size:.6rem;
      line-height:1;
      letter-spacing:.08em;
      padding:4px 8px;
      border:1.6px solid rgba(180,35,24,.72);
      color:rgba(180,35,24,.92);
      background:rgba(255,255,255,.86);
      border-radius:8px;
      transform:rotate(-8deg);
      transform-origin:top right;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      z-index:2;                         /* âœ…ç¢ºä¿ä¸è¢« tag/æ¨™ç±¤è“‹ä½ */
      pointer-events:none;               /* å¯é¸ï¼šé¿å…æ“‹é»æ“Š */
      
    }


    .tl-tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      font-size:.55rem;
      font-weight:900;
      letter-spacing:.12em;
      margin:0 0 6px 0;   /* åªç•™åº•éƒ¨ä¸€é»é»è·é›¢ */
      line-height:1;     /* âœ… è®“é«˜åº¦æ›´ç·Š */
      text-transform:uppercase;
      color:#a5a39f;
    }
    .tl-tag::before{
      content:'';
      width:8px; height:8px;
      border-radius:50%;
      display:inline-block;
      background:#B9B2AA;
    }
    .tag-food::before{ background:#D28A3A; }
    .tag-sight::before{ background:#2F8F5B; }
    .tag-transport::before{ background:#3D6EA9; }
    .tag-takagi::before{ background:#f574ef; }
    .tag-hotel::before{ background:#7A4FA8; }
    .tag-shop::before{ background:#e1c820; }

    .tl-title{
      font-family:'Noto Serif TC', serif;
      font-size:1.1rem;
      font-weight:900;
      margin-bottom:6px;
      line-height:1.15;
      letter-spacing:.2px;
    }
    .tl-desc{
      font-size:.92rem;
      color:var(--ink2);
      line-height:1.5;
      display:-webkit-box;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    /* âœ… å°è¡Œç¨‹ï¼šç°åº•çš„ã€Œé è¨ˆåœç•™/è»Šç¨‹ã€è† å›Š */
    .tl-meta{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }
    .tl-chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:#F2F2F7;
      color:#555;
      font-size:.85rem;
      font-weight:800;
    }
    .tl-chip i{ color:#8E8E93; }
    /* ===== highlightï¼ˆåŠ åšå…‰æšˆ + æ˜Ÿæ˜Ÿï¼‰===== */
    .tl-content.highlight{
      position:relative;
      border-color: rgba(176,138,91,.70);
      /* ä¿ç•™åŸæœ¬ç™½åº• + åŠ ä¸€å±¤æ·¡æ·¡æ—¥ç³»é‡‘è‰²è§’è½æ¼¸å±¤ */
      background:
        linear-gradient(135deg, rgba(176,138,91,.14), rgba(176,138,91,0) 55%),
        rgba(255,255,255,.78);
      box-shadow:
        0 14px 30px rgba(0,0,0,.10),
        0 0 0 1px rgba(176,138,91,.22),
        0 0 28px rgba(176,138,91,.40); /* âœ…å…‰æšˆæ›´åš */
    }

    /* å¤–å±¤å…‰æšˆï¼ˆä½ æƒ³è¦æ›´åšå°±èª¿ blur / opacity / insetï¼‰ */
    .tl-content.highlight::before{
      content:"";
      position:absolute;
      inset:-12px;                 /* âœ…æ›´å¤–æ“´ */
      border-radius: calc(var(--radius-M) + 14px);
      background:
        radial-gradient(circle at 30% 20%,
          rgba(176,138,91,.45), rgba(176,138,91,0) 60%);
      filter: blur(14px);          /* âœ…æ›´åš */
      opacity: .95;
      z-index:-1;
      pointer-events:none;
    }

    /* æ˜Ÿæ˜Ÿ badgeï¼ˆç”¨ ::after æ”¾å›ä¾†ï¼‰ */
    .tl-content.highlight::after{
      content:"â˜…";
      position:absolute;
      top:10px;
      right:12px;
      width:26px; height:26px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(176,138,91,.95);
      color:#fff;
      font-size:14px;
      box-shadow:0 10px 22px rgba(176,138,91,.45);
    }


    .tl-tag .tag-ico{
        color:#7E7469;
        opacity:.65;
        font-size:.78rem;
        margin-left:2px;
    }
    .day-route-card{
      margin:10px 0 12px;
      background:rgba(255,255,255,.72);
      border:1px solid rgba(233,225,214,.9);
      border-radius:24px;
      padding:14px 16px;
      box-shadow:0 10px 26px rgba(0,0,0,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .day-route-card .txt{
      font-weight:900;
      line-height:1.2;
    }
    .day-route-card .sub{
      margin-top:4px;
      font-size:.86rem;
      color:var(--ink2);
      font-weight:700;
    }




    /* ===== Modal: bottom sheet ===== */
    .modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.38);
      z-index:2000;
      opacity:0; pointer-events:none;
      transition:opacity .12s ease;
    }

    /* é»é–‹å°ç¨‹å¼æ‡¸æµ®çš„ */
    .modal-sheet{
      position:fixed;
      left:50%;
      background:#FAF7F2;     /* âœ… ä¸€å®šè¦æœ‰ */
      box-shadow:0 18px 70px rgba(0,0,0,.22); /* âœ… è®“å®ƒåƒçœŸçš„æµ®èµ·ä¾† */
      bottom:max(14px, env(safe-area-inset-bottom));
      transform:translateX(-50%) translateY(120%);
      width:min(760px, calc(100vw - 24px));

      /* âœ… ç”¨ dvh æ¯” vh ç©©ï¼ˆæ‰‹æ©Ÿç¶²å€åˆ—ç¸®æ”¾ä¸äº‚è·³ï¼‰ */
      max-height:calc(100dvh - 24px - env(safe-area-inset-top));
      background:#FAF7F2;
      z-index:2001;
      border-radius:28px;
      border:1px solid rgba(233,225,214,.95);
      box-shadow:0 22px 60px rgba(0,0,0,.18);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      /* transition:transform .18s cubic-bezier(.16,1,.3,1); */
      transform: translateX(-50%) translateY(calc(100dvh + 60px)); /* âœ… å¾¹åº•ç§»å‡ºè¦–çª— */
      visibility: hidden;    /* âœ… é€£é™°å½±éƒ½ä¸æœƒéœ² */
      pointer-events: none;  /* âœ… ä¸æœƒåƒåˆ°é»æ“Š */
      will-change: transform;
    }

    .modal-sheet.active{ 
      transform: translateX(-50%) translateY(0);
      visibility: visible;
      pointer-events: auto;
     }

    /* âœ… Header ä¸æ»¾å‹•ï¼Œæ°¸é åœ¨ä¸Šæ–¹ */
    .modal-header{
      position:relative;
      flex:0 0 auto;
      padding:4px 0 2px;
      background:#FAF7F2;
      border-bottom:1px solid rgba(233,225,214,.75);
      /* ğŸ’¡ é—œéµä¿®æ­£ */
      z-index: 2700;       /* å¿…é ˆé«˜æ–¼ .sheet-splash çš„ 2600 */
      touch-action: none;  /* ç¦æ­¢ç€è¦½å™¨å˜—è©¦æ²å‹•ï¼Œå¼·åˆ¶è®“ JS æ¥æ‰‹æ‹–æ›³ */
    }

    /* æ‹–æ›³æ¢ä¿æŒç½®ä¸­ */
    .modal-drag-handle{
      width:44px; height:5px;
      background:#D8CFC4;
      border-radius:99px;
      margin:8px auto 6px;
      flex-shrink:0;
    }

    /* âœ… X æ°¸é å¯è¦‹ï¼ˆåœ¨ header å…§ï¼‰ */
    .modal-x{
      position:absolute;
      right:12px;
      top:8px;
      width:30px; height:30px;  /* âœ… åœ“åœˆå°ä¸€é» */
      border-radius:50%;
      display:grid;              /* âœ… ä¿è­‰ç½®ä¸­ */
      border:1px solid rgba(233,225,214,.95);
      background:#fff;
      font-size:20px;
      line-height:1;             /* âœ… é˜²æ­¢ baseline è¦–è¦ºåç§» */
      cursor:pointer;
      align-items:center; 
      justify-content:center;
      z-index:10;
    }

    /* å…§å®¹æ»¾å‹•åªåœ¨é€™è£¡ç™¼ç”Ÿ */
    .modal-scroll{
      flex:1;
      overflow-y:auto;
      padding:0 18px 16px;
      background:#FAF7F2;           /* âœ… é˜²æ­¢é€å‡ºçœ‹åˆ°èƒŒå¾Œ */
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      /* ğŸ’¡ é—œéµï¼šå…è¨±å‚ç›´æ²å‹•ï¼Œä½†ç•¶æˆ‘å€‘æ””æˆªäº‹ä»¶æ™‚ï¼Œç€è¦½å™¨æ‡‰åœæ­¢å…¶åŸç”Ÿè¡Œç‚º */
      overscroll-behavior-y: none; 
      touch-action: pan-y;
    }



    /* sticky å€å¡Šå›ºå®šåœ¨ é»é–‹å°è¡Œç¨‹å…§å®¹æ»¾å‹•å€é ‚ç«¯ */
    #modalSticky{
        position: sticky;
        top: 0;
        z-index: 30;
        background:#FAF7F2;
        margin:0 -18px;               /* âœ… æŠµæ¶ˆå·¦å³ paddingï¼Œè²¼é½Šé‚Š */
        padding:10px 18px 8px;       /* âœ… æŠŠåŸæœ¬çš„ä¸Šæ–¹ç©ºé–“æ”¾å›é€™è£¡ */
        border-bottom: 1px solid rgba(233,225,214,.75);
        box-shadow:0 6px 18px rgba(0,0,0,.06); /* ã€Œæµ®åœ¨ä¸Šé¢ã€ï¼Œå¯ä»¥å†åŠ ä¸€é»æ·¡é™°å½±*/
    }

    /* å·¦é‚Šå½©è‰²ç›´æ§“ï¼ˆç”¨ tag é¡åˆ¥æ§åˆ¶é¡è‰²ï¼‰ */
    .modal-sticky-wrap{
        position: relative;
        padding-left: 14px;
    }
    .modal-overlay.active{
      opacity:1;
      pointer-events:auto;
    }

    .modal-sticky-wrap::before{
        content:'';
        position:absolute;
        left:-18px;
        top:6px;
        bottom:6px;
        width:4px;
        border-radius:0 999px 999px 0;
        background:#B9B2AA; /* default */
    }
    .modal-sticky-wrap.tag-food::before{ background:#D28A3A; }
    .modal-sticky-wrap.tag-sight::before{ background:#2F8F5B; }
    .modal-sticky-wrap.tag-takagi::before{ background:#f574ef; }
    .modal-sticky-wrap.tag-transport::before{ background:#3D6EA9; }
    .modal-sticky-wrap.tag-hotel::before{ background:#7A4FA8; }
    .modal-sticky-wrap.tag-shop::before{ background:#e1c820; }


    .sheet-head{
      display:flex;
      align-items:center;
      gap:10px; 
      /* padding:6px 2px 10px; */
    }
    /* === Modal tagï¼šæ°´å°æ„Ÿï¼ˆä¸åŠ æ¡†ï¼‰=== */
    .sheet-tag{
        display:inline-flex;
        align-items:center;
        gap:6px;

        /* æ‹¿æ‰æ¡†æ¡†æ„Ÿ */
        padding:0;
        border:none;
        background:transparent;

        font-size:.62rem;
        font-weight:900;
        letter-spacing:.14em;
        text-transform:uppercase;
        color:#A5A39F;
        line-height:1;
    }

    .sheet-tag::before{
        content:"";
        width:8px; height:8px;
        border-radius:50%;
        position:relative;
        background:#B9B2AA;
        display:inline-block;
    }

    /* ç›´æ¥æ²¿ç”¨ä½ åŸæœ¬çš„ tag é¡è‰²é» */
    .sheet-tag.tag-food::before{ background:#D28A3A; }
    .sheet-tag.tag-sight::before{ background:#2F8F5B; }
    .sheet-tag.tag-takagi::before{ background:#f574ef; }
    .sheet-tag.tag-transport::before{ background:#3D6EA9; }
    .sheet-tag.tag-hotel::before{ background:#7A4FA8; }
    .sheet-tag.tag-shop::before{ background:#2A6FA0; }

	/* Takagi SVG icon inside tag */
    .tag-svg{ width:16px; height:16px; display:inline-block; vertical-align:-3px; }
    .sheet-tag.tag-takagi{ color:#f574ef; }

								
    /* /* âœ… åªç¸® modal å…§çš„ tagï¼ˆä¸å½±éŸ¿å¤–é¢åˆ—è¡¨ï¼‰
    .sheet-head .tl-tag{
        padding:4px 8px;
        margin:0;                 /* âœ… å–æ¶ˆåŸæœ¬ margin-bottom:10px */
        /* font-size:.52rem;
        letter-spacing:.10em;
        border-radius:999px;
    } */
    .sheet-time{
      font-family:'Noto Serif TC', serif;
      display:inline-flex;
      align-items:center; 
      font-size:.86rem;
      font-weight:900;
      color:#2B2723;
      line-height:1;
      gap:6px;  
    }
    /* ===== Sheet Splash (open modal show image for ~5s) ===== */
    /* ===== Sheet Splash (camera frame + pop) ===== */
    .sheet-splash{
      position:absolute;
      inset:0;
      z-index:2600;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px;

      /* ä¸è¦æ­»ç°ï¼šæ”¹æˆé¡é ­é®å…‰æ„Ÿ */
      background:
        radial-gradient(circle at 50% 40%,
          rgba(0,0,0,.18) 0%,
          rgba(0,0,0,.46) 55%,
          rgba(0,0,0,.62) 100%);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);

      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease;
    }




    .sheet-splash.active{
      opacity:1;
      pointer-events:auto;          /* å‡ºç¾æ™‚åƒé»æ“Šï¼Œé¿å…èª¤è§¸å…§å®¹ */
    }

    .sheet-splash img{
      width:100%;
      max-width:640px;
      max-height:72vh;
      object-fit:cover;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 26px 80px rgba(0,0,0,.38);
    }


    
    /* å–æ™¯æ¡†æœ¬é«” */
    .splash-frame{
      width: min(720px, calc(100vw - 16px));
      max-width:660px;
      max-height: 86vh; 
      border-radius:22px;
      position:relative;
      overflow:hidden;

      /* ç»ç’ƒå¡ç‰‡æ„Ÿ */
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 28px 90px rgba(0,0,0,.38);

      transform: translateY(18px) scale(.94);
      opacity:0;
      animation: splashPop .34s cubic-bezier(.16,1,.3,1) forwards;
    }

    /* pop å‹•ç•« */
    @keyframes splashPop{
      0%   { transform: translateY(18px) scale(.94); opacity:0; }
      60%  { transform: translateY(-2px) scale(1.01); opacity:1; }
      100% { transform: translateY(0) scale(1); opacity:1; }
    }

    /* å–æ™¯æ¡†å››è§’ï¼ˆç›¸æ©Ÿæ¡†ï¼‰ */
    .splash-frame::before,
    .splash-frame::after{
      content:"";
      position:absolute;
      inset:12px;
      border-radius:16px;
      pointer-events:none;
    }
    .splash-frame::before{
      /* å››è§’æ¡†ç·šï¼šç”¨èƒŒæ™¯ç•«å››å€‹ L è§’ */
      background:
        linear-gradient(#fff,#fff) left top/22px 2px no-repeat,
        linear-gradient(#fff,#fff) left top/2px 22px no-repeat,

        linear-gradient(#fff,#fff) right top/22px 2px no-repeat,
        linear-gradient(#fff,#fff) right top/2px 22px no-repeat,

        linear-gradient(#fff,#fff) left bottom/22px 2px no-repeat,
        linear-gradient(#fff,#fff) left bottom/2px 22px no-repeat,

        linear-gradient(#fff,#fff) right bottom/22px 2px no-repeat,
        linear-gradient(#fff,#fff) right bottom/2px 22px no-repeat;
      opacity:.55;
    }
    .splash-frame::after{
      border:1px solid rgba(255,255,255,.18);
      opacity:.8;
    }

    /* 1 å¼µ / 2 å¼µ */
    .splash-grid{
      display:grid;
      gap:10px;
      padding:10px;
      height: min(82vh, 680px);
    }
    .splash-grid.one{
      grid-template-columns:1fr;
      grid-template-rows: 1fr;
    }
    .splash-grid.two{
      grid-template-columns:1fr;
      grid-template-rows:1fr 1fr;
    }

    /* åœ–ç‰‡æœ¬é«” */
    .splash-img{
      width:100%;
      height:100%;
      aspect-ratio: 16 / 9;
      object-fit:cover;
      object-position: center;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      box-shadow:0 18px 50px rgba(0,0,0,.25);
      display:none; /* JS æœƒæ±ºå®šé¡¯ç¤ºå“ªå¼µ */
    }

    /* å…©å¼µä¸Šä¸‹æ™‚ï¼Œè®“æ¯å¼µæ›´åƒæ‹ç«‹å¾—ç•«é¢ */
    .splash-grid.two .splash-img{
      aspect-ratio: 16 / 10;
    }

        /* ===== Shutter flash (120ms) ===== */
    .splash-frame{
      position:relative; /* ç¢ºä¿ flash ç–Šåœ¨æ¡†ä¸Š */
    }

    .splash-frame .shutter-flash{
      position:absolute;
      inset:0;
      border-radius:22px;
      background:rgba(255,255,255,.92);
      opacity:0;
      pointer-events:none;
    }

    .splash-frame.flash .shutter-flash{
      animation: shutterFlash 120ms ease-out 1;
    }

    @keyframes shutterFlash{
      0%   { opacity:0; }
      15%  { opacity:1; }
      100% { opacity:0; }
    }


    /* splash å‡ºç¾æ™‚ï¼Œç¦æ­¢åº•ä¸‹å…§å®¹äº’å‹•ï¼ˆä¿éšªï¼‰ */
    #modalSheet.splash-on #modalScroll{
      pointer-events:none;
    }




    /* FOOD å¤–æ¡† */
    .tag-chip{
        display:inline-flex;
        align-items:center;
        padding:4px 4px;
        border-radius:999px;
        border:1px solid rgba(233,225,214,.9);
        background:rgba(255,255,255,.55);
    }
.tag-chip.tag-food{ border-color:rgba(210,138,58,.55); }
.tag-chip.tag-sight{ border-color:rgba(47,143,91,.55); }
.tag-chip.tag-transport{ border-color:rgba(61,110,169,.55); }
.tag-chip.tag-hotel{ border-color:rgba(122,79,168,.55); }
.tag-chip.tag-shop{ border-color:rgba(225,200,32,.55); }

    .modal-title{
      font-family:'Noto Serif TC', serif;
      font-size:1.20rem;
      font-weight:900;
      line-height:1.18;
      margin:10px 0 10px 0;
      letter-spacing:.4px;
    }

    /* åœ°å€/åœè»Šå ´/Mapcode */
    .meta-box{
      border-top:1px solid var(--divider);
      border-bottom:1px solid var(--divider);
      padding:7px 0;
      margin:8px 0 8px;
      gap:10px;               /* å·¦å³é–“è·ç¸® */
      color:var(--ink2);
    }
    .meta-row{
      display:flex;
      align-items:center; 
      gap:10px;
      padding:6px 0;
      font-size:.90rem;
      line-height:1.35;
    }
    .meta-ico{ 
        width:auto; 
        text-align:center; 
        flex:0 0 auto; 
        padding-top:0px;
        font-size:1.05rem;      /* icon ç¨å¾®å° */
    }
    .meta-val{
        font-size:.92rem;       /* âœ… å­—å°ä¸€é» */
        line-height:1.25;
        color:#6f6a62;
        min-width:0;              /* âœ… å…è¨±æ­£å¸¸æ›è¡Œï¼Œä¸æŠŠæŒ‰éˆ•æ“ æ‰ */
        word-break:break-word;
    }

    .mini-btn{
      margin-left:auto;
      align-self:center;   /* âœ… è®“å®ƒè²¼é½Šç¬¬ä¸€è¡Œ */
      border:1px solid rgba(233,225,214,.95);
      justify-self:end;
      background:#fff;
      border-radius:10px;
      padding:5px 9px;
      font-size:.78rem;         /* âœ… æ›´å° */
      cursor:pointer;
      font-weight:900;
      color:#5F5A52;
      flex:0 0 auto;
    }


    .detail{
      font-size:1rem;
      color:#3A352E;
      line-height:1.7;
      white-space:pre-wrap;
      padding-left:1.05em;     /* âœ… æ•´æ®µå¾€å³ä¸€é» */
      text-indent:-1.05em;     /* âœ… ç¬¬ä¸€è¡Œå¾€å·¦æ‹‰å›ä¾†ï¼Œå½¢æˆã€Œå‡¸æ’ã€æ•ˆæœ */
    }

    .pill-row{ 
        margin:6px 0 2px; 
        display:flex; 
        flex-wrap:wrap; 
        gap:6px; 
    }
    .pill{
      display:inline-flex;
      gap:6px; align-items:center;
      padding:5px 8px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(233,225,214,.95);
      font-size:.78rem;
      font-weight:900;
      color:#5F5A52;
    }
    .pill i{ color:#8B8175; font-size:.85em;}

    .block{
      background:rgba(255,255,255,.72);
      border:1px solid rgba(233,225,214,.85);
      padding:14px;
      border-radius:var(--radius-M);
      margin:12px 0;
    }
    .block h4{
      margin:0 0 10px;
      font-size:1rem;
      font-weight:900;
      color:#2B2723;
      font-family:'Noto Serif TC', serif;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .bullet{ margin:0; padding-left:18px; line-height:1.7; color:#444; }

    .menu-recommend{
      background:#FFF8E1;
      border:1px solid #FFECB3;
      padding:15px;
      border-radius:var(--radius-M);
      margin:12px 0;
    }
    .menu-item{
      display:flex; justify-content:space-between; gap:12px;
      padding:6px 0;
      border-bottom:1px dashed #FFE082;
    }
    .menu-item:last-child{ border-bottom:none; }
    .jp-text{ font-weight:900; color:#5D4037; }

    .menuPillRow{ display:flex; flex-direction:column; gap:10px; }

    .menuPill{
      width:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255, 196, 0, .35);
      background:rgba(255,255,255,.75);
      cursor:pointer;
    }

    .menuPill .jp-text{ font-weight:900; color:#5D4037; }
    .menuPill .zh-text{ font-size:.9rem; color:#666; font-weight:800; margin-left:auto; }

    .menuSpeak{
      flex:0 0 auto;
      width:30px; height:30px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(233,225,214,.9);
      background:#fff;
    }

    .menuRecTag{
      flex:0 0 auto;
      font-size:.68rem;
      font-weight:900;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(180,35,24,.10);
      border:1px solid rgba(180,35,24,.25);
      color:rgba(180,35,24,.95);
    }


    .sheet-actions{
      position:sticky;
      bottom:0;
      padding:10px 0 2px;
      background:linear-gradient(to top, #FAF7F2 70%, rgba(250,247,242,0));
    }
    .btn-primary{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      width:100%;
      height:50px;
      border-radius:16px;
      border:1px solid rgba(176,138,91,.55);
      background:#fff;
      font-weight:900;
      text-decoration:none;
      color:#2B2723;
    }

    /* bottom nav */
    .bottom-nav{
      position:fixed; 
      bottom: 0;
      left:50%;
      transform:translateX(-50%);
      width:min(520px, calc(100vw - 40px));

      bottom:max(10px, env(safe-area-inset-bottom));
      padding:10px 0;

      background:rgba(255,255,255,.72);
      backdrop-filter:blur(20px);
      border-radius:24px;
      display:flex;
      justify-content:space-around;
      box-shadow:0 16px 50px rgba(0,0,0,.12);
      z-index:1000;
      border:1px solid rgba(233,225,214,.9); 
      /* background:rgba(255,255,255,.72);
      backdrop-filter:blur(20px);
      border-radius:24px;
      display:flex;
      justify-content:space-around;
      padding:10px 0 calc(10px + env(safe-area-inset-bottom));
      border:1px solid rgba(233,225,214,.9);
      box-shadow:0 16px 50px rgba(0,0,0,.12);
      z-index:1000;
      border:1px solid rgba(233,225,214,.9);
      align-items:flex-end; */
    }
    .nav-item{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;   /* âœ… å…§å®¹è²¼ bar åº• */
      gap:2px;
      font-size:.66rem;
      color:#B9B2AA;
      line-height:1;
    }

    .nav-item i{
      display:block;
      font-size:1.18rem;
      margin-bottom:0;            /* âœ… ä¸è¦å†æŠŠæ–‡å­—å¾€ä¸Šæ¨ */
    }
    .nav-item.active{ color:#2B2723; transform:translateY(-1px); }

    /* boarding */
    .boarding{
      background:rgba(255,255,255,.76);
      border-radius:var(--radius-L);
      box-shadow:var(--shadow-soft);
      overflow:hidden; margin-bottom:18px;
      border:1px solid rgba(233,225,214,.9);
      backdrop-filter: blur(10px);
    }
    .boarding-top{
      padding:18px 18px 14px;
      background:linear-gradient(135deg, rgba(176,138,91,.16), rgba(43,39,35,.06));
    }
    .boarding-top .row{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .boarding-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,.75);
      font-weight:900; font-size:.85rem;
      border:1px solid rgba(233,225,214,.9);
    }
    .boarding-mid{
      padding:14px 18px;
      display:flex; justify-content:space-between; align-items:center;
      border-top:1px dashed rgba(233,225,214,.95);
    }
    .code{
      font-family:'Noto Serif TC', serif;
      font-size:2.0rem;
      font-weight:900;
      color:#7D5B34;
      letter-spacing:1px;
    }
    .t{ color:var(--ink2); font-size:.9rem; margin-top:2px; font-weight:800; }
    .boarding-bottom{
      padding:14px 18px;
      border-top:1px solid rgba(233,225,214,.7);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color:var(--ink2); font-size:.9rem;
      font-weight:800;
    }
    .wx-head{
        display:flex;
        justify-content:space-between;
        align-items:baseline;
        margin-bottom:14px;
    }

    .wx-city{
        font-family:'Noto Serif TC', serif;
        font-size:1.25rem;
        font-weight:900;
        color:var(--primary);
    }

    .wx-label{
        font-size:.82rem;
        font-weight:900;
        color:var(--ink2);
        display:flex;
        align-items:center;
        gap:8px;
    }

    .link-grid{
        display:grid;
        grid-template-columns:1fr 1fr;
        gap:10px;
        margin-top:10px;
    }



    /* ===== Route strip (for drive/walk/train/flight/boat) ===== */
    .route-strip{
        display:flex;
        gap:14px;
        align-items:center;
        padding:10px 12px;        /* æ›´ç´°é•· */
        border-radius:16px;
        background:#F2F2F7;
        border:1px solid rgba(0,0,0,.04);
        box-shadow:0 6px 18px rgba(0,0,0,.06);
        width:100%;               /* âœ… æ’æ»¿ */
        margin:0;                 /* âœ… ä¸è¦è‡ªå·±ç¸®æ’ */
    }
    /* æƒ³è®“æ•´å¼µæ›´ã€Œç´°é•·ã€ä¸€é»å°±æŠŠ padding é™ä½ */

    .route-mins{
        flex:0 0 auto;
        font-family:'Roboto Mono', monospace;
        font-size:.65rem;         /* âœ… ç¸®å° */
        font-weight:900;
        color:#444;
        background:rgba(255,255,255,0.7);
        border-radius:999px;
        padding:5px 8px;
        white-space:nowrap;
    }

    /* è®“ route strip å…§å®¹å·¦å³åˆ†ä½ˆæ›´æ¼‚äº® */
    .route-main{
        flex: 1;
        min-width: 0;
    }

        /* icon å°ºå¯¸ï¼ˆå¯å¾®èª¿ï¼‰ */
    .route-ico{
        width:38px;
        height:38px;
        border-radius:14px;
        display:flex;
        align-items:center;
        justify-content:center;
        background:rgba(255,255,255,0.55);
        flex:0 0 auto;
    }
    .route-ico i{ font-size:16px; color:var(--primary); }


    .route-title{
      font-weight:900;
      font-size:.95rem;
      letter-spacing:-.2px;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .route-sub{
      margin-top:4px;
      color:var(--text-sec);
      font-weight:700;
      font-size:.9rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .routeRow{
        display:flex;
        align-items:center;
        gap:12px;
        padding:10px 12px;
        border-radius:14px;
        max-width:100%;
        width:100%;
        overflow:hidden;            /* é˜²æ­¢å…§éƒ¨æ±è¥¿æ’ç ´ */
    }

    .routeIcon{
        flex:0 0 36px;
        width:36px; height:36px;
        border-radius:12px;
        display:flex; align-items:center; justify-content:center;
    }

    .routeMain{
        flex:1 1 auto;
        min-width:0;                /* âœ… è¶…é‡è¦ï¼šå…è¨±ä¸­é–“æ¬„ä½ç¸® */
    }

    .routeTitle{
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;     /* âœ… é•·åœ°åä¸æ’ç ´ */
    }

    .routeDuration{
        flex:0 0 auto;
        margin-left:auto;           /* âœ… æ¨åˆ°æœ€å³ */
        white-space:nowrap;
        padding:6px 10px;
        border-radius:999px;
    }



    /* duration / stay pill */
    .stay-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top:12px;
      background:#ECECF0;
      color:#333;
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:.60rem;
    }
    .stay-pill i{ color:#8E8E93; }




    /* å»ºè­°åŠ ä¿éšªï¼šç æ‰æ°´å¹³ overflow */
    html, body{ overflow-x:hidden; }
    /* âœ… route ç›´æ¥åƒæ»¿æ•´å€‹å®¹å™¨å¯¬åº¦ */
    .timeline-item.route-item{
        display:block;         /* route ä¸ç”¨å…©æ¬„ grid */
        cursor: pointer;
        margin-bottom:18px;
    }

    /* route å¡ç‰‡æœ¬é«” */
    .route-item .route-strip{
        width:100%;
        max-width:100%;
        display:flex;
        align-items:center;
        gap:12px;
        padding:12px 16px;
        border-radius:16px;
        background:#EEF2FF;
        overflow:hidden;
    }
    /* å·¦å´ï¼šå°æ™‚é–“ + icon
    .route-left{
        flex:0 0 auto;
        display:flex;
        flex-direction:column;
        align-items:center;
        gap:6px;
    }

    .route-time-mini{
        font-size:12px;
        font-weight:800;
        color:#6B7280;
        line-height:1;
    } */



    /* ä¸­é–“æ¨™é¡Œï¼šå¯ç¸® + ... */
    .route-main{ flex:1 1 auto; min-width:0; }
    /* æ–‡å­—å€ï¼šä¸Šé¢æ™‚é–“ï¼Œä¸‹é¢æ¨™é¡Œ */
    .route-time-top{
        font-size:12px;
        font-weight:800;
        color:#6B7280;
        line-height:1.1;
        margin-bottom:4px;
    }





    /* ===== Mobile layout guard ===== */
    .page, .app-header{
      max-width: 520px;
      margin-left:auto;
      margin-right:auto;
    }

    /* å³å´ï¼šæ™‚é–“ + å°èˆªæŒ‰éˆ•ï¼ˆæŠŠ 15min ç§»åˆ°é€™è£¡ï¼‰ */
    .route-cta{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      justify-content:center;
      gap:10px;
      flex:0 0 auto;
    }

    .route-time{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#ECECF0;
      font-weight:900;
      color:#333;
      white-space:nowrap;
    }

    .route-time i{ color:#8E8E93; }


    .route-card{
      margin:10px 0 14px;
      background:rgba(255,255,255,.72);
      border:1px solid rgba(233,225,214,.9);
      border-radius:24px;
      box-shadow:0 10px 26px rgba(0,0,0,.08);
      overflow:hidden;
    }

    .route-thumb{
      position:relative;
      aspect-ratio: 16 / 9;
      background:rgba(0,0,0,.06);
    }
    .route-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .route-thumb{
      position:relative;
      aspect-ratio:16/9;
      overflow:hidden;
      border-radius:0; /* ä½ å¡ç‰‡å¤–å±¤å·²ç¶“ rounded */
    }
    #routeMiniMap{
      width:100%;
      height:100%;
    }
    .route-thumb .leaflet-control-container{ display:none; } /* éš±è—æ”¾å¤§ç¸®å°æŒ‰éˆ•ï¼Œåƒç¸®åœ– */


    .route-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px 10px;
      gap:12px;
    }
    .route-title{
      font-weight:900;
      line-height:1.2;
    }
    .route-sub{
      margin-top:4px;
      font-size:.86rem;
      color:var(--ink2);
      font-weight:700;
    }

    .route-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(176,138,91,.35);
      background:rgba(255,255,255,.85);
      font-weight:900;
      color:#6E4B2A;
      white-space:nowrap;
    }
    .route-btn i{
      font-size:14px;
      transform: translateY(-.5px);
    }

    /* mini-map pins */
    .rm-pin{
      border-radius:999px;
      background:rgba(255,255,255,.92);
      border:2px solid rgba(60,110,210,.80);
      box-shadow:0 10px 22px rgba(0,0,0,.16);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .rm-pin span{
      font-family:'Roboto Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-weight:800;
      font-size:.74rem;
      color:rgba(40,70,150,.95);
    }
    .rm-pin.rm-start{
      border-color:rgba(34,139,34,.85);
    }
    .rm-pin.rm-start span{ color:rgba(22,110,22,.95); }
    .rm-pin.rm-end{
      border-color:rgba(180,35,24,.80);
    }
    .rm-pin.rm-end span{ color:rgba(180,35,24,.92); }
    .rm-pin.rm-stop{
      border-color:rgba(60,110,210,.78);
    }

    .menuRow{ display:flex; flex-wrap:wrap; gap:10px; }

    .menuPill{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(233,225,214,.95);
      background:#fff;
      font-weight:800;
      font-size:.9rem;
      cursor:pointer;
    }
    .menuPill.is-rec{
      border-color: rgba(176,138,91,.55);
      box-shadow: 0 10px 20px rgba(0,0,0,.06);
    }
    .menuSpeak{
      display:inline-flex; align-items:center; justify-content:center;
      width:28px; height:28px;
      border-radius:999px;
      border:1px solid rgba(233,225,214,.95);
      background:rgba(255,255,255,.9);
      color:#666;
    }
    .menuSpeak i{ font-size:14px; }

    .menuCardDesc{
      margin-top:10px;
      color:#4B5563;
      font-size:.95rem;
      line-height:1.55;
    }


    /* ===== menu å­—å¡ ===== */
    .menuCard{
      position:absolute;
      left:12px; right:12px;
      bottom:12px;
      border-radius:18px;
      border:1px solid rgba(233,225,214,.95);
      background:rgba(255,255,255,.96);
      box-shadow:0 18px 40px rgba(0,0,0,.18);
      overflow:hidden;
      z-index:30;
    }
    .menuCardClose{
      position:absolute;
      right:10px; top:8px;
      width:30px; height:30px;
      border-radius:999px;
      border:1px solid rgba(233,225,214,.95);
      background:#fff;
      font-size:18px; font-weight:900; line-height:1;
      display:grid; place-items:center;
    }
    .menuCardImg{
      width:100%;
      height:160px;
      object-fit:cover;
      display:block;
    }
    .menuCardBody{ padding:12px 14px 14px; }
    .menuCardJp{ font-weight:900; margin-bottom:4px; }
    .menuCardZh{ color:#666; font-weight:800; margin-bottom:8px; }
    .menuCardNote{ color:#444; line-height:1.45; }

    /* âœ… é»ƒè‰²è¡¨æ ¼å¤–æ¡†ï¼ˆå›åˆ°ä½ ç¬¬ä¸€å¼µé‚£ç¨®æ„Ÿè¦ºï¼‰ */
    .menu-box{
      background: rgba(255, 242, 210, .55);
      border: 1px solid rgba(210, 184, 120, .55);
      border-radius: 16px;
      padding: 14px 14px 10px;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
    }
    .menu-box-head{
      display:flex; align-items:center; gap:8px;
      font-weight: 900;
      color: #5B4A2F;
      margin-bottom: 10px;
    }

    .menu-table{ display:flex; flex-direction:column; gap:0; }

    .menu-row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      padding: 12px 2px;
      background: transparent;;
      border: none;
      border-radius: 0;
      border-bottom:1px solid rgba(0,0,0,.08);
    }

    /* æœ€å¾Œä¸€åˆ—ä¸è¦åº•ç·š */
    .menu-row:last-child{
      border-bottom:none;
    }

    .menu-jp{ display:flex; align-items:center; gap:8px; font-size:.9rem; font-weight:900; color:#4B2E2A; }
    .menu-zh{ text-align:right; color:#6B7280; font-size:.9rem; font-weight:800; }

    /* âœ… å°å–‡å­ï¼ˆæ”¾æ—¥æ–‡å‰é¢ï¼‰ */
    .menuSpeak{
      width:28px; height:28px;
      border-radius:999px;
      border:1px solid rgba(210,184,120,.65);
      background:rgba(255,255,255,.75);
      display:inline-flex; align-items:center; justify-content:center;
      color:#6B5B3E;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
    }
    .menuSpeak:active{ transform:scale(.96); }

    /* âœ… åªæœ‰æ¨è–¦çš„æ‰åƒã€Œå¯é»ã€ */
    .menuPill{ cursor:pointer; }
    .menuPill:active{ transform:scale(.985); }






  
/* === PATCH: stronger highlight + reserved badge + route meta === */
.timeline-item.is-highlight .tl-content{ box-shadow:0 18px 40px rgba(0,0,0,.09), 0 0 0 5px rgba(214,158,76,.22) inset; }
.timeline-item.is-highlight:before{ inset:-22px -22px; filter: blur(10px); opacity:.95; }
/* .reserve-badge{ font-size:.62rem; padding:3px 7px; border-radius:7px; border:1.6px solid rgba(219, 64, 56, .9); color:rgb(219,64,56); transform: rotate(-10deg); } */
.route-meta{ margin-top:4px; font-size:.86rem; color:var(--ink2); font-weight:700; }

    /* ===== Timeline edit toolbar ===== */
    .timeline-toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin: 10px 2px 14px;
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.72);
      border:1px solid rgba(233,225,214,.9);
      box-shadow:0 10px 22px rgba(0,0,0,.06);
    }
    .tl-tool-left{ display:flex; gap:6px; align-items:center; }
    .tl-tool-right{ display:flex; gap:6px; align-items:center; }
    .tl-btn{
      appearance:none;
      border:none;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:.9rem;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      color:var(--ink1);
      cursor:pointer;
    }
    .tl-btn.primary{ background: var(--primary); color:#fff; border-color: rgba(0,0,0,.0); }
    .tl-btn.ghost{ background:transparent; }
    .tl-btn:active{ transform: translateY(1px); }
    .tl-edit-hint{ font-size:.85rem; color:var(--ink2); font-weight:800; }
    .edit-badge{
      position:absolute;
      right:10px; top:10px;
      font-size:.8rem;
      font-weight:900;
      color: rgba(60,60,60,.65);
    }
    .edit-row{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:10px;
    }
    .time-input{
      width:110px;
      padding:9px 10px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.9);
      font-weight:900;
      color: var(--ink1);
      font-family:'Roboto Mono', monospace;
    }
    .mini-btn{
      padding:9px 10px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      color: var(--ink1);
      white-space:nowrap;
    }
    .mini-btn.danger{ background: rgba(255,64,64,.10); border-color: rgba(255,64,64,.25); color:#B42318; }
    /* .timeline-item.is-dragging .tl-content{ box-shadow:0 22px 44px rgba(0,0,0,.14); transform: rotate(-.35deg) scale(1.01); } */
    /* âœ… æ–°å¢ï¼šè®“è·¯å¾‘ç‰©ä»¶åœ¨æ‹–æ›³æ™‚ä¹Ÿæœ‰è¦–è¦ºåé¥‹ */
    .timeline-item.is-dragging .tl-content,
    .timeline-item.is-dragging .route-strip {
      box-shadow: 0 22px 50px rgba(0,0,0,0.22);
      transform: rotate(-0.5deg) scale(1.02);
      z-index: 100;
      opacity: 0.9;
    }
    /* âœ… æ–°å¢ï¼šæ§åˆ¶ç·¨è¼¯åˆ—çš„é¡¯ç¤ºèˆ‡éš±è—ï¼Œé¿å… DOM é‡æ§‹å°è‡´ä½ç§» */
    .edit-row { 
      display: none; 
    }
    
    /* ç•¶çˆ¶å®¹å™¨è™•æ–¼ç·¨è¼¯æ¨¡å¼æ™‚æ‰é¡¯ç¤º */
    .edit-mode-active .edit-row { 
      display: flex !important; 
    }
    
    /* ç·¨è¼¯æ¨¡å¼æ™‚å¾®èª¿é–“è·ï¼Œç¢ºä¿è¦–è¦ºç©©å®š */
    .edit-mode-active .tl-content {
      padding-bottom: 14px;
    }
</style>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>

<body>
  <header class="app-header">
    <h1 id="hdrTitle"></h1>
    <div class="hdr-kana" id="hdrKana"></div>
    <div class="hdr-subrow">
      <p id="hdrSub"></p>
      <span class="year-pill" id="hdrYear">2026</span>
    </div>
  </header>

  <!-- è¡Œå‰ -->
  <div id="page-pre" class="page">
    <div class="card">
      <div class="section-title"><i class="fas fa-bullhorn"></i> å…¨å“¡é‡è¦å¾…è¾¦</div>
      <ul id="globalTodoList" style="list-style:none; padding:0; margin:0;"></ul>
    </div>

    <div class="card">
      <div class="section-title"><i class="fas fa-clipboard-user"></i> å€‹äººæ¸…å–®</div>
      <div class="user-tabs" id="userSwitch"></div>

      <h4 style="margin:10px 0 10px; color:var(--ink2); font-weight:900;">æ—…è¡Œå‰</h4>
      <div class="checklist-grid" id="list-pretrip"></div>

      <h4 style="margin:10px 0 10px; color:var(--ink2); font-weight:900;">éš¨èº«è¡Œæ</h4>
      <div class="checklist-grid" id="list-carry"></div>

      <h4 style="margin:20px 0 10px; color:var(--ink2); font-weight:900;">è¨—é‹è¡Œæ</h4>
      <div class="checklist-grid" id="list-check"></div>
    </div>
  </div>

  <!-- è¡Œç¨‹ -->
  <div id="page-itinerary" class="page active">
    <div class="date-scroller" id="dayScroller"></div>
      <!-- âœ… Day photos slideshowï¼ˆç¨ç«‹ blockï¼Œæ”¾åœ¨å¤©æ°£é å ±ä¸Šæ–¹ï¼‰ -->
    <div id="dayHero" class="day-hero"></div>

    <div class="card" style="margin-top: 18px;">
      <div class="wx-head">
        <div id="weatherLoc" class="wx-city"></div>
        <div class="wx-label"><i class="fas fa-cloud-sun"></i> 24H é å ±</div>
      </div>
      <div class="weather-strip" id="weatherStrip"></div>
      <div style="text-align:right; font-size:0.86rem; color:var(--ink2); font-weight:800;">
        ä»Šæ™šä½å®¿ï¼š<strong id="stayHotelName" style="color:var(--primary);"></strong>
      </div>
    </div>

    <div id="dayRouteCard"></div>

    <div id="timelineToolbar" class="timeline-toolbar"></div>
    <div id="timelineList" style="padding-bottom: 20px;"></div>
  </div>

  <!-- è³‡è¨Š -->
  <div id="page-info" class="page">
    <div class="section-title"><i class="fas fa-plane-departure"></i> èˆªç­è³‡è¨Š</div>
    <div id="flightBoard"></div>

    <div class="section-title" style="margin-top:8px;"><i class="fas fa-hotel"></i> ä½å®¿è³‡è¨Š</div>
    <div id="hotelList"></div>
  </div>

  <!-- è¨˜å¸³ -->
  <div id="page-money" class="page">
    <div class="card">
      <div class="section-title">æ–°å¢æ”¯å‡º</div>
      <div class="seg" id="currencySwitch" style="margin-bottom: 12px;">
        <div class="seg-btn active" data-curr="JPY" onclick="setCurrency('JPY')">æ—¥å¹£ (Â¥)</div>
        <div class="seg-btn" data-curr="TWD" onclick="setCurrency('TWD')">å°å¹£ ($)</div>
      </div>
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <input type="text" id="exName" placeholder="é …ç›® (ä¾‹: æ™šé¤)" style="padding:12px; border:1px solid rgba(233,225,214,.9); border-radius:14px; flex:1; background:rgba(255,255,255,.8);">
        <input type="number" id="exCost" placeholder="é‡‘é¡" style="padding:12px; border:1px solid rgba(233,225,214,.9); border-radius:14px; width:110px; background:rgba(255,255,255,.8);">
      </div>
      <div class="user-tabs" id="payerSwitch" style="background:rgba(233,225,214,.9); margin-bottom:15px;"></div>

      <!-- é¡å‹ï¼šè¡Œä¸­ / é ä»˜ -->
      <div class="seg" id="expTypeSwitch" aria-label="expense type">
        <div class="seg-btn active" data-type="trip" onclick="setExpenseType('trip')">è¡Œä¸­æ”¯å‡º</div>
        <div class="seg-btn" data-type="prepaid" onclick="setExpenseType('prepaid')">é ä»˜è²»ç”¨</div>
      </div>

      <!-- åƒèˆ‡è€…ï¼šå¯å¤šé¸ï¼ˆé è¨­å…¨é¸ï¼‰ -->
      <div style="font-weight:900; color:var(--ink2); font-size:.9rem; margin-top:2px;">åˆ†æ”¤æˆå“¡</div>
      <div class="chip-row" id="partSwitch"></div>

      <button class="btn" onclick="addExpense()">åŠ å…¥ç´€éŒ„</button>
    </div>

    <div class="card">
      <div class="section-title">å°è¨˜</div>
      <div id="expenseSummary"></div>
    </div>

    <div class="card">
      <div class="section-title">çµç®— (è² æ•¸ä»£è¡¨æ¬ æ¬¾)</div>
      <div id="debtList"></div>
    </div>

    <div class="card">
      <div class="section-title">è©³ç´°ç´€éŒ„</div>
      <div id="expenseList"></div>
    </div>
  </div>

  <!-- modal -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal()"></div>
  <div class="modal-sheet" id="modalSheet" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div class="modal-drag-handle"></div>
      <button class="modal-x" onclick="closeModal()" aria-label="close">Ã—</button>
    </div>
    <div class="sheet-splash" id="sheetSplash" aria-hidden="true">
      <div class="splash-frame" role="img" aria-label="spotlight">
        <div class="shutter-flash" aria-hidden="true"></div>
        <div class="splash-grid one" id="sheetSplashGrid">
          <img class="splash-img" id="sheetSplashImg1" alt="" />
          <img class="splash-img" id="sheetSplashImg2" alt="" />
        </div>
      </div>
    </div>
    <div class="modal-scroll" id="modalScroll">
        <div id="modalSticky"></div>
        <div id="modalBody"></div>
    </div>
  </div>

  <div id="menuCard" class="menuCard" hidden>
    <button class="menuCardClose" type="button">Ã—</button>
    <img class="menuCardImg" alt="" />
    <div class="menuCardBody">
      <div class="menuCardJp"></div>
      <div class="menuCardZh"></div>
      <div class="menuCardNote"></div>
    </div>
  </div>



  <nav class="bottom-nav">
    <div class="nav-item active" onclick="nav('itinerary', this)"><i class="fas fa-map-location-dot"></i> è¡Œç¨‹</div>
    <div class="nav-item" onclick="nav('info', this)"><i class="fas fa-passport"></i> è³‡è¨Š</div>
    <div class="nav-item" onclick="nav('money', this)"><i class="fas fa-yen-sign"></i> è¨˜å¸³</div>
    <div class="nav-item" onclick="nav('pre', this)"><i class="fas fa-list-check"></i> è¡Œå‰</div>
  </nav>

<script>
/*    ====== Globals (JSON é©…å‹•) ====== */
  let CONFIG, CHECKLISTS, TODOS, FLIGHTS, HOTELS, ITINERARY;

  let users = [];
  let curUser = 'L';
  let curPayer = 'L';

/*    timeline (æ”¯æ´æœ¬æ©Ÿå³æ™‚ç·¨è¼¯ï¼šæ‹–æ›³æ’åº / æ”¹æ™‚é–“ / åˆªé™¤) */
/*    âœ… å…ˆå®£å‘Šç·¨è¼¯æ¨¡å¼ç‹€æ…‹ï¼Œé¿å… TDZ é€ æˆè¡Œç¨‹æ¸²æŸ“å¤±æ•— */
  let __tlEditMode = false;
  let __tlSortable = null;
  let __editHistory = [];

  let checklistData = { carry: [], check: [] };
  let hotels = [];
  let itineraryIndex = [];
  let dayCache = {};
  let currentDayData = null;
  let currentDayIdx = 0;
  let __heroTimer = null;
  let __sheetSplashTimer = null;

  function pickSheetSplashSrcs(item){
/*
     æ”¯æ´ï¼šå­—ä¸² or é™£åˆ—
     å¯ç”¨æ¬„ä½ï¼šsplash / splash_img / cover / cover_img / image / img
     ä¹Ÿæ”¯æ´ç¬¬äºŒå¼µï¼šsplash2 / splash_img2 / cover2 / image2 / img2
*/
    const main =
      item?.splash || item?.splash_img ||
      item?.cover  || item?.cover_img  ||
      item?.image  || item?.img || '';

    const second =
      item?.splash2 || item?.splash_img2 ||
      item?.cover2  || item?.cover_img2  ||
      item?.image2  || item?.img2 || '';

/*      è‹¥ main æœ¬èº«å°±æ˜¯é™£åˆ—ï¼š["a","b"] */
    let list = [];
    if(Array.isArray(main)){
      list = main;
    }else{
      list = [main, second].filter(Boolean);
    }

/*      æ­£è¦åŒ– & æœ€å¤šå…©å¼µ */
    return list.map(s => normalizeAssetUrl(s)).filter(Boolean).slice(0,2);
  }




  function hideSheetSplash(){
    const ov = document.getElementById('sheetSplash');
    const sheet = document.getElementById('modalSheet');
    if(!ov || !sheet) return;

    ov.classList.remove('active');
    sheet.classList.remove('splash-on');
    const img1 = document.getElementById('sheetSplashImg1');
    const img2 = document.getElementById('sheetSplashImg2');
    if(img1) img1.removeAttribute('src');
    if(img2) img2.removeAttribute('src');

  }

  function showSheetSplash(item){
    const srcs = pickSheetSplashSrcs(item);
    if(!srcs.length) return;

    const ov    = document.getElementById('sheetSplash');
    const sheet = document.getElementById('modalSheet');
    const grid  = document.getElementById('sheetSplashGrid');
    const img1  = document.getElementById('sheetSplashImg1');
    const img2  = document.getElementById('sheetSplashImg2');
    if(!ov || !sheet || !grid || !img1 || !img2) return;

/*      reset timer */
    if(__sheetSplashTimer) clearTimeout(__sheetSplashTimer);

/*      å…ˆé‡ç½® */
    img1.style.display = 'none';
    img2.style.display = 'none';
    img1.removeAttribute('src');
    img2.removeAttribute('src');

/*      å¥— 1/2 å¼µæ¨¡å¼ class */
    grid.classList.remove('one','two');
    grid.classList.add(srcs.length >= 2 ? 'two' : 'one');

/*      å¡åœ– */
    img1.src = srcs[0];
    img1.style.display = 'block';

    if(srcs[1]){
      img2.src = srcs[1];
      img2.style.display = 'block';
    }

    ov.classList.add('active');
    sheet.classList.add('splash-on');
/*      âœ… shutter flash (120ms) */
    const frame = document.getElementById('sheetSplashFrame');
    if(frame){
      frame.classList.remove('flash');       /* reset */
      requestAnimationFrame(()=> frame.classList.add('flash'));
    }


/*      é»ä¸€ä¸‹æå‰è·³é */
    ov.onclick = () => {
      if(__sheetSplashTimer) clearTimeout(__sheetSplashTimer);
      hideSheetSplash();
    };

    __sheetSplashTimer = setTimeout(()=> hideSheetSplash(), 5000);
  }





/*    ====== Load Data ====== */

/*    Sync data from Google sheet */
  async function syncFromCloud() {
    try {
/*        ğŸ’¡ ç™¼é€è«‹æ±‚ï¼ŒåŠ å…¥ _t é˜²æ­¢ç€è¦½å™¨å¿«å– */
      const resp = await fetch(`${G_API_URL}?token=${G_TOKEN}&_t=${Date.now()}`);

/*        ğŸ’¡ BIOS Debug: æª¢æŸ¥å›æ‡‰çš„ URL æ˜¯å¦åŒ…å« "ServiceLogin" */
      if (resp.url.includes("ServiceLogin")) {
        console.error("ğŸš¨ æ¬Šé™éŒ¯èª¤ï¼šGAS è·³è½‰åˆ°äº†ç™»å…¥é é¢ã€‚è«‹å°‡ GAS éƒ¨ç½²è¨­å®šç‚ºã€ä»»ä½•äºº (Anyone)ã€ã€‚");
        return;
      }

/*        1. å…ˆè®€å–ç‚ºæ–‡å­— */
      const text = await resp.text();
      console.log("é›²ç«¯å›å‚³åŸå§‹å­—ä¸²:", text); /*  æª¢æŸ¥é€™æ˜¯å¦ç‚º JSON */

/*        2. æª¢æŸ¥æ¬Šé™ */
      if (text === "Unauthorized") {
        setCookie("trip_auth_token", "", -1);  /* æ¸…é™¤ç„¡æ•ˆçš„ Cookie */
        alert("è¨ªå•æš—è™ŸéŒ¯èª¤æˆ–å·²éæœŸï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚");
        location.reload(); 
        return;
      }
  
/*
       3. ğŸ’¡ é—œéµä¿®å¾©ï¼šæ”¹ç”¨ JSON.parse() è§£æå·²ç¶“è®€å–çš„ text å­—ä¸²
       ä¸è¦å†ç”¨ await resp.json()
*/
      const cloudData = JSON.parse(text);

/*        4-1. åŒæ­¥å¸³æœ¬è³‡æ–™ */
      if (cloudData.expenses) {
        expenses = cloudData.expenses; 
        localStorage.setItem('expenses', JSON.stringify(expenses));
        if (typeof renderExpenseUI === 'function') renderExpenseUI(); 
      }
  
/*        4-2. åŒæ­¥ Checkbox èˆ‡ å…¨å“¡å¾…è¾¦ (GLOBAL) */
      if (cloudData.checklists) {
        const userCheckMap = {};
        const globalTodos = {}; 
  
        cloudData.checklists.forEach(item => {
          if (item.user === "GLOBAL") {
            if (item.checked) globalTodos[item.item] = true;
          } else {
            if (!userCheckMap[item.user]) userCheckMap[item.user] = {};
            if (item.checked) userCheckMap[item.user][item.item] = true;
          }
        });
  
        localStorage.setItem('global_todos', JSON.stringify(globalTodos));
        Object.keys(userCheckMap).forEach(user => {
          localStorage.setItem('check_' + user, JSON.stringify(userCheckMap[user]));
        });
        
/*          é‡æ–°æ¸²æŸ“ç•«é¢ */
        if (typeof renderGlobalTodos === 'function') renderGlobalTodos();
        if (document.getElementById('page-pre').classList.contains('active')) {
          if (typeof renderChecklists === 'function') renderChecklists();
        }
      }
  
/*
      // 4-3. ğŸ’¡ æ–°å¢ï¼šåŒæ­¥è¡Œç¨‹ç•°å‹• (Itinerary Edits)
       if (cloudData.itineraryEdits) {
         const currentFile = itineraryIndex[currentDayIdx]?.file;
         
         Object.keys(cloudData.itineraryEdits).forEach(file => {
           const key = `day_edits_${file}`;
           const editData = cloudData.itineraryEdits[file];
           
           // æ›´æ–° LocalStorage ä»¥ä¾›é›¢ç·šä½¿ç”¨
           localStorage.setItem(key, JSON.stringify(editData));
           
           // å¦‚æœé›²ç«¯ç•°å‹•çš„æ˜¯ã€Œç›®å‰æ­£åœ¨çœ‹ã€çš„é€™ä¸€å¤©ï¼Œç«‹å³æ›´æ–°å¿«å–ä¸¦é‡ç¹ª
           if (file === currentFile) {
             dayCache[currentDayIdx] = { ...dayCache[currentDayIdx], items: editData.items };
             currentDayData = dayCache[currentDayIdx];
             
             // ç¢ºä¿åœ¨è¡Œç¨‹é é¢æ™‚æ‰é‡ç¹ª
             if (document.getElementById('page-itinerary').classList.contains('active')) {
               renderTimelineList(currentDayData);
               if (typeof enableTimelineSortable === 'function') enableTimelineSortable();
             }
           }
         });
       }
*/
/*         âœ… ä¿®æ­£è¡Œç¨‹å¡æ¶ˆå¤±å¾Œçš„ syncFromCloud ç‰‡æ®µ */
      if (cloudData.itineraryEdits) {
        const currentFile = itineraryIndex[currentDayIdx]?.file;
        
        Object.keys(cloudData.itineraryEdits).forEach(file => {
          const key = `day_edits_${file}`;
          const editData = cloudData.itineraryEdits[file];
          
/*            ğŸ’¡ é—œéµä¿®æ­£ï¼šåˆ¤æ–· editData æ˜¯é™£åˆ—é‚„æ˜¯ç‰©ä»¶ */
          const itemsArray = Array.isArray(editData) ? editData : (editData.items || []);
          
/*            æ›´æ–° LocalStorage èˆ‡ å¿«å– */
          localStorage.setItem(key, JSON.stringify({ items: itemsArray }));
          
/*
          // if (file === currentFile) {
          //   // ç¢ºä¿å°‡å¿«å–ä¸­çš„ items è¨­ç‚ºæ­£ç¢ºçš„é™£åˆ—
          //   dayCache[currentDayIdx] = { ...dayCache[currentDayIdx], items: itemsArray };
          //   currentDayData = dayCache[currentDayIdx];
            
          //   if (document.getElementById('page-itinerary').classList.contains('active')) {
          //     renderTimelineList(currentDayData);
          //     if (typeof enableTimelineSortable === 'function') enableTimelineSortable();
          //   }
          // }
*/
          if (cloudData.itineraryEdits) {
            Object.keys(cloudData.itineraryEdits).forEach(file => {
              const key = `day_edits_${file}`;
              const editData = cloudData.itineraryEdits[file];
              const itemsArray = Array.isArray(editData) ? editData : (editData.items || []);
              localStorage.setItem(key, JSON.stringify({ items: itemsArray }));
            });

/*              å¦‚æœç›®å‰å°±åœ¨è¡Œç¨‹é ï¼Œé‡ç¹ªç•¶å¤©ï¼ˆç”¨ applyDayEdits å¥—ç”¨æœ€æ–° localStorageï¼‰ */
            if (document.getElementById('page-itinerary').classList.contains('active')) {
              const meta = itineraryIndex[currentDayIdx];
              if (dayCache[currentDayIdx]) {
                currentDayData = applyDayEdits(dayCache[currentDayIdx], meta);
                renderTimelineList(currentDayData);
                if (__tlEditMode) enableTimelineSortable();
              }
            }
          }
        });
      }
  
      console.log("é›²ç«¯è³‡æ–™åŒæ­¥å®Œæˆ");
    } catch (e) {
      console.error("åŒæ­¥å¤±æ•—:", e);
    }
  }

/*    å¯«å…¥è³‡æ–™æ™‚åŠ å…¥ token æ¬„ä½ */
  function cloudPost(action, data) {
    fetch(G_API_URL, {
      method: "POST",
      mode: "no-cors", 
      body: JSON.stringify({
        token: G_TOKEN,  /* ğŸ”‘ åŠ å…¥é©—è­‰æš—è™Ÿ */
        action: action,
        data: data
      })
    });
  }

  async function loadAllData(){ 
    [CONFIG, CHECKLISTS, TODOS, FLIGHTS, HOTELS, ITINERARY] = await Promise.all([
      fetch("./data/config.json").then(r=>r.json()),
      fetch("./data/checklists.json").then(r=>r.json()),
      fetch("./data/todos.json").then(r=>r.json()),
      fetch("./data/flights.json").then(r=>r.json()),
      fetch("./data/hotels.json").then(r=>r.json()),
      fetch("./data/itinerary.index.json").then(r=>r.json()),
    ]);

    users = CONFIG?.members || ['L','K','R','Y','J'];
    curUser = users[0] || 'L';
    curPayer = users[0] || 'L';

    checklistData = CHECKLISTS || { carry: [], check: [] };
    hotels = HOTELS || [];
    itineraryIndex = ITINERARY || [];

    const title = (CONFIG?.trip_title || 'å››åœ‹å·¡ç¦®');

/*      2) subtitle ä¸é¡¯ç¤º L,K,R,Y,J */
    const sub = `${CONFIG?.days || 9}å¤©${CONFIG?.nights || 8}å¤œ${CONFIG?.mode ? CONFIG.mode : ''}`;
    
    document.getElementById('hdrTitle').innerText = title;
    document.getElementById('hdrKana').innerText = 'ã¨ãã—ã¾ã‘ã‚“ã€ã‹ãŒã‚ã‘ã‚“ã€ãˆã²ã‚ã‘ã‚“ã€ã“ã†ã¡ã‘ã‚“';
    document.getElementById('hdrSub').innerText = sub;
    document.getElementById('hdrYear').innerText = '2026';
    


    document.getElementById('hdrSub').innerText = sub;
  }

  document.addEventListener('DOMContentLoaded', async () => {
/*       ğŸ’¡ è‹¥ç„¡ Token å‰‡æç¤ºè¼¸å…¥ï¼ˆåƒ…éœ€è¼¸å…¥ç¬¬ä¸€æ¬¡ï¼Œå¾ŒçºŒæœƒå­˜æ–¼ Cookieï¼‰ */
     if (!G_TOKEN) {
       const inputToken = prompt("è«‹è¼¸å…¥è¨ªå•æš—è™Ÿ (Token)ï¼š");
       if (inputToken) {
         G_TOKEN = inputToken;
         setCookie("trip_auth_token", G_TOKEN, 30);  /* é è¨­å­˜å„² 30 å¤© */
         location.reload(); 
         return;
       } else {
         alert("æœªè¼¸å…¥æš—è™Ÿï¼ŒåŒæ­¥åŠŸèƒ½å°‡ç„¡æ³•æ­£å¸¸é‹ä½œã€‚");
       }
    }
    await loadAllData();
    await syncFromCloud();
/*      --- æ–°å¢ï¼šæ‰‹å‹•åŒæ­¥åŠŸèƒ½ --- */
    const titleEl = document.getElementById('hdrTitle');
    if (titleEl) {
      titleEl.style.cursor = 'pointer';  /* è®“æ»‘é¼ ç§»ä¸Šå»é¡¯ç¤ºæ‰‹æŒ‡åœ–ç¤º */
      titleEl.title = 'é»æ“Šå¼·åˆ¶åŒæ­¥é›²ç«¯è³‡æ–™';/*  å¢åŠ æç¤ºæ–‡å­— */
      titleEl.onclick = async () => {
        // å¢åŠ ä¸€é»è¦–è¦ºå›é¥‹ï¼ˆä¾‹å¦‚æ¨™é¡Œè®Šè‰²æˆ–éœ‡å‹•ï¼‰
        titleEl.style.opacity = '0.5';
        console.log("æ‰‹å‹•è§¸ç™¼åŒæ­¥...");
        await syncFromCloud();
        titleEl.style.opacity = '1';
        alert('åŒæ­¥å®Œæˆï¼');
      };
    }
/*      ----------------------- */
    renderGlobalTodos();
    renderUserTabs();
    renderChecklists();
    renderDateScroller();
    enableWheelHorizontal(document.getElementById('dayScroller'));
    await selectDay(0);
    renderHotels();
    renderFlights();
    normalizeExpenses();
    renderExpenseUI();
  });

  document.getElementById('modalSheet')?.addEventListener(
    'touchmove',
    (e) => e.stopPropagation(),
    { passive: true }
  );


  document.getElementById('modalOverlay')?.addEventListener(
    'touchmove',
    (e) => e.preventDefault(),
    { passive: false }
  );
  document.getElementById('timelineList').addEventListener('click', (e) => {
    const el = e.target.closest('.route-click');
    if(!el) return;

    const from = decodeURIComponent(el.dataset.from || '');
    const to   = decodeURIComponent(el.dataset.to || '');
    const mode = decodeURIComponent(el.dataset.mode || 'drive');

    openDirections(from, to, mode);
   });



  function nav(pageId, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-'+pageId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    window.scrollTo(0,0);
  }

/*    ====== å…¨å“¡å¾…è¾¦ ====== */
  function renderGlobalTodos(){
    const el = document.getElementById('globalTodoList');
    if(!el) return;

    const saved = JSON.parse(localStorage.getItem('global_todos')) || {};
    el.innerHTML = (TODOS || []).map((t, idx) => {
      const key = t.title || `todo_${idx}`;
      const checked = saved[key] ? 'checked' : '';

      const titleHTML = t.link
        ? `<div class="todo-title"><a href="${t.link}" target="_blank" rel="noopener">${escapeHtml(t.title)}</a></div>`
        : `<div class="todo-title"><span>${escapeHtml(t.title)}</span></div>`;

      return `
        <li class="todo-li">
          <input type="checkbox" ${checked} onchange="toggleGlobalTodo('${escapeHtml(key)}')">
          <div>
            ${titleHTML}
            ${t.note ? `<div class="todo-note">${escapeHtml(t.note)}</div>` : ''}
          </div>
        </li>
      `;
    }).join('');
  }

  function toggleGlobalTodo(key){
    const k = unescapeHtml(key);
    const saved = JSON.parse(localStorage.getItem('global_todos')) || {};
/*      1. åˆ‡æ›ç‹€æ…‹ */
    saved[k] = !saved[k];
    
/*      2. å­˜å…¥æœ¬åœ° */
    localStorage.setItem('global_todos', JSON.stringify(saved));
  
/*      3. ğŸ’¡ æ–°å¢ï¼šåŒæ­¥åˆ°é›²ç«¯ (ä½¿ç”¨ 'GLOBAL' ä½œç‚ºç”¨æˆ¶åæ¨™è¨˜) */
    cloudPost("updateCheck", { 
      user: "GLOBAL", 
      type: "todo", 
      item: k, 
      checked: saved[k] 
    });
  }
  function formatDuration(mins){
    const m = Number(mins);
    if(!Number.isFinite(m) || m <= 0) return '';
    const h = Math.floor(m / 60);
    const r = m % 60;
    if(h <= 0) return `${m} min`;
    if(r === 0) return `${h} hr`;
    return `${h} hr ${r} min`;
  }


/*    ====== å€‹äººæ¸…å–® ====== */
  function renderUserTabs() {
    document.getElementById('userSwitch').innerHTML = users.map(u =>
      `<div class="user-tab ${u===curUser?'active':''}" onclick="switchUser('${u}')">${u}</div>`
    ).join('');
  }
  function switchUser(u) { curUser = u; renderUserTabs(); renderChecklists(); }

  function iconForItem(item){
    if(item.includes('è­·ç…§')) return 'fa-passport';
    if(item.includes('æ‰‹æ©Ÿ')) return 'fa-mobile-screen';
    if(item.includes('è¡Œå‹•é›»æº') || item.includes('å……é›»')) return 'fa-battery-full';
    if(item.includes('è—¥')) return 'fa-pills';
    if(item.includes('è¡£') || item.includes('å…§è¡£') || item.includes('ç¡è¡£')) return 'fa-shirt';
    if(item.includes('é›¨')) return 'fa-umbrella';
    if(item.includes('ç‰™')) return 'fa-tooth';
    return 'fa-suitcase';
  }

  function renderChecklists() {
    const data = JSON.parse(localStorage.getItem('check_'+curUser)) || {};

    ['pretrip','carry','check'].forEach(type => {
      const target = document.getElementById('list-'+type);
      if(!target) return;

      target.innerHTML = (checklistData[type] || []).map(item => {
        const isChecked = data[item] ? 'checked' : '';
        const icon = iconForItem(item);
        return `
          <div class="check-item ${isChecked}" onclick="toggleCheck('${escapeHtml(item)}', this)">
            <i class="fas ${icon}"></i>
            <span>${escapeHtml(item)}</span>
          </div>`;
      }).join('');
    });
  }

  function toggleCheck(itemEscaped, el) {
    const item = unescapeHtml(itemEscaped);
    const data = JSON.parse(localStorage.getItem('check_'+curUser)) || {};
    if(data[item]) { delete data[item]; el.classList.remove('checked'); }
    else { data[item] = true; el.classList.add('checked'); }
    localStorage.setItem('check_'+curUser, JSON.stringify(data));

/*      Add data to Google sheet */
    const isChecked = el.classList.contains('checked'); /*  åˆ¤æ–·ç¾åœ¨æ˜¯å‹¾é¸é‚„æ˜¯æ¶ˆ */

/*        å‚³é€åˆ°é›²ç«¯ */
      cloudPost("updateCheck", { user: curUser, type: "carry", item: item, checked: isChecked });
  }

/*    ====== è¡Œç¨‹ ====== */
  function renderDateScroller() {
    document.getElementById('dayScroller').innerHTML = itineraryIndex.map((d, i) => `
      <div class="date-chip" id="chip-${i}" onclick="selectDay(${i})">
        <div class="day">${escapeHtml(d.date || '')}</div>
        <div class="wk">${escapeHtml(d.day || '')}</div>
        <div class="date">Day ${i+1}</div>
      </div>
    `).join('');
  }

  function tagClass(tag){
        const t = (tag||'').toLowerCase();
        if(t==='food') return 'tag-food';
        if(t==='sight') return 'tag-sight';
        if(t==='sight') return 'tag-sight';
        if(t==='takagi') return 'tag-takagi';
        if(t==='hotel') return 'tag-hotel';
        if(t==='shop') return 'tag-shop';
        return 'tag-transport';
    }

/*
 å›å‚³å°æ‡‰ Font Awesome icon classï¼ˆä¸å« "fa-solid" é‚£ç¨®å‰ç¶´ï¼‰
 è¦å‰‡ï¼šå…ˆçœ‹ subtagï¼ˆå­åˆ†é¡ï¼‰â†’ æ²’å‘½ä¸­å†çœ‹ tagï¼ˆå¤§åˆ†é¡ï¼‰â†’ éƒ½æ²’æœ‰å°±ç”¨é è¨­åœ“é»
*/
  function tagIcon(tag, subtag){

/*      t = å¤§åˆ†é¡ï¼ˆfood / sight / transport / hotel / shopï¼‰ */
    const t  = (tag || '').toLowerCase().trim();


/*      st = å­åˆ†é¡ï¼ˆramen / sushi / train / onsen ...ï¼‰ */
    const ALIAS = {
      'æ±½è»Š':'car','é£›æ©Ÿ':'plane','ç«è»Š':'train','å·´å£«':'bus','çºœè»Š':'cablecar','è¼ªèˆ¹':'ferry','èµ·é£›':'departure','æŠµé”':'arrived',
      'ç”Ÿé­šç‰‡':'sashimi','å£½å¸':'sushi','å’–å“©é£¯':'curry','ç‰›æ’':'steak','buffet':'buffet','æ‹‰éºµ':'ramen','ä¸²ç‡’':'yakitori','å±…é…’å±‹':'izakaya','å’–å•¡å»³':'cafe',
      'æµ·æ°´æµ´å ´':'beach','è²“å’ª':'cat','åŸæ± ':'castle','æº«æ³‰':'onsen','è»Šç«™':'station',
      'æ²³å·':'river','æ¤ç‰©åœ’':'botanic','å‹•ç‰©åœ’':'zoo','å…¬åœ’':'park','é³¥å±…':'torii','åšç‰©é¤¨':'museum',
    };

    const st = (ALIAS[subtag] || subtag || '').toLowerCase().trim();
    const TAG_SVGS = {
      takagi: ['./photos/takagi_01_nobg_v2.svg', './photos/takagi_02_nobg_v2.svg']
    };


/*
     -----------------------------
     âœ… å­åˆ†é¡ iconï¼ˆå„ªå…ˆï¼‰
     ä½ åœ¨è³‡æ–™ä¸­å¯« subtagï¼Œå°±æœƒå„ªå…ˆç”¨é€™è£¡çš„ icon
     ä¾‹å¦‚ï¼štag=food, subtag=ramen â†’ fa-bowl-food
     -----------------------------
*/
    const SUB = {

/*        ===== transport äº¤é€šå­åˆ†é¡ ===== */
      car:      'fa-car',             /* æ±½è»Š */
      plane:    'fa-plane',           /* é£›æ©Ÿ */
      train:    'fa-train',           /* ç«è»Š */
      bus:      'fa-bus',             /* å·´å£« */
      cablecar: 'fa-cable-car',       /* çºœè»Šï¼ˆFA ç‰ˆæœ¬è‹¥æ²’æœ‰ï¼Œæ”¹æˆ fa-mountain/ fa-train éƒ½è¡Œï¼‰ */
      ferry:    'fa-ship',            /* è¼ªèˆ¹/æ¸¡è¼ª */
      departure:'fas fa-plane-departure',  /* èµ·é£› */
      arrived:  'fas fa-plane-arrival',  /* æŠµé” */

/*        ===== food é¤é£²å­åˆ†é¡ ===== */
      sashimi:  'fa-fish',            /* ç”Ÿé­šç‰‡ï¼ˆä¿å®ˆ iconï¼Œé€šå¸¸ç‰ˆæœ¬éƒ½æœƒæœ‰ï¼‰ */
      sushi:    'fa-fish-fins',       /* å£½å¸ï¼ˆè‹¥ä½ ç‰ˆæœ¬æ²’æœ‰ â†’ æ› fa-fishï¼‰ */
      curry:    'fa-pepper-hot',      /* å’–å“©é£¯ï¼ˆè‹¥è¦ºå¾—ä¸è²¼ â†’ æ› fa-utensilsï¼‰ */
      steak:    'fa-drumstick-bite',  /* ç‰›æ’ï¼ˆè‹¥ç‰ˆæœ¬æ²’æœ‰ â†’ æ› fa-utensilsï¼‰ */
      buffet:   'fa-plate-wheat',     /* buffetï¼ˆè‹¥ç‰ˆæœ¬æ²’æœ‰ â†’ æ› fa-utensilsï¼‰ */
      ramen:    'fa-bowl-food',       /* æ‹‰éºµï¼ˆFA6 æ‰æ¯”è¼ƒç©©ï¼‰ */
      yakitori: 'fa-fire-flame-curved',  /* ä¸²ç‡’/ç‚­ç«ï¼ˆFA6 æ‰æ¯”è¼ƒç©©ï¼›ä¿å®ˆå¯æ› fa-fireï¼‰ */
      izakaya:  'fa-beer-mug-empty',  /* å±…é…’å±‹ï¼ˆFA6 æ‰æ¯”è¼ƒç©©ï¼›ä¿å®ˆå¯æ› fa-mug-hotï¼‰ */
      cafe:     'fa-mug-hot',         /* å’–å•¡å»³ */

/*        ===== sight æ™¯é»å­åˆ†é¡ ===== */
      beach:    'fa-umbrella-beach',  /* æµ·æ°´æµ´å ´ */
      cat:      'fa-cat',             /* è²“å’ª */
      castle:   'fa-chess-rook',      /* åŸæ±  */
      onsen:    'fa-hot-tub-person',  /* æº«æ³‰ï¼ˆFA6 æ‰æ¯”è¼ƒç©©ï¼›ä¿å®ˆå¯æ› fa-waterï¼‰ */
      station:  'fa-train-subway',    /* è»Šç«™ï¼ˆè‹¥ç‰ˆæœ¬æ²’æœ‰ â†’ æ› fa-trainï¼‰ */
      river:    'fa-water',           /* æ²³å· */
      botanic:  'fa-seedling',        /* æ¤ç‰©åœ’ */
      zoo:      'fa-paw',             /* å‹•ç‰©åœ’ */
      park:     'fa-tree',            /* å…¬åœ’ */
      torii:    'fa-torii-gate',      /* é³¥å±… */
      shrine:   'fa-torii-gate',      /* ç¥ç¤¾ï¼ˆåŒé³¥å±…ï¼‰ */
      museum:   'fa-landmark',        /* åšç‰©é¤¨ */
      takagi:   ''
    };

/*
     -----------------------------
     âœ… å¤§åˆ†é¡ iconï¼ˆfallbackï¼‰
     ç•¶ subtag æ²’å¯«æˆ–æ²’å‘½ä¸­æ™‚ï¼Œé€€å›çœ‹ tag
     ä¾‹å¦‚ï¼štag=food, subtag="" â†’ fa-utensils
     -----------------------------
*/
    const TAG = {
      food:      'fa-utensils',       /* é¤é£² */
      sight:     'fa-torii-gate',     /* æ™¯é»ï¼ˆé è¨­ç”¨é³¥å±…ï¼‰ */
      transport: 'fa-route',          /* äº¤é€š */
      hotel:     'fa-bed',            /* ä½å®¿ */
      shop:      'fa-bag-shopping'    /* è³¼ç‰© */
    };

/*      âœ… å›å‚³é †åºï¼šå­åˆ†é¡ â†’ å¤§åˆ†é¡ â†’ é è¨­ */
    return SUB[st] || TAG[t] || 'fa-circle';   /* fa-circle = æ²’åˆ†é¡æ™‚ç”¨åœ“é» */
  }


  function durationChip(item){
/*      1) å„ªå…ˆé¡¯ç¤º stayï¼ˆä½  JSON å·²ç¶“æœ‰ï¼‰ */
    const stay = (item.stay || '').trim();
    if(stay) return `<span class="tl-chip"><i class="fas fa-hourglass-half"></i> ${escapeHtml(stay)}</span>`;

/*      2) å¦‚æœæœ‰ route.minutesï¼Œé¡¯ç¤ºè»Šç¨‹ */
    const mins = item?.route?.minutes;
    if(Number.isFinite(mins)) return `<span class="tl-chip"><i class="fas fa-car"></i> ${mins} min</span>`;

    return '';
  }
  function normalizeTime(t){
/*      åªå– HH:MMï¼ˆé¿å… Before 05:00 / 13:20-13:45 ç ´ç‰ˆï¼‰ */
    const s = String(t ?? '').trim();
    const m = s.match(/(\d{1,2}:\d{2})/);
    if(m) return m[1].padStart(5,'0');
    if(s === 'â€”' || s === '-' || !s) return 'â€”';
    return s;  /* çœŸçš„ä¸æ˜¯æ™‚é–“å°±åŸæ¨£ï¼ˆä½†å»ºè­° json å°±åˆ¥æ”¾é€™ç¨®ï¼‰ */
  }

  function routeIcon(mode){
    const m = (mode||'').toLowerCase();
    if(m==='drive') return 'fa-car';
    if(m==='walk')  return 'fa-person-walking';
    if(m==='train') return 'fa-train-subway';
    if(m==='ship')  return 'fa-ship';
    if(m==='plane') return 'fa-plane';
    return 'fa-route';
  }

  function renderRouteStrip(item, i){
    const r = item.route || {};
    const mode = (r.mode || 'route').toLowerCase();
    const icon = routeIcon(mode);
    const mins = r.minutes ? `${formatDuration(r.minutes)}` : (item.stay || '');
    const line2 = `${r.from || ''} â†’ ${r.to || ''}`.trim();

    return `
        <div class="timeline-item route-item">
            <div class="tl-time">${escapeHtml(t)}</div>
            <div class="route-spacer"></div>

            <div class="route-strip route-click"
            data-from="${enc(r.from || '')}"
            data-to="${enc(r.to || '')}"
            data-mode="${enc(mode)}">

            <div class="route-ico"><i class="fas ${ico}"></i></div>

            <div class="route-main">
                <div class="route-title">${escapeHtml(title)}</div>
            </div>

            ${dur ? `<div class="route-mins">${escapeHtml(dur)}</div>` : ``}
            </div>
        </div>
    `;
  }

  function renderNormalItem(item, i){
    const stayPill = item.stay ? `<div style="margin-top:6px; display:inline-flex; gap:8px; align-items:center; background:#F2F2F7; padding:4px 10px; border-radius:999px; font-weight:900; font-size:.82rem; line-height:1.1; color:#4B5563;">
      <i class="fas fa-hourglass-half" style="color:#9CA3AF;"></i>${escapeHtml(item.stay)}
    </div>` : '';

/*      âœ… é—œéµï¼šç§»é™¤ onclickï¼Œæ”¹ç”¨ data-idx ä¾› JS è­˜åˆ¥ */
    return `
      <div class="timeline-item" data-idx="${i}" id="exp-item-${i}">
        <div class="tl-time">${escapeHtml(t)}</div>
        <div class="tl-content ${item.highlight ? 'highlight' : ''}" style="position:relative;">
          ${item.reserved ? `<div class="reserve-badge">äºˆç´„æ¸ˆ</div>` : ``}
          <div class="tl-tag ${tagClass(item.tag)}">
              ${escapeHtml((item.tag || '').toUpperCase())}
              <i class="fas ${tagIcon(item.tag, item.subtag)} tag-ico"></i>
          </div>	  
          <div class="tl-title">${escapeHtml(item.title || '').replace(/\n/g, '<br>')}</div>
          <div class="tl-desc">${escapeHtml(item.desc || '').replace(/\n/g, '<br>')}</div>
          ${stay}
          ${renderEditRow(i, item)}
        </div>
      </div>
    `;
/*
//     return `
//       <div class="timeline-item" onclick='openModal(${i})'>
//         <div class="tl-time">${escapeHtml(item.time || '')}</div>
//         <div class="tl-content ${item.highlight ? 'highlight' : ''}">
//           <div class="tl-tag ${tagClass(item.tag)}">
//             ${escapeHtml((item.tag||'').toUpperCase())}
//             ${((item.tag||'').toLowerCase()==='takagi')
//               ? getTagIconHtml('takagi', i)
//               : `<i class="fas ${tagIcon(item.tag, item.subtag)} tag-ico"
//                   style="opacity:.35; font-size:.72rem; margin-left:2px;"></i>`
//             }
//           </div>
//           <div class="tl-title">${escapeHtml(item.title || '').replace(/\n/g,'<br>')}</div>
//           <div class="tl-desc">${escapeHtml(item.desc || '').replace(/\n/g,'<br>')}</div>
//           ${stayPill}
//         </div>
//       </div>
//     `;
*/
  }
  function openDirections(from, to, mode='drive'){
    const tm = travelModeForRoute(mode);  /* ä½ ä¸‹é¢å·²ç¶“æœ‰é€™å€‹ function */
    const url = `https://www.google.com/maps/dir/?api=1`
        + `&origin=${encodeURIComponent(from||'')}`
        + `&destination=${encodeURIComponent(to||'')}`
        + `&travelmode=${encodeURIComponent(tm)}`;
    window.open(url, '_blank', 'noopener');
  }





/*
//   function openDirections(from, to){
//     // Google Maps Directions
//     const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from||'')}&destination=${encodeURIComponent(to||'')}&travelmode=driving`;
//     window.open(url, '_blank');
//   }
*/


    /* --- âœ… ä¿®æ­£ï¼šå°‡ä»¥ä¸‹å‡½å¼ç§»è‡³å…¨åŸŸä½ç½®ï¼ˆselectDay çš„å¤–éƒ¨ï¼‰ --- */
    
    function renderTimelineList(dayData) {
      const listEl = document.getElementById('timelineList');
      if (!listEl) return;
    
/*        âœ… æ ¹æ“šç‹€æ…‹åˆ‡æ› CSS é¡åˆ¥ */
      if (__tlEditMode) listEl.classList.add('edit-mode-active');
      else listEl.classList.remove('edit-mode-active');

      listEl.innerHTML = (dayData?.items || []).map((item, i) => {
        const t = normalizeTime(item.time);
        const stay = item.stay ? `
          <div class="stay-pill"><i class="fas fa-hourglass-half"></i>${escapeHtml(item.stay)}</div>
        ` : '';
    
/*          âœ… Route æ¸²æŸ“é‚è¼¯ */
        if (item.route && (item.route.from || item.route.to)) {
          const r = item.route;
          const mode = r.mode || 'drive';
          const ico = routeIcon(mode);
          const title = (item.title && item.title.trim()) ? item.title.trim() : `${r.from || ''} â†’ ${r.to || ''}`.trim();
          const dur = (item.stay && String(item.stay).trim()) ? String(item.stay).trim() : (Number.isFinite(r.minutes) ? `${r.minutes} min` : '');
          const enc = (s) => encodeURIComponent(String(s ?? ''));
    
          return `
            <div class="timeline-item route-item">
                <div class="route-strip route-click" data-from="${enc(r.from || '')}" data-to="${enc(r.to || '')}" data-mode="${enc(mode)}">
                  <div class="route-ico"><i class="fas ${ico}"></i></div>
                  <div class="route-main">
                      <div class="route-time-top">${escapeHtml(t)}</div>
                      <div class="route-title">${escapeHtml(title)}</div>
                  </div>
                  ${dur ? `<div class="route-mins">${escapeHtml(dur)}</div>` : ``}
                </div>
                  <div style="margin-left:76px; margin-top:-10px;" onclick="event.stopPropagation()">
                    ${renderEditRow(i, item)}
                  </div>
            </div>`;
        }
    
/*          âœ… ä¸€èˆ¬è¡Œç¨‹æ¸²æŸ“é‚è¼¯ */
        return `
          <div class="timeline-item" data-idx="${i}" id="exp-item-${i}">
            <div class="tl-time">${escapeHtml(t)}</div>
            <div class="tl-content ${item.highlight ? 'highlight' : ''}" style="position:relative;">
              ${item.reserved ? `<div class="reserve-badge">äºˆç´„æ¸ˆ</div>` : ``}
              <div class="tl-tag ${tagClass(item.tag)}">
                  ${escapeHtml((item.tag || '').toUpperCase())}
                  <i class="fas ${tagIcon(item.tag, item.subtag)} tag-ico"></i>
              </div>	  
              <div class="tl-title">${escapeHtml(item.title || '').replace(/\n/g, '<br>')}</div>
              <div class="tl-desc">${escapeHtml(item.desc || '').replace(/\n/g, '<br>')}</div>
              ${stay}
              ${renderEditRow(i, item)}
            </div>
          </div>`;
      }).join('');
    
      bindLongPressSelection();  /* æ¸²æŸ“å®Œé‡æ–°ç¶å®š */
    }
    
/*      æ¸²æŸ“ç·¨è¼¯åˆ— */
    function renderEditRow(i, item) {
/*       if (!__tlEditMode) return ''; */
/*        âœ… ç§»é™¤åˆ¤æ–·å¼ï¼Œè®“ç·¨è¼¯åˆ—æ°¸é ç”Ÿæˆï¼Œæ”¹ç”± CSS çš„ .edit-row { display: none; } æ§åˆ¶ */
      const t = normalizeTime(item.time);
      return `
        <div class="edit-row" onclick="event.stopPropagation()">
          <input class="time-input" type="time" value="${escapeHtml(t)}" data-edit-time="1" data-idx="${i}" />
          <button class="mini-btn danger" data-delete-idx="${i}"><i class="fas fa-trash"></i> åˆªé™¤</button>
        </div>`;
    }
    
/*
    // å„²å­˜ç•°å‹•
//     function saveDayEdits() {
//       const meta = itineraryIndex[currentDayIdx];
//       const file = meta?.file;
//       if (!file) return;
//       const dataToSave = { items: (currentDayData?.items || []) };
//       localStorage.setItem(`day_edits_${file}`, JSON.stringify(dataToSave));
//       cloudPost("updateItinerary", { file: file, items: dataToSave });
//     }
*/

    function renderDayHero(dayData, meta){
        const el = document.getElementById('dayHero');
        if(!el) return;

/*
         âœ… æ”¯æ´å…©ç¨®æ ¼å¼ï¼š
         1) æ–°æ ¼å¼ï¼š[{src,loc,caption}]
         2) èˆŠæ ¼å¼ï¼š[ "url1", "url2" ]
*/
        let photosRaw = Array.isArray(dayData?.photos) ? dayData.photos.slice(0,5) : [];
        if(!photosRaw.length){
            photosRaw = [
            "https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1200&q=80",
            "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80",
            "https://images.unsplash.com/photo-1526481280695-3c687fd5432c?auto=format&fit=crop&w=1200&q=80",
            "https://images.unsplash.com/photo-1528127269322-539801943592?auto=format&fit=crop&w=1200&q=80",
            "https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?auto=format&fit=crop&w=1200&q=80",
            ];
        }

        const photos = photosRaw.map(p=>{
            if(typeof p === 'string'){
                return { src:p, loc: (meta?.loc||''), caption:'' };
            }
            return {
                src: p.src || p.url || '',
                loc: (p.loc !== undefined) ? (p.loc ?? '') : (meta?.loc || ''),
                caption: p.caption || ''
            };
        }).filter(x=>x.src);

        const slides = photos.map((p, idx)=>`
          <div class="hero-slide hero--blur">
            <img
                src="${escapeHtml(p.src)}"
                alt="day photo ${idx+1}"
                loading="lazy"
                decoding="async"
                referrerpolicy="no-referrer"
                onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80';"
                class="hero-bg" alt="" aria-hidden="true"
            >
            <img
                src="${escapeHtml(p.src)}"
                alt="day photo ${idx+1}"
                loading="lazy"
                decoding="async"
                referrerpolicy="no-referrer"
                onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80';"
                class="hero-img" alt="day photo ...">
            >
            <div class="hero-overlay">
                ${p.loc ? `<div class="hero-loc"><i class="fas fa-location-dot"></i>${escapeHtml(p.loc)}</div>` : ``}
                ${p.caption ? `<div class="hero-caption">${escapeHtml(p.caption)}</div>` : ``}
					  
								   
																									
            </div>
           </div>
        `).join('');

        
/*          âŒ dotsï¼ˆå°ç™½é»ï¼‰å·²ç§»é™¤ï¼šä¸é¡¯ç¤ºä¹Ÿä¸éœ€è¦åŒæ­¥ */
        el.innerHTML = `<div class="hero-track" id="heroTrack">${slides}</div>`;

        const track = document.getElementById('heroTrack');
        if(!track) return;

/*          âœ… æ¡Œæ©Ÿæ»¾è¼ªä¹Ÿèƒ½å·¦å³æ»‘ */
        enableWheelHorizontal(track);

        if(__heroTimer) clearInterval(__heroTimer);

/*          auto slide */

        let cur = 0;
        __heroTimer = setInterval(()=>{
            cur = (cur + 1) % photos.length;
            track.scrollTo({ left: cur * track.clientWidth, behavior:'smooth' });
        }, 12000);
    }

    async function selectDay(idx) {
        currentDayIdx = idx;
        __editHistory = []; 
        __tlEditMode = false;
    
/*          UI æ›´æ–° (Active Date Chip) */
        document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
        const chip = document.getElementById('chip-' + idx);
/*         if (chip) chip.classList.add('active'); */
        if (chip) {
            chip.classList.add('active');

            /* âœ… æ–°å¢ï¼šå°‡æ‰€é¸æ—¥æœŸç½®ä¸­æ²å‹•çš„é‚è¼¯ */
            const scroller = document.getElementById('dayScroller');
            if (scroller) {
                const scrollPos = chip.offsetLeft - (scroller.clientWidth / 2) + (chip.clientWidth / 2);
                scroller.scrollTo({ left: scrollPos, behavior: 'smooth' });
            }
        } 

        const meta = itineraryIndex[idx];
        if (!meta) return;
    
/*
        // è¼‰å…¥è³‡æ–™
        // if (!dayCache[idx]) {
        //   const url = `./${meta.file}?v=${Date.now()}`;
        //   const raw = await fetch(url).then(r => r.json());
        //   dayCache[idx] = Array.isArray(raw) ? raw[0] : raw;
        // }
*/

        const needFetch =
          !dayCache[idx] ||
          (!Array.isArray(dayCache[idx]?.photos) || dayCache[idx].photos.length === 0) ||
          (dayCache[idx]?.items && !dayCache[idx]?.route && !dayCache[idx]?.loc); // ä¾ä½ è³‡æ–™å‹æ…‹è‡ªè¡Œå¾®èª¿

        if (needFetch) {
          const url = `./${meta.file}?v=${Date.now()}`;
          const raw = await fetch(url).then(r => r.json());
          dayCache[idx] = Array.isArray(raw) ? raw[0] : raw;
        }

    
/*          æ‡‰ç”¨ç·¨è¼¯ (æœ¬åœ°èˆ‡é›²ç«¯ç·©å­˜) */
        currentDayData = applyDayEdits(dayCache[idx], meta);
    
/*          âœ… å‘¼å«ç¾åœ¨å·²è®Šæˆå…¨åŸŸçš„æ¸²æŸ“å‡½å¼ */
        renderDayHero(currentDayData, meta);
        await renderDayRouteCard(currentDayData);
        renderTimelineToolbar(meta);
        renderTimelineList(currentDayData);
        enableTimelineSortable();
        await renderWeatherJMA(meta);
    }


/*      ===== timeline edit helpers ===== */
/*      (__tlEditMode / __tlSortable å·²åœ¨ä¸Šæ–¹å®£å‘Š) */

/*     function dayEditKey(){ return `day_edits_${meta?.file || ''}`; } */
/*       âœ… ä¿®æ­£å¾Œçš„ dayEditKeyï¼šå¾å…¨åŸŸç´¢å¼•ä¸­å–å¾— meta */
     function dayEditKey() {
       const meta = itineraryIndex[currentDayIdx];  /* å¾å…¨åŸŸè®Šæ•¸æŠ“å–ç›®å‰çš„ meta */
       return `day_edits_${meta?.file || ''}`;
     }

/*      âœ… ä¿®æ­£å¾Œçš„ applyDayEdits (ç¢ºä¿å®ƒä¹Ÿæ˜¯ç¨ç«‹çš„) */
    function applyDayEdits(dayData, meta) {
      try {
        const key = `day_edits_${meta?.file || ''}`;
        const saved = JSON.parse(localStorage.getItem(key) || 'null');
        if (saved && Array.isArray(saved.items)) {
          return { ...dayData, items: saved.items };
        }
      } catch (e) {}
      return dayData;
    }

/*
//     function applyDayEdits(dayData, meta){
//       try{
//         const key = `day_edits_${meta?.file || ''}`;
//         const saved = JSON.parse(localStorage.getItem(key) || 'null');
//         if(saved && Array.isArray(saved.items)){
//           return { ...dayData, items: saved.items };
//         }
//       }catch(e){}
//       return dayData;
//     }

//     function saveDayEdits() {
//       try {
//         const file = itineraryIndex[currentDayIdx]?.file;
//         if (!file) return;
//     
//         const key = dayEditKey();
//         const dataToSave = { items: (currentDayData?.items || []) };
//         
//         // 1. æœ¬åœ°å‚™ä»½
//         localStorage.setItem(key, JSON.stringify(dataToSave));
//     
//         // 2. é›²ç«¯åŒæ­¥
//         cloudPost("updateItinerary", {
//           file: file,
//           items: dataToSave // åŒ…å«å®Œæ•´çš„é …ç›®é †åºèˆ‡æ™‚é–“
//         });
//         console.log(`Day ${currentDayIdx + 1} è¡Œç¨‹ç•°å‹•å·²åŒæ­¥é›²ç«¯`);
//       } catch (e) {
//         console.error("å„²å­˜å¤±æ•—", e);
//       }
//     }
*/
/*       âœ… ä¿®æ­£å¾Œçš„ saveDayEdits */
     function saveDayEdits() {
       try {
         const file = itineraryIndex[currentDayIdx]?.file;
         if (!file) return;
     
         const key = dayEditKey();  /* ç¾åœ¨é€™è£¡ä¸æœƒå†å ±éŒ¯äº† */
         const dataToSave = { items: (currentDayData?.items || []) };
         
/*           1. æœ¬åœ°å‚™ä»½ */
         localStorage.setItem(key, JSON.stringify(dataToSave));
     
/*           2. é›²ç«¯åŒæ­¥ */
         cloudPost("updateItinerary", {
           file: file,
           items: dataToSave.items  /* ç¢ºä¿å‚³é€çš„æ˜¯é™£åˆ— */
         });
         console.log(`Day ${currentDayIdx + 1} è¡Œç¨‹ç•°å‹•å·²åŒæ­¥é›²ç«¯`);
       } catch (e) {
         console.error("å„²å­˜å¤±æ•—", e);
       }
     }

    function resetDayEdits(){
      try{ localStorage.removeItem(dayEditKey()); }catch(e){}
    }

/*      let __editHistory = []; // ç”¨æ–¼å­˜æ”¾ä¸Šä¸€æ­¥çš„ç‹€æ…‹ */
    
    function renderTimelineToolbar(meta) {
      const el = document.getElementById('timelineToolbar');
      if (!el) return;
    
      el.innerHTML = `
        <div class="tl-tool-left">
          <button class="tl-btn ${__tlEditMode ? 'primary' : ''}" id="tlEditToggle">
            <i class="fas ${__tlEditMode ? 'fa-check' : 'fa-pen'}"></i>
            ${__tlEditMode ? 'å®Œæˆ' : 'ç·¨è¼¯'}
          </button>
        </div>
        <div class="tl-tool-right">
          <button class="tl-btn ghost" id="tlUndoEdit"><i class="fas fa-undo"></i> å›å¾©ä¸Šä¸€æ­¥</button>
          <button class="tl-btn ghost" id="tlResetDay"><i class="fas fa-rotate-left"></i> é‡ç½®default</button>
        </div>
      `;
    
/*        --- é‡ç½®åŠŸèƒ½ --- */
      el.querySelector('#tlResetDay')?.addEventListener('click', async () => {
        const file = itineraryIndex[currentDayIdx]?.file;
        if (!file || !confirm('ç¢ºå®šè¦å°‡æ­¤æ—¥è¡Œç¨‹ã€Œé‡ç½®defaultã€å—ï¼Ÿ')) return;
        cloudPost("resetItinerary", { file: file });
        localStorage.removeItem(`day_edits_${file}`);
        delete dayCache[currentDayIdx];
        await selectDay(currentDayIdx);
      });
    
/*        --- å›å¾©ä¸Šä¸€æ­¥ (Undo) --- */
      el.querySelector('#tlUndoEdit')?.addEventListener('click', () => {
        if (__editHistory.length > 0) {
          const prevState = __editHistory.pop();
          currentDayData.items = prevState; 
          
          saveDayEdits();
          renderTimelineList(currentDayData);
          enableTimelineSortable();  /* âœ… é—œéµï¼šå›å¾©å¾Œå¿…é ˆé‡æ–°å•Ÿç”¨æ’åºç›£è½ */
          
          console.log("å·²å›å¾©ä¸Šä¸€æ­¥ï¼Œå‰©é¤˜æ­¥æ•¸:", __editHistory.length);
        } else {
          alert('æ²’æœ‰æ›´å¤šæ­¥é©Ÿå¯ä»¥å›å¾©');
        }
      });
    
/*
//       el.querySelector('#tlEditToggle')?.addEventListener('click', () => {
//         __tlEditMode = !__tlEditMode;
//         renderTimelineToolbar(meta);
// //         renderTimelineList(currentDayData);
//         // âœ… ä¿®æ­£ï¼šåªæœ‰åœ¨ã€Œé—œé–‰ã€ç·¨è¼¯æ¨¡å¼æ™‚ï¼Œç‚ºäº†æ¸…ç†å¯èƒ½çš„ç‹€æ…‹æ‰é‡æ–°æ¸²æŸ“
//         if (!__tlEditMode) {
//             renderTimelineList(currentDayData);
//         }
//         enableTimelineSortable();
//       });
*/
      el.querySelector('#tlEditToggle')?.addEventListener('click', () => {
/*          âœ… å¦‚æœæ˜¯é–‹å•Ÿç·¨è¼¯æ¨¡å¼ï¼Œç´€éŒ„æ²å‹•ä½ç½® */
        const scrollY = window.scrollY;
        
        __tlEditMode = !__tlEditMode;
      
/*          åˆ‡æ› Class */
        const listEl = document.getElementById('timelineList');
        if (listEl) {
/*
           if (__tlEditMode) listEl.classList.add('edit-mode-active');
           else listEl.classList.remove('edit-mode-active');
*/
            if (__tlEditMode) {
              listEl.classList.add('edit-mode-active');
/*                listEl.style.touchAction = 'none'; // ç·¨è¼¯ä¸­ç¦ç”¨ç³»çµ±æ²å‹• */
            } else {
              listEl.classList.remove('edit-mode-active');
/*                listEl.style.touchAction = 'pan-y'; // å®Œæˆå¾Œæ¢å¾© y è»¸æ²å‹• */
            }
        }
      
        renderTimelineToolbar(meta);
      
/*         âœ… ä¸è«–æ˜¯é€²å…¥é‚„æ˜¯é›¢é–‹ï¼Œéƒ½å‘¼å«ä¸€æ¬¡ä¾†ç¢ºä¿ Sortable ç‹€æ…‹åŒæ­¥ */
       enableTimelineSortable(); 
       
       if (!__tlEditMode) renderTimelineList(currentDayData); 
      });
    }

    function enableTimelineSortable(){
      const list = document.getElementById('timelineList');
      if(!list) return;
      if(__tlSortable){ __tlSortable.destroy(); __tlSortable = null; }
      if(!__tlEditMode) return;
      if(typeof Sortable === 'undefined') return;
    
      __tlSortable = new Sortable(list, {
        animation: 180,
        handle: '.tl-content, .route-strip, .tl-time, .route-time-top',
        ghostClass: 'is-dragging',
/*
         delay: 400,
         delayOnTouchOnly: true,
*/
	delay: 200,
        touchStartThreshold: 5,
    
        onStart: (evt)=>{ 
          if (navigator.vibrate) navigator.vibrate(40);
          evt.item.classList.add('is-dragging'); 
        },
        onEnd: (evt)=>{
/*            âœ… æ–°å¢ï¼šæ¢å¾©è§¸æ§å‹•ä½œ */
          evt.item.style.touchAction = '';

          evt.item.classList.remove('is-dragging');
          const oldIndex = evt.oldIndex;
          const newIndex = evt.newIndex;
          
/*            âœ… æª¢æŸ¥ï¼šå¦‚æœä½ç½®æ²’æœ‰è®Šå‹•ï¼Œå°±ä¸éœ€è¦ç´€éŒ„æ­·å²èˆ‡é‡æ–°æ¸²æŸ“ */
          if(oldIndex === newIndex || oldIndex == null || newIndex == null) return;
    
/*            âœ… é—œéµï¼šåœ¨ä¿®æ”¹é™£åˆ—é †åºä¹‹å‰ï¼Œå…ˆå­˜å…¥ç›®å‰çš„ç‹€æ…‹åˆ°ã€Œä¸Šä¸€æ­¥ã€ */
          pushHistory();
    
          const arr = (currentDayData?.items || []).slice();
          const [moved] = arr.splice(oldIndex, 1);
          arr.splice(newIndex, 0, moved);
          currentDayData = { ...currentDayData, items: arr };
          
          saveDayEdits();
          renderTimelineList(currentDayData);
          enableTimelineSortable();
        }
      });
    }

/*      äº‹ä»¶å§”æ´¾ï¼šæ”¹æ™‚é–“ / åˆªé™¤ */
    document.getElementById('timelineList').addEventListener('input', (e)=>{
      if(!__tlEditMode) return;
      const inp = e.target.closest('input[data-edit-time]');
      if(!inp) return;

      pushHistory();  /* ğŸ’¡ æ–°å¢ï¼šä¿®æ”¹å‰ç´€éŒ„ç‹€æ…‹ */

      const idx = Number(inp.dataset.idx);
      if(!Number.isFinite(idx)) return;
      const arr = (currentDayData?.items || []).slice();
      if(!arr[idx]) return;
      arr[idx] = { ...arr[idx], time: inp.value };
      currentDayData = { ...currentDayData, items: arr };
      saveDayEdits();
      renderTimelineList(currentDayData);
    });

    document.getElementById('timelineList').addEventListener('click', (e)=>{
      if(!__tlEditMode) return;
      const btn = e.target.closest('[data-delete-idx]');
      if(!btn) return;

      pushHistory();  /* ğŸ’¡ æ–°å¢ï¼šä¿®æ”¹å‰ç´€éŒ„ç‹€æ…‹ */

      const idx = Number(btn.dataset.deleteIdx);
      if(!Number.isFinite(idx)) return;
      const arr = (currentDayData?.items || []).slice();
      arr.splice(idx, 1);
      currentDayData = { ...currentDayData, items: arr };
      saveDayEdits();
      renderTimelineList(currentDayData);
      enableTimelineSortable();
    }, true);


/*    ====== Google å°èˆªï¼šå„ªå…ˆ geoï¼Œå…¶æ¬¡ addr/title ====== */
  function buildGoogleNavUrl(item){
    const hasGeo = item?.geo?.lat != null && item?.geo?.lng != null;
    if(hasGeo){
/*      return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(item.geo.lat + ',' +
	     item.geo.lng)}`; */
      return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.geo.lat + ',' + item.geo.lng)}`;
    }
    const q = (item?.addr || item?.title || '').trim();
    if(!q) return 'https://www.google.com/maps';
/*     return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`; */
    return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
  }
  function travelModeForRoute(mode){
    const m = (mode || '').toLowerCase();
    if(m === 'walk')  return 'walking';
    if(m === 'train') return 'transit';
    if(m === 'ship')  return 'transit';
    if(m === 'plane') return 'transit';
    return 'driving';
  }

  function getLatLonForMeta(meta){
/*      âœ… å„ªå…ˆï¼šitinerary.index.json æ¯å¤©ç›´æ¥å¸¶ lat/lon */
    if(Number.isFinite(meta?.lat) && Number.isFinite(meta?.lon)){
        return { lat: meta.lat, lon: meta.lon };
    }

/*      âœ… æ¬¡é¸ï¼šhotels.json è£¡çš„ geoï¼ˆå¦‚æœä½ æœ‰å­˜ï¼‰ */
    const h = hotels.find(x => x.id === meta.hotel_id);
    const lat = h?.geo?.lat;
    const lon = h?.geo?.lng ?? h?.geo?.lon;
    if(Number.isFinite(lat) && Number.isFinite(lon)){
        return { lat, lon };
    }
    return null;
   }
  async function renderDayRouteCard(dayData){
    const el = document.getElementById('dayRouteCard');
    if(!el) return;

    const route = dayData?.route;
    const rawPts = route?.points || [];
    const mode = route?.mode || 'drive';

/*
     âœ… æ”¯æ´ä¸‰ç¨®æ ¼å¼ï¼š
     1) "lat,lng"  (å­—ä¸²)
     2) "åœ°é»åç¨±" (å­—ä¸²ï¼šåªç”¨æ–¼ Googleï¼Œç¸®åœ–ä¸ç•«é»)
     3) { q:"åœ°é»åç¨±", lat:34.12, lng:134.56 } (ç‰©ä»¶ï¼šGoogle + ç¸®åœ–éƒ½èƒ½ç”¨)
*/
    const pts = rawPts.map(p=>{
      if(p == null) return null;

      if(typeof p === 'string'){
        const s = p.trim();
        if(!s) return null;
        const ll = parseLatLng(s);
        if(ll) return { q: `${ll.lat},${ll.lng}`, lat: ll.lat, lng: ll.lng };
        return { q: s };
      }

      if(typeof p === 'object'){
        const q = (p.q || p.name || p.title || '').toString().trim();
        const lat = (p.lat != null) ? Number(p.lat) : null;
        const lng = (p.lng != null) ? Number(p.lng) : null;
        const hasLL = Number.isFinite(lat) && Number.isFinite(lng);
        return { q: q || (hasLL ? `${lat},${lng}` : ''), lat: hasLL ? lat : null, lng: hasLL ? lng : null };
      }

      return null;
    }).filter(Boolean);

    if(!route || pts.length < 2){
      el.innerHTML = '';
      return;
    }

    const gUrl = buildGoogleDirUrlFromPoints(pts, mode);

/*      --- Stops (ä¸­é–“çš„åœé é»æ•¸é‡) --- */
    const stopCount = Math.max(0, pts.length - 2);

/*      --- å…ˆæº–å‚™åº§æ¨™é»ï¼ˆåªæœ‰æœ‰ lat/lng çš„æ‰æ‹¿ä¾†ç•«ç¸®åœ– + OSRMï¼‰--- */
    const stopLatLngs = pts.filter(p=>Number.isFinite(p.lat) && Number.isFinite(p.lng)).map(p=>({lat:p.lat, lng:p.lng}));

/*      --- center / zoom --- */
    const centerObj = parseLatLng(route?.preview?.center || '') || (stopLatLngs[0] || null);
    const centerStr = centerObj ? `${centerObj.lat},${centerObj.lng}` : '';
    const zoom = route?.preview?.zoom || 11;

/*      --- Road distance (å„ªå…ˆï¼šroute.distance_km > OSRM > (ä¸é¡¯ç¤º/ç›´ç·šä¼°ç®—)) --- */
    let roadKm = (route?.distance_km != null) ? Number(route.distance_km) : null;
    if(!Number.isFinite(roadKm)) roadKm = null;

/*      OSRM å–å¾—é“è·¯è·¯å¾‘ + è·é›¢ï¼ˆä¸éœ€è¦ API Keyï¼›ä½†å¯èƒ½å› ç¶²è·¯/CORS å¤±æ•—ï¼‰ */
    let pathLatLngs = null;
    if(roadKm == null && stopLatLngs.length >= 2){
      try{
        const osrm = await fetchOsrmRoute(stopLatLngs, mode);
        if(osrm?.distanceKm != null) roadKm = osrm.distanceKm.toFixed(1);
        if(osrm?.pathLatLngs?.length) pathLatLngs = osrm.pathLatLngs;
      }catch(e){
/*          å¤±æ•—å°±ä¸é¡¯ç¤º kmï¼ˆé¿å…å†å›åˆ°ç›´ç·š 65km é‚£ç¨®èª¤å·®ï¼‰ */
        console.warn('OSRM route failed:', e);
      }
    }

/*      æ²’æœ‰ OSRM è·¯å¾‘å°±ç”¨åœé é»ç›´ç·šï¼ˆè‡³å°‘èƒ½ç•«å‡ºå¤§æ¦‚ï¼‰ */
    if(!pathLatLngs) pathLatLngs = stopLatLngs;

    const meta = `${stopCount} å€‹åœç•™é»` + (roadKm != null ? ` Â· é è¨ˆè¡Œé§› ${roadKm} km` : '');

/*      --- UIï¼šç¶­æŒä½ ç¬¬ 3 å¼µé‚£å€‹å¡ç‰‡æ’ç‰ˆ --- */
    el.innerHTML = `
      <div class="route-card">
        <div class="route-thumb" id="routeMiniMap"></div>
        <div class="route-head">
          <div>
            <div class="route-title">Google Map å°èˆª</div>
            <div class="route-meta">${meta}</div>
          </div>
          <a class="route-btn" href="${gUrl}" target="_blank" rel="noopener">
            <i class="fas fa-location-arrow" aria-hidden="true"></i>
            <span>é–‹å•Ÿ</span>
          </a>
        </div>
      </div>
    `;

/*      --- ç¸®åœ–åœ°åœ–ï¼ˆç”¨ OSRM çš„é“è·¯è·¯å¾‘ç•«å‡ºã€Œåƒç¬¬4å¼µã€çš„èµ°æ³•ï¼‰--- */
    if(stopLatLngs.length){
      renderRouteMiniMap(pathLatLngs, stopLatLngs, centerStr, zoom);
    }
  }


  function buildGoogleDirUrlFromPoints(points, mode='drive'){
/*      points: [{q,lat,lng}, ...] */
    const list = points.map(p => (p?.q || (p?.lat!=null && p?.lng!=null ? `${p.lat},${p.lng}` : '')).trim()).filter(Boolean);
    if(list.length < 2) return 'https://www.google.com/maps';

    const origin = list[0];
    const dest   = list[list.length - 1];
    const wps    = list.slice(1, -1).join('|');   /* pipe-separated */

    const tm = travelModeForRoute(mode);
    return `https://www.google.com/maps/dir/?api=1`
      + `&origin=${encodeURIComponent(origin)}`
      + `&destination=${encodeURIComponent(dest)}`
      + (wps ? `&waypoints=${encodeURIComponent(wps)}` : '')
      + `&travelmode=${tm}`;
  }
  function buildGoogleDirPathUrl(points){
/*      https://www.google.com/maps/dir/é»1/é»2/é»3/é»4 */
    const path = points.map(p => encodeURIComponent(p)).join('/');
    return `https://www.google.com/maps/dir/${path}`;
  }
  function parseLatLng(s){
/*      æ”¯æ´ "lat,lng" å­—ä¸² */
    if(!s) return null;
    const m = String(s).trim().match(/^(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)$/);
    if(!m) return null;
    const lat = parseFloat(m[1]);
    const lng = parseFloat(m[3]);
    if(Number.isNaN(lat) || Number.isNaN(lng)) return null;
    return {lat, lng};
  }
  function normalizeLatLng(p){
    if(!p) return null;
    if(typeof p === 'string') return parseLatLng(p);
    if(Array.isArray(p) && p.length>=2){
      const lat = Number(p[0]), lng = Number(p[1]);
      if(Number.isFinite(lat) && Number.isFinite(lng)) return {lat,lng};
      return null;
    }
    if(typeof p === 'object' && Number.isFinite(p.lat) && Number.isFinite(p.lng)){
      return {lat:Number(p.lat), lng:Number(p.lng)};
    }
    return null;
  }


  function haversineKm(a, b){
    const R = 6371; /* Earth radius km */
    const toRad = (d)=> d*Math.PI/180;
    const dLat = toRad(b.lat - a.lat);
    const dLng = toRad(b.lng - a.lng);
    const lat1 = toRad(a.lat);
    const lat2 = toRad(b.lat);

    const x = Math.sin(dLat/2)**2 +
              Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
    return R * c;
  }

  
function estimateRouteKm(points){
/*    Fallback: straight-line (haversine) distance in km (UNDER-estimates driving distance). */
  const coords = (points||[]).map(parseLatLng).filter(Boolean);
  if(coords.length < 2) return null;
  let sum = 0;
  for(let i=0;i<coords.length-1;i++){
    sum += haversineKm(coords[i], coords[i+1]);
  }
  return sum;
}

/*  âœ… Preferred: get road route from OSRM and return { distanceKm, pathLatLngs } */
async function fetchOsrmRoute(latlngPoints, mode){
  try{
/*      latlngPoints ç›®å‰åœ¨ renderDayRouteCard çµ¦çš„æ˜¯ [{lat,lng}, ...] */
    const pts = (latlngPoints || [])
      .map(normalizeLatLng)     /*  -> {lat,lng} */
      .filter(Boolean);

    if(pts.length < 2) return null;

/*      OSRM éœ€è¦ lon,lat */
    const coords = pts.map(p => `${p.lng},${p.lat}`).join(';');

/*      OSRM demo server profiles: driving / walking / cycling */
    const m = (mode || 'drive').toLowerCase();
    const profile = (m === 'walk') ? 'walking' : 'driving';

    const url = `https://router.project-osrm.org/route/v1/${profile}/${coords}?overview=full&geometries=geojson`;

    const r = await fetch(url);
    const j = await r.json();

    if(!j || j.code !== 'Ok' || !j.routes || !j.routes[0]) return null;

    const distKm = (j.routes[0].distance || 0) / 1000;

/*      è½‰æˆ [{lat,lng}, ...]ï¼ˆè·Ÿä½ å…¶ä»–åœ°æ–¹ä¸€è‡´ï¼ŒrenderRouteMiniMap æ‰èƒ½ç•«ã€Œé“è·¯æ›²ç·šã€ï¼‰ */
    const line = j.routes[0]?.geometry?.coordinates || [];
    const pathLatLngs = line.map(([lon, lat]) => ({ lat, lng: lon }));

    return { distanceKm: distKm, pathLatLngs };
  }catch(e){
    console.warn('OSRM route failed', e);
    return null;
  }
}


function buildOsmStaticThumb(center, zoom, points){
/*
     OSM éœæ…‹åœ°åœ–æœå‹™ï¼ˆå… keyï¼‰
     éœ€è¦ centerï¼Œå¦å‰‡å°±ç”¨ç¬¬ä¸€å€‹é»ï¼ˆè‹¥æ˜¯åº§æ¨™å¯ç”¨ï¼‰æˆ– fallback ä¸€å¼µ placeholder
*/
    const base = 'https://staticmap.openstreetmap.fr/staticmap.php';

    const c = (center && center.includes(',')) ? center : null;

/*      markersï¼šæœ€å¤šå»ºè­°æ”¾ 5 å€‹ï¼Œä¸ç„¶ URL å¤ªé•·ï¼ˆä½ è¦æ›´å¤šé»å°±åªæ”¾èµ·è¨–ï¼‰ */
    const mk = [];
    const pick = points.length <= 5 ? points : [points[0], points[points.length-1]];

/*      è‹¥ pick æ˜¯ "lat,lng" æ‰èƒ½ç•¶ markerï¼›è‹¥æ˜¯æ–‡å­—åœ°å€ OSM éœæ…‹åœ–æ²’è¾¦æ³•åœ°ç†ç·¨ç¢¼ */
    pick.forEach(p=>{
      if(/^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/.test(p)){
        mk.push(`&markers=${encodeURIComponent(p)},lightblue1`);
      }
    });

/*      æ²’ center åˆæ²’æœ‰åº§æ¨™ marker â†’ çµ¦ä¸€å¼µæ·¡åº•åœ–ï¼ˆé¿å… broken imageï¼‰ */
    if(!c && mk.length === 0){
      return 'data:image/svg+xml,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="800" height="450">
          <rect width="100%" height="100%" fill="#f3f1ee"/>
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
            fill="#9a938a" font-size="24" font-family="system-ui, -apple-system">
            è«‹åœ¨ route.preview.center è¨­å®šåº§æ¨™
          </text>
        </svg>`
      );
    }

    const centerParam = c ? `center=${encodeURIComponent(c)}&zoom=${encodeURIComponent(zoom)}` : '';
    return `${base}?${centerParam}&size=800x450&maptype=mapnik${mk.join('')}`;
  }

  let __routeMap = null;

  
function renderRouteMiniMap(pathLatLngs, stopLatLngs, fallbackCenterStr, zoom){
  if(!window.L) return;

  const container = document.getElementById('routeMiniMap');
  if(!container) return;

/*    reset old map instance */
  if(window.__routeMap){
    try{ window.__routeMap.remove(); }catch(e){}
    window.__routeMap = null;
  }

  const centerObj = parseLatLng(fallbackCenterStr) || stopLatLngs?.[0] || pathLatLngs?.[0] || {lat:34.25, lng:134.105};
  const map = L.map(container, {
    zoomControl:false,
    attributionControl:false,
    dragging:false,
    scrollWheelZoom:false,
    doubleClickZoom:false,
    boxZoom:false,
    keyboard:false,
    tap:false
  }).setView([centerObj.lat, centerObj.lng], zoom || 11);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

/*    --- route line (ç”¨ OSRM çš„é“è·¯ polyline æœƒæ›´åƒ Google é‚£ç¨®èµ°æ³•) --- */
  if(Array.isArray(pathLatLngs) && pathLatLngs.length >= 2){
    const line = L.polyline(pathLatLngs.map(p=>[p.lat,p.lng]), {
      weight: 5,
      opacity: .95,
      lineCap: 'round',
      lineJoin: 'round'
    }).addTo(map);

/*      subtle outline */
    L.polyline(pathLatLngs.map(p=>[p.lat,p.lng]), {
      weight: 10,
      opacity: .18,
      lineCap: 'round',
      lineJoin: 'round'
    }).addTo(map);

    try{ map.fitBounds(line.getBounds(), {padding:[14,14]}); }catch(e){}
  }else if(Array.isArray(stopLatLngs) && stopLatLngs.length >= 2){
    const line = L.polyline(stopLatLngs.map(p=>[p.lat,p.lng]), { weight: 4, opacity: .75 }).addTo(map);
    try{ map.fitBounds(line.getBounds(), {padding:[14,14]}); }catch(e){}
  }

/*    --- stop markers (åªæ”¾åœé é»ï¼Œä¸è¦æŠŠæ•´æ¢ polyline æ¯é»éƒ½è®Š marker) --- */
  (stopLatLngs || []).forEach((p, i)=>{
    const isStart = (i === 0);
    const isEnd   = (i === (stopLatLngs.length - 1));
    const cls = isStart ? 'rm-start' : (isEnd ? 'rm-end' : 'rm-stop');

    const icon = L.divIcon({
      className: `rm-pin ${cls}`,
      html: `<span>${isStart ? 'S' : (isEnd ? 'G' : (i))}</span>`,
      iconSize: [24,24],
      iconAnchor: [12,12]
    });
    L.marker([p.lat, p.lng], { icon }).addTo(map);
  });

  window.__routeMap = map;
}


async function renderWeatherJMA(meta){
        const el = document.getElementById('weatherStrip');
        if(!el) return;

/*          ä½ æƒ³è¦ 01:00~24:00 */
        const pad2 = (n)=>String(n).padStart(2,'0');

/*
         âœ… 16 å¤©é™åˆ¶ï¼šå¦‚æœæ—¥æœŸå¤ªé ï¼Œé¡¯ç¤ºæç¤ºï¼ˆé¿å…ä½ è¦ºå¾—â€œä¸å‡†â€ï¼‰
         é€™è£¡ç”¨ã€Œä»Šå¤©ã€å°æ¯” meta.file è£¡çš„ YYYY-MM-DDï¼ˆå¦‚æœä½ ä¸æƒ³ä¾è³´ fileï¼Œå¯æ”¹ä½ è‡ªå·±çš„ date_rangeï¼‰
*/
        const m = String(meta?.file || '').match(/\d{4}-\d{2}-\d{2}/);
        const iso = m ? m[0] : '';
        if(!iso){
            el.innerHTML = `<div style="padding:10px; color:var(--ink2); font-weight:900;">æ‰¾ä¸åˆ°æ—¥æœŸï¼ˆmeta.file éœ€åŒ…å« YYYY-MM-DDï¼‰</div>`;
            return;
        }

        const today = new Date();
        const target = new Date(iso + 'T00:00:00');
        const diffDays = Math.floor((target - new Date(today.getFullYear(), today.getMonth(), today.getDate())) / 86400000);

        if(diffDays < 0 || diffDays > 16){
            el.innerHTML = `<div style="padding:10px; color:var(--ink2); font-weight:900; line-height:1.5;">
            é€æ™‚é å ±åªæä¾›æœªä¾† 16 å¤©ã€‚<br/>
            ï¼ˆç›®å‰é»é¸æ˜¯ <b>${iso}</b>ï¼‰
            </div>`;
            return;
        }

        const ll = getLatLonForMeta(meta);
        if(!ll){
            el.innerHTML = `<div style="padding:10px; color:var(--ink2); font-weight:900; line-height:1.5;">
            å°šæœªè¨­å®šç¶“ç·¯åº¦ï¼šè«‹åœ¨ <code>data/itinerary.index.json</code> é€™ä¸€å¤©åŠ  <code>lat</code> / <code>lon</code>
            </div>`;
            return;
        }

        const url =
            `https://api.open-meteo.com/v1/jma?latitude=${encodeURIComponent(ll.lat)}&longitude=${encodeURIComponent(ll.lon)}`
            + `&hourly=temperature_2m,weather_code`
            + `&forecast_days=16`
            + `&timezone=Asia%2FTokyo`;

        try{
            const data = await fetch(url).then(r=>r.json());
            const times = data?.hourly?.time || [];
            const temps = data?.hourly?.temperature_2m || [];
            const codes = data?.hourly?.weather_code || [];

            const rows = [];
            for(let h=1; h<=24; h++){
            const hh = (h === 24) ? 0 : h;
            const day = (h === 24) ? new Date(target.getTime() + 86400000) : target;
            const y = day.getFullYear();
            const mo = pad2(day.getMonth()+1);
            const d = pad2(day.getDate());
            const tKey = `${y}-${mo}-${d}T${pad2(hh)}:00`;

            const idx = times.indexOf(tKey);
            if(idx === -1){
                rows.push({ time: pad2(h)+':00', icon:'fa-minus', temp:'â€”' });
                continue;
            }
            const icon = wmoToFa(Number(codes[idx] ?? 0), hh);
            const temp = temps[idx] != null ? Math.round(temps[idx]) + 'Â°' : 'â€”';
            rows.push({ time: pad2(h)+':00', icon, temp });
            }

            el.innerHTML = rows.map(r=>`
            <div class="weather-hour">
                <div class="w-time">${r.time}</div>
                <div class="w-icon"><i class="fas ${r.icon}"></i></div>
                <div class="w-temp">${r.temp}</div>
            </div>
            `).join('');
        }catch(e){
            el.innerHTML = `<div style="padding:10px; color:var(--ink2); font-weight:900;">
            è®€å–å¤©æ°£å¤±æ•—ï¼ˆç¶²è·¯/CORS/æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼‰
            </div>`;
        }
    }



  function buildGoogleDirUrlForItem(item){
/*      route itemï¼šç”¨ directions */
    const r = item?.route;
    if(r?.from && r?.to){
      const tm = travelModeForRoute(r.mode);
      return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(r.from)}&destination=${encodeURIComponent(r.to)}&travelmode=${tm}`;
    }
/*      ä¸€èˆ¬æ™¯é»ï¼šç”¨ search */
    return buildGoogleNavUrl(item);
  }

  function normalizeAssetUrl(src){
    const s = String(src || '').trim();
    if(!s) return '';
/*      å¤–éƒ¨é€£çµ / base64 ä¸å‹• */
    if(/^https?:\/\//i.test(s) || s.startsWith('data:')) return s;
/*      ä»¥ / é–‹é ­ï¼šæ”¹æˆç›¸å°è·¯å¾‘ï¼Œè®“å®ƒè·Ÿ index.html åŒå±¤é–‹å§‹æ‰¾ */
    return s.startsWith('/') ? ('.' + s) : s;
  }

  if(!window.__modalBound){
    window.__modalBound = true;
    document.getElementById('modalSheet')?.addEventListener('click', (e) => {
      const speakBtn = e.target.closest?.('.menuSpeak');
      if(speakBtn){
        e.stopPropagation();
        const text = speakBtn.getAttribute('data-speak') || '';
        speakJapanese(text);
        return;
      }
      const pill = e.target.closest?.('.menuPill');
      if(!pill) return;
      const isRec = pill.getAttribute('data-rec') === '1';
      if(!isRec) return;
      const idx = Number(pill.getAttribute('data-menu-idx'));
      const m = window.__activeModalItem?.menu?.[idx];
      if(m) openMenuCard(m);
    });
  }




/*    ====== Modalï¼šé è¨ˆåˆ°é”/åœ°å€/åœè»Š/Mapcode/ä»‹ç´¹ + Google å°èˆª ====== */
  function openModal(itemIdx) {
    const item = currentDayData?.items?.[itemIdx];
    if(!item) return;
    window.__activeModalItem = item;


    const hours = item.hours ? `<span class="pill"><i class="fas fa-clock"></i> ${escapeHtml(item.hours)}</span>` : '';
    const price = item.price ? `<span class="pill"><i class="fas fa-ticket"></i> ${escapeHtml(item.price)}</span>` : '';
    const stay  = item.stay  ? `<span class="pill"><i class="fas fa-hourglass-half"></i> ${escapeHtml(item.stay)}</span>` : '';

    const guideList = (item.guide || []).length
      ? `<div class="block"><h4><i class="fas fa-headset"></i> ç‰¹è‰²ä»‹ç´¹</h4><ul class="bullet">${item.guide.map(x=>`<li>${escapeHtml(x).replace(/\n/g,'<br>').replace(/^\[(.+?)\]ï¼š/,'<strong>[$1]ï¼š</strong>')}</li>`).join('')}</ul></div>`
      : '';

    const avoidList = (item.avoid || []).length
      ? `<div class="block"><h4><i class="fas fa-triangle-exclamation"></i> æ³¨æ„äº‹é …</h4><ul class="bullet">${item.avoid.map(x=>`<li>${escapeHtml(x).replace(/\n/g,'<br>').replace(/^\[(.+?)\]ï¼š/,'<strong>[$1]ï¼š</strong>')}</li>`).join('')}</ul></div>`
      : '';

    const menuBlock = (item.menu || []).length ? `
      <div class="menu-box">
        <div class="menu-box-head">
          <i class="fas fa-thumbs-up"></i> å¿…åƒç¾é£Ÿ
        </div>
        <div class="menu-table">
          ${(item.menu || []).map((m, idx) => {
            const jpRaw = (m.jp || '');
            const jp = escapeHtml(jpRaw);
            const zh = escapeHtml(m.zh || '');
            const isRec = m.rec === true || m.recommend === true;

/*              âœ… åªè®“æ¨è–¦çš„é …ç›®å¯ä»¥é»é–‹ï¼ˆç¶­æŒä½ åŸæœ¬é‚è¼¯ï¼‰ */
            const pillCls = `menu-row ${isRec ? 'menuPill' : ''}`;

            return `
              <div class="${pillCls}" data-menu-idx="${idx}" data-rec="${isRec ? '1':'0'}">
                <div class="menu-jp">
                  <button class="menuSpeak" type="button" data-speak="${escapeHtml(m.speak || jpRaw)}" aria-label="speak">
                    <i class="fas fa-volume-up"></i>
                  </button>
                  <span>${jp}</span>
                </div>
                <div class="menu-zh">${zh}</div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    ` : '';


    const reserveBlock = (item.reservations || []).length
      ? `<div class="block">
            <h4><i class="fas fa-receipt"></i> é ç´„è³‡è¨Š</h4>
            ${(item.reservations||[]).map(r=>`
                <div class="meta-row" style="padding:6px 0; border-bottom:1px dashed rgba(233,225,214,.85);">
                <span class="meta-ico"><i class="fas fa-hashtag"></i></span>
                <span class="meta-val"><b>${escapeHtml(r.label||'')}</b>ï¼š${escapeHtml(r.value||'')}</span>
                <button class="mini-btn" onclick="copyText('${escapeHtml(r.value||'')}')">è¤‡è£½</button>
                </div>
            `).join('')}
        </div>`
    : '';							

    const detailText = item.detail || item.desc || '';

/*      âœ… æ”¯æ´ links æ˜¯ã€Œç‰©ä»¶ã€æˆ–ã€Œé™£åˆ—åŒ…ä¸€å€‹ç‰©ä»¶ã€ */
    const links = Array.isArray(item.links) ? (item.links[0] || {}) : (item.links || {});

/*      âœ… ç”¨ JSON.stringify é¿å…å¼•è™Ÿ/ç‰¹æ®Šå­—å…ƒæŠŠ onclick æ’çˆ† */
    const linkBtns = [
        links.official ? `<button class="btn btn-outline" onclick='openUrl(${JSON.stringify(String(links.official))})'>å®˜ç¶²</button>` : '',
        links.reserve  ? `<button class="btn btn-outline" onclick='openUrl(${JSON.stringify(String(links.reserve))})'>reserveseat</button>` : '',
        links.menu     ? `<button class="btn btn-outline" onclick='openUrl(${JSON.stringify(String(links.menu))})'>meun</button>` : '',
        links.cupon    ? `<button class="btn btn-outline" onclick='openUrl(${JSON.stringify(String(links.cupon))})'>cupon</button>` : '',
        links.floormap      ? `<button class="btn btn-outline" onclick='openUrl(${JSON.stringify(String(links.floormap))})'>æ¨“å±¤åœ°åœ–</button>` : '',
    ].filter(Boolean).join('');

    const linkBtnsHtml = linkBtns ? `<div class="link-grid">${linkBtns}</div>` : '';

/*      âœ… ä½ è¦çš„æ¬„ä½ï¼ˆeta/arrive/arrival çš†å¯ï¼‰ */
    const eta = item.eta || item.arrive || item.arrival || '';
    const addr = item.addr || '';
    const parking = item.parking || '';
    const mapcode = item.mapcode || '';

    const navUrl = buildGoogleDirUrlForItem(item);

    const sticky = document.getElementById('modalSticky');
    const body   = document.getElementById('modalBody');

    sticky.innerHTML = `
        <div class="modal-sticky-wrap ${tagClass(item.tag)}">
            <div class="sheet-head">
                <div class="tag-chip ${tagClass(item.tag)}">
                    <div class="sheet-tag ${tagClass(item.tag)}">
                      ${escapeHtml((item.tag||'').toUpperCase())}
                      ${((item.tag||'').toLowerCase()==='takagi') ? getTagIconHtml('takagi', itemIdx) : ''}
                    </div>
                </div>
            <div class="sheet-time"><i class="fa-regular fa-clock" style="color:#8B8175;"></i>${escapeHtml(item.time || 'â€”')}</div>
            </div>

            <div class="modal-title">${escapeHtml(item.title || '')}</div>

            <div class="pill-row">
            ${hours}${price}${stay}
            </div>
        </div>
    `;



    body.innerHTML = `
      <div class="meta-box">
        ${eta ? `
        <div class="meta-row">
          <span class="meta-ico"><i class="fa-regular fa-clock"></i></span>
          <span class="meta-val">é è¨ˆåˆ°é”ï¼š${escapeHtml(eta)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(eta)}')">è¤‡è£½</button>
        </div>` : ''}

        ${addr ? `
        <div class="meta-row">
          <span class="meta-ico"><i class="fas fa-location-dot"></i></span>
          <span class="meta-val">${escapeHtml(addr)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(addr)}')">è¤‡è£½</button>
        </div>` : ''}

        ${parking ? `
        <div class="meta-row">
          <span class="meta-ico"><i class="fas fa-square-parking"></i></span>
          <span class="meta-val">${escapeHtml(parking)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(parking)}')">è¤‡è£½</button>
        </div>` : ''}

        ${mapcode ? `
        <div class="meta-row">
          <span class="meta-ico">ğŸ—¾</span>
          <span class="meta-val">Mapcodeï¼š${escapeHtml(mapcode)}</span>
          <button class="mini-btn" onclick="copyText('${escapeHtml(mapcode)}')">è¤‡è£½</button>
        </div>` : ''}

        ${(!eta && !addr && !parking && !mapcode) ? `
        <div class="meta-row">
          <span class="meta-ico">â„¹ï¸</span>
          <span class="meta-val">ï¼ˆæ­¤è¡Œç¨‹å°šæœªå¡«ï¼šåˆ°é”/åœ°å€/åœè»Š/Mapcodeï¼‰</span>
        </div>` : ''}
      </div>
      ${reserveBlock}	 
      ${menuBlock}
      <div class="detail">${escapeHtml(detailText)}</div>

      ${avoidList}
      ${guideList}
      ${linkBtnsHtml}


      


      <div class="sheet-actions">
        <a class="btn-primary" href="${navUrl}" target="_blank" rel="noopener">
          <i class="fas fa-location-arrow"></i> é–‹å•Ÿ Google Maps å°èˆª
        </a>
      </div>`;

    lockBodyScroll();
    document.getElementById('modalOverlay').classList.add('active');
    document.getElementById('modalSheet').classList.add('active');
    showSheetSplash(item);

/*
    // === menu pill click + å–‡å­ clickï¼šäº‹ä»¶å§”æ´¾ï¼ˆåªç¶ä¸€æ¬¡ï¼‰===
    // document.getElementById('modalSheet')?.addEventListener('click', (e) => {
    //   const speakBtn = e.target.closest?.('.menuSpeak');
    //   if(speakBtn){
    //     e.stopPropagation();
    //     const text = speakBtn.getAttribute('data-speak') || '';
    //     speakJapanese(text);
    //     return;
    //   }

    //   const pill = e.target.closest?.('.menuPill');
    //   if(!pill) return;

    //   const isRec = pill.getAttribute('data-rec') === '1';
    //   if(!isRec) return; // ä¸æ˜¯æ¨è–¦å°±ä¸é–‹å¡

    //   const idx = Number(pill.getAttribute('data-menu-idx'));
    //   const m = window.__activeModalItem?.menu?.[idx];
    //   if(m) openMenuCard(m);
    // });
*/

  }

/*
  // function openRouteMap(ev, idx){
  //   ev?.stopPropagation?.();

  //   const item = currentDayData?.items?.[idx];
  //   if(!item) return;

  //   const r = item.route || {};
  //   const from = r.from || '';
  //   const to   = r.to || '';
  //   if(!to) return;

  //   const mode = (r.mode || 'drive').toLowerCase();
  //   const travelmode =
  //     mode === 'walk'  ? 'walking' :
  //     mode === 'train' ? 'transit' :
  //     mode === 'ship'  ? 'transit' :
  //     mode === 'plane' ? 'transit' :
  //     'driving';

  //   window.open(
  //     `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(from)}&destination=${encodeURIComponent(to)}&travelmode=${travelmode}`,
  //     '_blank',
  //     'noopener'
  //   );
  // }
*/
  function openRouteMap(ev, idx){
    ev?.stopPropagation?.();
    const item = currentDayData?.items?.[idx];
    if(!item?.route) return;

    const r = item.route;
    const tm = travelModeForRoute(r.mode);
/*     window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(r.from||'')}&destination=${encodeURIComponent(r.to||'')}&travelmode=${tm}`,
	    '_blank', 'noopener'); */
    window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(r.from||'')}&destination=${encodeURIComponent(r.to||'')}&travelmode=${tm}`, '_blank', 'noopener');
  }

  let __closingModal = false;

/* âœ… ä¿®æ­£å¾Œçš„ closeModalï¼šç¢ºä¿èƒŒæ™¯ 100% åŒæ­¥å›æ­¸é€æ˜ */
/* âœ… ä¿®æ­£å¾Œçš„ closeModalï¼šæ¶ˆé™¤èƒŒæ™¯é–ƒçˆ */
/* âœ… æœ€çµ‚ä¿®æ­£ç‰ˆï¼šç¢ºä¿èƒŒæ™¯ 100% é›¶å»¶é²åŒæ­¥å›æ­¸é€æ˜ */
  function closeModal(){
    if(__closingModal) return;
    __closingModal = true;

    const overlay = document.getElementById('modalOverlay');
    const sheet   = document.getElementById('modalSheet');

    /* ğŸ’¡ BIOS é‚è¼¯ï¼šè¨­å®šæ˜ç¢ºçš„è½‰ç§»æ™‚é–“ï¼Œä¸¦ç›´æ¥å°‡æ•¸å€¼å¯«å…¥æš«å­˜å™¨ */
    const duration = "0.28s";
    const easing = "cubic-bezier(0.16, 1, 0.3, 1)";
    
    sheet.style.transition = `transform ${duration} ${easing}`;
    overlay.style.transition = `opacity ${duration} ease`;
    
    /* æ ¸å¿ƒï¼šå°‡çµ‚é»ç‹€æ…‹æ˜ç¢ºå¯«æ­»ï¼Œä¸è®“ CSS Class ä»‹å…¥ */
    sheet.style.transform = 'translateX(-50%) translateY(120%)';
    overlay.style.opacity = '0';

    hideSheetSplash();
    
    /* å»¶å¾Œç§»é™¤ Active é¡åˆ¥ï¼Œåƒ…ä½œç‚ºç‹€æ…‹ç´€éŒ„ */
    setTimeout(() => {
        sheet.classList.remove('active');
        overlay.classList.remove('active');
        closeMenuCard();
    }, 10);

    const done = ()=>{
      /* å‹•ç•«çµæŸå¾Œæ¸…ç©ºæ‰€æœ‰æš«å­˜ï¼Œæ¢å¾©åˆ°ç´”æ·¨çš„ CSS ç‹€æ…‹ */
      sheet.style.cssText = '';
      overlay.style.cssText = '';
      unlockBodyScroll();
      __closingModal = false;
    };

    /* ä½¿ç”¨ once: true ç¢ºä¿äº‹ä»¶åªè§¸ç™¼ä¸€æ¬¡ */
    sheet.addEventListener('transitionend', done, { once: true });
    setTimeout(done, 350); 
  }

  function showUserDetail(userName) {
    const userExpenses = expenses.filter(e => e.payer === userName || e.participants.includes(userName));
    let html = `<div style="padding:10px;">`;
    userExpenses.forEach(e => {
      const isPayer = e.payer === userName;
      const symbol = e.currency === 'TWD' ? '$' : 'Â¥';
      html += `<div style="margin-bottom:10px; border-bottom:1px dashed #DDD; padding-bottom:5px;">
        <div style="font-weight:800;">${e.name} (${e.currency})</div>
        <div style="font-size:0.85rem; color:#666;">${isPayer ? 'ä½ ä»˜äº†' : 'ä½ åˆ†æ”¤'} ${symbol}${e.cost}</div>
      </div>`;
    });
    html += `</div>`;

    // å¡«å…¥æ‚¨ç¾æœ‰çš„ Modal
    document.getElementById('modalSticky').innerHTML = `<div class="modal-title">${userName} çš„å€‹äººæ˜ç´°</div>`;
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalOverlay').classList.add('active');
    document.getElementById('modalSheet').classList.add('active');
  }


  function openMenuCard(m){
    const card = document.getElementById('menuCard');
    if(!card) return;

    card.hidden = false;
    card.querySelector('.menuCardJp').textContent = m.jp || '';
    card.querySelector('.menuCardZh').textContent = m.zh || '';
    card.querySelector('.menuCardNote').textContent = m.note || '';

    const img = card.querySelector('.menuCardImg');
    if(m.img){
      img.src = m.img;
      img.style.display = 'block';
    }else{
      img.removeAttribute('src');
      img.style.display = 'none';
    }
    const desc = m.desc || m.note || m.detail || m.intro || '';
    


    const closeBtn = card.querySelector('.menuCardClose');
    closeBtn.onclick = closeMenuCard;
  }

  function closeMenuCard(){
    const card = document.getElementById('menuCard');
    if(card) card.hidden = true;
  }

  function speakJapanese(text){
    if(!text) return;
    if(!('speechSynthesis' in window)) return;

    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'ja-JP';

/*      å˜—è©¦æŒ‘ ja-JP voiceï¼ˆæœ‰çš„ç€è¦½å™¨è¦ voiceschanged å¾Œæ‰æ‹¿å¾—åˆ°ï¼‰ */
    const pickVoice = () => {
      const vs = window.speechSynthesis.getVoices?.() || [];
      const v = vs.find(v => (v.lang||'').toLowerCase().startsWith('ja'));
      if(v) u.voice = v;
      window.speechSynthesis.speak(u);
    };

    const voices = window.speechSynthesis.getVoices?.() || [];
    if(voices.length) pickVoice();
    else window.speechSynthesis.onvoiceschanged = pickVoice;
  }



/*    ===== Modal drag to close ===== */
/* âœ… ä¿®æ­£å¾Œçš„ initModalDragï¼šå¢åŠ å°å…§å®¹æ²å‹•ç‹€æ…‹çš„æ„ŸçŸ¥ */
/* âœ… å„ªåŒ–å¾Œçš„ initModalDragï¼šå¾¹åº•è§£æ±ºå…§å®¹å€ä¸‹æ‹‰æ™ƒå‹•å•é¡Œ */
/* âœ… å„ªåŒ–å¾Œçš„ initModalDragï¼šå¾¹åº•è§£æ±ºå…§å®¹å€ä¸‹æ‹‰é—œé–‰å¤±æ•ˆèˆ‡æŠ–å‹• */
/* âœ… å„ªåŒ–å¾Œçš„ initModalDragï¼šè§£æ±ºæ‰‹æ©Ÿç«¯ä¸‹æ‹‰å¤±æ•ˆ */
/* âœ… æœ€çµ‚ä¿®æ­£ç‰ˆï¼šå…¨åŸŸé–å®šè§£æ±ºæ‰‹æ©Ÿä¸‹æ‹‰æŠ–å‹• */
  (function initModalDrag(){
    const sheet   = document.getElementById('modalSheet');
    const overlay = document.getElementById('modalOverlay');
    const handle  = document.querySelector('.modal-header');
    const scrollArea = document.getElementById('modalScroll');
  
    if(!sheet || !overlay || !handle || !scrollArea) return;
  
    let startY = 0, dy = 0, dragging = false;
  
    const onStart = (e) => {
      if(!sheet.classList.contains('active')) return;

      /* ğŸ’¡ åªæœ‰åœ¨æ¥è¿‘é ‚ç«¯æ™‚æ‰å•Ÿå‹•ä¸‹æ‹‰é—œé–‰ä¸­æ–· */
      if (scrollArea.scrollTop > 5 && e.target !== handle) return;

      dragging = true;
      startY = e.clientY;
      dy = 0;
      
      /* é—œéµï¼šç«‹å³é–å®šæŒ‡é‡ä¸¦ç¦æ­¢åŸç”Ÿæ²å‹• */
      sheet.setPointerCapture(e.pointerId);
      sheet.style.touchAction = 'none';
      scrollArea.style.touchAction = 'none';
    };
  
    const onMove = (e) => {
      if (!dragging) return;
  
      const deltaY = e.clientY - startY;
      
      /* åˆ¤å®šæ˜¯å¦çœŸçš„è¦ä¸‹æ‹‰ */
      if (deltaY < 0) {
          /* ä½¿ç”¨è€…å¾€ä¸Šæ¨ï¼Œé‡‹æ”¾æ§åˆ¶æ¬Šäº¤é‚„çµ¦æ²å‹•å¼•æ“ */
          dragging = false;
          sheet.style.touchAction = '';
          scrollArea.style.touchAction = 'pan-y';
          sheet.releasePointerCapture(e.pointerId);
          return;
      }

      /* âœ… å¼·åˆ¶æ””æˆªæ‰€æœ‰åŸç”Ÿè¡Œç‚ºï¼Œé˜²æ­¢æŠ–å‹• */
      if (e.cancelable) e.preventDefault(); 
      scrollArea.scrollTop = 0; 
      
      dy = deltaY;
      
      requestAnimationFrame(() => {
          sheet.style.transition = 'none';
          overlay.style.transition = 'none';
          sheet.style.transform = `translateX(-50%) translateY(${dy}px)`;
          
          /* èƒŒæ™¯éš¨ä½ç§»ç·šæ€§è®Šæ·¡ */
          const k = Math.max(0, 1 - dy / 450);
          overlay.style.opacity = (0.38 * k).toFixed(3);
      });
    };
  
    const onEnd = (e) => {
      if (!dragging) return;
      dragging = false;
      sheet.releasePointerCapture(e.pointerId);
      
      /* æ¢å¾©æ¨™æº–è§¸æ§æš«å­˜å™¨ */
      sheet.style.touchAction = '';
      scrollArea.style.touchAction = 'pan-y';
  
      if (dy > 120) {
        closeModal();
      } else {
        /* å›å½ˆç¨‹åº */
        sheet.style.transition = 'transform .25s cubic-bezier(0.16, 1, 0.3, 1)';
        overlay.style.transition = 'opacity .25s ease';
        sheet.style.transform = 'translateX(-50%) translateY(0)';
        overlay.style.opacity = '0.38'; 
      }
      dy = 0;
    };
  
    handle.addEventListener('pointerdown', onStart);
    scrollArea.addEventListener('pointerdown', onStart);
    sheet.addEventListener('pointermove', onMove, { passive: false });
    sheet.addEventListener('pointerup', onEnd);
    sheet.addEventListener('pointercancel', onEnd);
  })();

  function openUrl(url){
    window.open(url, '_blank', 'noopener');
  }

/*    ====== ä½å®¿/èˆªç­/è¨˜å¸³ï¼ˆæ²¿ç”¨ä½ åŸæœ¬é‚è¼¯ï¼‰ ====== */
  function renderHotels() {
    document.getElementById('hotelList').innerHTML = (HOTELS || []).map(h => {
      const dateText = h.stay ? `${h.stay.from} - ${h.stay.to}` : '';
      const img = (h.images && h.images[0]) ? h.images[0]
        : "https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&q=80&w=900";

      return `
        <div class="card" style="padding:0; overflow:hidden;">
          <img src="${escapeHtml(img)}" style="height:180px; width:100%; object-fit:cover; border-radius:20px; margin-bottom:0;">
          <div style="padding:20px;">
            <h3 style="margin:0 0 6px; font-family:'Noto Serif TC',serif; font-weight:900;">${escapeHtml(h.name || '')}</h3>
            <div style="color:var(--ink2); font-size:0.9rem; margin-bottom:10px; font-weight:800;">${escapeHtml(dateText)}</div>
            <div style="font-size:0.95rem; line-height:1.6; color:#444; font-weight:700;">
              ${escapeHtml(h.desc || '')}
            </div>
            ${h.mapcode ? `<div style="display:inline-block;background:rgba(255,235,238,.92);color:#B42318;padding:6px 10px;border-radius:999px;font-size:.82rem;font-weight:900;margin-top:10px;border:1px solid rgba(180,35,24,.15);">Mapcode: ${escapeHtml(h.mapcode)}</div>` : ''}
            <button class="btn btn-outline" style="margin-top:15px;" onclick="openUrl('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.name || '')}')">å°èˆª</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderFlights(){
    const el = document.getElementById('flightBoard');
    const out = FLIGHTS?.outbound;
    const inn = FLIGHTS?.inbound;

    el.innerHTML = [out, inn].filter(Boolean).map((f, idx) => {
      const isOut = idx === 0;
      const label = isOut ? `å»ç¨‹ ${mmdd(f.date)} (${weekdayZh(f.date)})` : `å›ç¨‹ ${mmdd(f.date)} (${weekdayZh(f.date)})`;
      const carrier = FLIGHTS?.carrier || '';
      const baggage = f.baggage ? `${f.baggage.checked || ''} / ${f.baggage.pieces || ''}ä»¶` : '';
      const terminal = f.from?.terminal ? `â€¢ ${f.from.terminal}` : '';

      return `
        <div class="boarding">
          <div class="boarding-top">
            <div class="row">
              <div class="boarding-badge"><i class="fas fa-plane"></i> ${escapeHtml(label)}</div>
              <div style="font-weight:900; color:#333;">${escapeHtml(f.flight_no || '')}</div>
            </div>
            <div style="margin-top:8px; color:var(--ink2); font-weight:800;">${escapeHtml(carrier)} â€¢ ${escapeHtml(f.aircraft || '')}</div>
          </div>

          <div class="boarding-mid">
            <div style="text-align:left;">
              <div class="code">${escapeHtml(f.from?.code || '')}</div>
              <div class="t">${escapeHtml(f.from?.city || '')} â€¢ ${escapeHtml(f.depart_time || '')} ${escapeHtml(terminal)}</div>
            </div>
            <i class="fas fa-arrow-right" style="color:#B9B2AA; font-size:1.1rem;"></i>
            <div style="text-align:right;">
              <div class="code">${escapeHtml(f.to?.code || '')}</div>
              <div class="t">${escapeHtml(f.to?.city || '')} â€¢ ${escapeHtml(f.arrive_time || '')}</div>
            </div>
          </div>

          <div class="boarding-bottom">
            <div><i class="fas fa-suitcase-rolling"></i> è¡Œæï¼š${escapeHtml(baggage)}</div>
            <div><i class="fas fa-plane-departure"></i> å‡ºç™¼ï¼š${escapeHtml(f.from?.city || '')} ${escapeHtml(f.from?.terminal || '')}</div>
            <div><i class="fas fa-plane-arrival"></i> æŠµé”ï¼š${escapeHtml(f.to?.city || '')}</div>
          </div>
        </div>
      `;
    }).join('');
  }

/*    ====== è¨˜å¸³ï¼ˆæ”¯æ´ï¼šåƒèˆ‡è€…å¤šé¸ / è¡Œä¸­ vs é ä»˜ï¼‰ ====== */
  let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
  let curCurrency = 'JPY';  // é è¨­æ—¥å¹£
  const JPY_TWD_RATE = 0.21; // æ‚¨å¯ä»¥æ ¹æ“šéœ€æ±‚ä¿®æ”¹åŒ¯ç‡
  let editingTs = null;      // è¿½è¹¤æ˜¯å¦æ­£åœ¨ç·¨è¼¯
  let curParticipants = new Set();
  let curExpenseType = 'trip';  /* 'trip' | 'prepaid' */
  /* ğŸ’¡ åœ¨ curCurrency = 'JPY' é™„è¿‘æ·»åŠ  */
  function setCurrency(curr) {
      curCurrency = curr;
      // æ›´æ–°æŒ‰éˆ• UI é«˜äº®ç‹€æ…‹
      document.querySelectorAll('#currencySwitch .seg-btn').forEach(btn => {
          btn.classList.toggle('active', btn.getAttribute('data-curr') === curr);
      });
      // é‡æ–°æ¸²æŸ“ï¼Œé€™æœƒè®“è¼¸å…¥æ¡†æˆ–åˆ—è¡¨å³æ™‚åæ‡‰
      renderExpenseUI(); 
  }
    

/*    å…¼å®¹èˆŠè³‡æ–™ï¼ˆæ²’æœ‰ participants/type æ™‚è£œä¸Šï¼‰ */
  function normalizeExpenses(){
    expenses = (Array.isArray(expenses) ? expenses : []).map(e => {
      const payer = (e?.payer || users[0] || 'L');
      const cost = Number(e?.cost);
      const name = String(e?.name || '').trim();
      const participants = Array.isArray(e?.participants) && e.participants.length
        ? e.participants.filter(x => users.includes(x))
        : users.slice();
      const type = (e?.type === 'prepaid') ? 'prepaid' : 'trip';
      return {
        name,
        cost: Number.isFinite(cost) ? cost : 0,
        payer,
        participants,
        type,
        ts: e?.ts || Date.now(),
        currency: e?.currency || 'JPY'  /* âœ… è£œä¸Šé€™è¡Œï¼Œç¢ºä¿å¹£åˆ¥è³‡æ–™è¢«ä¿ç•™ */
      };
    }).filter(e => e.name && e.cost > 0);
    localStorage.setItem('expenses', JSON.stringify(expenses));
  }

  function setExpenseType(type){
    curExpenseType = (type === 'prepaid') ? 'prepaid' : 'trip';
    renderExpenseUI();
  }

  function toggleParticipant(u){
    if(curParticipants.has(u)){
/*        è‡³å°‘ç•™ 1 å€‹ */
      if(curParticipants.size <= 1) return;
      curParticipants.delete(u);
    }else{
      curParticipants.add(u);
    }
    renderExpenseUI();
  }

  function renderExpenseUI() {
    /* 1. åˆå§‹åŒ–åƒèˆ‡è€…ï¼šé è¨­å…¨é¸ */
    if (curParticipants.size === 0) {
      users.forEach(u => curParticipants.add(u));
    }

    /* 2. ä»˜æ¬¾äººåˆ‡æ› (Payer Tabs) */
    const payerSwitchEl = document.getElementById('payerSwitch');
    if (payerSwitchEl) {
      payerSwitchEl.innerHTML = users.map(u =>
        `<div class="user-tab ${u === curPayer ? 'active' : ''}" onclick="curPayer='${u}'; renderExpenseUI();">${escapeHtml(u)}</div>`
      ).join('');
    }
    /* âœ… æ–°å¢ 2.5ï¼šåŒæ­¥å¹£åˆ¥åˆ‡æ›æŒ‰éˆ•çš„é«˜äº®ç‹€æ…‹ */
    const currEl = document.getElementById('currencySwitch');
    if (currEl) {
      currEl.querySelectorAll('.seg-btn').forEach(btn => {
        /* ğŸ’¡ æ ¹æ“šå…¨åŸŸè®Šæ•¸ curCurrency çš„å€¼ï¼Œæ±ºå®šå“ªå€‹æŒ‰éˆ•è©²æœ‰ active é¡åˆ¥ */
        const btnCurr = btn.getAttribute('data-curr');
        btn.classList.toggle('active', btn.getAttribute('data-curr') === curCurrency);
      });
    }

    /* 3. é¡å‹åˆ‡æ› (Type Segmented) */
    const typeEl = document.getElementById('expTypeSwitch');
    if (typeEl) {
      typeEl.querySelectorAll('.seg-btn').forEach(btn => {
        const t = btn.getAttribute('data-type');
        btn.classList.toggle('active', t === curExpenseType);
      });
    }

    /* 4. åƒèˆ‡è€…é¸æ“‡ (Participants Chips) */
    const partEl = document.getElementById('partSwitch');
    if (partEl) {
      partEl.innerHTML = users.map(u => {
        const on = curParticipants.has(u);
        return `<span class="chip ${on ? 'on' : 'off'}" onclick="toggleParticipant('${escapeHtml(u)}')">
          <i class="fas ${on ? 'fa-user-check' : 'fa-user'}" style="opacity:${on ? 0.55 : 0.35};"></i>${escapeHtml(u)}
        </span>`;
      }).join('');
    }

    /* 5. è¨ˆç®—ç¸½é¡ã€å°è¨˜èˆ‡å€‹äººçµç®— */
    let balJPY = {}, balTWD = {};
    let sumTripJPY = 0, sumPrepaidJPY = 0;
    let sumTripTWD = 0, sumPrepaidTWD = 0;
    
    users.forEach(u => { balJPY[u] = 0; balTWD[u] = 0; });

    expenses.forEach(e => {
      const parts = e.participants && e.participants.length ? e.participants : users;
      const share = e.cost / parts.length;
      const isTWD = (e.currency === 'TWD');

      // åˆ†å¹£åˆ¥çµ±è¨ˆå°è¨˜
      if (isTWD) {
        if (e.type === 'prepaid') sumPrepaidTWD += e.cost;
        else sumTripTWD += e.cost;
      } else {
        if (e.type === 'prepaid') sumPrepaidJPY += e.cost;
        else sumTripJPY += e.cost;
      }

      // å€‹äººçµç®—é‚è¼¯
      const targetBal = isTWD ? balTWD : balJPY;
      if (users.includes(e.payer)) targetBal[e.payer] += e.cost;
      parts.forEach(u => {
        if (users.includes(u)) targetBal[u] -= share;
      });
    });

    /* 6. æ¸²æŸ“è©³ç´°ç´€éŒ„æ¸…å–® */
    const listEl = document.getElementById('expenseList');
    if (listEl) {
      listEl.innerHTML = expenses
        .slice()
        .sort((a, b) => (b.ts || 0) - (a.ts || 0))
        .map((e) => {
          const parts = Array.isArray(e.participants) && e.participants.length ? e.participants : users;
          const typeLabel = e.type === 'prepaid' ? 'é ä»˜' : 'è¡Œä¸­';
          const typeCls = e.type === 'prepaid' ? 'prepaid' : 'trip';
          const symbol = e.currency === 'TWD' ? '$' : 'Â¥';
          const altSymbol = e.currency === 'TWD' ? 'Â¥' : '$';
          const altCost = e.currency === 'TWD' ? Math.round(e.cost / JPY_TWD_RATE) : Math.round(e.cost * JPY_TWD_RATE);
          
          return `
            <div style="display:flex; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px solid rgba(233,225,214,.8);">
              <div style="min-width:0;">
                <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                  <div style="font-weight:900;">${escapeHtml(e.name)}</div>
                  <span class="exp-badge ${typeCls}">${typeLabel}</span>
                </div>
                <div style="font-size:0.8rem; color:var(--ink2); font-weight:800; margin-top:4px;">
                  ${escapeHtml(e.payer)} ä»˜æ¬¾ Â· åˆ†æ”¤ï¼š${escapeHtml(parts.join('ã€'))}
                </div>
              </div>
              <div style="text-align:right; flex:0 0 auto;">
                <div style="font-weight:900;">${symbol}${e.cost}</div>
                <div style="font-size:0.75rem; color:#999; font-weight:700;">(${altSymbol}${altCost})</div>
                <div style="font-size:0.8rem; margin-top:4px;">
                  <span style="color:var(--accent); cursor:pointer; font-weight:900; margin-right:8px;" onclick="startEdit(${e.ts})">ç·¨è¼¯</span>
                  <span style="color:#B42318; cursor:pointer; font-weight:900;" onclick="delExpByTs(${e.ts})">åˆªé™¤</span>
                </div>
              </div>
            </div>`;
        }).join('');
    }

    /* 7. æ¸²æŸ“çµç®—æ¸…å–® (Debt List) */
    const debtEl = document.getElementById('debtList');
    if (debtEl) {
/*
      debtEl.innerHTML = users.map(u => `
        <div style="padding:10px 0; border-bottom:1px solid #EEE; cursor:pointer;" onclick="showUserDetail('${u}')">
          <div style="font-weight:900; color:var(--primary);">ğŸ‘¤ ${u} (é»æ“Šæ˜ç´°)</div>
          <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
            <span style="color:${balJPY[u] >= 0 ? '#2F8F5B' : '#B42318'}">æ—¥å¹£ï¼š${balJPY[u] >= 0 ? 'æ”¶' : 'ä»˜'} Â¥${Math.abs(Math.round(balJPY[u]))}</span>
            <span style="color:${balTWD[u] >= 0 ? '#2F8F5B' : '#B42318'}">å°å¹£ï¼š${balTWD[u] >= 0 ? 'æ”¶' : 'ä»˜'} $${Math.abs(Math.round(balTWD[u]))}</span>
          </div>
        </div>`).join('');
*/
      debtEl.innerHTML = users.map(u => {
        const jpyRounded = Math.round(balJPY[u]);
        const twdRounded = Math.round(balTWD[u]);
        
        // ğŸ’¡ åªæœ‰åœ¨é‡‘é¡ä¸ç‚º 0 æ™‚æ‰é¡¯ç¤ºè©²å¹£åˆ¥
        const jpyHtml = jpyRounded !== 0 ? `<span style="color:${jpyRounded > 0 ? '#2F8F5B' : '#B42318'}">æ—¥å¹£ï¼š${jpyRounded > 0 ? 'æ”¶' : 'ä»˜'} Â¥${Math.abs(jpyRounded)}</span>` : '';
        const twdHtml = twdRounded !== 0 ? `<span style="color:${twdRounded > 0 ? '#2F8F5B' : '#B42318'}">å°å¹£ï¼š${twdRounded > 0 ? 'æ”¶' : 'ä»˜'} $${Math.abs(twdRounded)}</span>` : '';

        return `
        <div style="padding:10px 0; border-bottom:1px solid #EEE; cursor:pointer;" onclick="showUserDetail('${u}')">
          <div style="font-weight:900; color:var(--primary);">ğŸ‘¤ ${u} (é»æ“Šæ˜ç´°)</div>
          <div style="display:flex; justify-content:space-between; font-size:0.9rem; gap:10px;">
            ${jpyHtml || '<span style="color:#999">æ—¥å¹£ï¼šå·²æ¸…</span>'}
            ${twdHtml || '<span style="color:#999">å°å¹£ï¼šå·²æ¸…</span>'}
          </div>
        </div>`;
      }).join('');
    }

    /* 8. æ¸²æŸ“å°è¨˜ (Summary) - å¢åŠ æ›ç®—ç¸½é¡ */
    const sumEl = document.getElementById('expenseSummary');
    if (sumEl) {
      // âœ… è¨ˆç®—æ›ç®—å¾Œçš„ç¸½å°å¹£æ”¯å‡º
      const grandTotalTWD = (sumTripTWD + sumPrepaidTWD) + (sumTripJPY + sumPrepaidJPY) * JPY_TWD_RATE;

      sumEl.innerHTML = `
        <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(233,225,214,.5); font-weight:900;">
          <span>è¡Œä¸­æ”¯å‡º</span>
          <div style="text-align:right;"><div>Â¥${Math.round(sumTripJPY)}</div><div style="font-size:0.8rem; color:#888;">$${Math.round(sumTripTWD)}</div></div>
        </div>
        <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(233,225,214,.5); font-weight:900;">
          <span>é ä»˜è²»ç”¨</span>
          <div style="text-align:right;"><div>Â¥${Math.round(sumPrepaidJPY)}</div><div style="font-size:0.8rem; color:#888;">$${Math.round(sumPrepaidTWD)}</div></div>
        </div>
        <div style="display:flex; justify-content:space-between; padding:8px 0; font-weight:900; color:var(--accent);">
          <span>é ä¼°ç¸½æ”¯å‡º (æ›ç®—å°å¹£)</span>
          <div style="text-align:right; font-size:1.2rem;">$${Math.round(grandTotalTWD)}</div>
        </div>
      `;
    }
  }

  // function renderExpenseUI() {
  //   /*      åˆå§‹åŒ– participantsï¼šé è¨­å…¨é¸ */
  //   if(curParticipants.size === 0){
  //     users.forEach(u => curParticipants.add(u));
  //   }

  //   /*      payer tabs */
  //   document.getElementById('payerSwitch').innerHTML = users.map(u =>
  //     `<div class="user-tab ${u===curPayer?'active':''}" onclick="curPayer='${u}'; renderExpenseUI();">${escapeHtml(u)}</div>`
  //   ).join('');

  //   /*      type segmented */
  //   const typeEl = document.getElementById('expTypeSwitch');
  //   if(typeEl){
  //     typeEl.querySelectorAll('.seg-btn').forEach(btn => {
  //       const t = btn.getAttribute('data-type');
  //       btn.classList.toggle('active', t === curExpenseType);
  //     });
  //   }

  //   /*      participants chips */
  //   const partEl = document.getElementById('partSwitch');
  //   if(partEl){
  //     partEl.innerHTML = users.map(u => {
  //       const on = curParticipants.has(u);
  //       return `<span class="chip ${on?'on':'off'}" onclick="toggleParticipant('${escapeHtml(u)}')">
  //         <i class="fas ${on?'fa-user-check':'fa-user'}" style="opacity:${on?0.55:0.35};"></i>${escapeHtml(u)}
  //       </span>`;
  //     }).join('');
  //   }

  //   /*      list */
  //   const listEl = document.getElementById('expenseList');
  //   if(listEl){
  //     listEl.innerHTML = expenses
  //       .slice()
  //       .sort((a,b)=> (b.ts||0) - (a.ts||0))
  //       .map((e,i) => {
  //         const parts = Array.isArray(e.participants) && e.participants.length ? e.participants : users;
  //         const typeLabel = e.type === 'prepaid' ? 'é ä»˜' : 'è¡Œä¸­';
  //         const typeCls = e.type === 'prepaid' ? 'prepaid' : 'trip';
  //         const symbol = e.currency === 'TWD' ? '$' : 'Â¥';
  //         const altSymbol = e.currency === 'TWD' ? 'Â¥' : '$';
  //         // ç°¡å–®æ›ç®—é‚è¼¯
  //         const altCost = e.currency === 'TWD' ? Math.round(e.cost / JPY_TWD_RATE) : Math.round(e.cost * JPY_TWD_RATE);
  //         return `
  //           <div style="display:flex; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px solid rgba(233,225,214,.8);">
  //             <div style="min-width:0;">
  //               <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
  //                 <div style="font-weight:900;">${escapeHtml(e.name)}</div>
  //                 <span class="exp-badge ${typeCls}"><i class="fas ${e.type==='prepaid'?'fa-receipt':'fa-bag-shopping'}" style="opacity:.55;"></i>${typeLabel}</span>
  //               </div>
  //               <div style="font-size:0.8rem; color:var(--ink2); font-weight:800; margin-top:4px;">
  //                 ${escapeHtml(e.payer)} ä»˜æ¬¾ Â· åˆ†æ”¤ï¼š${escapeHtml(parts.join('ã€'))}
  //               </div>
  //             </div>
  //             <div style="text-align:right; flex:0 0 auto;">
  //               <div style="font-weight:900;">${symbol}${e.cost}</div>
  //               <div style="font-size:0.75rem; color:#999; font-weight:700;">(${altSymbol}${altCost})</div>
  //               <div style="font-size:0.8rem; margin-top:4px;">
  //                 <span style="color:var(--accent); cursor:pointer; font-weight:900; margin-right:8px;" onclick="startEdit(${e.ts})">ç·¨è¼¯</span>
  //                 <span style="color:#B42318; cursor:pointer; font-weight:900;" onclick="delExpByTs(${e.ts})">åˆªé™¤</span>
  //               </div>
  //             </div>
  //           </div>
  //         `;
  //       }).join('');
  //   }

  //   // ä¿®æ”¹è¨ˆç®— bal çš„é‚è¼¯ï¼Œæ‹†æˆå…©çµ„
  //   let balJPY = {}, balTWD = {};
  //   let totalTripJPY = 0, totalPrepaidJPY = 0;
  //   let totalTripTWD = 0, totalPrepaidTWD = 0;
  //   users.forEach(u => { balJPY[u]=0; balTWD[u]=0; });

  //   expenses.forEach(e => {
  //     const parts = e.participants || users;
  //     const share = e.cost / parts.length;
  //     const targetBal = (e.currency === 'TWD') ? balTWD : balJPY; // ğŸ’¡ åˆ¤æ–·è¦åŠ åˆ°å“ªçµ„

  //     if(users.includes(e.payer)) targetBal[e.payer] += e.cost;
  //     parts.forEach(u => { if(users.includes(u)) targetBal[u] -= share; });
  //   });

  //   // æ¸²æŸ“æ™‚é¡¯ç¤ºå…©è¡Œ
  //   debtEl.innerHTML = users.map(u => {
  //     return `
  //       <div style="padding:10px 0; border-bottom:1px solid #EEE;" onclick="showUserDetail('${u}')">
  //         <div style="font-weight:900; color:var(--primary); cursor:pointer;">ğŸ‘¤ ${u} (é»æ“Šæ˜ç´°)</div>
  //         <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
  //           <span style="color:${balJPY[u]>=0?'#2F8F5B':'#B42318'}">æ—¥å¹£ï¼š${balJPY[u]>=0?'æ”¶':'ä»˜'} Â¥${Math.abs(Math.round(balJPY[u]))}</span>
  //           <span style="color:${balTWD[u]>=0?'#2F8F5B':'#B42318'}">å°å¹£ï¼š${balTWD[u]>=0?'æ”¶':'ä»˜'} $${Math.abs(Math.round(balTWD[u]))}</span>
  //         </div>
  //       </div>`;
  //   }).join('');
    

  //   /*      summary */
  //   const sumEl = document.getElementById('expenseSummary');
  //   if(sumEl){
  //     const totalAll = expenses.reduce((a,e)=>a+Number(e.cost||0),0);
  //     const totalTrip = expenses.filter(e=>e.type!=='prepaid').reduce((a,e)=>a+Number(e.cost||0),0);
  //     const totalPre = expenses.filter(e=>e.type==='prepaid').reduce((a,e)=>a+Number(e.cost||0),0);

  //     sumEl.innerHTML = `
  //       <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(233,225,214,.8); font-weight:900;">
  //         <span>è¡Œä¸­æ”¯å‡º</span><span>Â¥${Math.round(totalTrip)}</span>
  //       </div>
  //       <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(233,225,214,.8); font-weight:900;">
  //         <span>é ä»˜è²»ç”¨</span><span>Â¥${Math.round(totalPre)}</span>
  //       </div>
  //       <div style="display:flex; justify-content:space-between; padding:10px 0; font-weight:900;">
  //         <span>ç›®å‰ç¸½èŠ±è²»</span><span>Â¥${Math.round(totalAll)}</span>
  //       </div>
  //       <div style="margin-top:10px; color:var(--ink2); font-size:.86rem; font-weight:800; line-height:1.45;">
  //         âœ… åˆ†æ”¤è¦å‰‡ï¼šåªå°ã€Œåˆ†æ”¤æˆå“¡ã€å¹³å‡åˆ†æ”¤ï¼ˆå¯ 1 äººã€2â€“3 äººâ€¦ï¼‰ã€‚<br>
  //         âœ… é ä»˜è²»ç”¨ï¼šå¯å…ˆè¨˜æ©Ÿç¥¨ / é£¯åº— / é ç´„ç¥¨åˆ¸ï¼Œæ–¹ä¾¿æŒæ¡ç¸½é¡ã€‚
  //       </div>
  //     `;
  //   }
  // }

  function addExpense() {
    const name = document.getElementById('exName').value.trim();
    const cost = Number(document.getElementById('exCost').value);
    const participants = Array.from(curParticipants);
    
    if(!name || !Number.isFinite(cost) || cost<=0) return alert('è«‹è¼¸å…¥æ­£ç¢ºé …ç›®èˆ‡é‡‘é¡');
    if(participants.length<=0) return alert('è«‹è‡³å°‘é¸ä¸€ä½åˆ†æ”¤æˆå“¡');
  
/*      å»ºç«‹è³‡æ–™ç‰©ä»¶ */
    const expData = {
      name,
      cost: Math.round(cost),
      payer: curPayer,
      participants,
      type: curExpenseType,
      currency: curCurrency, // ğŸ’¡ ç´€éŒ„é€™ç­†éŒ¢æ˜¯æ—¥å¹£é‚„æ˜¯å°å¹£
      ts: editingTs || Date.now() // ğŸ’¡ å¦‚æœæ˜¯ç·¨è¼¯ï¼Œå»¶ç”¨èˆŠçš„æ™‚é–“æˆ³è¨˜
    };
    if (editingTs) {
      // ç·¨è¼¯æ¨¡å¼ï¼šå–ä»£èˆŠè³‡æ–™
      const idx = expenses.findIndex(e => e.ts === editingTs);
      if(idx !== -1) expenses[idx] = expData;
      editingTs = null; // é‡ç½®
      const btn = document.querySelector('#page-money .btn');
      if(btn) btn.innerText = "åŠ å…¥ç´€éŒ„";
      /* âœ… å„²å­˜å¾Œå°‡å…¨åŸŸç‹€æ…‹æ¢å¾©ç‚ºé è¨­ï¼Œé¿å…å½±éŸ¿ä¸‹ä¸€ç­† */
      curCurrency = 'JPY'; 
      curPayer = users[0] || 'L';
      curParticipants = new Set(users);
    } 
    else {
      // æ–°å¢æ¨¡å¼
      expenses.push(expData);
    }
  
    /*      1. å…ˆæ›´æ–°æœ¬åœ° UI (è®“ä½¿ç”¨è€…æ„Ÿè¦ºåæ‡‰å¾ˆå¿«) */
    localStorage.setItem('expenses', JSON.stringify(expenses));
    document.getElementById('exName').value = '';
    document.getElementById('exCost').value = '';
    renderExpenseUI();
  
    /*      2. å‚³é€åˆ°é›²ç«¯ */
    cloudPost("addExpense", expData);
    // æ¸…ç©ºè¼¸å…¥æ¡†
    document.getElementById('exName').value = '';
    document.getElementById('exCost').value = '';

  }

  /* ğŸ’¡ æ–°å¢ï¼šå•Ÿå‹•ç·¨è¼¯æ¨¡å¼çš„ Function */
  function startEdit(ts) {
    const e = expenses.find(exp => exp.ts === ts);
    if(!e) return;
    
    editingTs = ts;
    document.getElementById('exName').value = e.name;
    document.getElementById('exCost').value = e.cost;
    curPayer = e.payer;
    curCurrency = e.currency || 'JPY';
    curExpenseType = e.type || 'trip';
    curParticipants = new Set(e.participants);
    
    // ğŸ’¡ ä¿®æ­£ 1ï¼šè®Šæ›´æŒ‰éˆ•æ–‡å­—ä»¥æä¾›å›é¥‹
    const btn = document.querySelector('#page-money .btn');
    if(btn) btn.innerText = "æ›´æ–°ç´€éŒ„ (å–æ¶ˆè«‹é‡æ•´)";
    
    // ğŸ’¡ ä¿®æ­£ 2ï¼šç¢ºä¿é é¢æ²å›ã€Œæ–°å¢æ”¯å‡ºã€çš„å€å¡Š
    // å¦‚æœä½ æœ‰ä½¿ç”¨ header æˆ– paddingï¼Œæ²å‹•åˆ° 0 æˆ–æ˜¯è©² Card çš„ä½ç½®
    window.scrollTo({ top: 0, behavior: 'smooth' });
    renderExpenseUI();
  }

  function delExpByTs(ts) {
    const t = Number(ts);
    if (!Number.isFinite(t)) return;
  
/*      1. ä½¿ç”¨ç¢ºèªå°è©±æ¡† (å„ªåŒ–èªæ°£) */
    if (!confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œå°‡åŒæ­¥ç§»é™¤é›²ç«¯è³‡æ–™ã€‚')) return;
  
/*      2. æœ¬åœ°è³‡æ–™éæ¿¾ */
    const index = expenses.findIndex(e => Number(e.ts) === t);
    if (index === -1) return;
  
/*      å‚™ä»½ä¸€ä»½è³‡æ–™ï¼Œè¬ä¸€å¤±æ•—å¯ä»¥å›æ»¾ (BIOS å·¥ç¨‹å¸«ç¿’æ…£çš„å‚™æ´æ©Ÿåˆ¶) */
    const deletedItem = expenses[index];
    
/*      å…ˆå¾æœ¬åœ°é™£åˆ—ç§»é™¤ */
    expenses.splice(index, 1);
    localStorage.setItem('expenses', JSON.stringify(expenses));
    
/*      3. ç«‹å³åˆ·æ–° UI (Optimistic UI æ›´æ–°ï¼Œè®“ä½¿ç”¨è€…æ„Ÿè¦ºå¾ˆå¿«) */
    renderExpenseUI();
  
/*      4. åŒæ­¥è‡³é›²ç«¯ */
    fetch(G_API_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify({
        token: G_TOKEN,
        action: "deleteExpense",
        data: { ts: t }
      })
    }).then(() => {
      console.log(`é›²ç«¯åˆªé™¤æˆåŠŸ: ${t}`);
    }).catch(err => {
      console.error("é›²ç«¯åˆªé™¤å¤±æ•—ï¼Œè³‡æ–™å¯èƒ½åœ¨ä¸‹æ¬¡é‡æ–°æ•´ç†æ™‚æ¢å¾©", err);
      alert("ç¶²è·¯é€£ç·šä¸ç©©ï¼Œé›²ç«¯åŒæ­¥å¤±æ•—ã€‚");
    });
  }

  
/*    ====== Desktop: wheel -> horizontal scroll for horizontal strips ====== */
  function enableWheelHorizontal(el){
    if(!el) return;
    el.addEventListener('wheel', (e)=>{
      /* åµæ¸¬å‚ç›´æ»¾è¼ªæ„åœ– */
      if(Math.abs(e.deltaY) > Math.abs(e.deltaX)){
        const canScrollLeft = el.scrollLeft > 0;
        const canScrollRight = el.scrollLeft < (el.scrollWidth - el.clientWidth - 1);

        /* ğŸ’¡ BIOS é‚è¼¯ï¼šåªæœ‰åœ¨å…§éƒ¨é‚„æœ‰ç©ºé–“å¯ä»¥æ°´å¹³ä½ç§»æ™‚ï¼Œæ‰æ””æˆª(PreventDefault)æ²å‹•ä¸­æ–· */
        if ((e.deltaY < 0 && canScrollLeft) || (e.deltaY > 0 && canScrollRight)) {
          e.preventDefault();
          el.scrollLeft += e.deltaY;
        }
        /* å¦å‰‡ï¼šä¸åŸ·è¡Œ preventDefaultï¼Œè®“æ²å‹•äº‹ä»¶å†’æ³¡çµ¦ body è™•ç† */
      }
    }, { passive:false });
  }

/*  utils */
  function escapeHtml(str){
    return String(str ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function unescapeHtml(str){
    return String(str ?? '')
      .replaceAll('&amp;','&')
      .replaceAll('&lt;','<')
      .replaceAll('&gt;','>')
      .replaceAll('&quot;','"')
      .replaceAll('&#39;',"'");
  }
  function copyText(txt) {
    navigator.clipboard.writeText(txt);
    alert('å·²è¤‡è£½ï¼š' + txt);
  }
  function speakJapanese(text){
    const t = String(text||'').trim();
    if(!t) return;

    if(!('speechSynthesis' in window)) return;

    const u = new SpeechSynthesisUtterance(t);
    u.lang = 'ja-JP';
    u.rate = 0.95;
    u.pitch = 1.0;

/*      å˜—è©¦æŒ‘ ja-JP voice */
    const voices = speechSynthesis.getVoices?.() || [];
    const ja = voices.find(v => (v.lang||'').toLowerCase().startsWith('ja'));
    if(ja) u.voice = ja;

    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

/*    ç¢ºä¿ menu card çš„ DOM å­˜åœ¨ */
  function ensureMenuCardUI(){
    if(document.getElementById('menuCardOverlay')) return;

    const overlay = document.createElement('div');
    overlay.id = 'menuCardOverlay';
    overlay.style.cssText = `
      position:fixed; inset:0;
      background:rgba(0,0,0,.38);
      z-index:3000;
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:0 12px calc(14px + env(safe-area-inset-bottom));
    `;

    overlay.innerHTML = `
      <div id="menuCardSheet" style="
        width:min(560px, 100%);
        background:#FAF7F2;
        border-radius:22px;
        border:1px solid rgba(233,225,214,.95);
        box-shadow:0 22px 60px rgba(0,0,0,.22);
        overflow:hidden;
      ">
        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(233,225,214,.8);">
          <div style="font-weight:900;">å“é …ä»‹ç´¹</div>
          <button onclick="closeMenuCard()" style="
            width:34px;height:34px;border-radius:999px;
            border:1px solid rgba(233,225,214,.95);
            background:#fff;font-size:18px;display:flex;align-items:center;justify-content:center;
          ">Ã—</button>
        </div>
        <div id="menuCardBody" style="padding:14px;"></div>
      </div>
    `;

    overlay.addEventListener('click', (e)=>{
      if(e.target === overlay) closeMenuCard();
    });

    document.body.appendChild(overlay);
  }

  function openMenuCard(m){
    ensureMenuCardUI();
    const ov = document.getElementById('menuCardOverlay');
    const body = document.getElementById('menuCardBody');
    if(!ov || !body) return;

    const img = (m.img || '').trim();
    const desc = (m.desc || '').trim();

    body.innerHTML = `
      ${img ? `<img src="${escapeHtml(img)}" alt="" style="width:100%; aspect-ratio:16/9; object-fit:cover; border-radius:14px; border:1px solid rgba(233,225,214,.9);">` : ``}
      <div style="margin-top:10px; font-weight:900; font-size:1.05rem;">${escapeHtml(m.jp || '')}</div>
      <div style="margin-top:4px; color:var(--ink2); font-weight:800;">${escapeHtml(m.zh || '')}</div>
      ${desc ? `<div style="margin-top:10px; line-height:1.65; color:#3A352E; font-weight:700;">${escapeHtml(desc).replace(/\n/g,'<br>')}</div>` : ``}
      ${desc ? `<div class="menuCardDesc">${escapeHtml(desc).replace(/\n/g,'<br>')}</div>` : ``}
    `;

    ov.style.display = 'flex';
  }

  function closeMenuCard(){
    const ov = document.getElementById('menuCardOverlay');
    if(ov) ov.style.display = 'none';
  }


  function mmdd(iso){
    if(!iso) return '';
    const m = String(iso).slice(5,7);
    const d = String(iso).slice(8,10);
    return `${m}/${d}`;
  }
  function weekdayZh(iso){
    if(!iso) return '';
    const dt = new Date(iso + "T00:00:00");
    const arr = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
    return arr[dt.getDay()];
  }

  let __scrollY = 0;
  function lockBodyScroll(){
    __scrollY = window.scrollY || 0;

/*      iOS æœ€ç©©ï¼šæŠŠ body å›ºå®šä½ */
    document.body.classList.add('body-no-scroll'); /*  ä½ åŸæœ¬é‚£å€‹ class å¯ä»¥ç•™è‘— */
    document.body.style.position = 'fixed';
    document.body.style.top = `-${__scrollY}px`;
    document.body.style.left = '0';
    document.body.style.right = '0';
    document.body.style.width = '100%';
  }

  function unlockBodyScroll(){
    document.body.classList.remove('body-no-scroll');
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.left = '';
    document.body.style.right = '';
    document.body.style.width = '';

    window.scrollTo(0, __scrollY);
  }

  function bindLongPressSelection() {
/*      é¸å–æ‰€æœ‰éè·¯å¾‘çš„è¡Œç¨‹é …ç›® */
/*      const items = document.querySelectorAll('.timeline-item:not(.route-item)'); */
/*      âœ… ä¿®æ­£ 1ï¼šç§»é™¤ :not(.route-item)ï¼Œè®“è·¯å¾‘å¡ç‰‡ä¹Ÿèƒ½é•·å£“é€²å…¥ç·¨è¼¯æ¨¡å¼ */
    const items = document.querySelectorAll('.timeline-item');
    
    items.forEach(el => {
      let pressTimer;
      let isLongPress = false;
      let startPos = { x: 0, y: 0 };
  
/*        æ””æˆªç³»çµ±é¸å–®ä¸­æ–· */
      el.oncontextmenu = (e) => {
        if (!__tlEditMode) e.preventDefault(); 
      };
  
/*
//       const start = (e) => {
//         if (__tlEditMode) return; 
//         
//         isLongPress = false;
//         startPos = { x: e.clientX, y: e.clientY };
//         
//         // å•Ÿå‹• 700ms å®šæ™‚å™¨
//         pressTimer = setTimeout(() => {
//           isLongPress = true;
//           triggerEditMode(el);
//         }, 700); 
//       };
*/
/*      âœ… ä¿®æ”¹ï¼šå°‡åŸå§‹äº‹ä»¶ e å‚³å…¥ triggerEditMode */
    const start = (e) => {
      if (__tlEditMode) return; 
      
      isLongPress = false;
      startPos = { x: e.clientX, y: e.clientY };
      
/*        å•Ÿå‹• 700ms å®šæ™‚å™¨ */
      pressTimer = setTimeout(() => {
        isLongPress = true;
        triggerEditMode(el, e);  /* ğŸ‘ˆ é€™è£¡å¤šå‚³å…¥ e */
      }, 700); 
    };
  
      const cancel = (e) => {
        clearTimeout(pressTimer);
        
/*          å¦‚æœä¸æ˜¯é•·å£“ï¼Œä¸”æ˜¯æ­£å¸¸æ”¾é–‹æŒ‡é‡ï¼Œå‰‡è¦–ç‚ºã€Œé»æ“Šã€æ‰“é–‹ Modal */
        if (!isLongPress && e.type === 'pointerup') {
/*            æª¢æŸ¥ä½ç§»ï¼Œé¿å…æ»‘å‹•æ™‚æ„å¤–é–‹å•Ÿ Modal */
          const dist = Math.hypot(e.clientX - startPos.x, e.clientY - startPos.y);
          if (dist < 10) {
            const idx = el.dataset.idx;
/*              openModal(idx); */
            if (idx !== undefined) openModal(idx);
          }
        }
      };
  
/*        å¦‚æœç§»å‹•è·é›¢éå¤§ï¼ˆåœ¨æ»‘å‹•ç¶²é ï¼‰ï¼Œå‰‡å–æ¶ˆé•·å£“åµæ¸¬ */
      const move = (e) => {
        const dist = Math.hypot(e.clientX - startPos.x, e.clientY - startPos.y);
/*          if (dist > 10) clearTimeout(pressTimer); */
/*
         âœ… é—œéµï¼šæé«˜ã€Œå–æ¶ˆé•·å£“ã€çš„é–€æª»åˆ° 30px
         åªè¦æ‰‹æŒ‡ç§»å‹•è¶…é 30 åƒç´ ï¼Œå°±åˆ¤å®šä½¿ç”¨è€…æ˜¯åœ¨ã€Œæ»‘å‹•ç¶²é ã€ï¼Œç«‹åˆ»æ®ºæ‰å®šæ™‚å™¨
*/
        if (dist > 20) {
          clearTimeout(pressTimer);
        }
      };
  
/*        ç¶å®šæ‰€æœ‰æŒ‡é‡äº‹ä»¶ */
      el.addEventListener('pointerdown', start);
      el.addEventListener('pointerup', cancel);
      el.addEventListener('pointermove', move);
      el.addEventListener('pointercancel', () => clearTimeout(pressTimer));
    });
  }

/*    âœ… æ–°å¢ï¼šçµ±ä¸€çš„æ­·å²ç´€éŒ„æ¨é€å‡½å¼ */
  function pushHistory() {
    if (currentDayData && currentDayData.items) {
      __editHistory.push(JSON.parse(JSON.stringify(currentDayData.items)));
/*        é™åˆ¶ Stack å¤§å°ç‚º 10 æ­¥ */
      if (__editHistory.length > 10) __editHistory.shift();
      console.log("å·²ç´€éŒ„æ­·å²ç‹€æ…‹ï¼Œç•¶å‰æ­¥æ•¸:", __editHistory.length);
    }
  }

/*
//   function triggerEditMode(targetEl) {
//     if (navigator.vibrate) navigator.vibrate(50); // è§¸è¦ºå›é¥‹
//     
//     // ç´€éŒ„ç›®å‰ç‹€æ…‹åˆ°æ­·å²ç´€éŒ„ï¼Œæ”¯æ´ã€Œå›å¾©ä¸Šä¸€æ­¥ã€
// //     if (currentDayData) {
// //       __editHistory.push(JSON.parse(JSON.stringify(currentDayData.items)));
// //       if (__editHistory.length > 10) __editHistory.shift();
// //     }
// 
//     // âœ… ä¿®æ”¹ï¼šå‘¼å«çµ±ä¸€çš„æ­·å²ç´€éŒ„å‡½å¼ï¼Œç´€éŒ„ã€Œé€²å…¥ç·¨è¼¯å‰ã€çš„åŸå§‹ç‹€æ…‹
//     pushHistory();
//   
//     __tlEditMode = true;
//     
//     // é‡æ–°æ¸²æŸ“ UI ä»¥é¡¯ç¤ºæ‹–æ›³æ‰‹æŸ„èˆ‡å·¥å…·åˆ—
//     // âœ… ä¿®æ­£ï¼šç›´æ¥æ“ä½œ CSS Classï¼Œä¸è¦é‡æ–°æ¸²æŸ“æ•´å€‹åˆ—è¡¨
//     const listEl = document.getElementById('timelineList');
//     if (listEl) {
//       listEl.classList.add('edit-mode-active');
//     }
//     renderTimelineToolbar(itineraryIndex[currentDayIdx]);
// //     renderTimelineList(currentDayData);
//     enableTimelineSortable();
//     
//     // çµ¦é¸ä¸­çš„é …ç›®ä¸€å€‹è¦–è¦ºæç¤º
//     const content = targetEl.querySelector('.tl-content');
//     if (content) {
//       content.style.transition = "transform 0.2s";
//       content.style.transform = "scale(1.05)";
//       setTimeout(() => content.style.transform = "", 200);
//     }
//   }
//     function triggerEditMode(targetEl) {
//       if (navigator.vibrate) navigator.vibrate(50); // è§¸è¦ºå›é¥‹
//       
//       // âœ… 1. ç´€éŒ„åˆ‡æ›å‰çš„ Viewport åº§æ¨™ (é ‚ç«¯è·é›¢)
//       const oldTop = targetEl.getBoundingClientRect().top;
//       
//       pushHistory();
//       __tlEditMode = true;
//     
//       // âœ… 2. åˆ‡æ› Class é¡¯ç¤ºç·¨è¼¯åˆ—
//       const listEl = document.getElementById('timelineList');
//       if (listEl) {
//         listEl.classList.add('edit-mode-active');
//       }
//     
//       // âœ… 3. ç«‹å³è¨ˆç®—ä½ç§»ä¸¦è£œå„Ÿæ²å‹• (æ ¸å¿ƒä¿®æ­£)
//       const newTop = targetEl.getBoundingClientRect().top;
//       window.scrollBy(0, newTop - oldTop);
//     
//       renderTimelineToolbar(itineraryIndex[currentDayIdx]);
//       enableTimelineSortable();
//       
//       // è¦–è¦ºæç¤º
//       const content = targetEl.querySelector('.tl-content');
//       if (content) {
//         content.style.transition = "transform 0.2s";
//         content.style.transform = "scale(1.05)";
//         setTimeout(() => content.style.transform = "", 200);
//       }
//     }
//     // âœ… ä¿®æ”¹ï¼šæ¥æ”¶ç¬¬äºŒå€‹åƒæ•¸ originalEvent
//     function triggerEditMode(targetEl, originalEvent) {
//       if (navigator.vibrate) navigator.vibrate(50); 
//       
//       const oldTop = targetEl.getBoundingClientRect().top;
//       
//       pushHistory();
//       __tlEditMode = true;
//     
//       const listEl = document.getElementById('timelineList');
//       if (listEl) {
//         listEl.classList.add('edit-mode-active');
// 	// âœ… é˜²æ­¢åœ¨æ‹–æ›³éç¨‹ä¸­é é¢ç™¼ç”Ÿæ„å¤–çš„æ»¾å‹•è¡Œç‚º
// //         listEl.style.touchAction = 'none';
//       }
//     
//       const newTop = targetEl.getBoundingClientRect().top;
//       window.scrollBy(0, newTop - oldTop);
//     
//       // âœ… ä½¿ç”¨ requestAnimationFrame ç¢ºä¿ä½ç§»è£œå„Ÿç”Ÿæ•ˆå¾Œå†ç§»äº¤äº‹ä»¶
//       requestAnimationFrame(() => {
//           if (__tlSortable && originalEvent) {
//               __tlSortable._onTapStart(originalEvent);
//           }
//       });
// 
//       renderTimelineToolbar(itineraryIndex[currentDayIdx]);
//       
//       // 1. å…ˆåˆå§‹åŒ– Sortable
//       enableTimelineSortable();
//       
//       // 2. ğŸ’¡ é—œéµï¼šæ‰‹å‹•å°‡åŸå§‹ pointerdown äº‹ä»¶ã€Œé¤µã€çµ¦ Sortable å¯¦é«”
//       // é€™æœƒè®“ Sortable è¦ºå¾—ä½¿ç”¨è€…ã€Œå‰›å‰›æ‰æŒ‰ä¸‹å»ã€ï¼Œä¸¦ç«‹å³é€²å…¥æ‹–æ›³ç‹€æ…‹
//       if (__tlSortable && originalEvent) {
//         __tlSortable._onTapStart(originalEvent);
//       }
//     
//       const content = targetEl.querySelector('.tl-content');
//       if (content) {
//         content.style.transition = "transform 0.2s";
//         content.style.transform = "scale(1.05)";
//         setTimeout(() => content.style.transform = "", 200);
//       }
//     }
*/
    function triggerEditMode(targetEl, originalEvent) {
      if (navigator.vibrate) navigator.vibrate(50); 
      
/*        âœ… æ–°å¢ï¼šç«‹å³é–å®šè§¸æ§è¡Œç‚ºï¼Œé˜²æ­¢ç€è¦½å™¨åœ¨ç§»äº¤äº‹ä»¶æ™‚è·³å›æ²å‹•æ¨¡å¼ */
      targetEl.style.touchAction = 'none';

      const oldTop = targetEl.getBoundingClientRect().top;
      pushHistory();
      __tlEditMode = true;
    
      const listEl = document.getElementById('timelineList');
      if (listEl) {
        listEl.classList.add('edit-mode-active');
      }
    
      const newTop = targetEl.getBoundingClientRect().top;
      window.scrollBy(0, newTop - oldTop);

      renderTimelineToolbar(itineraryIndex[currentDayIdx]);
      
/*        âœ… ä¿®æ­£ 3ï¼šå…ˆåˆå§‹åŒ– SortableJS */
      enableTimelineSortable();
      
/*
       âœ… ä¿®æ­£ 4ï¼šä½¿ç”¨ requestAnimationFrame ç¢ºä¿ä½ç§»è£œå„Ÿç”Ÿæ•ˆå¾Œå†ç§»äº¤äº‹ä»¶
       ä¸¦ç§»é™¤åŸæœ¬é‡è¤‡çš„ _onTapStart å‘¼å«
*/
/*       requestAnimationFrame(() => { */
          if (__tlSortable && originalEvent) {
              try {
                  __tlSortable._onTapStart(originalEvent);
              } catch (e) {
                  console.warn("äº‹ä»¶ç§»äº¤å¤±æ•—");
              }
          }
/*       }); */
    
/*        è¦–è¦ºæç¤ºï¼šåŒæ™‚ç›¸å®¹ä¸€èˆ¬å¡ç‰‡èˆ‡è·¯å¾‘å¡ç‰‡ */
      const visualTarget = targetEl.querySelector('.tl-content, .route-strip');
      if (visualTarget) {
        visualTarget.style.transition = "transform 0.2s";
        visualTarget.style.transform = "scale(1.05)";
        setTimeout(() => visualTarget.style.transform = "", 200);
      }
    }

/*    åœ¨ä½ çš„ script çµå°¾åŠ å…¥ */
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      console.log("åµæ¸¬åˆ°å›åˆ°ç¶²é ï¼Œå•Ÿå‹•åŒæ­¥...");
      syncFromCloud();
    }
  });

</script>
</body>
</html>
